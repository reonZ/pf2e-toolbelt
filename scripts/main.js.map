{
  "version": 3,
  "sources": ["../../../../../dev/module-api/foundry/actor.js", "../../../../../dev/module-api/foundry/application.js", "../../../../../dev/module-api/foundry/chat.js", "../../../../../dev/module-api/foundry/document.js", "../../../../../dev/module-api/utils/array.js", "../../../../../dev/module-api/utils/html.js", "../../../../../dev/module-api/utils/math.js", "../../../../../dev/module-api/utils/object.js", "../../../../../dev/module-api/utils/string.js", "../../../../../dev/module-api/foundry/flags.js", "../../../../../dev/module-api/foundry/handlebars.js", "../../../../../dev/module-api/foundry/hooks.js", "../../../../../dev/module-api/foundry/item.js", "../../../../../dev/module-api/foundry/libwrapper.js", "../../../../../dev/module-api/foundry/localize.js", "../../../../../dev/module-api/foundry/notifications.js", "../../../../../dev/module-api/foundry/settings.js", "../../../../../dev/module-api/foundry/socket.js", "../../../../../dev/module-api/foundry/user.js", "../../../../../dev/module-api/foundry/index.js", "../../../../../dev/module-api/pf2e/actor.js", "../../../../../dev/module-api/pf2e/browser.js", "../../../../../dev/module-api/pf2e/html.js", "../../../../../dev/module-api/pf2e/misc.js", "../../../../../dev/module-api/pf2e/rules.js", "../../../../../dev/module-api/pf2e/chat.js", "../../../../../dev/module-api/pf2e/classes.js", "../../../../../dev/module-api/pf2e/item.js", "../../../../../dev/module-api/pf2e/spell.js", "../../../../../dev/module-api/pf2e/success.js", "../../../../../dev/module-api/pf2e/template.js", "../src/misc.js", "../src/features/arp.js", "../src/hooks.js", "../src/features/debug.js", "../src/features/effects.js", "../src/actor.js", "../src/apps/giveth/popup.js", "../src/socket.js", "../src/features/giveth.js", "../src/apps/hero/trade.js", "../src/features/hero.js", "../src/draggable.js", "../src/features/inventory.js", "../src/apps/knowledges/lores.js", "../src/features/knowledges.js", "../src/features/merchant.js", "../src/chat.js", "../src/apps/merge/multi.js", "../src/features/merge.js", "../src/features/nobulk.js", "../src/features/share.js", "../src/features/stances.js", "../src/features/summary.js", "../src/features/target.js", "../src/features/unided.js", "../src/features/untarget.js", "../src/macros/condition.js", "../src/main.js"],
  "sourcesContent": ["/**\r\n * @param {unknown} actor\r\n * @returns {unknown}\r\n */\r\nexport function getOwner(actor) {\r\n\tconst isValidUser = (user) => user.active && !user.isGM;\r\n\r\n\tlet owners = game.users.filter(\r\n\t\t(user) => isValidUser(user) && user.character === actor,\r\n\t);\r\n\r\n\tif (!owners.length) {\r\n\t\towners = game.users.filter(\r\n\t\t\t(user) => isValidUser(user) && doc.testUserPermission(user, \"OWNER\"),\r\n\t\t);\r\n\t}\r\n\r\n\towners.sort((a, b) => (a.id > b.id ? 1 : -1));\r\n\r\n\treturn owners[0] || null;\r\n}\r\n\r\n/**\r\n * @param {unknown} actor\r\n * @returns {boolean}\r\n */\r\nexport function isOwner(actor) {\r\n\treturn getOwner(actor) === game.user;\r\n}\r\n", "/**\r\n * @param {unknown} actor\r\n */\r\nexport function refreshCharacterSheets(actor) {\r\n\tfor (const win of Object.values(ui.windows)) {\r\n\t\tconst winActor = win.actor;\r\n\t\tif (!(win instanceof ActorSheet) || !winActor.isOfType(\"character\"))\r\n\t\t\tcontinue;\r\n\t\tif (!actor || actor === winActor) win.render();\r\n\t}\r\n}\r\n", "/**\r\n * @generator\r\n * @template T\r\n * @param {number} nb\r\n * @param {T} [fromMessage]\r\n * @returns {{message: T, html: JQuery}}\r\n */\r\nexport function* latestChatMessages(nb, fromMessage) {\r\n\tconst chat = ui.chat?.element;\r\n\tif (!chat) return;\r\n\r\n\tconst messages = game.messages.contents;\r\n\tconst start =\r\n\t\t(fromMessage\r\n\t\t\t? messages.findLastIndex((m) => m === fromMessage)\r\n\t\t\t: messages.length) - 1;\r\n\r\n\tfor (let i = start; i >= start - nb; i--) {\r\n\t\tconst message = messages[i];\r\n\t\tif (!message) return;\r\n\r\n\t\tconst html = chat.find(`[data-message-id=${message.id}]`);\r\n\t\tif (!html.length) continue;\r\n\r\n\t\tyield { message, html };\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {string} uuid\r\n * @param {string} [label]\r\n * @param {boolean} [fake]\r\n * @returns {string}\r\n */\r\nexport function chatUUID(uuid, label, fake = false) {\r\n\tif (fake) {\r\n\t\treturn `<span style=\"background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);\r\nborder-radius: 2px; white-space: nowrap; word-break: break-all;\">${label}</span>`;\r\n\t}\r\n\r\n\tif (label) return `@UUID[${uuid}]{${label}}`;\r\n\r\n\treturn `@UUID[${uuid}]`;\r\n}\r\n\r\n/**\r\n * @param {object} message\r\n * @returns {string}\r\n */\r\nexport function hasEmbeddedSpell(message) {\r\n\treturn !!(\r\n\t\tmessage.getFlag(\"pf2e\", \"casting.embeddedSpell\") ||\r\n\t\tmessage.item?.trickMagicEntry\r\n\t);\r\n}\r\n", "import { MODULE } from \".\";\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getInMemory(doc, ...path) {\r\n\treturn getProperty(doc, `modules.${MODULE.id}.${path.join(\".\")}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Boolean}\r\n */\r\nexport function setInMemory(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn setProperty(doc, `modules.${MODULE.id}.${args.join(\".\")}`, value);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param {string[]} path\r\n * @returns {boolean}\r\n */\r\nexport function deleteInMemory(doc, ...path) {\r\n\tconst split = [\"modules\", MODULE.id, ...path];\r\n\tconst last = split.pop();\r\n\tlet cursor = doc;\r\n\tfor (const key of split) {\r\n\t\tcursor = cursor[key];\r\n\t\tif (!cursor) return true;\r\n\t}\r\n\treturn delete cursor[last];\r\n}\r\n", "/**\r\n * @template T\r\n *\r\n * @param {T[]} arr\r\n * @param {(value: T) => unknown} fn\r\n * @param {string | number} [key]\r\n * @returns {Record<T, unknown>}\r\n */\r\n\r\nexport function arrayToObject(arr, fn, key) {\r\n\tconst obj = {};\r\n\tfor (const entry of arr) {\r\n\t\tconst k = Array.isArray(entry)\r\n\t\t\t? entry[key ?? 0]\r\n\t\t\t: typeof entry === \"object\" && key != null\r\n\t\t\t  ? entry[key]\r\n\t\t\t  : entry;\r\n\t\tobj[k] = fn(entry);\r\n\t}\r\n\treturn obj;\r\n}\r\n\r\n/**\r\n *\r\n * @param {unknown[]} arr1\r\n * @param {unknown[]} arr2\r\n * @returns {boolean}\r\n */\r\nexport function compareArrays(arr1, arr2) {\r\n\tif (arr1.length !== arr2.length) return false;\r\n\r\n\tconst clonedArr2 = arr2.slice();\r\n\r\n\tfor (const arr1Value of arr1) {\r\n\t\tconst index = clonedArr2.findIndex((arr2Value) => arr1Value === arr2Value);\r\n\t\tif (index === -1) return false;\r\n\t\tclonedArr2.splice(index, 1);\r\n\t}\r\n\r\n\treturn true;\r\n}\r\n\r\n/**\r\n * @param {number | undefined} index\r\n * @returns {boolean}\r\n */\r\nexport function indexIsValid(index) {\r\n\treturn index !== undefined && index !== -1;\r\n}\r\n", "/**\r\n * @param {HTMLElement} el\r\n * @returns {number | undefined}\r\n */\r\nexport function getElementIndex(el) {\r\n\treturn Array.from(el.parentElement.children).indexOf(el);\r\n}\r\n", "/**\r\n * @param {number} x1\r\n * @param {number} y1\r\n * @param {number} x2\r\n * @param {number} y2\r\n * @returns {number}\r\n */\r\nexport function calculateDistanceBetweenPoints(x1, y1, x2, y2) {\r\n\tconst x = x2 - x1;\r\n\tconst y = y2 - y1;\r\n\treturn Math.sqrt(x * x + y * y);\r\n}\r\n", "/**\r\n * @param {object} obj\r\n * @param {string} name\r\n * @returns {boolean}\r\n */\r\nexport function isInstanceOf(obj, name) {\r\n\tif (typeof obj !== \"object\") return false;\r\n\r\n\tlet cursor = Reflect.getPrototypeOf(obj);\r\n\twhile (cursor) {\r\n\t\tif (cursor.constructor.name === name) return true;\r\n\t\tcursor = Reflect.getPrototypeOf(cursor);\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n", "/**\r\n * @param {string} separator\r\n * @param  {(string|string[])[]} path\r\n * @returns {string}\r\n */\r\nexport function joinStr(separator, ...path) {\r\n\tconst pathArr = Array.isArray(path[0]) ? path[0] : path;\r\n\treturn pathArr.filter((x) => typeof x === \"string\").join(separator);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function flagPath(...path) {\r\n\treturn `flags.${MODULE.id}.${joinStr(\".\", path)}`;\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlag(doc, ...path) {\r\n\treturn doc.getFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {string[]} path\r\n * @returns {unknown}\r\n */\r\nexport function getFlagProperty(doc, ...path) {\r\n\treturn getProperty(doc, flagPath(...path));\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {Promise<T>}\r\n */\r\nexport function setFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.setFlag(MODULE.id, args.join(\".\"), value);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {T} doc\r\n * @param {string[]} path\r\n * @returns {Promise<T>}\r\n */\r\nexport function unsetFlag(doc, ...path) {\r\n\treturn doc.unsetFlag(MODULE.id, path.join(\".\"));\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @returns {unknown}\r\n */\r\nexport function getModuleFlags(doc) {\r\n\treturn getProperty(doc, `flags.${MODULE.id}`);\r\n}\r\n\r\n/**\r\n * @param {object} doc\r\n * @param  {(string|unknown)[]} args\r\n * @returns {object}\r\n */\r\nexport function updateSourceFlag(doc, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\treturn doc.updateSource({\r\n\t\t[flagPath(...args)]: value,\r\n\t});\r\n}\r\n\r\n/**\r\n * @param {object} updates\r\n * @param  {(string|unknown)[]} args\r\n */\r\nexport function moduleFlagUpdate(updates, ...args) {\r\n\tconst value = args.splice(-1)[0];\r\n\tupdates[flagPath(...args)] = value;\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param  {(string|object)[]} args\r\n * @returns {Promise<string>}\r\n */\r\nexport function render(...args) {\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : {};\r\n\tconst path = templatePath(...args);\r\n\treturn renderTemplate(path, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function templatePath(...path) {\r\n\treturn `modules/${MODULE.id}/templates/${joinStr(\"/\", path)}.hbs`;\r\n}\r\n", "/**\r\n * @param {string} hook\r\n * @param {Functionn} fn\r\n * @returns {number}\r\n */\r\nexport function registerUpstreamHook(hook, fn) {\r\n\tconst id = Hooks.on(hook, fn);\r\n\tconst index = Hooks.events[hook].findIndex((x) => x.id === id);\r\n\r\n\tif (index !== 0) {\r\n\t\tconst [hooked] = Hooks.events[hook].splice(index, 1);\r\n\t\tHooks.events[hook].unshift(hooked);\r\n\t}\r\n\r\n\treturn id;\r\n}\r\n", "/**\r\n * @param {object} item\r\n * @returns {string}\r\n */\r\nfunction getSourceId(item) {\r\n\treturn item.getFlag(\"core\", \"sourceId\");\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {string[]} list\r\n * @returns {boolean}\r\n */\r\nfunction includesSourceId(item, list) {\r\n\tconst sourceId = getSourceId(item);\r\n\treturn sourceId ? list.includes(sourceId) : false;\r\n}\r\n\r\n/**\r\n * @param {string|string[]} sourceId\r\n * @returns {(item: object) => boolean}\r\n */\r\nfunction getItemSourceIdCondition(sourceId) {\r\n\treturn Array.isArray(sourceId)\r\n\t\t? (item) => includesSourceId(item, sourceId)\r\n\t\t: (item) => getSourceId(item) === sourceId;\r\n}\r\n\r\n/**\r\n *\r\n * @param {object} actor\r\n * @param {string|string[]} itemTypes\r\n * @returns {object[]}\r\n */\r\nexport function getItems(actor, itemTypes = []) {\r\n\tconst types = typeof itemTypes === \"string\" ? [itemTypes] : itemTypes;\r\n\treturn types.length\r\n\t\t? types.flatMap((type) => actor.itemTypes[type])\r\n\t\t: actor.items;\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {boolean}\r\n */\r\nexport function hasItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).some(getItemSourceIdCondition(sourceId));\r\n}\r\n\r\n/**\r\n * @param {object} actor\r\n * @param {string} sourceId\r\n * @param {string|string[]} itemTypes\r\n * @returns {object} item\r\n */\r\nexport function getItemWithSourceId(actor, sourceId, itemTypes) {\r\n\treturn getItems(actor, itemTypes).find(getItemSourceIdCondition(sourceId));\r\n}\r\n", "import { MODULE } from \".\";\r\n\r\n/**\r\n * @param {string} path\r\n * @param {(...args: unknown[]) => unknown} callback\r\n * @param {\"WRAPPER\" | \"OVERRIDE\" | \"MIXED\"} type\r\n * @returns {string}\r\n */\r\nexport function registerWrapper(path, callback, type = \"WRAPPER\") {\r\n\treturn libWrapper.register(MODULE.id, path, callback, type);\r\n}\r\n\r\n/**\r\n * @param {string} id\r\n */\r\nexport function unregisterWrapper(id) {\r\n\tlibWrapper.unregister(MODULE.id, id);\r\n}\r\n", "import { MODULE, error, info, warn } from \".\";\r\nimport { joinStr } from \"../utils\";\r\n\r\n/**\r\n * @param {(string | object)[]} args\r\n * @returns {string}\r\n */\r\nexport function localize(...args) {\r\n\targs.unshift(MODULE.id);\r\n\tconst data = typeof args.at(-1) === \"object\" ? args.splice(-1)[0] : undefined;\r\n\treturn game.i18n[data ? \"format\" : \"localize\"](joinStr(\".\", args), data);\r\n}\r\n\r\n/**\r\n * Check if a module localization exists\r\n * @param {string[]} keys\r\n * @returns {boolean}\r\n */\r\nexport function hasLocalization(...keys) {\r\n\treturn game.i18n.has(`${MODULE.id}.${keys.join(\".\")}`, false);\r\n}\r\n\r\n/**\r\n * Used to localize in handlebars template\r\n * @param  {(string | {hash: object})[]} args\r\n * @returns {string}\r\n */\r\nexport function templateLocalize(...args) {\r\n\tconst data = args.splice(-1)[0].hash;\r\n\treturn localize(...args, data);\r\n}\r\n\r\n/**\r\n * @param  {string[]} path\r\n * @returns {string}\r\n */\r\nexport function localizePath(...path) {\r\n\treturn `${MODULE.id}.${path.join(\".\")}`;\r\n}\r\n\r\n/**\r\n * Convenient localization object with a sub context\r\n * @param {string} subKey\r\n * @returns {typeof localize & {path: typeof localizePath, template: typeof templateLocalize, warn: typeof warn, info: typeof info, error: typeof error, i18n: {i18n: typeof templateLocalize, i18Path: typeof localizePath}}}\r\n */\r\nexport function subLocalize(subKey) {\r\n\tconst fn = (...args) => localize(subKey, ...args);\r\n\r\n\tObject.defineProperties(fn, {\r\n\t\twarn: {\r\n\t\t\tvalue: (str, arg1, arg2) => warn(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tinfo: {\r\n\t\t\tvalue: (str, arg1, arg2) => info(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\terror: {\r\n\t\t\tvalue: (str, arg1, arg2) => error(`${subKey}.${str}`, arg1, arg2),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\thas: {\r\n\t\t\tvalue: (key) => hasLocalization(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\tpath: {\r\n\t\t\tvalue: (key) => localizePath(subKey, key),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ttemplate: {\r\n\t\t\tvalue: (key, { hash }) => fn(key, hash),\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t\ti18n: {\r\n\t\t\tget() {\r\n\t\t\t\treturn {\r\n\t\t\t\t\ti18n: this.template,\r\n\t\t\t\t\ti18Path: this.path,\r\n\t\t\t\t};\r\n\t\t\t},\r\n\t\t\tenumerable: false,\r\n\t\t\tconfigurable: false,\r\n\t\t},\r\n\t});\r\n\r\n\treturn fn;\r\n}\r\n\r\n/**\r\n * @param {string} a\r\n * @param {string} b\r\n * @returns {number}\r\n */\r\nexport function localeCompare(a, b) {\r\n\treturn a.localeCompare(b, game.i18n.lang);\r\n}\r\n", "import { localize } from \"./localize\";\r\n\r\n/**\r\n * @param {string} str\r\n * @param {\"warning\" | \"info\" | \"error\" | object | boolean} [arg1]\r\n * @param {object | boolean} [arg2]\r\n * @param {boolean} [arg3]\r\n */\r\nfunction notify(str, arg1, arg2, arg3) {\r\n\tconst type = typeof arg1 === \"string\" ? arg1 : \"info\";\r\n\tconst data =\r\n\t\ttypeof arg1 === \"object\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"object\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : undefined;\r\n\tconst permanent =\r\n\t\ttypeof arg1 === \"boolean\"\r\n\t\t\t? arg1\r\n\t\t\t: typeof arg2 === \"boolean\"\r\n\t\t\t  ? arg2\r\n\t\t\t  : arg3 ?? false;\r\n\r\n\tui.notifications.notify(localize(str, data), type, { permanent });\r\n}\r\n\r\n/**\r\n * @typedef { (str: string, arg1?: object | boolean, arg2?: boolean) => void } Notify\r\n */\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function warn(str, arg1, arg2) {\r\n\tnotify(str, \"warning\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function info(str, arg1, arg2) {\r\n\tnotify(str, \"info\", arg1, arg2);\r\n}\r\n\r\n/**\r\n * @type {Notify}\r\n */\r\nexport function error(str, arg1, arg2) {\r\n\tnotify(str, \"error\", arg1, arg2);\r\n}\r\n", "import { MODULE } from \".\";\r\nimport { arrayToObject } from \"../utils/array\";\r\n\r\n/**\r\n * Register a foundry setting\r\n *\r\n * @template {number | boolean | string} T\r\n * @param { {key: string, type: new (...args: unknkown[]) => T, default: T, [k: string]: unknown }} options\r\n */\r\nexport function registerSetting(options) {\r\n\toptions.key ??= options.name;\r\n\r\n\tif (Array.isArray(options.choices)) {\r\n\t\toptions.choices = arrayToObject(options.choices, (choice) =>\r\n\t\t\tsettingPath(options.key, `choices.${choice}`),\r\n\t\t);\r\n\t}\r\n\r\n\toptions.name ??= settingPath(options.key, \"name\");\r\n\toptions.hint ??= settingPath(options.key, \"hint\");\r\n\toptions.scope ??= \"world\";\r\n\toptions.config ??= true;\r\n\r\n\tgame.settings.register(MODULE.id, options.key, options);\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @param {string} key\r\n * @returns\r\n */\r\nexport function settingPath(setting, key) {\r\n\treturn `${MODULE.id}.settings.${setting}.${key}`;\r\n}\r\n\r\n/**\r\n * @param {string} setting\r\n * @returns {unknown}\r\n */\r\nexport function getSetting(setting) {\r\n\treturn game.settings.get(MODULE.id, setting);\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {string} setting\r\n * @param {T} value\r\n * @returns {Promise<T>}\r\n */\r\nexport function setSetting(setting, value) {\r\n\treturn game.settings.set(MODULE.id, setting, value);\r\n}\r\n", "import { MODULE } from \".\";\r\n\r\n/**\r\n * @typedef { {key: string, [k: string]: unknown} } ModulePacket\r\n * @typedef { (packet: ModulePacket, senderId: string) => void} ModuleSocketFunction\r\n */\r\n\r\n/**\r\n * @param {ModuleSocketFunction} callback\r\n */\r\nexport function socketOn(callback) {\r\n\tgame.socket.on(`module.${MODULE.id}`, callback);\r\n}\r\n\r\n/**\r\n * @param {ModuleSocketFunction} callback\r\n */\r\nexport function socketOff(callback) {\r\n\tgame.socket.off(`module.${MODULE.id}`, callback);\r\n}\r\n\r\n/**\r\n * @param {ModulePacket} packet\r\n */\r\nexport function socketEmit(packet) {\r\n\tgame.socket.emit(`module.${MODULE.id}`, packet);\r\n}\r\n", "function getUser() {\r\n\treturn game.user ?? game.data.users.find((x) => x._id === game.data.userId);\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isUserGM() {\r\n\tconst user = getUser();\r\n\treturn user && user.role >= CONST.USER_ROLES.ASSISTANT;\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isActiveGM() {\r\n\treturn game.user === game.users.activeGM;\r\n}\r\n\r\n/**\r\n * @returns {boolean}\r\n */\r\nexport function isGMOnline() {\r\n\treturn game.users.some((user) => user.active && user.isGM);\r\n}\r\n", "export * from \"./actor\";\r\nexport * from \"./application\";\r\nexport * from \"./chat\";\r\nexport * from \"./document\";\r\nexport * from \"./flags\";\r\nexport * from \"./handlebars\";\r\nexport * from \"./hooks\";\r\nexport * from \"./item\";\r\nexport * from \"./libwrapper\";\r\nexport * from \"./localize\";\r\nexport * from \"./notifications\";\r\nexport * from \"./settings\";\r\nexport * from \"./socket\";\r\nexport * from \"./user\";\r\n\r\n/**\r\n * @type {string}\r\n */\r\nlet MODULE_ID = null;\r\n\r\nexport const MODULE = {\r\n\tget id() {\r\n\t\tif (!MODULE_ID) {\r\n\t\t\tthrow new Error(\"Module id needs to be registered.\");\r\n\t\t}\r\n\t\treturn MODULE_ID;\r\n\t},\r\n\t/**\r\n\t * @param {string} str\r\n\t */\r\n\terror(str) {\r\n\t\tthrow new Error(`[${this.id}] ${str}`);\r\n\t},\r\n};\r\n\r\n/**\r\n * register the module id\r\n * @param {string} id\r\n */\r\nexport function registerModule(id) {\r\n\tMODULE_ID = id;\r\n}\r\n\r\n/**\r\n * @param {string} [id]\r\n * @returns {object}\r\n */\r\nexport function getModule(id) {\r\n\treturn game.modules.get(id ?? MODULE.id);\r\n}\r\n", "/** A comparison which rates the first modifier as better than the second if it's modifier is at least as large. */\r\nconst HIGHER_BONUS = (a, b) => a.modifier >= b.modifier;\r\n/** A comparison which rates the first modifier as better than the second if it's modifier is at least as small. */\r\nconst LOWER_PENALTY = (a, b) => a.modifier <= b.modifier;\r\n\r\n/**\r\n * @param {object[]} modifiers\r\n * @returns {number}\r\n */\r\nexport function applyStackingRules(modifiers) {\r\n\tlet total = 0;\r\n\tconst highestBonus = {};\r\n\tconst lowestPenalty = {};\r\n\r\n\t// There are no ability bonuses or penalties, so always take the highest ability modifier.\r\n\tconst abilityModifiers = modifiers.filter(\r\n\t\t(m) => m.type === \"ability\" && !m.ignored,\r\n\t);\r\n\tconst bestAbility = abilityModifiers.reduce((best, modifier) => {\r\n\t\tif (best === null) {\r\n\t\t\treturn modifier;\r\n\t\t}\r\n\r\n\t\treturn modifier.force\r\n\t\t\t? modifier\r\n\t\t\t: best.force\r\n\t\t\t  ? best\r\n\t\t\t  : modifier.modifier > best.modifier\r\n\t\t\t\t  ? modifier\r\n\t\t\t\t  : best;\r\n\t}, null);\r\n\tfor (const modifier of abilityModifiers) {\r\n\t\tmodifier.ignored = modifier !== bestAbility;\r\n\t}\r\n\r\n\tfor (const modifier of modifiers) {\r\n\t\t// Always disable ignored modifiers and don't do anything further with them.\r\n\t\tif (modifier.ignored) {\r\n\t\t\tmodifier.enabled = false;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Untyped modifiers always stack, so enable them and add their modifier.\r\n\t\tif (modifier.type === \"untyped\") {\r\n\t\t\tmodifier.enabled = true;\r\n\t\t\ttotal += modifier.modifier;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\t// Otherwise, apply stacking rules to positive modifiers and negative modifiers separately.\r\n\t\tif (modifier.modifier < 0) {\r\n\t\t\ttotal += applyStacking(lowestPenalty, modifier, LOWER_PENALTY);\r\n\t\t} else {\r\n\t\t\ttotal += applyStacking(highestBonus, modifier, HIGHER_BONUS);\r\n\t\t}\r\n\t}\r\n\r\n\treturn total;\r\n}\r\n\r\n/**\r\n * @template T\r\n * @param {Record<string, T>} best\r\n * @param {T} modifier\r\n * @param {(a: object, b:object) => boolean} isBetter\r\n * @returns {number}\r\n */\r\nfunction applyStacking(best, modifier, isBetter) {\r\n\t// If there is no existing bonus of this type, then add ourselves.\r\n\tconst existing = best[modifier.type];\r\n\tif (existing === undefined) {\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier;\r\n\t}\r\n\r\n\tif (isBetter(modifier, existing)) {\r\n\t\t// If we are a better modifier according to the comparison, then we become the new 'best'.\r\n\t\texisting.enabled = false;\r\n\t\tmodifier.enabled = true;\r\n\t\tbest[modifier.type] = modifier;\r\n\t\treturn modifier.modifier - existing.modifier;\r\n\t}\r\n\r\n\t// Otherwise, the existing modifier is better, so do nothing.\r\n\tmodifier.enabled = false;\r\n\treturn 0;\r\n}\r\n", "/**\r\n * @param {object} tab\r\n * @returns {Promise<object[]>}\r\n */\r\nexport function getTabResults(tab) {\r\n\treturn Promise.all(\r\n\t\ttab.currentIndex.flatMap(async ({ uuid }) =>\r\n\t\t\t(await fromUuid(uuid))?.toObject(),\r\n\t\t),\r\n\t);\r\n}\r\n", "/**\r\n * @param {unknown} parent\r\n * @param {string} selectors\r\n * @returns {HTMLElement|null}\r\n */\r\nexport function htmlQuery(parent, selectors) {\r\n\tif (!(parent instanceof Element || parent instanceof Document)) return null;\r\n\treturn parent.querySelector(selectors);\r\n}\r\n", "/**\r\n * @param {number} value\r\n * @returns {string}\r\n */\r\nexport function ordinalString(value) {\r\n\tconst pluralRules = new Intl.PluralRules(game.i18n.lang, { type: \"ordinal\" });\r\n\tconst suffix = game.i18n.localize(\r\n\t\t`PF2E.OrdinalSuffixes.${pluralRules.select(value)}`,\r\n\t);\r\n\treturn game.i18n.format(\"PF2E.OrdinalNumber\", { value, suffix });\r\n}\r\n\r\n/**\r\n * @param {string} message\r\n * @returns {Error}\r\n */\r\nexport function ErrorPF2e(message) {\r\n\treturn Error(`PF2e System | ${message}`);\r\n}\r\n\r\n/**\r\n * @type {Intl.NumberFormat}\r\n */\r\nlet intlNumberFormat;\r\n/**\r\n * @param {number} value\r\n * @param {object} [options]\r\n * @param {boolean} [options.emptyStringZero]\r\n * @param {boolean} [options.zeroIsNegative]\r\n * @returns {string}\r\n */\r\nexport function signedInteger(\r\n\tvalue,\r\n\t{ emptyStringZero = false, zeroIsNegative = false } = {},\r\n) {\r\n\tif (value === 0 && emptyStringZero) return \"\";\r\n\r\n\tintlNumberFormat ??= new Intl.NumberFormat(game.i18n.lang, {\r\n\t\tmaximumFractionDigits: 0,\r\n\t\tsignDisplay: \"always\",\r\n\t});\r\n\r\n\tconst maybeNegativeZero = zeroIsNegative && value === 0 ? -0 : value;\r\n\r\n\treturn intlNumberFormat.format(maybeNegativeZero);\r\n}\r\n", "/**\r\n * @param {object} options\r\n * @param {string} options.affects\r\n * @param {object} options.origin\r\n * @param {object} options.target\r\n * @param {object} options.item\r\n * @param {string[]} options.domains\r\n * @param {string[]} options.options\r\n * @returns {Promise<object[]>}\r\n */\r\nexport async function extractEphemeralEffects({\r\n\taffects,\r\n\torigin,\r\n\ttarget,\r\n\titem,\r\n\tdomains,\r\n\toptions,\r\n}) {\r\n\tif (!(origin && target)) return [];\r\n\r\n\tconst [effectsFrom, effectsTo] =\r\n\t\taffects === \"target\" ? [origin, target] : [target, origin];\r\n\tconst fullOptions = [\r\n\t\t...options,\r\n\t\teffectsFrom.getRollOptions(domains),\r\n\t\teffectsTo.getSelfRollOptions(affects),\r\n\t].flat();\r\n\tconst resolvables = item\r\n\t\t? item.isOfType(\"spell\")\r\n\t\t\t? { spell: item }\r\n\t\t\t: { weapon: item }\r\n\t\t: {};\r\n\treturn (\r\n\t\tawait Promise.all(\r\n\t\t\tdomains\r\n\t\t\t\t.flatMap(\r\n\t\t\t\t\t(s) => effectsFrom.synthetics.ephemeralEffects[s]?.[affects] ?? [],\r\n\t\t\t\t)\r\n\t\t\t\t.map((d) => d({ test: fullOptions, resolvables })),\r\n\t\t)\r\n\t).flatMap((e) => e ?? []);\r\n}\r\n\r\n/**\r\n * @param {object} rollNotes\r\n * @param {string[]} selectors\r\n * @returns {object[]}\r\n */\r\nexport function extractNotes(rollNotes, selectors) {\r\n\treturn selectors.flatMap((s) => (rollNotes[s] ?? []).map((n) => n.clone()));\r\n}\r\n\r\n/**\r\n *\r\n * @param {object} deferredDice\r\n * @param {string[]} selectors\r\n * @param {object} options\r\n * @returns {object[]}\r\n */\r\nexport function extractDamageDice(deferredDice, selectors, options) {\r\n\treturn selectors\r\n\t\t.flatMap((s) => deferredDice[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n}\r\n\r\n/**\r\n * @param {object} synthetics\r\n * @param {string[]} selectors\r\n * @param {object} options\r\n * @returns {object[]}\r\n */\r\nexport function extractModifiers(synthetics, selectors, options) {\r\n\tconst { modifierAdjustments, modifiers: syntheticModifiers } = synthetics;\r\n\tconst modifiers = Array.from(new Set(selectors))\r\n\t\t.flatMap((s) => syntheticModifiers[s] ?? [])\r\n\t\t.flatMap((d) => d(options) ?? []);\r\n\tfor (const modifier of modifiers) {\r\n\t\tmodifier.adjustments = extractModifierAdjustments(\r\n\t\t\tmodifierAdjustments,\r\n\t\t\tselectors,\r\n\t\t\tmodifier.slug,\r\n\t\t);\r\n\t}\r\n\r\n\treturn modifiers;\r\n}\r\n\r\n/**\r\n * @param {object} adjustmentsRecord\r\n * @param {string[]} selectors\r\n * @param {string} slug\r\n * @returns {object[]}\r\n */\r\nfunction extractModifierAdjustments(adjustmentsRecord, selectors, slug) {\r\n\tconst adjustments = Array.from(\r\n\t\tnew Set(selectors.flatMap((s) => adjustmentsRecord[s] ?? [])),\r\n\t);\r\n\treturn adjustments.filter((a) => [slug, null].includes(a.slug));\r\n}\r\n", "import { isInstanceOf } from \"../utils\";\r\nimport { applyStackingRules } from \"./actor\";\r\nimport { htmlQuery } from \"./html\";\r\nimport { ErrorPF2e, signedInteger } from \"./misc\";\r\nimport {\r\n\textractDamageDice,\r\n\textractEphemeralEffects,\r\n\textractModifiers,\r\n\textractNotes,\r\n} from \"./rules\";\r\n\r\n/**\r\n * @typedef {(message: object, tokens: object[], rollIndex: number) => void} OnDamageApplied\r\n *\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.addend\r\n * @param {boolean} options.promptModifier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nexport async function applyDamageFromMessage({\r\n\tmessage,\r\n\tmultiplier = 1,\r\n\taddend = 0,\r\n\tpromptModifier = false,\r\n\trollIndex = 0,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tif (promptModifier) {\r\n\t\treturn shiftAdjustDamage({\r\n\t\t\tmessage,\r\n\t\t\tmultiplier,\r\n\t\t\trollIndex,\r\n\t\t\t// added\r\n\t\t\ttokens,\r\n\t\t\tonDamageApplied,\r\n\t\t});\r\n\t}\r\n\r\n\t// changed\r\n\ttokens ??= (() => {\r\n\t\tconst html = htmlQuery(\r\n\t\t\tui.chat.element[0],\r\n\t\t\t`li.chat-message[data-message-id=\"${message.id}\"]`,\r\n\t\t);\r\n\t\treturn html?.dataset.actorIsTarget && message.token\r\n\t\t\t? [message.token]\r\n\t\t\t: game.user.getActiveTokens();\r\n\t})();\r\n\tif (tokens.length === 0) {\r\n\t\tui.notifications.error(\"PF2E.ErrorMessage.NoTokenSelected\", {\r\n\t\t\tlocalize: true,\r\n\t\t});\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst shieldBlockRequest = CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\tconst roll = message.rolls.at(rollIndex);\r\n\tif (!isInstanceOf(roll, \"DamageRoll\"))\r\n\t\tthrow ErrorPF2e(\"Unexpected error retrieving damage roll\");\r\n\r\n\tlet damage =\r\n\t\tmultiplier < 0\r\n\t\t\t? multiplier * roll.total + addend\r\n\t\t\t: roll.alter(multiplier, addend);\r\n\r\n\t// Get origin roll options and apply damage to a contextual clone: this may influence condition IWR, for example\r\n\tconst messageRollOptions = [...(message.flags.pf2e.context?.options ?? [])];\r\n\tconst originRollOptions = messageRollOptions\r\n\t\t.filter((o) => o.startsWith(\"self:\"))\r\n\t\t.map((o) => o.replace(/^self/, \"origin\"));\r\n\tconst messageItem = message.item;\r\n\tconst effectRollOptions = messageItem?.isOfType(\r\n\t\t\"affliction\",\r\n\t\t\"condition\",\r\n\t\t\"effect\",\r\n\t)\r\n\t\t? messageItem.getRollOptions(\"item\")\r\n\t\t: [];\r\n\r\n\tfor (const token of tokens) {\r\n\t\tif (!token.actor) continue;\r\n\r\n\t\t// If no target was acquired during a roll, set roll options for it during damage application\r\n\t\tif (!messageRollOptions.some((o) => o.startsWith(\"target\"))) {\r\n\t\t\tmessageRollOptions.push(...token.actor.getSelfRollOptions(\"target\"));\r\n\t\t}\r\n\t\tconst domain = multiplier > 0 ? \"damage-received\" : \"healing-received\";\r\n\t\tconst ephemeralEffects =\r\n\t\t\tmultiplier > 0\r\n\t\t\t\t? await extractEphemeralEffects({\r\n\t\t\t\t\t\taffects: \"target\",\r\n\t\t\t\t\t\torigin: message.actor,\r\n\t\t\t\t\t\ttarget: token.actor,\r\n\t\t\t\t\t\titem: message.item,\r\n\t\t\t\t\t\tdomains: [domain],\r\n\t\t\t\t\t\toptions: messageRollOptions,\r\n\t\t\t\t  })\r\n\t\t\t\t: [];\r\n\t\tconst contextClone = token.actor.getContextualClone(\r\n\t\t\toriginRollOptions,\r\n\t\t\tephemeralEffects,\r\n\t\t);\r\n\t\tconst applicationRollOptions = new Set([\r\n\t\t\t...messageRollOptions.filter((o) => !/^(?:self|target):/.test(o)),\r\n\t\t\t...effectRollOptions,\r\n\t\t\t...originRollOptions,\r\n\t\t\t...contextClone.getSelfRollOptions(),\r\n\t\t]);\r\n\r\n\t\t// Target-specific damage/healing adjustments\r\n\t\tconst outcome = message.flags.pf2e.context?.outcome;\r\n\t\tconst breakdown = [];\r\n\t\tconst rolls = [];\r\n\t\tif (typeof damage === \"number\" && damage < 0) {\r\n\t\t\tconst critical = outcome === \"criticalSuccess\";\r\n\r\n\t\t\tconst resolvables = (() => {\r\n\t\t\t\tif (messageItem?.isOfType(\"spell\")) return { spell: messageItem };\r\n\t\t\t\tif (messageItem?.isOfType(\"weapon\")) return { weapon: messageItem };\r\n\t\t\t\treturn {};\r\n\t\t\t})();\r\n\r\n\t\t\tconst damageDice = extractDamageDice(\r\n\t\t\t\tcontextClone.synthetics.damageDice,\r\n\t\t\t\t[domain],\r\n\t\t\t\t{\r\n\t\t\t\t\tresolvables,\r\n\t\t\t\t\ttest: applicationRollOptions,\r\n\t\t\t\t},\r\n\t\t\t).filter(\r\n\t\t\t\t(d) =>\r\n\t\t\t\t\t(d.critical === null || d.critical === critical) &&\r\n\t\t\t\t\td.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\tfor (const dice of damageDice) {\r\n\t\t\t\tconst formula = `${dice.diceNumber}${dice.dieSize}[${dice.label}]`;\r\n\t\t\t\tconst roll = await new Roll(formula).evaluate({ async: true });\r\n\t\t\t\troll._formula = `${dice.diceNumber}${dice.dieSize}`; // remove the label from the main formula\r\n\t\t\t\tawait roll.toMessage({\r\n\t\t\t\t\tflags: { pf2e: { suppressDamageButtons: true } },\r\n\t\t\t\t\tflavor: dice.label,\r\n\t\t\t\t\tspeaker: ChatMessage.getSpeaker({ token }),\r\n\t\t\t\t});\r\n\t\t\t\tbreakdown.push(`${dice.label} ${dice.diceNumber}${dice.dieSize}`);\r\n\t\t\t\trolls.push(roll);\r\n\t\t\t}\r\n\t\t\tif (rolls.length) {\r\n\t\t\t\tdamage -= rolls\r\n\t\t\t\t\t.map((roll) => roll.total)\r\n\t\t\t\t\t.reduce((previous, current) => previous + current);\r\n\t\t\t}\r\n\r\n\t\t\tconst modifiers = extractModifiers(contextClone.synthetics, [domain], {\r\n\t\t\t\tresolvables,\r\n\t\t\t}).filter(\r\n\t\t\t\t(m) =>\r\n\t\t\t\t\t(m.critical === null || m.critical === critical) &&\r\n\t\t\t\t\tm.predicate.test(applicationRollOptions),\r\n\t\t\t);\r\n\r\n\t\t\t// unlikely to have any typed modifiers, but apply stacking rules just in case even though the context of\r\n\t\t\t// previously applied modifiers has been lost\r\n\t\t\tdamage -= applyStackingRules(modifiers ?? []);\r\n\r\n\t\t\t// target-specific modifiers breakdown\r\n\t\t\tbreakdown.push(\r\n\t\t\t\t...modifiers\r\n\t\t\t\t\t.filter((m) => m.enabled)\r\n\t\t\t\t\t.map((m) => `${m.label} ${signedInteger(m.modifier)}`),\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tconst hasDamageOrHealing =\r\n\t\t\ttypeof damage === \"number\" ? damage !== 0 : damage.total !== 0;\r\n\t\tconst notes = hasDamageOrHealing\r\n\t\t\t? extractNotes(contextClone.synthetics.rollNotes, [domain]).filter(\r\n\t\t\t\t\t(n) =>\r\n\t\t\t\t\t\t(!outcome ||\r\n\t\t\t\t\t\t\tn.outcome.length === 0 ||\r\n\t\t\t\t\t\t\tn.outcome.includes(outcome)) &&\r\n\t\t\t\t\t\tn.predicate.test(applicationRollOptions),\r\n\t\t\t  )\r\n\t\t\t: [];\r\n\r\n\t\tawait contextClone.applyDamage({\r\n\t\t\tdamage,\r\n\t\t\ttoken,\r\n\t\t\titem: message.item,\r\n\t\t\tskipIWR: multiplier <= 0,\r\n\t\t\trollOptions: applicationRollOptions,\r\n\t\t\tshieldBlockRequest,\r\n\t\t\tbreakdown,\r\n\t\t\tnotes,\r\n\t\t});\r\n\t}\r\n\ttoggleOffShieldBlock(message.id);\r\n\r\n\t// added\r\n\tonDamageApplied?.(message, tokens, rollIndex);\r\n}\r\n\r\n/**\r\n * @param {object} target\r\n * @param {HTMLElement} shieldButton\r\n * @param {HTMLElement} messageEl\r\n */\r\nexport function onClickShieldBlock(target, shieldButton, messageEl) {\r\n\t// changed\r\n\tconst getTokens = () => {\r\n\t\treturn [target];\r\n\t};\r\n\tconst getNonBrokenShields = (tokens) => {\r\n\t\tconst actor = tokens[0]?.actor;\r\n\t\treturn (\r\n\t\t\tactor?.itemTypes.shield.filter(\r\n\t\t\t\t(s) => s.isEquipped && !s.isBroken && !s.isDestroyed,\r\n\t\t\t) ?? []\r\n\t\t);\r\n\t};\r\n\r\n\t// Add a tooltipster instance to the shield button if needed.\r\n\tif (!shieldButton.classList.contains(\"tooltipstered\")) {\r\n\t\t$(shieldButton)\r\n\t\t\t.tooltipster({\r\n\t\t\t\tanimation: \"fade\",\r\n\t\t\t\ttrigger: \"click\",\r\n\t\t\t\tarrow: false,\r\n\t\t\t\tcontent: htmlQuery(messageEl, \"div.hover-content\"),\r\n\t\t\t\tcontentAsHTML: true,\r\n\t\t\t\tcontentCloning: true,\r\n\t\t\t\tdebug: false,\r\n\t\t\t\tinteractive: true,\r\n\t\t\t\tside: [\"top\"],\r\n\t\t\t\ttheme: \"crb-hover\",\r\n\t\t\t\tfunctionBefore: () => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tif (!tokens.length) return false;\r\n\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst hasMultipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// More than one shield and no selection. Show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && !shieldActivated) {\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\t// More than one shield and one was previously selected. Remove selection and show tooltip.\r\n\t\t\t\t\tif (hasMultipleShields && shieldButton.dataset.shieldId) {\r\n\t\t\t\t\t\tshieldButton.attributes.removeNamedItem(\"data-shield-id\");\r\n\t\t\t\t\t\tshieldButton.classList.remove(\"shield-activated\");\r\n\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n\t\t\t\t\t\treturn true;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tconsole.log(\"end of before\", shieldButton);\r\n\t\t\t\t\t// Normal toggle behaviour. Tooltip is suppressed.\r\n\t\t\t\t\tshieldButton.classList.toggle(\"shield-activated\");\r\n\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle =\r\n\t\t\t\t\t\t!CONFIG.PF2E.chatDamageButtonShieldToggle;\r\n\t\t\t\t\treturn false;\r\n\t\t\t\t},\r\n\t\t\t\tfunctionFormat: (instance, _helper, contentEl) => {\r\n\t\t\t\t\tconst tokens = getTokens();\r\n\t\t\t\t\tconst nonBrokenShields = getNonBrokenShields(tokens);\r\n\t\t\t\t\tconst multipleShields =\r\n\t\t\t\t\t\ttokens.length === 1 && nonBrokenShields.length > 1;\r\n\t\t\t\t\tconst shieldActivated =\r\n\t\t\t\t\t\tshieldButton.classList.contains(\"shield-activated\");\r\n\r\n\t\t\t\t\t// If the actor is wielding more than one shield, have the user pick which shield to use for blocking.\r\n\t\t\t\t\tif (multipleShields && !shieldActivated) {\r\n\t\t\t\t\t\t// Populate the list with the shield options\r\n\t\t\t\t\t\tconst listEl = htmlQuery(contentEl, \"ul.shield-options\");\r\n\t\t\t\t\t\tif (!listEl) return $(contentEl);\r\n\r\n\t\t\t\t\t\tconst shieldList = nonBrokenShields.map((shield) => {\r\n\t\t\t\t\t\t\tconst input = document.createElement(\"input\");\r\n\t\t\t\t\t\t\tinput.classList.add(\"data\");\r\n\t\t\t\t\t\t\tinput.type = \"radio\";\r\n\t\t\t\t\t\t\tinput.name = \"shield-id\";\r\n\t\t\t\t\t\t\tinput.value = shield.id;\r\n\t\t\t\t\t\t\tinput.addEventListener(\"click\", () => {\r\n\t\t\t\t\t\t\t\tshieldButton.dataset.shieldId = input.value;\r\n\t\t\t\t\t\t\t\tshieldButton.classList.add(\"shield-activated\");\r\n\t\t\t\t\t\t\t\tCONFIG.PF2E.chatDamageButtonShieldToggle = true;\r\n\t\t\t\t\t\t\t\tinstance.close();\r\n\t\t\t\t\t\t\t});\r\n\t\t\t\t\t\t\tconst shieldName = document.createElement(\"span\");\r\n\t\t\t\t\t\t\tshieldName.classList.add(\"label\");\r\n\t\t\t\t\t\t\tshieldName.innerHTML = shield.name;\r\n\r\n\t\t\t\t\t\t\tconst hardness = document.createElement(\"span\");\r\n\t\t\t\t\t\t\thardness.classList.add(\"tag\");\r\n\t\t\t\t\t\t\tconst hardnessLabel = game.i18n.localize(\"PF2E.HardnessLabel\");\r\n\t\t\t\t\t\t\thardness.innerHTML = `${hardnessLabel}: ${shield.hardness}`;\r\n\r\n\t\t\t\t\t\t\tconst itemLi = document.createElement(\"li\");\r\n\t\t\t\t\t\t\titemLi.classList.add(\"item\");\r\n\t\t\t\t\t\t\titemLi.append(input, shieldName, hardness);\r\n\r\n\t\t\t\t\t\t\treturn itemLi;\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tlistEl.replaceChildren(...shieldList);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\treturn $(contentEl);\r\n\t\t\t\t},\r\n\t\t\t})\r\n\t\t\t.tooltipster(\"open\");\r\n\t}\r\n}\r\n\r\n/**\r\n * adapted to toggle multiple buttons\r\n * @param {string} messageId\r\n */\r\nexport function toggleOffShieldBlock(messageId) {\r\n\tconsole.trace(\"toggleOffShieldBlock\");\r\n\tfor (const app of [\"#chat-log\", \"#chat-popout\"]) {\r\n\t\tconst selector = `${app} > li.chat-message[data-message-id=\"${messageId}\"] button[data-action$=shield-block]`;\r\n\t\tfor (const button of document.body.querySelectorAll(selector)) {\r\n\t\t\tbutton?.classList.remove(\"shield-activated\");\r\n\t\t}\r\n\t}\r\n\tCONFIG.PF2E.chatDamageButtonShieldToggle = false;\r\n}\r\n\r\n/**\r\n * @param {object} options\r\n * @param {object} options.message\r\n * @param {number} options.multiplier\r\n * @param {number} options.rollIndex\r\n * @param {object[]} [options.tokens]\r\n * @param {OnDamageApplied} [options.onDamageApplied]\r\n */\r\nasync function shiftAdjustDamage({\r\n\tmessage,\r\n\tmultiplier,\r\n\trollIndex,\r\n\t// added\r\n\ttokens,\r\n\tonDamageApplied,\r\n}) {\r\n\tconst content = await renderTemplate(\r\n\t\t\"systems/pf2e/templates/chat/damage/adjustment-dialog.hbs\",\r\n\t);\r\n\tconst AdjustmentDialog = class extends Dialog {\r\n\t\tactivateListeners($html) {\r\n\t\t\tsuper.activateListeners($html);\r\n\t\t\t$html[0].querySelector(\"input\")?.focus();\r\n\t\t}\r\n\t};\r\n\tconst isHealing = multiplier < 0;\r\n\tnew AdjustmentDialog({\r\n\t\ttitle: game.i18n.localize(\r\n\t\t\tisHealing\r\n\t\t\t\t? \"PF2E.UI.shiftModifyHealingTitle\"\r\n\t\t\t\t: \"PF2E.UI.shiftModifyDamageTitle\",\r\n\t\t),\r\n\t\tcontent,\r\n\t\tbuttons: {\r\n\t\t\tok: {\r\n\t\t\t\tlabel: game.i18n.localize(\"PF2E.OK\"),\r\n\t\t\t\tcallback: async ($dialog) => {\r\n\t\t\t\t\t// In case of healing, multipler will have negative sign. The user will expect that positive\r\n\t\t\t\t\t// modifier would increase healing value, while negative would decrease.\r\n\t\t\t\t\tconst adjustment =\r\n\t\t\t\t\t\t(Number($dialog[0].querySelector(\"input\")?.value) || 0) *\r\n\t\t\t\t\t\tMath.sign(multiplier);\r\n\t\t\t\t\tapplyDamageFromMessage({\r\n\t\t\t\t\t\tmessage,\r\n\t\t\t\t\t\tmultiplier,\r\n\t\t\t\t\t\taddend: adjustment,\r\n\t\t\t\t\t\tpromptModifier: false,\r\n\t\t\t\t\t\trollIndex,\r\n\t\t\t\t\t\t// added\r\n\t\t\t\t\t\ttokens,\r\n\t\t\t\t\t\tonDamageApplied,\r\n\t\t\t\t\t});\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tcancel: {\r\n\t\t\t\tlabel: \"Cancel\",\r\n\t\t\t},\r\n\t\t},\r\n\t\tdefault: \"ok\",\r\n\t\tclose: () => {\r\n\t\t\ttoggleOffShieldBlock(message.id);\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "/**\r\n * @returns { new (...args: unknkown[]) => object}\r\n */\r\nexport function getDamageRollClass() {\r\n\treturn CONFIG.Dice.rolls.find((Roll) => Roll.name === \"DamageRoll\");\r\n}\r\n", "export const HANDWRAPS_SLUG = \"handwraps-of-mighty-blows\";\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function canBeInvested(item) {\r\n\treturn item.traits.has(\"invested\");\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function hasWornSlot(item) {\r\n\treturn item.system.equipped.inSlot != null;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nfunction isWornAs(item) {\r\n\treturn item.system.usage.type === \"worn\" && item.system.equipped.inSlot;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isInvestedOrWornAs(item) {\r\n\treturn item.isInvested || isWornAs(item);\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHeld(item) {\r\n\treturn item.system.usage.type === \"held\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isTwoHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-two-hands\";\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isOneHanded(item) {\r\n\treturn isHeld(item) && item.system.usage.value === \"held-in-one-hand\";\r\n}\r\n\r\n/**\r\n * @tempate T\r\n * @param {object} item\r\n * @param {T} value\r\n * @returns {T|undefined}\r\n */\r\nfunction inSlotValue(item, value) {\r\n\tconst usage = item.system.usage;\r\n\treturn usage.type === \"worn\" && usage.where ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {boolean} [invest]\r\n * @returns {boolean|undefined}\r\n */\r\nfunction toggleInvestedValue(item, invest) {\r\n\tconst value = invest ?? !item.system.equipped.invested;\r\n\treturn item.traits.has(\"invested\") ? value : undefined;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @param {object} options\r\n * @param {string} [options.carryType]\r\n * @param {number} [options.handsHeld]\r\n * @param {boolean} [options.inSlot]\r\n * @param {boolean} [options.invested]\r\n * @param {string|null} [options.containerId]\r\n * @returns {object}\r\n */\r\nexport function itemCarryUpdate(\r\n\titem,\r\n\t{ carryType = \"worn\", handsHeld = 0, inSlot, invested, containerId },\r\n) {\r\n\tconst update = {\r\n\t\t_id: item.id,\r\n\t\tsystem: {\r\n\t\t\tequipped: {\r\n\t\t\t\tcarryType: carryType,\r\n\t\t\t\thandsHeld: handsHeld,\r\n\t\t\t\tinSlot: inSlotValue(item, inSlot),\r\n\t\t\t\tinvested: toggleInvestedValue(item, invested),\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\r\n\tif (containerId !== undefined) {\r\n\t\tupdate.system.containerId = containerId;\r\n\t}\r\n\r\n\treturn update;\r\n}\r\n\r\n/**\r\n * @param {object} item\r\n * @returns {boolean}\r\n */\r\nexport function isHandwrapsOfMightyBlows(item) {\r\n\treturn (\r\n\t\titem.isOfType(\"weapon\") &&\r\n\t\titem.slug === HANDWRAPS_SLUG &&\r\n\t\titem.category === \"unarmed\"\r\n\t);\r\n}\r\n", "/**\r\n * @param {string} groupId\r\n * @returns {number|null}\r\n */\r\nexport function spellSlotGroupIdToNumber(groupId) {\r\n\tif (groupId === \"cantrips\") return 0;\r\n\tconst numericValue = Number(groupId ?? NaN);\r\n\treturn numericValue.between(0, 10) ? numericValue : null;\r\n}\r\n\r\n/**\r\n * @param {string} value\r\n * @returns {number|null}\r\n */\r\nexport function coerceToSpellGroupId(value) {\r\n\tif (value === \"cantrips\") return value;\r\n\tconst numericValue = Number(value) || NaN;\r\n\treturn numericValue.between(1, 10) ? numericValue : null;\r\n}\r\n", "const DEGREE_ADJUSTMENT_AMOUNTS = {\r\n\tLOWER_BY_TWO: -2,\r\n\tLOWER: -1,\r\n\tINCREASE: 1,\r\n\tINCREASE_BY_TWO: 2,\r\n\tTO_CRITICAL_FAILURE: \"criticalFailure\",\r\n\tTO_FAILURE: \"failure\",\r\n\tTO_SUCCESS: \"success\",\r\n\tTO_CRITICAL_SUCCESS: \"criticalSuccess\",\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS_STRINGS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\n/**\r\n * @class\r\n * @constructor\r\n */\r\nexport class DegreeOfSuccess {\r\n\t/**\r\n\t * @param {{dieResult: number, rollTotal: number}} roll\r\n\t * @param {number|{value: number}} dc\r\n\t * @param {object|null} [dosAdjustments]\r\n\t */\r\n\tconstructor(roll, dc, dosAdjustments = null) {\r\n\t\tif (roll instanceof Roll) {\r\n\t\t\tthis.dieResult =\r\n\t\t\t\t(roll.isDeterministic\r\n\t\t\t\t\t? roll.terms.find((t) => t instanceof NumericTerm)\r\n\t\t\t\t\t: roll.dice.find((d) => d instanceof Die && d.faces === 20)\r\n\t\t\t\t)?.total ?? 1;\r\n\t\t\tthis.rollTotal = roll.total;\r\n\t\t} else {\r\n\t\t\tthis.dieResult = roll.dieValue;\r\n\t\t\tthis.rollTotal = roll.dieValue + roll.modifier;\r\n\t\t}\r\n\r\n\t\tthis.dc = typeof dc === \"number\" ? { value: dc } : dc;\r\n\r\n\t\tthis.unadjusted = this.#calculateDegreeOfSuccess();\r\n\t\tthis.adjustment = this.#getDegreeAdjustment(\r\n\t\t\tthis.unadjusted,\r\n\t\t\tdosAdjustments,\r\n\t\t);\r\n\t\t/**\r\n\t\t * @type {0|1|2|3}\r\n\t\t */\r\n\t\tthis.value = this.adjustment\r\n\t\t\t? this.#adjustDegreeOfSuccess(this.adjustment.amount, this.unadjusted)\r\n\t\t\t: this.unadjusted;\r\n\t}\r\n\r\n\tstatic CRITICAL_FAILURE = 0;\r\n\tstatic FAILURE = 1;\r\n\tstatic SUCCESS = 2;\r\n\tstatic CRITICAL_SUCCESS = 3;\r\n\r\n\t#getDegreeAdjustment(degree, adjustments) {\r\n\t\tif (!adjustments) return null;\r\n\r\n\t\tfor (const outcome of [\"all\", ...DEGREE_OF_SUCCESS_STRINGS]) {\r\n\t\t\tconst { label, amount } = adjustments[outcome] ?? {};\r\n\t\t\tif (\r\n\t\t\t\tamount &&\r\n\t\t\t\tlabel &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_SUCCESS &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.INCREASE\r\n\t\t\t\t) &&\r\n\t\t\t\t!(\r\n\t\t\t\t\tdegree === DegreeOfSuccess.CRITICAL_FAILURE &&\r\n\t\t\t\t\tamount === DEGREE_ADJUSTMENT_AMOUNTS.LOWER\r\n\t\t\t\t) &&\r\n\t\t\t\t(outcome === \"all\" ||\r\n\t\t\t\t\tDEGREE_OF_SUCCESS_STRINGS.indexOf(outcome) === degree)\r\n\t\t\t) {\r\n\t\t\t\treturn { label, amount };\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn null;\r\n\t}\r\n\r\n\t#adjustDegreeOfSuccess(amount, degreeOfSuccess) {\r\n\t\tswitch (amount) {\r\n\t\t\tcase \"criticalFailure\":\r\n\t\t\t\treturn 0;\r\n\t\t\tcase \"failure\":\r\n\t\t\t\treturn 1;\r\n\t\t\tcase \"success\":\r\n\t\t\t\treturn 2;\r\n\t\t\tcase \"criticalSuccess\":\r\n\t\t\t\treturn 3;\r\n\t\t\tdefault:\r\n\t\t\t\treturn Math.clamped(degreeOfSuccess + amount, 0, 3);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * @param degree The current success value\r\n\t * @return The new success value\r\n\t */\r\n\t#adjustDegreeByDieValue(degree) {\r\n\t\tif (this.dieResult === 20) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.INCREASE,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (this.dieResult === 1) {\r\n\t\t\treturn this.#adjustDegreeOfSuccess(\r\n\t\t\t\tDEGREE_ADJUSTMENT_AMOUNTS.LOWER,\r\n\t\t\t\tdegree,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn degree;\r\n\t}\r\n\r\n\t#calculateDegreeOfSuccess() {\r\n\t\tconst dc = this.dc.value;\r\n\r\n\t\tif (this.rollTotal - dc >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_SUCCESS);\r\n\t\t}\r\n\r\n\t\tif (dc - this.rollTotal >= 10) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.CRITICAL_FAILURE);\r\n\t\t}\r\n\r\n\t\tif (this.rollTotal >= dc) {\r\n\t\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.SUCCESS);\r\n\t\t}\r\n\r\n\t\treturn this.#adjustDegreeByDieValue(DegreeOfSuccess.FAILURE);\r\n\t}\r\n}\r\n", "/**\r\n * @param {unknown} measuredTemplate\r\n * @param {{collisionOrigin?: {x: number, y: number}, collisionType?: \"move\" | \"sight\"}} [options]\r\n * @returns {unknown[]}\r\n */\r\nexport function getTemplateTokens(\r\n\tmeasuredTemplate,\r\n\t{ collisionOrigin, collisionType = \"move\" } = {},\r\n) {\r\n\tconst template =\r\n\t\tmeasuredTemplate instanceof MeasuredTemplateDocument\r\n\t\t\t? measuredTemplate.object\r\n\t\t\t: measuredTemplate;\r\n\r\n\tif (!canvas.scene) return [];\r\n\tconst { grid, dimensions } = canvas;\r\n\tif (!(grid && dimensions)) return [];\r\n\r\n\tif (!template?.highlightId) return [];\r\n\r\n\tconst gridHighlight = grid.getHighlightLayer(template.highlightId);\r\n\tif (!gridHighlight || grid.type !== CONST.GRID_TYPES.SQUARE) return [];\r\n\tconst origin = collisionOrigin ?? template.center;\r\n\r\n\tconst tokens = canvas.tokens.quadtree.getObjects(\r\n\t\tgridHighlight.getLocalBounds(undefined, true),\r\n\t);\r\n\r\n\tconst gridSize = grid.size;\r\n\r\n\tconst containedTokens = [];\r\n\tfor (const token of tokens) {\r\n\t\tconst tokenDoc = token.document;\r\n\r\n\t\tconst tokenPositions = [];\r\n\t\tfor (let h = 0; h < tokenDoc.height; h++) {\r\n\t\t\tconst tokenX = Math.floor(token.x / gridSize) * gridSize;\r\n\t\t\tconst tokenY = Math.floor(token.y / gridSize) * gridSize;\r\n\r\n\t\t\tconst y = tokenY + h * gridSize;\r\n\t\t\ttokenPositions.push(`${tokenX}.${y}`);\r\n\t\t\tif (tokenDoc.width > 1) {\r\n\t\t\t\tfor (let w = 1; w < tokenDoc.width; w++) {\r\n\t\t\t\t\ttokenPositions.push(`${tokenX + w * gridSize}.${y}`);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor (const position of tokenPositions) {\r\n\t\t\tif (!gridHighlight.positions.has(position)) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tconst [gx, gy] = position.split(\".\").map((s) => Number(s));\r\n\t\t\tconst destination = {\r\n\t\t\t\tx: gx + dimensions.size * 0.5,\r\n\t\t\t\ty: gy + dimensions.size * 0.5,\r\n\t\t\t};\r\n\t\t\tif (destination.x < 0 || destination.y < 0) continue;\r\n\r\n\t\t\tconst hasCollision =\r\n\t\t\t\tcanvas.ready &&\r\n\t\t\t\tcollisionType &&\r\n\t\t\t\tCONFIG.Canvas.polygonBackends[collisionType].testCollision(\r\n\t\t\t\t\torigin,\r\n\t\t\t\t\tdestination,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\ttype: collisionType,\r\n\t\t\t\t\t\tmode: \"any\",\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\tif (!hasCollision) {\r\n\t\t\t\tcontainedTokens.push(token);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn containedTokens;\r\n}\r\n", "import { MODULE } from \"module-api\";\r\n\r\nexport function wrapperError(feature, path) {\r\n\tconsole.error(\r\n\t\t`an error occured in the feature '${feature}' of the module '${MODULE.id}' with the wrapper: '${path}'`,\r\n\t);\r\n}\r\n\r\nexport async function roll3dDice(\r\n\troll,\r\n\t{ user = game.user, synchronize = true } = {},\r\n) {\r\n\tif (!game.modules.get(\"dice-so-nice\")?.active) return;\r\n\treturn game.dice3d.showForRoll(roll, user, synchronize);\r\n}\r\n", "import { HANDWRAPS_SLUG, getSetting, info, registerWrapper } from \"module-api\";\r\nimport { wrapperError } from \"../misc\";\r\n\r\nconst PREPARE_WEAPON_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData\";\r\nconst PREPARE_WEAPON_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData\";\r\n\r\nconst PREPARE_ARMOR_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData\";\r\nconst PREPARE_ARMOR_DERIVED_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData\";\r\n\r\nexport function registerArp() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"auto-runes\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"force\", \"lower\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-arp\"],\r\n\t\tinit: () => {\r\n\t\t\tconst setting = getSetting(\"auto-runes\");\r\n\t\t\tif (setting === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(PREPARE_WEAPON_DATA, onPrepareWeaponData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_WEAPON_DERIVED_DATA,\r\n\t\t\t\tonPrepareWeaponDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tregisterWrapper(PREPARE_ARMOR_DATA, onPrepareArmorData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tPREPARE_ARMOR_DERIVED_DATA,\r\n\t\t\t\tonPrepareArmorDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tif (setting === \"force\") {\r\n\t\t\t\tHooks.on(\"renderPhysicalItemSheetPF2e\", renderPhysicalItemSheetPF2e);\r\n\t\t\t}\r\n\t\t},\r\n\t\tready: (isGM) => {\r\n\t\t\tif (\r\n\t\t\t\tisGM &&\r\n\t\t\t\tgetSetting(\"auto-runes\") !== \"disabled\" &&\r\n\t\t\t\tgame.settings.get(\"pf2e\", \"automaticBonusVariant\") !== \"noABP\"\r\n\t\t\t) {\r\n\t\t\t\tgame.settings.set(\"pf2e\", \"automaticBonusVariant\", \"noABP\");\r\n\t\t\t\tinfo(\"arp.forceVariant\");\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction isValidActor(actor, isCharacter = false) {\r\n\treturn (\r\n\t\tactor &&\r\n\t\t!actor.getFlag(\"pf2e\", \"disableABP\") &&\r\n\t\t(!isCharacter || actor.isOfType(\"character\"))\r\n\t);\r\n}\r\n\r\n/**\r\n * weapon\r\n */\r\n\r\nconst WEAPON_POTENCY_PRICE = {\r\n\t1: 35,\r\n\t2: 935,\r\n\t3: 8935,\r\n\t4: 8935,\r\n};\r\n\r\nconst WEAPON_STRIKING_PRICE = {\r\n\t1: 65,\r\n\t2: 1065,\r\n\t3: 31065,\r\n};\r\n\r\nfunction isShieldWeapon(weapon) {\r\n\treturn [\"shield-boss\", \"shield-spikes\"].includes(\r\n\t\tweapon._source.system.baseItem,\r\n\t);\r\n}\r\n\r\nfunction isValidWeapon(weapon) {\r\n\tconst traits = weapon._source.system.traits.value;\r\n\tconst { group, category, slug } = weapon._source.system;\r\n\r\n\tif (category === \"unarmed\" && slug !== HANDWRAPS_SLUG) {\r\n\t\treturn !!weapon.actor.itemTypes.weapon.find(\r\n\t\t\t(weapon) =>\r\n\t\t\t\tweapon.slug === HANDWRAPS_SLUG &&\r\n\t\t\t\tweapon.category === \"unarmed\" &&\r\n\t\t\t\tweapon.isEquipped &&\r\n\t\t\t\tweapon.isInvested,\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t(group !== \"shield\" || isShieldWeapon(weapon)) &&\r\n\t\t!traits.includes(\"alchemical\") &&\r\n\t\t!traits.includes(\"bomb\")\r\n\t);\r\n}\r\n\r\nfunction onPrepareWeaponData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidWeapon(this)) return wrapped();\r\n\r\n\t\tconst traits = this._source.system.traits.value;\r\n\t\tif (traits.includes(\"alchemical\") && traits.includes(\"bomb\"))\r\n\t\t\treturn wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 2 ? null : level < 10 ? 1 : level < 16 ? 2 : 3;\r\n\t\tconst expectedStriking =\r\n\t\t\tlevel < 4 ? null : level < 12 ? 1 : level < 19 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.striking <= expectedStriking || forceUpdate) {\r\n\t\t\tthis.system.runes.striking = expectedStriking;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareWeaponDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidWeapon(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= WEAPON_POTENCY_PRICE[potency];\r\n\r\n\t\tconst striking = this.system.runes.striking;\r\n\t\tif (striking) coins.gp -= WEAPON_STRIKING_PRICE[striking];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || striking) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_WEAPON_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * amor\r\n */\r\n\r\nconst ARMOR_POTENCY_PRICE = {\r\n\t1: 160,\r\n\t2: 1060,\r\n\t3: 20560,\r\n\t4: 20560,\r\n};\r\n\r\nconst ARMOR_RESILIENCY_PRICE = {\r\n\t1: 340,\r\n\t2: 3440,\r\n\t3: 49440,\r\n};\r\n\r\nfunction isValidArmor(armor) {\r\n\treturn true;\r\n}\r\n\r\nfunction onPrepareArmorData(wrapped) {\r\n\ttry {\r\n\t\tconst actor = this.actor;\r\n\t\tif (!isValidActor(actor, true) || !isValidArmor(this)) return wrapped();\r\n\r\n\t\tconst level = actor.level;\r\n\t\tconst forceUpdate = getSetting(\"auto-runes\") === \"force\";\r\n\r\n\t\tconst expectedPotency =\r\n\t\t\tlevel < 5 ? null : level < 11 ? 1 : level < 18 ? 2 : 3;\r\n\t\tconst expectedResilient =\r\n\t\t\tlevel < 8 ? null : level < 14 ? 1 : level < 20 ? 2 : 3;\r\n\r\n\t\tif (this.system.runes.potency <= expectedPotency || forceUpdate) {\r\n\t\t\tthis.system.runes.potency = expectedPotency;\r\n\t\t}\r\n\r\n\t\tif (this.system.runes.resilient <= expectedResilient || forceUpdate) {\r\n\t\t\tthis.system.runes.resilient = expectedResilient;\r\n\t\t}\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DATA);\r\n\t}\r\n\r\n\twrapped();\r\n}\r\n\r\nfunction onPrepareArmorDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!isValidActor(this.actor) || this.isSpecific || !isValidArmor(this))\r\n\t\t\treturn;\r\n\r\n\t\tlet coins = this.price.value.toObject();\r\n\t\tif (!coins.gp) return;\r\n\r\n\t\tconst potency = this.system.runes.potency;\r\n\t\tif (potency) coins.gp -= ARMOR_POTENCY_PRICE[potency];\r\n\r\n\t\tconst resiliency = this.system.runes.resilient;\r\n\t\tif (resiliency) coins.gp -= ARMOR_RESILIENCY_PRICE[resiliency];\r\n\r\n\t\tcoins = new game.pf2e.Coins(coins);\r\n\r\n\t\tif ((potency || resiliency) && !this.system.runes.property.length) {\r\n\t\t\tcoins = coins.plus(this._source.system.price.value);\r\n\t\t}\r\n\r\n\t\tthis.system.price.value = coins;\r\n\t} catch {\r\n\t\twrapperError(\"auto-runes\", PREPARE_ARMOR_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\n/**\r\n * item sheet\r\n */\r\n\r\nfunction renderPhysicalItemSheetPF2e(sheet, html) {\r\n\tconst item = sheet.item;\r\n\tif (\r\n\t\t!item ||\r\n\t\t!item.isOfType(\"weapon\", \"armor\") ||\r\n\t\t!isValidActor(item.actor, true)\r\n\t)\r\n\t\treturn;\r\n\r\n\tconst lookups = [\"potency\", \"striking\", \"resilient\"]\r\n\t\t.map((x) => `[name=\"system.runes.${x}\"]`)\r\n\t\t.join(\", \");\r\n\thtml.find(`[data-tab=details] fieldset .form-group:has(${lookups})`).hide();\r\n}\r\n", "import { getSetting } from \"module-api\";\r\n\r\nexport function createHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, otherSettings = [], skipCallback = false) => {\r\n\t\tconst others =\r\n\t\t\ttypeof otherSettings === \"string\" ? [otherSettings] : otherSettings;\r\n\t\tconst settingValue = value || others.some((s) => getSetting(s));\r\n\r\n\t\tif (settingValue && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t} else if (!settingValue && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(settingValue);\r\n\t};\r\n}\r\n\r\nexport function createChoicesHook(event, listener, callback = () => {}) {\r\n\tlet HOOK = null;\r\n\r\n\treturn (value, skipCallback = false) => {\r\n\t\tif (value === \"disabled\" && HOOK) {\r\n\t\t\tHooks.off(event, HOOK);\r\n\t\t\tHOOK = null;\r\n\t\t} else if (value !== \"disabled\" && !HOOK) {\r\n\t\t\tHOOK = Hooks.on(event, listener);\r\n\t\t}\r\n\r\n\t\tif (!skipCallback) callback(value);\r\n\t};\r\n}\r\n", "import { getSetting } from \"module-api\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst appHook = createHook(\"renderApplication\", onRender);\r\nconst actorHook = createHook(\"renderActorSheet\", onRender);\r\nconst itemHook = createHook(\"renderItemSheet\", onRender);\r\n\r\nexport function registerDebug() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"debug\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tconfig: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"debug\");\r\n\tappHook(enabled);\r\n\tactorHook(enabled);\r\n\titemHook(enabled);\r\n}\r\n\r\nfunction onRender(app, html) {\r\n\tconst link = html.find(\".document-id-link\")[0];\r\n\tif (!link) return;\r\n\r\n\tlink.addEventListener(\r\n\t\t\"click\",\r\n\t\t(event) => {\r\n\t\t\tif (!event.shiftKey) return;\r\n\r\n\t\t\tconst obj = app.object;\r\n\t\t\tif (!obj) return;\r\n\r\n\t\t\tevent.preventDefault();\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tconst type = obj.type;\r\n\r\n\t\t\tlet i = 2;\r\n\t\t\tlet variable = type;\r\n\t\t\twhile (window[variable]) {\r\n\t\t\t\tvariable = `${type}${i++}`;\r\n\t\t\t}\r\n\r\n\t\t\twindow[variable] = obj;\r\n\t\t\tconsole.log(variable, obj);\r\n\t\t},\r\n\t\ttrue,\r\n\t);\r\n}\r\n", "import { getSetting, localize } from \"module-api\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderEffectsPanel\",\r\n\trenderEffectsPanel,\r\n\trefreshEffectsPanel,\r\n);\r\n\r\nexport function registerEffectsPanelHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"effect-remove\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"condition-sheet\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"condition-sheet\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"effect-remove\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-effect-description\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHook(false, [\"effect-remove\", \"condition-sheet\"]);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction refreshEffectsPanel() {\r\n\tgame.pf2e.effectPanel?.render();\r\n}\r\n\r\nfunction renderEffectsPanel(panel, html) {\r\n\tconst removeRow = `<div>${localize(\"effects.remove\")}</div>`;\r\n\tconst editIcon = `<a data-action=\"edit\" data-tooltip=\"Edit Item\"><i class=\"fa-solid fa-fw fa-pencil\"></i></a>`;\r\n\r\n\tconst effectPanels = html.find(\".effect-item[data-item-id]\").toArray();\r\n\tfor (const effectPanel of effectPanels) {\r\n\t\tconst id = effectPanel.dataset.itemId;\r\n\t\tconst effect = panel.actor?.items.get(id);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tif (\r\n\t\t\tgetSetting(\"effect-remove\") &&\r\n\t\t\t!effect.isLocked &&\r\n\t\t\teffect.badge &&\r\n\t\t\teffect.badge.type === \"counter\"\r\n\t\t) {\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".effect-info .instructions\")\r\n\t\t\t\t.insertAdjacentHTML(\"beforeend\", removeRow);\r\n\t\t\teffectPanel\r\n\t\t\t\t.querySelector(\".icon\")\r\n\t\t\t\t.addEventListener(\r\n\t\t\t\t\t\"contextmenu\",\r\n\t\t\t\t\t(event) => onRemoveEffect(event, panel),\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (getSetting(\"condition-sheet\") && effect.isOfType(\"condition\")) {\r\n\t\t\tconst h1 = effectPanel.querySelector(\".effect-info > h1\");\r\n\t\t\th1.insertAdjacentHTML(\"beforeend\", editIcon);\r\n\t\t\th1.querySelector('[data-action=\"edit\"]').addEventListener(\r\n\t\t\t\t\"click\",\r\n\t\t\t\t(event) => onConditionSheet(event, panel),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction onConditionSheet(event, panel) {\r\n\tconst effect = getEffect(event, panel);\r\n\tif (!effect?.isOfType(\"condition\")) return;\r\n\tevent.preventDefault();\r\n\teffect.sheet.render(true);\r\n}\r\n\r\nfunction onRemoveEffect(event, panel) {\r\n\tif (!event.shiftKey) return;\r\n\r\n\tconst effect = getEffect(event, panel);\r\n\tif (\r\n\t\t!effect ||\r\n\t\teffect.isLocked ||\r\n\t\t!effect.badge ||\r\n\t\teffect.badge.type !== \"counter\"\r\n\t)\r\n\t\treturn;\r\n\r\n\tevent.preventDefault();\r\n\tevent.stopPropagation();\r\n\tevent.stopImmediatePropagation();\r\n\r\n\teffect.delete();\r\n}\r\n\r\nfunction getEffect(event, panel) {\r\n\tconst target = event.currentTarget;\r\n\tconst effect = target.closest(\".effect-item[data-item-id]\");\r\n\tconst id = effect.dataset.itemId;\r\n\treturn panel.actor?.items.get(id);\r\n}\r\n", "import {\r\n\tgetInMemory,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetInMemory,\r\n\tunregisterWrapper,\r\n} from \"module-api\";\r\n\r\nconst sheetTabsRegistered = {\r\n\twrapperIds: [],\r\n\ttabs: new Collection(),\r\n};\r\n\r\nconst preparedEmbeddedRegistered = {\r\n\twrapperIds: [],\r\n\tlisteners: new Map(),\r\n};\r\n\r\nconst ACTOR_PREPARE_EMBEDDED_DOCUMENTS =\r\n\t\"CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments\";\r\n\r\nconst CHARACTER_SHEET_INNER_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner\";\r\nconst CHARACTER_SHEET_RENDER =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render\";\r\nconst CHARACTER_SHEET_ACTIVE_LISTENERS =\r\n\t\"CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners\";\r\n\r\nexport function isPlayedActor(actor) {\r\n\treturn actor && !actor.pack && actor.id && game.actors.has(actor.id);\r\n}\r\n\r\nexport function registerActorPreparedEmbeddedDocuments(feature, listener) {\r\n\tif (!preparedEmbeddedRegistered.wrapperIds.length) {\r\n\t\tpreparedEmbeddedRegistered.wrapperIds = [\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tACTOR_PREPARE_EMBEDDED_DOCUMENTS,\r\n\t\t\t\tactorPrepareEmbeddedDocuments,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t),\r\n\t\t];\r\n\t}\r\n\tpreparedEmbeddedRegistered.listeners.set(feature, listener);\r\n}\r\n\r\nexport function registerCharacterSheetExtraTab(options) {\r\n\tif (!sheetTabsRegistered.wrapperIds.length) {\r\n\t\tsheetTabsRegistered.wrapperIds = [\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_RENDER, characterSheetRender),\r\n\t\t\tregisterWrapper(CHARACTER_SHEET_INNER_RENDER, characterSheetInnerRender),\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tCHARACTER_SHEET_ACTIVE_LISTENERS,\r\n\t\t\t\tcharacterSheetActiveListeners,\r\n\t\t\t),\r\n\t\t];\r\n\t}\r\n\tsheetTabsRegistered.tabs.set(options.tabName, options);\r\n}\r\n\r\nexport function unregisterCharacterSheetExtraTab(tabName) {\r\n\tsheetTabsRegistered.tabs.delete(tabName);\r\n\tif (sheetTabsRegistered.wrapperIds.length && !sheetTabsRegistered.tabs.size) {\r\n\t\tfor (const wrapperId of sheetTabsRegistered.wrapperIds) {\r\n\t\t\tunregisterWrapper(wrapperId);\r\n\t\t}\r\n\t\tsheetTabsRegistered.wrapperIds = [];\r\n\t}\r\n}\r\n\r\nfunction actorPrepareEmbeddedDocuments(wrapped, ...args) {\r\n\twrapped(...args);\r\n\r\n\tfor (const [feature, listener] of preparedEmbeddedRegistered.listeners) {\r\n\t\ttry {\r\n\t\t\tlistener.call(this);\r\n\t\t} catch {\r\n\t\t\twrapperError(feature, ACTOR_PREPARE_EMBEDDED_DOCUMENTS);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nasync function characterSheetRender(wrapped, ...args) {\r\n\tconst positions = {};\r\n\r\n\tfor (const { tabName } of sheetTabsRegistered.tabs) {\r\n\t\tconst existingTab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst existingAlternate = existingTab.find(\".alternate\")[0];\r\n\t\tif (!existingAlternate) continue;\r\n\t\tpositions[tabName] = existingAlternate.scrollTop;\r\n\t}\r\n\r\n\tawait wrapped(...args);\r\n\r\n\tfor (const { tabName } of sheetTabsRegistered.tabs) {\r\n\t\tconst oldPosition = positions[tabName];\r\n\t\tif (!oldPosition) continue;\r\n\r\n\t\tconst tab = getCharacterSheetTab(this.element, tabName);\r\n\t\tconst alternate = tab.find(\".alternate\")[0];\r\n\t\talternate.scrollTop = positions[tabName];\r\n\t}\r\n}\r\n\r\nasync function characterSheetInnerRender(wrapped, data) {\r\n\tconst inner = await wrapped(data);\r\n\tconst actor = this.actor;\r\n\r\n\tif (!sheetTabsRegistered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn inner;\r\n\t}\r\n\r\n\tconst element = this.element;\r\n\r\n\tfor (const {\r\n\t\ttabName,\r\n\t\tgetData,\r\n\t\ttemplateFolder,\r\n\t\tonRender,\r\n\t} of sheetTabsRegistered.tabs) {\r\n\t\tconst innerTab = getCharacterSheetTab(inner, tabName);\r\n\r\n\t\tconst tabData = await getData(\r\n\t\t\tactor,\r\n\t\t\tthis,\r\n\t\t\tgetCharacterSheetTab(element, tabName),\r\n\t\t);\r\n\r\n\t\tconst template = await render(templateFolder, tabData);\r\n\r\n\t\tif (onRender) {\r\n\t\t\tawait onRender(actor, this, inner);\r\n\t\t}\r\n\r\n\t\tif (getInMemory(this, `${tabName}.toggled`)) {\r\n\t\t\tinnerTab.addClass(\"toggled\");\r\n\t\t}\r\n\r\n\t\tinnerTab.children(\":last\").before(template);\r\n\t}\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction characterSheetActiveListeners(wrapped, inner) {\r\n\twrapped(inner);\r\n\r\n\tconst actor = this.actor;\r\n\r\n\tif (!sheetTabsRegistered.tabs.size || !isPlayedActor(actor)) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const { tabName, addEvents } of sheetTabsRegistered.tabs) {\r\n\t\tinner\r\n\t\t\t.find(`nav.sheet-navigation .item[data-tab=${tabName}]`)\r\n\t\t\t.on(\"click\", (event) =>\r\n\t\t\t\tonCharacterSheetTabBtnToggle(event, inner, this, tabName),\r\n\t\t\t);\r\n\r\n\t\tconst tab = getCharacterSheetTab(inner, tabName);\r\n\t\taddEvents(tab.find(\"> .alternate\"), this, actor, inner);\r\n\t}\r\n}\r\n\r\nexport function getCharacterSheetTab(html, tabName) {\r\n\treturn html.find(\r\n\t\t`section.sheet-body .sheet-content > .tab[data-tab=${tabName}]`,\r\n\t);\r\n}\r\n\r\nfunction onCharacterSheetTabBtnToggle(event, html, sheet, tabName) {\r\n\tevent.preventDefault();\r\n\r\n\tconst tab = getCharacterSheetTab(html, tabName);\r\n\r\n\tif (tab.hasClass(\"active\")) {\r\n\t\ttab.toggleClass(\"toggled\");\r\n\t\ttab.scrollTop(0);\r\n\t\tsetInMemory(sheet, `${tabName}.toggled`, tab.hasClass(\"toggled\"));\r\n\t}\r\n}\r\n", "export class MoveLootPopup extends FormApplication {\r\n\tconstructor(object, options, callback) {\r\n\t\tsuper(object, options);\r\n\t\tthis.onSubmitCallback = callback;\r\n\t}\r\n\r\n\tasync getData() {\r\n\t\tconst [prompt, buttonLabel] = this.options.isPurchase\r\n\t\t\t? [\"PF2E.loot.PurchaseLootMessage\", \"PF2E.loot.PurchaseLoot\"]\r\n\t\t\t: [\"PF2E.loot.MoveLootMessage\", \"PF2E.loot.MoveLoot\"];\r\n\r\n\t\treturn {\r\n\t\t\t...(await super.getData()),\r\n\t\t\tmaxQuantity: this.options.maxQuantity,\r\n\t\t\tnewStack: this.options.newStack,\r\n\t\t\tlockStack: this.options.lockStack,\r\n\t\t\tprompt,\r\n\t\t\tbuttonLabel,\r\n\t\t};\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn {\r\n\t\t\t...FormApplication.defaultOptions,\r\n\t\t\tid: \"MoveLootPopup\",\r\n\t\t\tclasses: [],\r\n\t\t\ttitle: game.i18n.localize(\"PF2E.loot.MoveLootPopupTitle\"),\r\n\t\t\ttemplate: \"systems/pf2e/templates/popups/loot/move-loot-popup.hbs\",\r\n\t\t\twidth: \"auto\",\r\n\t\t\tmaxQuantity: 1,\r\n\t\t\tnewStack: false,\r\n\t\t\tlockStack: false,\r\n\t\t\tisPurchase: false,\r\n\t\t};\r\n\t}\r\n\r\n\tasync _updateObject(_event, formData) {\r\n\t\tthis.onSubmitCallback(formData.quantity, formData.newStack);\r\n\t}\r\n}\r\n", "import { MODULE, socketEmit } from \"module-api\";\r\n\r\n/**\r\n * @typedef {import('module-api').ModulePacket} ModulePacket\r\n * @typedef {import('module-api').ModuleSocketFunction} ModuleSocketFunction\r\n *\r\n * @type {Record<string, {listener: ModuleSocketFunction, active: boolean}>}\r\n */\r\nconst registeredSockets = {};\r\n\r\n/**\r\n * @type {ModuleSocketFunction}\r\n */\r\nexport function onSocket(packet, senderId) {\r\n\tconst user = game.user;\r\n\tif (user.id === senderId) return;\r\n\r\n\tconst registered = registeredSockets[packet.key];\r\n\tif (!registered?.active) return;\r\n\r\n\tregistered.listener(packet, senderId);\r\n}\r\n\r\n/**\r\n * @param {string} key\r\n * @param {ModuleSocketFunction} listener\r\n */\r\nexport function registerSocket(key, listener) {\r\n\tif (registeredSockets[key]) {\r\n\t\tMODULE.error(\r\n\t\t\t`a socket listener with the key '${key}' has already been registered`,\r\n\t\t);\r\n\t}\r\n\r\n\tregisteredSockets[key] = { listener, active: false };\r\n\r\n\treturn {\r\n\t\temit: (packet) => {\r\n\t\t\tpacket.key = key;\r\n\t\t\tsocketEmit(packet);\r\n\t\t},\r\n\t\tactivate: () => {\r\n\t\t\tregisteredSockets[key].active = true;\r\n\t\t},\r\n\t\tdisable: () => {\r\n\t\t\tregisteredSockets[key].active = false;\r\n\t\t},\r\n\t\ttoggle: (enabled) => {\r\n\t\t\tregisteredSockets[key].active = enabled ?? !registeredSockets[key].active;\r\n\t\t},\r\n\t};\r\n}\r\n", "import {\r\n\tchatUUID,\r\n\tgetSetting,\r\n\tisGMOnline,\r\n\tlocalize,\r\n\tregisterUpstreamHook,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor\";\r\nimport { MoveLootPopup } from \"../apps/giveth/popup\";\r\nimport { registerSocket } from \"../socket\";\r\n\r\nlet enabled = false;\r\nlet CANVAS_HOOK = null;\r\n\r\nconst socket = registerSocket(\"giveth\", onSocket);\r\n\r\nexport function registerGiveth() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"giveth\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"no-message\"],\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-giveth\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (getSetting(\"giveth\") !== \"disabled\") setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tif (value === \"disabled\" && enabled) {\r\n\t\tif (isGM) {\r\n\t\t\tsocket.disable();\r\n\t\t} else if (CANVAS_HOOK) {\r\n\t\t\tHooks.off(\"dropCanvasData\", CANVAS_HOOK);\r\n\t\t\tCANVAS_HOOK = null;\r\n\t\t}\r\n\t\tenabled = false;\r\n\t} else if (value !== \"disabled\" && !enabled) {\r\n\t\tif (isGM) {\r\n\t\t\tsocket.activate();\r\n\t\t} else if (!CANVAS_HOOK) {\r\n\t\t\tCANVAS_HOOK = registerUpstreamHook(\"dropCanvasData\", onDropCanvasData);\r\n\t\t}\r\n\t\tenabled = true;\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (packet.type === \"giveth-condition\") takethCondition(packet);\r\n\telse if (packet.type === \"giveth-effect\") takethEffect(packet);\r\n\telse takethPhysical(packet);\r\n}\r\n\r\nfunction onDropCanvasData(canvas, data) {\r\n\tif (!isGMOnline()) return true;\r\n\r\n\tconst details = getDetailsFromData(data);\r\n\tif (!details) return true;\r\n\r\n\tconst target = canvas.tokens.placeables\r\n\t\t.slice()\r\n\t\t.filter((token) => {\r\n\t\t\tif (!token.document.actorLink) return false;\r\n\t\t\tconst target = token.actor;\r\n\t\t\tif (!isValidActor(target, data.actorId) || target.isOwner) return false;\r\n\t\t\tconst maximumX = token.x + (token.hitArea?.right ?? 0);\r\n\t\t\tconst maximumY = token.y + (token.hitArea?.bottom ?? 0);\r\n\t\t\treturn (\r\n\t\t\t\tdata.x >= token.x &&\r\n\t\t\t\tdata.y >= token.y &&\r\n\t\t\t\tdata.x <= maximumX &&\r\n\t\t\t\tdata.y <= maximumY\r\n\t\t\t);\r\n\t\t})\r\n\t\t.sort((a, b) => b.document.sort - a.document.sort)\r\n\t\t.at(0)?.actor;\r\n\r\n\tif (!target) return true;\r\n\r\n\tgiveth(details.actor, target, details.item, details.value);\r\n\treturn false;\r\n}\r\n\r\nfunction giveth(origin, target, item, value) {\r\n\tconst ownerId = origin.id;\r\n\tconst targetId = target.id;\r\n\tconst isIndex = !(item instanceof Item);\r\n\r\n\tif (!isIndex && item.isOfType(\"physical\")) {\r\n\t\tconst qty = item.quantity;\r\n\t\tif (qty < 1) return warn(\"giveth.notification.zero\");\r\n\r\n\t\tif (qty === 1)\r\n\t\t\treturn sendPhysicalRequest(ownerId, targetId, item.id, 1, false);\r\n\r\n\t\tnew MoveLootPopup(\r\n\t\t\torigin,\r\n\t\t\t{ maxQuantity: qty, lockStack: false, isPurchase: false },\r\n\t\t\t(qty, stack) => {\r\n\t\t\t\tsendPhysicalRequest(ownerId, targetId, item.id, qty, stack);\r\n\t\t\t},\r\n\t\t).render(true);\r\n\t} else {\r\n\t\tconst uuid = isIndex ? `Compendium.${item.pack}.${item._id}` : item.uuid;\r\n\t\tif (item.type === \"condition\") {\r\n\t\t\tsocket.emit({\r\n\t\t\t\ttype: \"giveth-condition\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tvalue: value ?? 1,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t} else {\r\n\t\t\tsocket.emit({\r\n\t\t\t\ttype: \"giveth-effect\",\r\n\t\t\t\ttargetId,\r\n\t\t\t\tuuid,\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction sendPhysicalRequest(ownerId, targetId, itemId, qty, stack) {\r\n\tsocket.emit({\r\n\t\ttype: \"giveth-physical\",\r\n\t\townerId,\r\n\t\ttargetId,\r\n\t\titemId,\r\n\t\tqty,\r\n\t\tstack,\r\n\t});\r\n}\r\n\r\nfunction isValidActor(actor, id) {\r\n\tif (!isPlayedActor(actor) || (id && actor.id === id)) return false;\r\n\treturn (\r\n\t\tactor.hasPlayerOwner &&\r\n\t\t!actor.isToken &&\r\n\t\tactor.isOfType(\"character\", \"npc\", \"vehicle\")\r\n\t);\r\n}\r\n\r\nfunction getDetailsFromData(data) {\r\n\tif (data.tokenId || data.type !== \"Item\" || !data.uuid) return;\r\n\r\n\tconst item = fromUuidSync(data.uuid);\r\n\tif (!item) return;\r\n\r\n\tlet actor = item.actor;\r\n\tif (!actor) {\r\n\t\tconst actorUUID = data.context?.origin.actor;\r\n\t\tactor = actorUUID ? fromUuidSync(actorUUID) : null;\r\n\t}\r\n\r\n\tif (!isValidActor(actor) || !actor.isOwner) return;\r\n\r\n\tconst isIndex = !(item instanceof Item);\r\n\tif (isIndex && item.pack && [\"effect\", \"condition\"].includes(item.type))\r\n\t\treturn { actor, item, value: data.value };\r\n\tif (!isIndex && item.isOfType(\"physical\", \"effect\"))\r\n\t\treturn { actor, item, value: data.value };\r\n}\r\n\r\nasync function takethCondition({ targetId, uuid, value }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\ttarget.increaseCondition(item.slug, { min: value });\r\n}\r\n\r\nasync function takethEffect({ targetId, uuid }) {\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!target) return;\r\n\r\n\tconst item = await fromUuid(uuid);\r\n\tif (!item) return;\r\n\r\n\tconst source = item\r\n\t\t.clone({ \"system.tokenIcon.show\": true, \"system.unidentified\": false })\r\n\t\t.toObject();\r\n\ttarget.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n\r\nasync function takethPhysical({ itemId, ownerId, qty, stack, targetId }) {\r\n\tconst owner = game.actors.get(ownerId);\r\n\tconst target = game.actors.get(targetId);\r\n\tif (!owner || !target) return;\r\n\r\n\tconst item = owner.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tqty = Math.min(qty, item.quantity);\r\n\tconst newQty = item.quantity - qty;\r\n\r\n\tconst source = item.toObject();\r\n\tsource.system.quantity = qty;\r\n\tsource.system.equipped.carryType = \"worn\";\r\n\tif (item.isOfType(\"physical\") && \"invested\" in source.system.equipped) {\r\n\t\tsource.system.equipped.invested = item.traits.has(\"invested\")\r\n\t\t\t? false\r\n\t\t\t: null;\r\n\t}\r\n\r\n\tconst newItem = await target.addToInventory(source, undefined, stack);\r\n\tif (!newItem) return;\r\n\r\n\tif (newQty < 1) item.delete();\r\n\telse item.update({ \"system.quantity\": newQty });\r\n\r\n\tif (getSetting(\"giveth\") === \"no-message\") return;\r\n\r\n\tlet content = chatUUID(newItem.uuid, newItem.name, !newItem.isIdentified);\r\n\tif (qty > 1) content += ` x${qty}`;\r\n\r\n\tconst giveth = localize(\"giveth.giveth\", {\r\n\t\ttarget: target.name,\r\n\t});\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${giveth}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: owner }),\r\n\t});\r\n}\r\n", "import { getOwner, subLocalize, templatePath } from \"module-api\";\r\nimport { getHeroActions, sendTradeRequest } from \"../../features/hero\";\r\n\r\nconst localize = subLocalize(\"hero.templates.trade\");\r\n\r\nexport class Trade extends Application {\r\n\tconstructor(actor) {\r\n\t\tsuper({ id: `pf2e-hero-actions-trade-${actor.id}` });\r\n\t\tthis._actor = actor;\r\n\t}\r\n\r\n\tstatic get defaultOptions() {\r\n\t\treturn mergeObject(Application.defaultOptions, {\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\ttemplate: templatePath(\"hero/trade\"),\r\n\t\t\twidth: 600,\r\n\t\t\theight: \"auto\",\r\n\t\t});\r\n\t}\r\n\r\n\tget actor() {\r\n\t\treturn this._actor;\r\n\t}\r\n\r\n\tget target() {\r\n\t\treturn this._target;\r\n\t}\r\n\r\n\tset target(value) {\r\n\t\tif (!value) {\r\n\t\t\tlocalize.error(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (value === this._target) return;\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t\tthis._target = value;\r\n\t\tthis.render();\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(), {\r\n\t\t\tactor: this.actor,\r\n\t\t\ttarget: this.target,\r\n\t\t\ttargets: game.actors.filter(\r\n\t\t\t\t(x) =>\r\n\t\t\t\t\tx.type === \"character\" && x.id !== this.actor.id && x.hasPlayerOwner,\r\n\t\t\t),\r\n\t\t\tactions: getHeroActions(this.actor),\r\n\t\t\ttargetActions: this.target ? getHeroActions(this.target) : [],\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\tsuper.activateListeners(html);\r\n\t\thtml\r\n\t\t\t.find('select[name=\"target\"]')\r\n\t\t\t.on(\"change\", this.#onChangeTarget.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"description\"]')\r\n\t\t\t.on(\"click\", this.#onDescription.bind(this));\r\n\t\thtml\r\n\t\t\t.find('[data-action=\"trade\"]')\r\n\t\t\t.on(\"click\", this.#onSendTrade.bind(this));\r\n\t\thtml.find('[data-action=\"cancel\"]').on(\"click\", () => this.close());\r\n\t}\r\n\r\n\trender(force, options) {\r\n\t\tthis.actor.apps[this.appId] = this;\r\n\t\tif (this.target) this.target.apps[this.appId] = this;\r\n\t\treturn super.render(force, options);\r\n\t}\r\n\r\n\tasync close(options) {\r\n\t\tawait super.close(options);\r\n\t\tdelete this.actor.apps?.[this.appId];\r\n\t\tdelete this.target?.apps?.[this.appId];\r\n\t}\r\n\r\n\t#onSendTrade() {\r\n\t\tif (!this.target) {\r\n\t\t\tlocalize.warn(\"no-target\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst action = this.element.find('[name=\"action\"]:checked').val();\r\n\t\tconst target = this.element.find('[name=\"targetAction\"]:checked').val();\r\n\r\n\t\tif (typeof action !== \"string\" || typeof target !== \"string\") {\r\n\t\t\tlocalize.warn(\"no-select\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst user = getOwner(this.target) ?? game.users.activeGM;\r\n\r\n\t\tif (!user) {\r\n\t\t\tlocalize.warn(\"no-user\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tsendTradeRequest({\r\n\t\t\tsender: {\r\n\t\t\t\tid: game.user.id,\r\n\t\t\t\tcid: this.actor.id,\r\n\t\t\t\tuuid: action,\r\n\t\t\t},\r\n\t\t\treceiver: {\r\n\t\t\t\tid: user.id,\r\n\t\t\t\tcid: this.target.id,\r\n\t\t\t\tuuid: target,\r\n\t\t\t},\r\n\t\t});\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\tasync #onDescription(event) {\r\n\t\tconst uuid = $(event.currentTarget).siblings(\"input\").val();\r\n\t\tconst entry = await fromUuid(uuid);\r\n\t\tentry?.sheet.render(true);\r\n\t}\r\n\r\n\t#onChangeTarget(event) {\r\n\t\tconst id = event.currentTarget.value;\r\n\t\tthis.target = game.actors.get(id);\r\n\t}\r\n}\r\n", "import {\r\n\tchatUUID,\r\n\terror,\r\n\tgetSetting,\r\n\tisActiveGM,\r\n\tlocalize,\r\n\trefreshCharacterSheets,\r\n\trender,\r\n\tsetSetting,\r\n\tsubLocalize,\r\n\ttemplatePath,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor\";\r\nimport { Trade } from \"../apps/hero/trade\";\r\nimport { createHook } from \"../hooks\";\r\nimport { registerSocket } from \"../socket\";\r\n\r\nconst MODULE_ID = \"pf2e-hero-actions\";\r\n\r\nconst socket = registerSocket(\"hero-action\", onSocket);\r\n\r\nconst setHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n\tsetupSocket,\r\n);\r\n\r\nconst JOURNAL_UUID = \"Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko\";\r\nconst TABLE_UUID = \"Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK\";\r\n\r\nconst TABLE_ICON = \"systems/pf2e/icons/features/feats/heroic-recovery.webp\";\r\n\r\nexport function registerHeroActions() {\r\n\treturn {\r\n\t\tname: \"heroActions\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"hero\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"hero-table\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"\",\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"hero-trade\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: () => refreshCharacterSheets(),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"hero-private\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [MODULE_ID],\r\n\t\tapi: {\r\n\t\t\tcreateTable,\r\n\t\t\tremoveHeroActions,\r\n\t\t\tgetHeroActions,\r\n\t\t\tuseHeroAction,\r\n\t\t\tgetHeroActionDetails,\r\n\t\t\tdrawHeroAction,\r\n\t\t\tdrawHeroActions,\r\n\t\t\tsendActionToChat,\r\n\t\t\tdiscardHeroActions,\r\n\t\t\ttradeHeroAction,\r\n\t\t\tgetDeckTable,\r\n\t\t\tgiveHeroActions,\r\n\t\t\tcreateChatMessage,\r\n\t\t},\r\n\t\tready: () => {\r\n\t\t\tsetHook(false, \"hero\");\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setupSocket(value) {\r\n\tsocket.toggle(value);\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tswitch (packet.type) {\r\n\t\tcase \"hero.trade-reject\":\r\n\t\t\tif (packet.sender.id !== game.user.id) return;\r\n\t\t\tonTradeRejected(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-accept\":\r\n\t\t\tif (!isActiveGM()) return;\r\n\t\t\tonTradeAccepted(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-request\":\r\n\t\t\tif (packet.receiver.id !== game.user.id) return;\r\n\t\t\tonTradeRequest(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"hero.trade-error\":\r\n\t\t\tif (!packet.users.includes(game.user.id)) return;\r\n\t\t\tonTradeError(packet.error);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tawait addActionsToSheet(html, actor);\r\n\taddSheetEvents(html, actor);\r\n}\r\n\r\nasync function addActionsToSheet(html, actor) {\r\n\tconst actions = getHeroActions(actor);\r\n\tconst diff = actor.heroPoints.value - actions.length;\r\n\tconst isOwner = actor.isOwner;\r\n\tconst localize = subLocalize(\"hero.templates.heroActions\");\r\n\r\n\tconst template = await render(\"hero/sheet\", {\r\n\t\towner: isOwner,\r\n\t\tlist: actions,\r\n\t\tcanUse: diff >= 0 && isOwner,\r\n\t\tcanDraw: diff > 0 && isOwner,\r\n\t\tcanTrade: getSetting(\"hero-trade\"),\r\n\t\tmustDiscard: diff < 0,\r\n\t\tdiff: Math.abs(diff),\r\n\t\ti18n: localize.template,\r\n\t});\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)\",\r\n\t\t)\r\n\t\t.first()\r\n\t\t.after(template);\r\n}\r\n\r\nfunction addSheetEvents(html, actor) {\r\n\tconst list = html.find(\".tab.actions .heroActions-list\");\r\n\tlist\r\n\t\t.find(\"[data-action=draw]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionsDraw(actor, event));\r\n\tlist.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\tlist\r\n\t\t.find(\"[data-action=use]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionUse(actor, event));\r\n\tlist\r\n\t\t.find(\"[data-action=display]\")\r\n\t\t.on(\"click\", (event) => onClickHeroActionDisplay(actor, event));\r\n\tlist.find(\"[data-action=discard]\").on(\"click\", onClickHeroActionDiscard);\r\n\tlist\r\n\t\t.find(\"[data-action=discard-selected]\")\r\n\t\t.on(\"click\", () => onClickHeroActionsDiscard(actor, html));\r\n\thtml\r\n\t\t.find(\"[data-action=hero-actions-trade]\")\r\n\t\t.on(\"click\", () => tradeHeroAction(actor));\r\n}\r\n\r\nasync function onClickHeroActionsDiscard(actor, html) {\r\n\tconst discarded = html.find(\r\n\t\t\".tab.actions .heroActions-list .action.discarded\",\r\n\t);\r\n\tconst uuids = discarded.toArray().map((x) => x.dataset.uuid);\r\n\tdiscardHeroActions(actor, uuids);\r\n}\r\n\r\nfunction onClickHeroActionDiscard(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst list = action.closest(\".heroActions-list\");\r\n\r\n\taction.toggleClass(\"discarded\");\r\n\r\n\tconst toDiscard = Number(list.attr(\"data-discard\") ?? \"0\");\r\n\tconst $discarded = list.find(\".action.discarded\");\r\n\r\n\tlist.toggleClass(\"discardable\", $discarded.length === toDiscard);\r\n}\r\n\r\nasync function onClickHeroActionDisplay(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tsendActionToChat(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionUse(actor, event) {\r\n\tevent.preventDefault();\r\n\tconst uuid = $(event.currentTarget).closest(\".action\").attr(\"data-uuid\");\r\n\tuseHeroAction(actor, uuid);\r\n}\r\n\r\nasync function onClickHeroActionsDraw(actor, event) {\r\n\tevent.preventDefault();\r\n\tdrawHeroActions(actor);\r\n}\r\n\r\nexport function getHeroActions(actor) {\r\n\treturn getProperty(actor, `flags.${MODULE_ID}.heroActions`) ?? [];\r\n}\r\n\r\nasync function setHeroActions(actor, actions) {\r\n\treturn actor.update({ [`flags.${MODULE_ID}.heroActions`]: actions });\r\n}\r\n\r\nasync function onClickHeroActionExpand(event) {\r\n\tevent.preventDefault();\r\n\r\n\tconst action = $(event.currentTarget).closest(\".action\");\r\n\tconst summary = action.find(\".item-summary\");\r\n\r\n\tif (!summary.hasClass(\"loaded\")) {\r\n\t\tconst uuid = action.attr(\"data-uuid\");\r\n\t\tconst details = await getHeroActionDetails(uuid);\r\n\t\tif (!details) return;\r\n\r\n\t\tconst text = await TextEditor.enrichHTML(details.description, {\r\n\t\t\tasync: true,\r\n\t\t});\r\n\r\n\t\tsummary.find(\".item-description\").html(text);\r\n\t\tsummary.addClass(\"loaded\");\r\n\t}\r\n\r\n\taction.toggleClass(\"expanded\");\r\n}\r\n\r\nasync function getHeroActionDetails(uuid) {\r\n\tconst document = await fromUuid(uuid);\r\n\tif (!document) return undefined;\r\n\r\n\tconst parent = document instanceof JournalEntry ? document : document.parent;\r\n\tconst page =\r\n\t\tdocument instanceof JournalEntry ? document.pages.contents[0] : document;\r\n\r\n\tlet text = page?.text.content;\r\n\tif (!text) return undefined;\r\n\r\n\tif (parent.uuid === JOURNAL_UUID)\r\n\t\ttext = text.replace(/^<p>/, \"<p><strong>Trigger</strong> \");\r\n\treturn { name: page.name, description: text };\r\n}\r\n\r\nexport async function drawHeroActions(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst nb = actor.heroPoints.value - actions.length;\r\n\r\n\tconst drawn = [];\r\n\tfor (let i = 0; i < nb; i++) {\r\n\t\tconst action = await drawHeroAction();\r\n\r\n\t\tif (action === undefined) continue;\r\n\t\tif (action === null) return;\r\n\r\n\t\tactions.push(action);\r\n\t\tdrawn.push(action);\r\n\t}\r\n\r\n\tif (!drawn.length) return;\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: drawn,\r\n\t\tlabel: (nb) => localize(\"hero.actions-draw.header\", { nb }),\r\n\t\tsecret: true,\r\n\t});\r\n}\r\n\r\nfunction createChatMessage({ actor, actions, label, secret = false }) {\r\n\tconst { content, size } = chatActions(actions);\r\n\r\n\tlabel = typeof label === \"function\" ? label(size) : label;\r\n\r\n\tconst data = {\r\n\t\tflavor: `<h4 class=\"action\">${label}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t};\r\n\r\n\tif (secret && getSetting(\"hero-private\")) {\r\n\t\tdata.type = CONST.CHAT_MESSAGE_TYPES.ROLL;\r\n\t\tdata.rollMode = CONST.DICE_ROLL_MODES.PRIVATE;\r\n\t}\r\n\r\n\tChatMessage.create(data);\r\n}\r\n\r\nfunction chatActions(actions) {\r\n\tconst links = actions.map(({ uuid, name }) => chatUUID(uuid, name));\r\n\treturn {\r\n\t\tcontent: links\r\n\t\t\t.map((x) => `<div style=\"line-height: 1.6;\">${x}</div>`)\r\n\t\t\t.join(\"\"),\r\n\t\tsize: links.length,\r\n\t};\r\n}\r\n\r\nfunction tradeHeroAction(actor) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tif (!actions || !actions.length) {\r\n\t\twarn(\"hero.no-action\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst diff = actions.length - actor.heroPoints.value;\r\n\tif (diff > 0) {\r\n\t\twarn(\"hero.no-points\", { nb: diff.toString() });\r\n\t\treturn;\r\n\t}\r\n\r\n\tnew Trade(actor).render(true);\r\n}\r\n\r\nasync function drawHeroAction() {\r\n\tconst table = await getDeckTable();\r\n\tconst localize = subLocalize(\"hero.table\");\r\n\r\n\tif (!table) {\r\n\t\tlocalize.error(\"drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tif (!table.formula) {\r\n\t\tif (game.user.isGM) {\r\n\t\t\tif (table.compendium) {\r\n\t\t\t\tlocalize.error(\"noFormulaCompendium\", true);\r\n\t\t\t\treturn null;\r\n\t\t\t}\r\n\t\t\tawait table.normalize();\r\n\t\t} else {\r\n\t\t\tlocalize.error(\"noFormula\", true);\r\n\t\t\treturn null;\r\n\t\t}\r\n\t}\r\n\r\n\tif (table.replacement === false) {\r\n\t\tconst notDrawn = table.results.some((r) => !r.drawn);\r\n\t\tif (!notDrawn) await table.resetResults();\r\n\t}\r\n\r\n\tconst draw = (await table.draw({ displayChat: false })).results[0];\r\n\tif (!draw) return;\r\n\r\n\tconst uuid = documentUuidFromTableResult(draw);\r\n\tif (uuid) return { uuid, name: await getLabelfromTableResult(draw, uuid) };\r\n}\r\n\r\nasync function useHeroAction(actor, uuid) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst points = actor.heroPoints.value;\r\n\tif (points < 1) return warn(\"hero.use.noPoints\");\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\r\n\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\tif (index === -1) return;\r\n\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) error(\"hero.use.noDetails\");\r\n\r\n\tactions.splice(index, 1);\r\n\r\n\tif (details) {\r\n\t\tactor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": points - 1,\r\n\t\t\t[`flags.${MODULE_ID}.heroActions`]: actions,\r\n\t\t});\r\n\r\n\t\tChatMessage.create({\r\n\t\t\tflavor: `<h4 class=\"action\">${localize(\"hero.actions-use.header\")}</h4>`,\r\n\t\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\t\tspeaker: ChatMessage.getSpeaker({ actor }),\r\n\t\t});\r\n\t} else {\r\n\t\tsetHeroActions(actor, actions);\r\n\t}\r\n}\r\n\r\nasync function discardHeroActions(actor, actionsUUIDS) {\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\twarn(\"hero.onlyCharacter\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst uuids =\r\n\t\ttypeof actionsUUIDS === \"string\" ? [actionsUUIDS] : actionsUUIDS;\r\n\r\n\tconst actions = getHeroActions(actor);\r\n\tconst removed = [];\r\n\r\n\tfor (const uuid of uuids) {\r\n\t\tconst index = actions.findIndex((x) => x.uuid === uuid);\r\n\t\tif (index === -1) continue;\r\n\t\tremoved.push(actions[index]);\r\n\t\tactions.splice(index, 1);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\tcreateChatMessage({\r\n\t\tactor,\r\n\t\tactions: removed,\r\n\t\tlabel: (nb) => localize(\"hero.actions-discard.header\", { nb }),\r\n\t});\r\n}\r\n\r\nasync function getLabelfromTableResult(result, uuid) {\r\n\tif (result.type !== CONST.TABLE_RESULT_TYPES.TEXT) return result.text;\r\n\tconst label = /@UUID\\[[\\w\\.]+\\]{([\\w -]+)}/.exec(result.text)?.[1];\r\n\treturn label ?? (uuid && (await fromUuid(uuid))?.name);\r\n}\r\n\r\nasync function getTableFromUuid(uuid) {\r\n\tif (!uuid) return undefined;\r\n\tconst table = await fromUuid(uuid);\r\n\treturn table && table instanceof RollTable ? table : undefined;\r\n}\r\n\r\nasync function getDefaultCompendiumTable() {\r\n\treturn getTableFromUuid(TABLE_UUID);\r\n}\r\n\r\nfunction getDefaultWorldTable() {\r\n\treturn game.tables.find((x) => x.getFlag(\"core\", \"sourceId\") === TABLE_UUID);\r\n}\r\n\r\nasync function getCustomTable() {\r\n\treturn getTableFromUuid(getSetting(\"hero-table\"));\r\n}\r\n\r\nasync function getDeckTable() {\r\n\treturn (\r\n\t\t(await getCustomTable()) ??\r\n\t\tgetDefaultWorldTable() ??\r\n\t\t(await getDefaultCompendiumTable())\r\n\t);\r\n}\r\n\r\nasync function sendActionToChat(actor, uuid) {\r\n\tconst details = await getHeroActionDetails(uuid);\r\n\tif (!details) return error(\"hero.details.missing\");\r\n\r\n\tChatMessage.create({\r\n\t\tcontent: `<h2>${details.name}</h2>${details.description}`,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: actor }),\r\n\t});\r\n}\r\n\r\nexport function sendTradeRequest(trade) {\r\n\tif (trade.receiver.id === game.user.id) {\r\n\t\tacceptRequest(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-request\",\r\n\t});\r\n}\r\n\r\nfunction acceptRequest(trade) {\r\n\tif (game.user.isGM) {\r\n\t\tonTradeAccepted(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-accept\",\r\n\t});\r\n}\r\n\r\nasync function onTradeAccepted(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderActions = getHeroActions(senderActor);\r\n\tconst receiverActions = getHeroActions(receiverActor);\r\n\r\n\tconst senderActionIndex = senderActions.findIndex(\r\n\t\t(x) => x.uuid === sender.uuid,\r\n\t);\r\n\tconst receiverActionIndex = receiverActions.findIndex(\r\n\t\t(x) => x.uuid === receiver.uuid,\r\n\t);\r\n\r\n\tif (senderActionIndex === -1 || receiverActionIndex === -1) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst senderAction = senderActions.splice(senderActionIndex, 1)[0];\r\n\tconst receiverAction = receiverActions.splice(receiverActionIndex, 1)[0];\r\n\r\n\tsenderActions.push(receiverAction);\r\n\treceiverActions.push(senderAction);\r\n\r\n\tsetHeroActions(senderActor, senderActions);\r\n\tsetHeroActions(receiverActor, receiverActions);\r\n\r\n\tconst sentLink = chatUUID(senderAction.uuid);\r\n\tconst receivedLink = chatUUID(receiverAction.uuid);\r\n\r\n\tconst localize = subLocalize(\"hero.trade-success\");\r\n\r\n\tlet content = `<div style=\"line-height: 1.6\">${localize(\"offer\", {\r\n\t\toffer: sentLink,\r\n\t})}</div>`;\r\n\tcontent += `<div style=\"line-height: 1.6\">${localize(\"receive\", {\r\n\t\treceive: receivedLink,\r\n\t})}</div>`;\r\n\r\n\tChatMessage.create({\r\n\t\tflavor: `<h4 class=\"action\">${localize(\"header\", {\r\n\t\t\tname: receiverActor.name,\r\n\t\t})}</h4>`,\r\n\t\tcontent,\r\n\t\tspeaker: ChatMessage.getSpeaker({ actor: senderActor }),\r\n\t});\r\n}\r\n\r\nfunction sendTradeError({ sender, receiver }, error = \"trade-error\") {\r\n\tconst users = new Set([sender.id, receiver.id]);\r\n\r\n\tif (users.has(game.user.id)) {\r\n\t\tusers.delete(game.user.id);\r\n\t\tonTradeError(error);\r\n\t}\r\n\r\n\tif (!users.size) return;\r\n\r\n\tsocket.emit({\r\n\t\ttype: \"hero.trade-error\",\r\n\t\tusers: Array.from(users),\r\n\t\terror,\r\n\t});\r\n}\r\n\r\nfunction onTradeError(err) {\r\n\terror(\"hero.trade-error\");\r\n}\r\n\r\nasync function onTradeRequest(trade) {\r\n\tconst { sender, receiver } = trade;\r\n\tconst senderActor = game.actors.get(sender.cid);\r\n\tconst receiverActor = game.actors.get(receiver.cid);\r\n\r\n\tif (!senderActor || !receiverActor) {\r\n\t\tsendTradeError(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.trade-request\");\r\n\r\n\tlet content = `<p>${localize(\"header\", {\r\n\t\tsender: senderActor.name,\r\n\t\treceiver: receiverActor.name,\r\n\t})}</p>`;\r\n\tcontent += `<p>${localize(\"give\", { give: chatUUID(sender.uuid) })}</p>`;\r\n\tcontent += `<p>${localize(\"want\", { want: chatUUID(receiver.uuid) })}</p>`;\r\n\tcontent += `<p style=\"margin-bottom: 1em;\">${localize(\"accept\")}</p>`;\r\n\r\n\tconst accept = await Dialog.confirm({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await TextEditor.enrichHTML(content, { async: true }),\r\n\t});\r\n\r\n\tif (accept) acceptRequest(trade);\r\n\telse rejectRequest(trade);\r\n}\r\n\r\nfunction rejectRequest(trade) {\r\n\tif (trade.sender.id === game.user.id) {\r\n\t\tonTradeRejected(trade);\r\n\t\treturn;\r\n\t}\r\n\r\n\tsocket.emit({\r\n\t\t...trade,\r\n\t\ttype: \"hero.trade-reject\",\r\n\t});\r\n}\r\n\r\nasync function onTradeRejected({ receiver }) {\r\n\tconst actor = game.actors.get(receiver.cid);\r\n\twarn(\"hero.trade-rejected\", { name: actor.name }, true);\r\n}\r\n\r\nasync function createTable() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.createTable.choice\");\r\n\tconst template = templatePath(\"hero/dialogs/create-table\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"create\"),\r\n\t\t\ticon: '<i class=\"fas fa-border-all\"></i>',\r\n\t\t\tcallback: (html) => {\r\n\t\t\t\tconst type = html\r\n\t\t\t\t\t.find('.window-content input[name=\"type\"]:checked')\r\n\t\t\t\t\t.val();\r\n\t\t\t\tconst unique =\r\n\t\t\t\t\thtml.find('.window-content input[name=\"draw\"]:checked').val() ===\r\n\t\t\t\t\t\"unique\";\r\n\t\t\t\treturn { type, unique };\r\n\t\t\t},\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, { i18n: localize.template }),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-create-table\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tif (result.type === \"default\") createDefaultTable(result.unique);\r\n\telse createCustomTable(result.unique);\r\n}\r\n\r\nasync function createCustomTable(unique) {\r\n\tconst table = await createCustomActionsTable(unique);\r\n\tawait setTable(table);\r\n\ttable.sheet?.render(true);\r\n}\r\n\r\nfunction createCustomActionsTable(unique = true) {\r\n\tconst source = getTableSource(unique);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function createDefaultTable(unique) {\r\n\tconst localize = subLocalize(\"templates.createTable.default.confirm\");\r\n\tlet table = await getDefaultWorldTable();\r\n\r\n\tif (table) {\r\n\t\tconst override = await Dialog.confirm({\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tcontent: localize(\"content\"),\r\n\t\t});\r\n\r\n\t\tif (override) {\r\n\t\t\tconst update = getTableSource(unique);\r\n\t\t\tawait table.update(update);\r\n\t\t\treturn setTable(table, true);\r\n\t\t}\r\n\t}\r\n\r\n\ttable = await createDefautActionsTable(unique);\r\n\tawait setTable(table);\r\n}\r\n\r\nasync function createDefautActionsTable(unique = true) {\r\n\tconst table = await fromUuid(TABLE_UUID);\r\n\tconst source = getTableSource(unique, table);\r\n\treturn RollTable.create(source, { temporary: false });\r\n}\r\n\r\nasync function setTable(table, normalize = false) {\r\n\tif (normalize) await table.normalize();\r\n\tawait setSetting(\"hero-table\", table.uuid);\r\n}\r\n\r\nfunction getTableSource(unique, table) {\r\n\tconst source = {\r\n\t\tname: localize(\"hero.table.name\"),\r\n\t\treplacement: !(unique ?? true),\r\n\t\timg: TABLE_ICON,\r\n\t\tdescription: localize(\"hero.table.description\"),\r\n\t\tflags: {\r\n\t\t\tcore: {\r\n\t\t\t\tsourceId: TABLE_UUID,\r\n\t\t\t},\r\n\t\t},\r\n\t};\r\n\tif (!table) return source;\r\n\treturn mergeObject(deepClone(table._source), source);\r\n}\r\n\r\nasync function removeHeroActions() {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst localize = subLocalize(\"hero.templates.removeActions\");\r\n\tconst template = templatePath(\"hero/dialogs/remove-actions\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: localize(\"remove\"),\r\n\t\t\ticon: '<i class=\"fas fa-trash\"></i>',\r\n\t\t\tcallback: (html) =>\r\n\t\t\t\thtml\r\n\t\t\t\t\t.find('input[name=\"actor\"]:checked')\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((x) => game.actors.get(x.value))\r\n\t\t\t\t\t.filter((x) => x),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\tcontent: await renderTemplate(template, {\r\n\t\t\tactors: game.actors.filter((x) => x.type === \"character\"),\r\n\t\t\ti18n: localize.template,\r\n\t\t}),\r\n\t\ttitle: localize(\"title\"),\r\n\t\tbuttons,\r\n\t\tdefault: \"yes\",\r\n\t\trender: (html) => {\r\n\t\t\thtml.on(\"change\", 'input[name=\"all\"]', () =>\r\n\t\t\t\tremoveActionsToggleAll(html),\r\n\t\t\t);\r\n\t\t\thtml.on(\"change\", 'input[name=\"actor\"]', () =>\r\n\t\t\t\tremoveActionsToggleActor(html),\r\n\t\t\t);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst actors = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-remove-actions\",\r\n\t});\r\n\r\n\tif (!actors) return;\r\n\r\n\tif (!actors.length) {\r\n\t\tlocalize.warn(\"noSelection\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tfor (const actor of actors) {\r\n\t\tsetHeroActions(actor, []);\r\n\t}\r\n\r\n\tlocalize.info(\"removed\");\r\n}\r\n\r\nfunction removeActionsToggleAll(html) {\r\n\tconst state = html.find('input[name=\"all\"]')[0].checked;\r\n\thtml.find('input[name=\"actor\"]').prop(\"checked\", state);\r\n}\r\n\r\nfunction removeActionsToggleActor(html) {\r\n\tconst actors = html.find('input[name=\"actor\"]');\r\n\tconst checked = actors.filter(\":checked\");\r\n\tconst all = html.find('input[name=\"all\"]');\r\n\r\n\tif (actors.length === checked.length) {\r\n\t\tall.prop(\"checked\", true).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", true);\r\n\t} else if (!checked.length) {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", false);\r\n\t\tactors.prop(\"checked\", false);\r\n\t} else {\r\n\t\tall.prop(\"checked\", false).prop(\"indeterminate\", true);\r\n\t}\r\n}\r\n\r\nfunction documentUuidFromTableResult(result) {\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.TEXT)\r\n\t\treturn /@UUID\\[([\\w\\.]+)\\]/.exec(result.text)?.[1];\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.DOCUMENT)\r\n\t\treturn `${result.documentCollection}.${result.documentId}`;\r\n\tif (result.type === CONST.TABLE_RESULT_TYPES.COMPENDIUM)\r\n\t\treturn `Compendium.${result.documentCollection}.${result.documentId}`;\r\n\treturn undefined;\r\n}\r\n\r\nasync function giveHeroActions(actor) {\r\n\tif (!game.user.isGM) {\r\n\t\twarn(\"hero.notGM\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst templateLocalize = subLocalize(\"hero.templates.giveAction\");\r\n\r\n\tif (!actor?.isOfType(\"character\")) {\r\n\t\ttemplateLocalize.warn(\"noCharacter\");\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst table = await getDeckTable();\r\n\tif (!table) {\r\n\t\terror(\"hero.table.drawError\", true);\r\n\t\treturn null;\r\n\t}\r\n\r\n\tconst isUnique = table.replacement === false;\r\n\r\n\tconst actionsList = (\r\n\t\tawait Promise.all(\r\n\t\t\ttable.results.map(async (result) => {\r\n\t\t\t\tconst uuid = documentUuidFromTableResult(result);\r\n\t\t\t\tif (!uuid) return;\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tkey: result.id,\r\n\t\t\t\t\tuuid,\r\n\t\t\t\t\tname: await getLabelfromTableResult(result, uuid),\r\n\t\t\t\t\tdrawn: result.drawn,\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tconst template = templatePath(\"hero/dialogs/give-action\");\r\n\tconst content = await renderTemplate(template, {\r\n\t\tactions: actionsList,\r\n\t\tisUnique,\r\n\t\ti18n: templateLocalize,\r\n\t});\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\tlabel: templateLocalize(\"give\"),\r\n\t\t\ticon: '<i class=\"fa-solid fa-gift\"></i>',\r\n\t\t\tcallback: (html) => ({\r\n\t\t\t\tselected: html\r\n\t\t\t\t\t.find(\"[name=action]:checked\")\r\n\t\t\t\t\t.closest(\".action\")\r\n\t\t\t\t\t.toArray()\r\n\t\t\t\t\t.map((el) => el.dataset),\r\n\t\t\t\tasDrawn: html.find(\"[name=drawn]\").prop(\"checked\") ?? false,\r\n\t\t\t\twithMessage: html.find(\"[name=message]\").prop(\"checked\"),\r\n\t\t\t}),\r\n\t\t},\r\n\t\tno: {\r\n\t\t\tlabel: templateLocalize(\"cancel\"),\r\n\t\t\ticon: '<i class=\"fas fa-times\"></i>',\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tconst data = {\r\n\t\ttitle: templateLocalize(\"title\"),\r\n\t\tcontent,\r\n\t\tbuttons,\r\n\t\trender: (html) => {\r\n\t\t\thtml.find(\"[data-action=expand]\").on(\"click\", onClickHeroActionExpand);\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-hero-actions-give-action\",\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst { selected, asDrawn, withMessage } = result;\r\n\tconst actions = getHeroActions(actor);\r\n\tconst tableUpdates = [];\r\n\r\n\tfor (const { uuid, name, key } of selected) {\r\n\t\tactions.push({ uuid, name });\r\n\t\tif (!asDrawn) continue;\r\n\r\n\t\tconst result = table.results.get(key);\r\n\t\tif (result && !result.drawn) tableUpdates.push(key);\r\n\t}\r\n\r\n\tif (tableUpdates.length) {\r\n\t\tawait table.updateEmbeddedDocuments(\r\n\t\t\t\"TableResult\",\r\n\t\t\ttableUpdates.map((key) => ({ _id: key, drawn: true })),\r\n\t\t);\r\n\t}\r\n\r\n\tsetHeroActions(actor, actions);\r\n\r\n\tif (withMessage) {\r\n\t\tcreateChatMessage({\r\n\t\t\tactor,\r\n\t\t\tactions: selected,\r\n\t\t\tlabel: (nb) => localize(\"hero.actions-give.header\", { nb }),\r\n\t\t\tsecret: true,\r\n\t\t});\r\n\t}\r\n}\r\n", "import { calculateDistanceBetweenPoints, getElementIndex } from \"module-api\";\r\n\r\n/** @type {DraggableData | null} */\r\nlet dragData = null;\r\n\r\nlet DRAG_ID = 0;\r\n\r\n/**\r\n * @template {DraggableOptions | DroppableOptions} T\r\n * @param {T} options\r\n * @param {OptionsFilter<T>} filters\r\n */\r\nfunction cleanOptions(options, filters) {\r\n\tfor (const [type, keys] of Object.entries(filters)) {\r\n\t\tfor (const key of keys) {\r\n\t\t\tconst option = options[key];\r\n\t\t\t// biome-ignore lint/suspicious/useValidTypeof: <explanation>\r\n\t\t\tif (!option || typeof option === type) continue;\r\n\t\t\toptions[option] = undefined;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {DraggableOptions} options\r\n */\r\nexport function makeDraggable(options) {\r\n\tif (!(options.element instanceof HTMLElement)) return;\r\n\r\n\tcleanOptions(options, {\r\n\t\tstring: [\"draggedClass\", \"group\", \"selector\", \"filter\", \"identifier\"],\r\n\t\tnumber: [\"triggerDistance\"],\r\n\t\tboolean: [\"cancelOnRightClick\"],\r\n\t\tfunction: [\"onCancel\", \"onDragEnd\", \"onDragStart\"],\r\n\t});\r\n\r\n\toptions.triggerDistance ??= 6;\r\n\r\n\toptions.cancelOnRightClick ??= true;\r\n\r\n\toptions.cursorImage ??= {};\r\n\toptions.cursorImage.id =\r\n\t\ttypeof options.cursorImage.id === \"string\" ? options.cursorImage.id : \"\";\r\n\toptions.cursorImage.img =\r\n\t\ttypeof options.cursorImage.img === \"function\"\r\n\t\t\t? options.cursorImage.img\r\n\t\t\t: undefined;\r\n\r\n\toptions.droppables ??= [];\r\n\r\n\tfor (let i = options.droppables.length - 1; i >= 0; i--) {\r\n\t\tconst droppable = options.droppables[i];\r\n\r\n\t\tif (!(droppable.element instanceof HTMLElement)) {\r\n\t\t\toptions.droppables.splice(i, 1);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tcleanOptions(droppable, {\r\n\t\t\tstring: [\"selector\", \"overClass\", \"filter\"],\r\n\t\t\tboolean: [\"purgeOnLeave\"],\r\n\t\t\tfunction: [\"onDragEnter\", \"onDragLeave\", \"onDragOver\", \"onDrop\"],\r\n\t\t});\r\n\t}\r\n\r\n\toptions.element.addEventListener(\"mousedown\", (event) =>\r\n\t\tonMouseDown(event, options),\r\n\t);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragCancel(event) {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.canceled = true;\r\n\r\n\tif (dragData.dragging && dragData.draggable.ghost) {\r\n\t\tdragData.draggable.ghost.reset();\r\n\t}\r\n\r\n\tif (dragData.dragging && dragData.options.onCancel) {\r\n\t\tawait dragData.options.onCancel(event, dragData.draggable);\r\n\t}\r\n\r\n\tcleanUp();\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragEnd(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging && dragData.options.onDragEnd) {\r\n\t\tawait dragData.options.onDragEnd(event, dragData.draggable, {\r\n\t\t\tcanceled: dragData.canceled,\r\n\t\t\tdropped: dragData.dropped,\r\n\t\t});\r\n\t}\r\n\r\n\twindow.removeEventListener(\"mousemove\", onMouseMove);\r\n\twindow.removeEventListener(\"mouseup\", onMouseUp);\r\n\r\n\tdragData = null;\r\n}\r\n\r\nfunction cleanUp() {\r\n\tif (!dragData) return;\r\n\r\n\tdragData.draggable.classList.purge();\r\n\tdragData.draggable.ghost?.classList.purge();\r\n\tdragData.cursorElement?.remove();\r\n\r\n\tfor (const { classList } of Object.values(dragData.hovered)) {\r\n\t\tclassList.purge();\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n * @param {DraggableOptions} options\r\n */\r\nfunction onMouseDown(event, options) {\r\n\tif (\r\n\t\tevent.button === 2 &&\r\n\t\tdragData?.dragging &&\r\n\t\tdragData.options.cancelOnRightClick\r\n\t) {\r\n\t\tonDragCancel(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tif (event.button) return;\r\n\r\n\tconst target = closestInside(event.target, options.element, options);\r\n\tif (!target) return;\r\n\r\n\t/** @type {DraggableGhost | undefined} */\r\n\tlet _ghost;\r\n\r\n\tconst targetIndex = getElementIndex(target);\r\n\tconst targetParent = target.parentElement;\r\n\tconst targetClassList = newClassList(target);\r\n\r\n\t/** @type {DraggableData} */\r\n\tdragData = {\r\n\t\tcanceled: false,\r\n\t\tdragging: false,\r\n\t\tdropped: false,\r\n\t\toptions,\r\n\t\tgroup: options.group,\r\n\t\tdraggable: {\r\n\t\t\tidentifier: options.identifier,\r\n\t\t\telement: target,\r\n\t\t\ttriggeringElement: event.target,\r\n\t\t\tx: event.clientX,\r\n\t\t\ty: event.clientY,\r\n\t\t\tparent: targetParent,\r\n\t\t\tindex: targetIndex,\r\n\t\t\tclassList: targetClassList,\r\n\t\t\tget ghost() {\r\n\t\t\t\tif (_ghost) {\r\n\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t_ghost.classList.add(options.ghostClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t\treturn _ghost;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst { element = target.cloneNode(true), index = Infinity } =\r\n\t\t\t\t\toptions.createGhost?.(target, targetIndex) ?? {};\r\n\r\n\t\t\t\tconst classList = newClassList(element);\r\n\r\n\t\t\t\tif (options.draggedClass && element !== target) {\r\n\t\t\t\t\telement.classList.remove(options.draggedClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\tclassList.add(options.ghostClass);\r\n\t\t\t\t}\r\n\r\n\t\t\t\t_ghost = {\r\n\t\t\t\t\telement,\r\n\t\t\t\t\tclassList,\r\n\t\t\t\t\tindex,\r\n\t\t\t\t\treset: () => {\r\n\t\t\t\t\t\telement.remove();\r\n\t\t\t\t\t\tif (element === target) {\r\n\t\t\t\t\t\t\tconst child = targetParent.children[targetIndex];\r\n\t\t\t\t\t\t\ttargetParent.insertBefore(target, child);\r\n\t\t\t\t\t\t\t_ghost.index = targetIndex;\r\n\t\t\t\t\t\t\tif (options.ghostClass) {\r\n\t\t\t\t\t\t\t\tclassList.remove(options.ghostClass);\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t_ghost.index = Infinity;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t};\r\n\r\n\t\t\t\treturn _ghost;\r\n\t\t\t},\r\n\t\t\tresetPosition: () => {\r\n\t\t\t\ttarget.remove();\r\n\t\t\t\ttargetParent.children[targetIndex].before(target);\r\n\t\t\t},\r\n\t\t},\r\n\t\tdroppables: options.droppables.map((droppable) => ({\r\n\t\t\t...droppable,\r\n\t\t\tid: DRAG_ID++,\r\n\t\t})),\r\n\t\thovered: {},\r\n\t};\r\n\r\n\twindow.addEventListener(\"mousemove\", onMouseMove);\r\n\twindow.addEventListener(\"mouseup\", onMouseUp);\r\n}\r\n\r\nasync function onMouseMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tonDragMove(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst { draggable } = dragData;\r\n\tconst distance = calculateDistanceBetweenPoints(\r\n\t\tdraggable.x,\r\n\t\tdraggable.y,\r\n\t\tclientX,\r\n\t\tclientY,\r\n\t);\r\n\r\n\tif (distance > dragData.options.triggerDistance) {\r\n\t\tawait onDragStart(event);\r\n\t}\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onMouseUp(event) {\r\n\tif (event.button || !dragData) return;\r\n\r\n\tif (dragData.dragging) {\r\n\t\tlet dropped = false;\r\n\r\n\t\tcleanUp();\r\n\r\n\t\tawait Promise.all(\r\n\t\t\tObject.values(dragData.hovered).map(async (hovered) => {\r\n\t\t\t\tif (!hovered.droppable.onDrop) return;\r\n\r\n\t\t\t\tconst hasDropped = await hovered.droppable.onDrop(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\t\ttriggeringElement: hovered.triggeringElement,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (hasDropped) dropped = true;\r\n\t\t\t}),\r\n\t\t);\r\n\r\n\t\tdragData.dropped = dropped;\r\n\t}\r\n\r\n\tawait onDragEnd(event);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragStart(event) {\r\n\tif (dragData.dragging) return;\r\n\r\n\tdragData.dragging = true;\r\n\r\n\tif (dragData.options.cursorImage.img) {\r\n\t\tconst img = dragData.options.cursorImage.img(dragData.draggable.element);\r\n\t\tif (img instanceof HTMLElement) {\r\n\t\t\tdragData.cursorElement = img;\r\n\t\t} else {\r\n\t\t\tdragData.cursorElement = new Image();\r\n\t\t\tdragData.cursorElement.src = typeof img === \"string\" ? img : \"\";\r\n\t\t}\r\n\t} else {\r\n\t\tdragData.cursorElement = dragData.draggable.element.cloneNode(true);\r\n\t}\r\n\r\n\tdragData.cursorElement.id = dragData.options.cursorImage.id;\r\n\r\n\tif (dragData.options.draggedClass) {\r\n\t\tdragData.draggable.classList.add(dragData.options.draggedClass);\r\n\t}\r\n\r\n\tdocument.body.appendChild(dragData.cursorElement);\r\n\r\n\tawait dragData.options.onDragStart?.(event, dragData.draggable);\r\n}\r\n\r\n/**\r\n * @param {MouseEvent} event\r\n */\r\nasync function onDragMove(event) {\r\n\tif (!dragData) return;\r\n\r\n\tconst { clientX, clientY } = event;\r\n\tconst cursorElement = dragData.cursorElement;\r\n\r\n\tconst offsetX = cursorElement.offsetWidth / 2;\r\n\tconst offsetY = cursorElement.offsetHeight / 2;\r\n\r\n\tcursorElement.style.left = `${clientX - offsetX}px`;\r\n\tcursorElement.style.top = `${clientY - offsetY}px`;\r\n\r\n\tawait Promise.all(\r\n\t\tdragData.droppables.map(async (droppable) => {\r\n\t\t\tconst target = closestInside(event.target, droppable.element, {\r\n\t\t\t\tselector: droppable.selector,\r\n\t\t\t\tfilter: droppable.filter,\r\n\t\t\t});\r\n\t\t\tconst hovered = dragData.hovered[droppable.id];\r\n\r\n\t\t\tif (hovered && (!target || hovered.element !== target)) {\r\n\t\t\t\tconst left = await droppable.onDragLeave?.(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\r\n\t\t\t\tif (left !== false) {\r\n\t\t\t\t\tdelete dragData.hovered[droppable.id];\r\n\t\t\t\t\tif (droppable.purgeOnLeave) {\r\n\t\t\t\t\t\thovered.classList.purge();\r\n\t\t\t\t\t} else if (droppable.overClass) {\r\n\t\t\t\t\t\thovered.classList.remove(droppable.overClass);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!target) return;\r\n\r\n\t\t\tif (!hovered) {\r\n\t\t\t\tconst classList = newClassList(target);\r\n\r\n\t\t\t\tconst entered = await droppable.onDragEnter?.(\r\n\t\t\t\t\tevent,\r\n\t\t\t\t\tdragData.draggable,\r\n\t\t\t\t\t{\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t},\r\n\t\t\t\t);\r\n\r\n\t\t\t\tif (entered !== false) {\r\n\t\t\t\t\tif (droppable.overClass) classList.add(droppable.overClass);\r\n\r\n\t\t\t\t\tdragData.hovered[droppable.id] = {\r\n\t\t\t\t\t\tid: droppable.id,\r\n\t\t\t\t\t\tclassList,\r\n\t\t\t\t\t\tdroppable,\r\n\t\t\t\t\t\telement: target,\r\n\t\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t\t};\r\n\t\t\t\t}\r\n\t\t\t} else if (droppable.onDragOver) {\r\n\t\t\t\tawait droppable.onDragOver(event, dragData.draggable, {\r\n\t\t\t\t\tclassList: hovered.classList,\r\n\t\t\t\t\telement: hovered.element,\r\n\t\t\t\t\ttriggeringElement: event.target,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}),\r\n\t);\r\n}\r\n\r\n/**\r\n *\r\n * @param {HTMLElement} target\r\n * @returns {DraggableClassList}\r\n */\r\nexport function newClassList(target) {\r\n\treturn new (class extends Set {\r\n\t\tadd(value) {\r\n\t\t\ttarget.classList.add(value);\r\n\t\t\tsuper.add(value);\r\n\t\t}\r\n\t\tremove(value) {\r\n\t\t\ttarget.classList.remove(value);\r\n\t\t\tsuper.delete(value);\r\n\t\t}\r\n\t\ttoggle(value, enabled) {\r\n\t\t\tconst toggled = enabled ?? !target.classList.contains(value);\r\n\t\t\tif (toggled) this.add(value);\r\n\t\t\telse this.remove(value);\r\n\t\t}\r\n\t\tcontains(value) {\r\n\t\t\treturn this.has(value);\r\n\t\t}\r\n\t\tpurge() {\r\n\t\t\ttarget.classList.remove(...this);\r\n\t\t}\r\n\t})();\r\n}\r\n\r\n/**\r\n * @param {HTMLElement} target\r\n * @param {HTMLElement} parent\r\n * @param {Object} [options]\r\n * @param {string} [options.selector]\r\n * @param {string} [options.filter]\r\n * @returns {HTMLElement | undefined}\r\n */\r\nexport function closestInside(target, parent, { selector, filter } = {}) {\r\n\tif (!parent.contains(target)) return;\r\n\r\n\tif (!selector && !filter) return parent;\r\n\r\n\tlet element;\r\n\tlet cursor = target;\r\n\r\n\twhile (true) {\r\n\t\tif (filter && cursor.matches(filter)) return;\r\n\r\n\t\tif (!element && selector && cursor.matches(selector)) {\r\n\t\t\telement = cursor;\r\n\t\t}\r\n\r\n\t\tif (cursor === parent) break;\r\n\r\n\t\tcursor = cursor.parentElement;\r\n\t}\r\n\r\n\treturn !selector ? parent : element;\r\n}\r\n", "import {\r\n\tcanBeInvested,\r\n\terror,\r\n\tgetElementIndex,\r\n\tgetFlag,\r\n\tgetInMemory,\r\n\tgetSetting,\r\n\thasWornSlot,\r\n\tindexIsValid,\r\n\tisHandwrapsOfMightyBlows,\r\n\tisHeld,\r\n\tisInvestedOrWornAs,\r\n\tisOneHanded,\r\n\tisTwoHanded,\r\n\titemCarryUpdate,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n} from \"module-api\";\r\nimport {\r\n\tgetCharacterSheetTab,\r\n\tisPlayedActor,\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../actor\";\r\nimport { closestInside, makeDraggable } from \"../draggable\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst closeHook = createHook(\r\n\t\"closeCharacterSheetPF2e\",\r\n\tcloseCharacterSheetPF2e,\r\n);\r\n\r\nlet dragging = false;\r\n\r\nexport function registerInventory() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"inventory\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nlet dragIdentifier;\r\n\r\nconst COINS = [\r\n\t\"platinum-pieces\",\r\n\t\"gold-pieces\",\r\n\t\"silver-pieces\",\r\n\t\"copper-pieces\",\r\n];\r\n\r\nfunction setup(value) {\r\n\tconst enabled = value ?? getSetting(\"inventory\");\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"inventory\",\r\n\t\t\ttemplateFolder: \"inventory/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t\tonRender,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"inventory\");\r\n\t}\r\n\tcloseHook(enabled);\r\n}\r\n\r\nfunction closeCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\tif (!getInMemory(sheet, \"inventory.requireSave\")) return;\r\n\r\n\tconst tab = getCharacterSheetTab(html, \"inventory\")[0];\r\n\tconst data = getCurrentData(tab);\r\n\tif (!data) return;\r\n\r\n\tsetFlag(actor, \"inventory\", data);\r\n}\r\n\r\nfunction onRender(actor, sheet, inner) {\r\n\tconst sidebar = inner.find(\"> aside\");\r\n\tsidebar.css(\"position\", \"relative\");\r\n\tsidebar.append(\r\n\t\t\"<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>\",\r\n\t);\r\n}\r\n\r\nfunction getCurrentData(tabElement) {\r\n\tif (!tabElement) return;\r\n\r\n\tconst alternate = tabElement.querySelector(\":scope > .alternate\");\r\n\tconst equipped = alternate.querySelector(\"[data-area='equipped']\");\r\n\r\n\tconst equippedItemId = (slot) => {\r\n\t\tconst el = equipped.querySelector(`[data-equipped-slot='${slot}']`);\r\n\t\tconst item = el.querySelector(\"[data-item-id]\");\r\n\t\treturn item?.dataset.itemId ?? null;\r\n\t};\r\n\r\n\tconst itemIds = (parent) => {\r\n\t\tconst ids = {};\r\n\t\tconst items = parent.querySelectorAll(\":scope > [data-item-id]\");\r\n\t\tfor (let i = 0; i < items.length; i++) {\r\n\t\t\tconst item = items[i];\r\n\t\t\tids[item.dataset.itemId] = i;\r\n\t\t}\r\n\t\treturn ids;\r\n\t};\r\n\r\n\tconst tabs = {};\r\n\tfor (const tab of alternate.querySelectorAll(\"[data-area='items-grid']\")) {\r\n\t\tconst tabId = tab.dataset.tabId;\r\n\t\ttabs[tabId] = itemIds(tab);\r\n\t}\r\n\r\n\treturn {\r\n\t\tequipped: {\r\n\t\t\thands: [equippedItemId(\"left-hand\"), equippedItemId(\"right-hand\")],\r\n\t\t\tarmor: [equippedItemId(\"armor\")],\r\n\t\t\tothers: itemIds(equipped),\r\n\t\t},\r\n\t\ttabs,\r\n\t};\r\n}\r\n\r\nasync function getData(actor, sheet, tabElement) {\r\n\tconst flags = getFlag(actor, \"inventory\");\r\n\tconst data = getCurrentData(tabElement[0]) ??\r\n\t\tflags ?? {\r\n\t\t\tequipped: {\r\n\t\t\t\thands: [null, null],\r\n\t\t\t\tarmor: [null],\r\n\t\t\t\tothers: {},\r\n\t\t\t},\r\n\t\t\ttabs: {},\r\n\t\t};\r\n\r\n\tif (!flags) {\r\n\t\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n\t}\r\n\r\n\tconst tabs = new Collection();\r\n\tconst orphans = {};\r\n\tconst containers = new Set();\r\n\tconst equipped = {\r\n\t\thands: [null, null],\r\n\t\tarmor: [null],\r\n\t\tothers: [],\r\n\t};\r\n\r\n\tfunction getTab(item) {\r\n\t\tconst tabId = item?.id;\r\n\r\n\t\tlet tab = tabs.get(tabId);\r\n\t\tif (tab) return tab;\r\n\r\n\t\ttab = {\r\n\t\t\tid: tabId,\r\n\t\t\titem: item,\r\n\t\t\tparent: item?.container,\r\n\t\t\tcontainers: [],\r\n\t\t\tmatrix: [],\r\n\t\t\tparents: [],\r\n\t\t};\r\n\r\n\t\ttabs.set(tabId, tab);\r\n\t\treturn tab;\r\n\t}\r\n\r\n\tfor (const item of actor.inventory) {\r\n\t\tif (\r\n\t\t\titem.isOfType(\"treasure\") &&\r\n\t\t\titem.system.stackGroup === \"coins\" &&\r\n\t\t\tCOINS.includes(item.slug)\r\n\t\t) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst itemId = item.id;\r\n\t\tconst parent = item.container;\r\n\r\n\t\t// we retrieve the parent tab, undefined === root inventory\r\n\t\tconst tab = getTab(parent);\r\n\r\n\t\tconst addOrphan = (item) => {\r\n\t\t\torphans[tab.id] ??= [];\r\n\t\t\torphans[tab.id].push(item);\r\n\t\t};\r\n\r\n\t\tif (item.isOfType(\"backpack\")) {\r\n\t\t\ttab.containers.push(item);\r\n\t\t\tcontainers.add(item);\r\n\r\n\t\t\t// we create the tab for this container, in case it is empty\r\n\t\t\tgetTab(item);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst handsHeld = item.handsHeld;\r\n\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\tif (handsHeld === 2 && equippedHands === 0) {\r\n\t\t\tif (data.equipped.hands[0] === itemId) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (handsHeld === 1 && equippedHands <= 1) {\r\n\t\t\tconst handIndex = data.equipped.hands.indexOf(itemId);\r\n\t\t\tif (indexIsValid(handIndex)) {\r\n\t\t\t\tequipped.hands[handIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\tif (data.equipped.armor[0] === itemId) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tif (\r\n\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\tisInvestedOrWornAs(item)\r\n\t\t) {\r\n\t\t\tconst equippedIndex = data.equipped.others[itemId];\r\n\t\t\tif (indexIsValid(equippedIndex)) {\r\n\t\t\t\tequipped.others[equippedIndex] = item;\r\n\t\t\t} else {\r\n\t\t\t\taddOrphan(item);\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst index = data.tabs[tab.id]?.[itemId];\r\n\t\tif (indexIsValid(index)) {\r\n\t\t\ttab.matrix[index] = item;\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\taddOrphan(item);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tconst tabOrphans = orphans[tab.id];\r\n\t\tif (!tabOrphans) continue;\r\n\r\n\t\tfor (const item of tabOrphans) {\r\n\t\t\tconst handsHeld = item.handsHeld;\r\n\t\t\tconst equippedHands = equipped.hands.filter(Boolean).length;\r\n\r\n\t\t\tif (equippedHands === 0 && handsHeld === 2) {\r\n\t\t\t\tequipped.hands = [item, item];\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (equippedHands <= 1 && handsHeld === 1) {\r\n\t\t\t\tconst otherIndex = equipped.hands[0] ? 1 : 0;\r\n\t\t\t\tequipped.hands[otherIndex] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (!equipped.armor[0] && item.isOfType(\"armor\") && item.isEquipped) {\r\n\t\t\t\tequipped.armor[0] = item;\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\tif (\r\n\t\t\t\t(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item)) &&\r\n\t\t\t\tisInvestedOrWornAs(item)\r\n\t\t\t) {\r\n\t\t\t\tequipped.others.push(item);\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\r\n\t\t\ttab.matrix.push(item);\r\n\t\t}\r\n\r\n\t\ttab.matrix = tab.matrix.filter(Boolean);\r\n\t}\r\n\r\n\tfor (const tab of tabs) {\r\n\t\tlet parent = tab.parent;\r\n\r\n\t\twhile (parent) {\r\n\t\t\ttab.parents.push(parent);\r\n\t\t\tparent = parent.container;\r\n\t\t}\r\n\r\n\t\ttab.parents.reverse();\r\n\r\n\t\tconst grouped = [tab.containers, tab.parents, tab.item].flat();\r\n\t\ttab.trailings = containers.filter((item) => !grouped.includes(item));\r\n\t}\r\n\r\n\t// if no item exist on the character, we still want one tab\r\n\tif (!tabs.size) getTab(undefined);\r\n\r\n\tequipped.others = equipped.others.filter(Boolean);\r\n\r\n\tconst activeTabId = getInMemory(sheet, \"inventory.activeTab\");\r\n\r\n\treturn {\r\n\t\ttabs: Array.from(tabs.values()),\r\n\t\tequipped,\r\n\t\tactor,\r\n\t\tselectedTab: tabs.get(activeTabId)?.id,\r\n\t\tcontainerBulk: (container) => {\r\n\t\t\tconst capacity = container.capacity;\r\n\t\t\treturn `${capacity.value.toString()} / ${capacity.max.toString()}`;\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction addEvents(tab, sheet, actor, inner) {\r\n\tconst containerTabs = tab.find(\"[data-tab-id]\");\r\n\tfor (const container of tab.find(\"[data-container-id]\")) {\r\n\t\tcontainer.addEventListener(\"click\", (event) => {\r\n\t\t\tconst tabId = container.dataset.containerId;\r\n\r\n\t\t\tcontainerTabs.removeClass(\"active\");\r\n\t\t\tcontainerTabs.filter(`[data-tab-id=${tabId}]`).addClass(\"active\");\r\n\r\n\t\t\tsetInMemory(sheet, \"inventory.activeTab\", tabId);\r\n\t\t});\r\n\t}\r\n\r\n\tconst sidebar = inner.find(\"#pf2e-toobelt-inventory-item-details\")[0];\r\n\tconst itemElements = tab.find(\"[data-item-id], [data-container-id]\");\r\n\tfor (const itemElement of itemElements) {\r\n\t\titemElement.addEventListener(\"mouseenter\", (event) =>\r\n\t\t\tonItemDetails(event, actor, itemElement, sidebar),\r\n\t\t);\r\n\t\titemElement.addEventListener(\"mouseleave\", (event) => {\r\n\t\t\tsidebar.classList.add(\"hidden\");\r\n\t\t});\r\n\t}\r\n\r\n\tif (!actor.isOwner) return;\r\n\r\n\tdragIdentifier = randomID();\r\n\r\n\tmakeDraggable({\r\n\t\telement: tab[0],\r\n\t\tselector: \"[data-item-id]\",\r\n\t\tfilter: \"input\",\r\n\t\tdraggedClass: \"dragged\",\r\n\t\tghostClass: \"ghost\",\r\n\t\tidentifier: dragIdentifier,\r\n\t\tcursorImage: {\r\n\t\t\tid: \"pf2e-toolbelt-inventory-cursor-image\",\r\n\t\t\timg: (target) => target.dataset.itemImg,\r\n\t\t},\r\n\t\tcreateGhost: createGhost,\r\n\t\tonDragStart: () => onDragStart(sidebar),\r\n\t\tonDragEnd: (event, draggable, options) => onDragEnd(sheet, options),\r\n\t\tdroppables: [\r\n\t\t\tcontainersDroppable(tab, sheet),\r\n\t\t\totherEquipmentDroppable(tab, sheet),\r\n\t\t\tlargeEquipmentDroppable(tab, sheet),\r\n\t\t\titemsListDroppable(tab, sheet),\r\n\t\t\titemsGridDroppable(tab, sheet),\r\n\t\t],\r\n\t});\r\n}\r\n\r\nasync function onItemDetails(event, actor, itemElement, sidebar) {\r\n\tif (dragging) return;\r\n\r\n\tlet details = itemElement.dataset.details;\r\n\r\n\tif (!details) {\r\n\t\tconst item = getItemFromElement(actor, itemElement);\r\n\t\tif (!item) return;\r\n\r\n\t\tdetails = await render(\"inventory/details\", { item });\r\n\t\titemElement.dataset.details = details;\r\n\t}\r\n\r\n\tsidebar.innerHTML = details;\r\n\tsidebar.classList.remove(\"hidden\");\r\n}\r\n\r\nfunction onDragStart(sidebar) {\r\n\tdragging = true;\r\n\tsidebar.classList.add(\"hidden\");\r\n}\r\n\r\n/**\r\n * @param {*} sheet\r\n * @param {Parameters<DraggableDragEndFunction>[2]} options\r\n */\r\nfunction onDragEnd(sheet, { dropped, canceled }) {\r\n\tdragging = false;\r\n\tif (canceled || !dropped) return;\r\n\tsetInMemory(sheet, \"inventory.requireSave\", true);\r\n}\r\n\r\n/** @type {DraggableGhostFunction} */\r\nfunction createGhost(dragged, draggedIndex) {\r\n\treturn dragged.parentElement.dataset.area === \"items-grid\"\r\n\t\t? { element: dragged, index: draggedIndex }\r\n\t\t: undefined;\r\n}\r\n\r\n/** @param {DraggableObj} */\r\nfunction checkIdentifier(draggable) {\r\n\tif (draggable.identifier === dragIdentifier) return true;\r\n\terror(\"inventory.identifier.error\");\r\n\treturn false;\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsGridDroppable(html, sheet) {\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tif (\r\n\t\t\tdroppable.element === draggable.element ||\r\n\t\t\tdroppable.element === draggable.ghost\r\n\t\t) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst ghost = draggable.ghost;\r\n\t\tconst index = getElementIndex(droppable.element);\r\n\t\tconst target =\r\n\t\t\tghost.index >= index\r\n\t\t\t\t? droppable.element\r\n\t\t\t\t: droppable.element.nextElementSibling;\r\n\r\n\t\tdroppable.element.parentElement.insertBefore(ghost.element, target);\r\n\t\tghost.index = index;\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tconst parentGrid = droppable.element.parentElement;\r\n\t\tif (!parentGrid) return;\r\n\r\n\t\tconst isItem = closestInside(droppable.triggeringElement, parentGrid, {\r\n\t\t\tselector: \"[data-item-id]\",\r\n\t\t});\r\n\t\tif (isItem) return;\r\n\r\n\t\tconst parentList = parentGrid.parentElement;\r\n\t\tif (!parentList.contains(droppable.triggeringElement)) return;\r\n\r\n\t\tparentGrid.appendChild(draggable.ghost.element);\r\n\t\tdraggable.ghost.index = Infinity;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-grid'] [data-item-id]\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction itemsListDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst isItem = closestInside(\r\n\t\t\tdroppable.triggeringElement,\r\n\t\t\tdroppable.element,\r\n\t\t\t{\r\n\t\t\t\tselector: \"[data-item-id]\",\r\n\t\t\t},\r\n\t\t);\r\n\t\tif (isItem) return;\r\n\r\n\t\tdroppable.element\r\n\t\t\t.querySelector(\"[data-area='items-grid']\")\r\n\t\t\t.appendChild(draggable.ghost.element);\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragLeave(event, draggable, droppable) {\r\n\t\tdraggable.ghost.reset();\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return false;\r\n\r\n\t\tconst updates = [];\r\n\r\n\t\tif (draggable.element === draggable.ghost.element) {\r\n\t\t\tdraggable.ghost.classList.purge();\r\n\t\t\tcleanContainerItem(draggable.element);\r\n\t\t} else {\r\n\t\t\tmoveItemToContainer({\r\n\t\t\t\thtml,\r\n\t\t\t\tupdates,\r\n\t\t\t\titem,\r\n\t\t\t\t...draggable,\r\n\t\t\t\ttarget: draggable.ghost.element,\r\n\t\t\t});\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t\tdraggable.ghost.reset();\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-area='items-list']\",\r\n\t\tonDragEnter,\r\n\t\tonDragLeave,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction largeEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\tconst rightHand = html.find(\"[data-equipped-slot=right-hand]\")[0];\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst slot = droppable.element.dataset.equippedSlot;\r\n\r\n\t\tif (\r\n\t\t\tslot === draggable.parent.dataset.equippedSlot ||\r\n\t\t\tdroppable.element.querySelector(\"[data-two-hands]\")\r\n\t\t) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canDrop = slot === \"armor\" ? item.isOfType(\"armor\") : true;\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tslot,\r\n\t\t\tcanDrop,\r\n\t\t};\r\n\t}\r\n\r\n\tfunction moveItemToSlot({\r\n\t\tupdates,\r\n\t\titem,\r\n\t\telement,\r\n\t\tdrop,\r\n\t\tnoTwoHand = false,\r\n\t\tnoUpdate = false,\r\n\t}) {\r\n\t\tconst dropSlot = drop instanceof HTMLElement ? drop : drop.element;\r\n\t\tconst slot = dropSlot.dataset.equippedSlot;\r\n\t\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\t\tconst isOneHand = isOneHanded(item);\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\t\tconst canInvest = canBeInvested(item);\r\n\r\n\t\tdropSlot.appendChild(movable);\r\n\r\n\t\tconst move = (carryType, handsHeld, inSlot, invested) => {\r\n\t\t\tif (!noUpdate) {\r\n\t\t\t\tupdates.push(\r\n\t\t\t\t\titemCarryUpdate(item, {\r\n\t\t\t\t\t\tcarryType,\r\n\t\t\t\t\t\thandsHeld,\r\n\t\t\t\t\t\tinSlot,\r\n\t\t\t\t\t\tinvested,\r\n\t\t\t\t\t\tcontainerId: null,\r\n\t\t\t\t\t}),\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tmovable.classList.toggle(\"invested\", canInvest && invested);\r\n\t\t};\r\n\r\n\t\tif (slot === \"armor\") {\r\n\t\t\tmove(\"worn\", 0, true, true);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tif (slot === \"right-hand\") {\r\n\t\t\tmove(\"held\", 1, false, isOneHand);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tmove(\r\n\t\t\t\"held\",\r\n\t\t\tisTwoHand && !noTwoHand ? 2 : 1,\r\n\t\t\tfalse,\r\n\t\t\tisHeld(item) && (!isTwoHand || !noTwoHand),\r\n\t\t);\r\n\t}\r\n\r\n\t/** @param {HTMLElement | {element: HTMLElement}} */\r\n\tfunction getSlottedItem(slot) {\r\n\t\tconst slotElement = slot instanceof HTMLElement ? slot : slot.element;\r\n\t\tconst element = slotElement.querySelector(\"[data-item-id]\");\r\n\t\tconst item = getItemFromElement(actor, element);\r\n\t\treturn { element, item };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\r\n\t\tif (canDrop !== undefined) {\r\n\t\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t\t}\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { item, canDrop, slot } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = [];\r\n\t\tconst slotted = getSlottedItem(droppable);\r\n\t\tconst dragArea = draggable.parent.dataset.area;\r\n\t\tconst dragSlot = draggable.parent.dataset.equippedSlot;\r\n\t\tconst isTwoHand = isTwoHanded(item);\r\n\r\n\t\tlet noUpdate = false;\r\n\r\n\t\tif (dragArea === \"equipped\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({ html, updates, ...slotted });\r\n\t\t\t}\r\n\t\t} else if (dragArea === \"items-grid\") {\r\n\t\t\tif (slot === \"left-hand\" && isTwoHand) {\r\n\t\t\t\tconst otherSlotted = getSlottedItem(rightHand);\r\n\t\t\t\tif (otherSlotted.item) {\r\n\t\t\t\t\tmoveItemToContainer({ html, updates, ...otherSlotted });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\ttarget: draggable.element,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (dragSlot === \"armor\") {\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tif (slotted.item.isOfType(\"armor\")) {\r\n\t\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\t});\r\n\t\t\t\t} else {\r\n\t\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\t\thtml,\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t...slotted,\r\n\t\t\t\t\t});\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else if (slot === \"right-hand\") {\r\n\t\t\tnoUpdate = true;\r\n\t\t\tif (slotted.item) {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t\tnoTwoHand: true,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t} else if (slotted.item) {\r\n\t\t\tif (isTwoHand) {\r\n\t\t\t\tmoveItemToContainer({\r\n\t\t\t\t\thtml,\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tmoveItemToSlot({\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t...slotted,\r\n\t\t\t\t\tdrop: draggable.parent,\r\n\t\t\t\t\tnoUpdate: true,\r\n\t\t\t\t});\r\n\t\t\t\tnoUpdate = true;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tmoveItemToSlot({\r\n\t\t\tupdates,\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\tdrop: droppable,\r\n\t\t\tnoUpdate,\r\n\t\t});\r\n\r\n\t\tif (slot === \"left-hand\" || dragSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped] .main-items\")[0],\r\n\t\tselector: \"[data-equipped-slot]\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @return {DroppableObj} */\r\nfunction otherEquipmentDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tif (draggable.parent === droppable.element) {\r\n\t\t\treturn { canDrop: undefined };\r\n\t\t}\r\n\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (\r\n\t\t\t!item.isIdentified ||\r\n\t\t\t!(item.isOfType(\"equipment\") || isHandwrapsOfMightyBlows(item))\r\n\t\t) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\tconst canInvest = canBeInvested(item);\r\n\t\tconst canEquip = hasWornSlot(item);\r\n\t\tif (!canInvest && !canEquip) {\r\n\t\t\treturn { canDrop: false };\r\n\t\t}\r\n\r\n\t\treturn { canDrop: true, item, canInvest };\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop, canInvest } = getData(draggable, droppable);\r\n\t\tif (canDrop === undefined) return;\r\n\r\n\t\tdroppable.classList.add(\"show\");\r\n\t\tdroppable.classList.toggle(\"add-forbidden\", !canDrop);\r\n\t\tdroppable.classList.toggle(\"add-invest\", canDrop && canInvest);\r\n\t\tdroppable.classList.toggle(\"add-equip\", canDrop && !canInvest);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, canInvest, item } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tdroppable.element.appendChild(draggable.element);\r\n\t\tdraggable.element.classList.toggle(\"invested\", canInvest);\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", [\r\n\t\t\titemCarryUpdate(item, {\r\n\t\t\t\tcontainerId: null,\r\n\t\t\t\tinSlot: true,\r\n\t\t\t\tinvested: true,\r\n\t\t\t}),\r\n\t\t]);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html.find(\"[data-area=equipped]\")[0],\r\n\t\tfilter: \".main-items\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\n/** @returns {DroppableOptions} */\r\nfunction containersDroppable(html, sheet) {\r\n\tconst actor = sheet.actor;\r\n\r\n\t/**\r\n\t * @param {DraggableObj} draggable\r\n\t * @param {DroppableObj} droppable\r\n\t */\r\n\tfunction getData(draggable, droppable) {\r\n\t\tconst item = getItemFromElement(actor, draggable);\r\n\t\tif (!item) return { canDrop: false };\r\n\r\n\t\tconst containerId = droppable.element.dataset.containerId;\r\n\r\n\t\tif (containerId === \"undefined\") return { item, canDrop: true };\r\n\r\n\t\tconst container = actor.items.get(containerId);\r\n\t\tif (!container) return { canDrop: false };\r\n\r\n\t\tconst capacity = container.capacity;\r\n\t\tconst remaining = capacity.max.minus(capacity.value);\r\n\r\n\t\treturn {\r\n\t\t\titem,\r\n\t\t\tcontainer,\r\n\t\t\tcanDrop: remaining.value >= item.bulk.value,\r\n\t\t};\r\n\t}\r\n\r\n\t/** @type {DroppableFunction} */\r\n\tfunction onDragEnter(event, draggable, droppable) {\r\n\t\tconst { canDrop } = getData(draggable, droppable);\r\n\t\tdroppable.classList.toggle(\"valid\", canDrop);\r\n\t\tdroppable.classList.toggle(\"invalid\", !canDrop);\r\n\t}\r\n\r\n\t/** @type {DroppableDropFunction} */\r\n\tasync function onDrop(event, draggable, droppable) {\r\n\t\tif (!checkIdentifier(draggable)) return false;\r\n\r\n\t\tconst { canDrop, item, container } = getData(draggable, droppable);\r\n\t\tif (!canDrop) return false;\r\n\r\n\t\tconst updates = moveItemToContainer({\r\n\t\t\thtml,\r\n\t\t\tupdates: [],\r\n\t\t\titem,\r\n\t\t\telement: draggable,\r\n\t\t\ttarget: container,\r\n\t\t});\r\n\r\n\t\tif (draggable.parent.dataset.equippedSlot === \"left-hand\") {\r\n\t\t\tcheckForTwoHandedSlots(html, actor);\r\n\t\t}\r\n\r\n\t\tawait actor.updateEmbeddedDocuments(\"Item\", updates);\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn {\r\n\t\telement: html[0],\r\n\t\tselector: \"[data-container-id]\",\r\n\t\tfilter: \".back\",\r\n\t\tpurgeOnLeave: true,\r\n\t\tonDragEnter,\r\n\t\tonDrop,\r\n\t};\r\n}\r\n\r\nfunction cleanContainerItem(item) {\r\n\titem.classList.remove(\"invested\");\r\n\titem.querySelector(\".vignette.hands\")?.remove();\r\n}\r\n\r\nfunction moveItemToContainer({ html, updates, item, element, target }) {\r\n\tconst targetIsElement = target instanceof HTMLElement;\r\n\tconst movable = element instanceof HTMLElement ? element : element.element;\r\n\r\n\tlet containerId = targetIsElement\r\n\t\t? target.closest(\"[data-tab-id]\").dataset.tabId\r\n\t\t: target instanceof Item\r\n\t\t  ? target.id\r\n\t\t  : target;\r\n\r\n\tcleanContainerItem(movable);\r\n\r\n\tif (targetIsElement) {\r\n\t\ttarget.before(movable);\r\n\t} else {\r\n\t\thtml\r\n\t\t\t.find(`.container-tab[data-tab-id=${containerId}] [data-area=items-grid]`)\r\n\t\t\t.append(movable);\r\n\t}\r\n\r\n\tcontainerId = [undefined, \"undefined\"].includes(containerId)\r\n\t\t? null\r\n\t\t: containerId;\r\n\r\n\tupdates.push(\r\n\t\titemCarryUpdate(item, {\r\n\t\t\tcontainerId: containerId,\r\n\t\t\tinSlot: false,\r\n\t\t\tinvested: false,\r\n\t\t\tcarryType: containerId ? \"stowed\" : \"worn\",\r\n\t\t\thandsHeld: 0,\r\n\t\t}),\r\n\t);\r\n\r\n\treturn updates;\r\n}\r\n\r\nfunction checkForTwoHandedSlots(html, actor) {\r\n\t/** @type {HTMLElement} */\r\n\tconst equipped = html.find(\"[data-area='equipped'] .main-items\")[0];\r\n\tconst leftHand = equipped.querySelector(\"[data-equipped-slot='left-hand']\");\r\n\tconst rightHand = equipped.querySelector(\"[data-equipped-slot='right-hand']\");\r\n\tconst leftSlotted = leftHand.querySelector(\"[data-item-id]\");\r\n\tconst rightSlotted = rightHand.querySelector(\".item:not(.fake)\");\r\n\tconst item = getItemFromElement(actor, leftSlotted);\r\n\tconst isTwoHand = !!item && isTwoHanded(item);\r\n\r\n\tif (!isTwoHand && rightSlotted?.dataset.twoHands) {\r\n\t\trightSlotted.remove();\r\n\t} else if (isTwoHand && !rightSlotted) {\r\n\t\t/** @type {HTMLElement} */\r\n\t\tconst clone = leftSlotted.cloneNode(true);\r\n\t\tclone.dataset.twoHands = \"true\";\r\n\t\trightHand.appendChild(clone);\r\n\t}\r\n}\r\n\r\n/** @param {HTMLElement | {element: HTMLElement}} */\r\nfunction getItemFromElement(actor, element) {\r\n\tif (!element) return;\r\n\r\n\tconst el = element instanceof HTMLElement ? element : element.element;\r\n\tconst { itemId, containerId } = el.dataset;\r\n\tconst id = itemId ?? containerId;\r\n\r\n\tif (id) return actor.items.get(id);\r\n}\r\n", "import { getFlag, setFlag, subLocalize, templatePath } from \"module-api\";\r\n\r\nconst localize = subLocalize(\"knowledges.editLore\");\r\n\r\nexport class EditLores extends FormApplication {\r\n\tget actor() {\r\n\t\treturn this.object;\r\n\t}\r\n\r\n\tget id() {\r\n\t\treturn `npc-edit-lores-${this.actor.id}`;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.actor);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"knowledges/lores\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\tconst actor = this.actor;\r\n\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\tunspecified: getFlag(actor, \"knowledges.unspecified\") ?? \"\",\r\n\t\t\tspecific: getFlag(actor, \"knowledges.specific\") ?? \"\",\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tasync _updateObject(event, { unspecified, specific }) {\r\n\t\tconst actor = this.object;\r\n\t\tsetFlag(actor, \"knowledges.unspecified\", unspecified.trim());\r\n\t\tsetFlag(actor, \"knowledges.specific\", specific.trim());\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"button.cancel\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import { getFlag, getSetting } from \"module-api\";\r\nimport { isPlayedActor } from \"../actor\";\r\nimport { EditLores } from \"../apps/knowledges/lores\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst setHook = createHook(\"renderNPCSheetPF2e\", renderNPCSheetPF2e);\r\n\r\nexport function registerKnowledges() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"knowledges\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: (value) => setHook(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-npc-knowledges\"],\r\n\t\tready: (isGM) => {\r\n\t\t\tif (isGM && getSetting(\"knowledges\")) setHook(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction renderNPCSheetPF2e(sheet, $html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\treplaceLores(actor, $html);\r\n\taddEditButton($html);\r\n\taddEvents(actor, $html);\r\n}\r\n\r\nfunction knowledgeSelector(html, section, selector) {\r\n\treturn html.find(\r\n\t\t`[data-tab=\"main\"] .recall-knowledge ${\r\n\t\t\tsection === \"header\" ? \".section-header\" : \".section-body\"\r\n\t\t} ${selector}`,\r\n\t);\r\n}\r\n\r\nfunction editLores(actor) {\r\n\tnew EditLores(actor).render(true);\r\n}\r\n\r\nfunction replaceLores(actor, html) {\r\n\tconst unspecifics = getFlag(actor, \"knowledges.unspecified\");\r\n\tconst specifics = getFlag(actor, \"knowledges.specific\");\r\n\tif (!unspecifics && !specifics) return;\r\n\r\n\tconst lores = actor.identificationDCs.lore;\r\n\tconst body = knowledgeSelector(html, \"body\", \"\");\r\n\tbody.find(\".identification-skills\").last().remove();\r\n\r\n\tfunction tag(skills, dc, adjustment) {\r\n\t\tconst content = game.i18n.format(\r\n\t\t\t\"PF2E.Actor.NPC.Identification.Skills.Label\",\r\n\t\t\t{ skills, dc, adjustment },\r\n\t\t);\r\n\t\treturn `<div class=\"tag-legacy identification-skills tooltipstered\">${content}</div>`;\r\n\t}\r\n\r\n\tfunction addTags(lores, { dc, start }) {\r\n\t\tconst tags = lores\r\n\t\t\t.split(\",\")\r\n\t\t\t.filter((lore) => lore.trim())\r\n\t\t\t.map((lore) => tag(lore, dc, start))\r\n\t\t\t.join(\"\");\r\n\t\tbody.append(tags);\r\n\t}\r\n\r\n\taddTags(unspecifics || \"Unspecific\", lores[0]);\r\n\taddTags(specifics || \"Specific\", lores[1]);\r\n}\r\n\r\nfunction addEvents(actor, html) {\r\n\tconst edit = knowledgeSelector(html, \"header\", \"button.edit\");\r\n\tedit.on(\"click\", () => editLores(actor));\r\n}\r\n\r\nfunction addEditButton(html) {\r\n\tconst attempts = knowledgeSelector(html, \"header\", \"button\");\r\n\tconst edit = '<button type=\"button\" class=\"breakdown edit\">Edit</button>';\r\n\tattempts.before(edit);\r\n}\r\n", "import {\r\n\tErrorPF2e,\r\n\tflagPath,\r\n\tgetFlag,\r\n\tgetSetting,\r\n\tgetTabResults,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetFlag,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport { wrapperError } from \"../misc\";\r\n\r\nconst localize = subLocalize(\"merchant\");\r\n\r\nconst ITEM_PREPARE_DERIVED_DATA =\r\n\t\"CONFIG.Item.documentClass.prototype.prepareDerivedData\";\r\nconst LOOT_TRANSFER_ITEM_TO_ACTOR =\r\n\t\"CONFIG.PF2E.Actor.documentClasses.loot.prototype.transferItemToActor\";\r\n\r\nconst PULL_LIMIT = 100;\r\n\r\nconst RATIO_MAX = 5;\r\nconst RATIO_MIN = 0.1;\r\nconst RATIO_STEP = 0.1;\r\n\r\nexport function registerMerchant() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"merchant\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: (isGM) => {\r\n\t\t\tif (!getSetting(\"merchant\")) return;\r\n\r\n\t\t\tHooks.on(\"renderLootSheetPF2e\", (...args) =>\r\n\t\t\t\trenderLootSheetPF2e(isGM, ...args),\r\n\t\t\t);\r\n\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tITEM_PREPARE_DERIVED_DATA,\r\n\t\t\t\titemPrepareDerivedData,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tLOOT_TRANSFER_ITEM_TO_ACTOR,\r\n\t\t\t\tlootTranferItemToActor,\r\n\t\t\t\t\"OVERRIDE\",\r\n\t\t\t);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nasync function renderLootSheetPF2e(isGM, sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!actor?.isMerchant) return;\r\n\r\n\tconst {\r\n\t\tnoCoins = false,\r\n\t\tpriceRatio = 1,\r\n\t\tinfiniteStocks = false,\r\n\t\tinfiniteItems = {},\r\n\t} = getFlag(actor, \"merchant\") ?? {};\r\n\r\n\tif (isGM) {\r\n\t\tconst sheetTemplate = await render(\"merchant/sheet\", {\r\n\t\t\tnoCoins,\r\n\t\t\tinfiniteStocks,\r\n\t\t\tpriceRatio: {\r\n\t\t\t\tvalue: clampRatio(priceRatio),\r\n\t\t\t\tmax: RATIO_MAX,\r\n\t\t\t\tmin: RATIO_MIN,\r\n\t\t\t\tstep: RATIO_STEP,\r\n\t\t\t},\r\n\t\t\tactorUUID: actor.uuid,\r\n\t\t\t...localize.i18n,\r\n\t\t\tflagPath: (str) => flagPath(\"merchant\", str),\r\n\t\t});\r\n\r\n\t\tconst sidebar = html.find(\".sheet-sidebar\");\r\n\r\n\t\tsidebar.find(\".editor\").before(sheetTemplate);\r\n\r\n\t\tconst better = sidebar.find(\".better-merchant\");\r\n\t\tbetter\r\n\t\t\t.find(\"[data-action=pull-from-browser]\")\r\n\t\t\t.on(\"click\", (event) => pullFromBrowser(event, actor));\r\n\t\tbetter\r\n\t\t\t.find(\"[data-action=open-equipment-tab]\")\r\n\t\t\t.on(\"click\", (event) => opentEquipmentTab());\r\n\t}\r\n\r\n\tconst itemTypes = html\r\n\t\t.find(\".content .sheet-body [data-item-types]\")\r\n\t\t.filter(\"[data-item-types!=treasure]\");\r\n\r\n\tlet hasInfiniteStock = infiniteStocks;\r\n\r\n\tif (infiniteStocks && isGM) {\r\n\t\titemTypes.find(\".quantity a\").remove();\r\n\t} else if (!infiniteStocks) {\r\n\t\tconst items = itemTypes.find(\"[data-item-id]\");\r\n\t\tconst tooltip = localize.path(\"infinite-item.tooltip\");\r\n\r\n\t\tfor (const item of items) {\r\n\t\t\tconst itemId = item.dataset.itemId;\r\n\t\t\tconst isInfinite = !!infiniteItems[itemId];\r\n\r\n\t\t\tif (isGM) {\r\n\t\t\t\tconst toggle =\r\n\t\t\t\t\t$(`<a data-action=\"toggle-infinite-item\" data-tooltip=\"${tooltip}\">\r\n\t<i class=\"${isInfinite ? \"fa-solid\" : \"fa-duotone\"} fa-infinity\"></i>\r\n</a>`)[0];\r\n\r\n\t\t\t\titem.querySelector(\".item-controls\").prepend(toggle);\r\n\r\n\t\t\t\tif (isInfinite) {\r\n\t\t\t\t\tfor (const el of item.querySelectorAll(\".quantity a\")) {\r\n\t\t\t\t\t\tel.remove();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\ttoggle.addEventListener(\"click\", (event) => {\r\n\t\t\t\t\tconst flagKey = `merchant.infiniteItems.${itemId}`;\r\n\t\t\t\t\tconst current = getFlag(actor, flagKey) ?? false;\r\n\t\t\t\t\tsetFlag(actor, flagKey, !current);\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (isInfinite) {\r\n\t\t\t\thasInfiniteStock = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (hasInfiniteStock) {\r\n\t\thtml.find(\".content .sheet-body .coinage .wealth h3:last span\").html(\"-\");\r\n\r\n\t\thtml.find(\".content .sheet-body .total-bulk span\").html(\r\n\t\t\tgame.i18n.format(\"PF2E.Actor.Inventory.TotalBulk\", {\r\n\t\t\t\tbulk: \"-\",\r\n\t\t\t}),\r\n\t\t);\r\n\t}\r\n}\r\n\r\nfunction itemPrepareDerivedData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (!this.isOfType(\"physical\") || this.isOfType(\"treasure\")) return;\r\n\r\n\t\tconst actor = this.actor;\r\n\t\tif (!actor?.isMerchant) return;\r\n\r\n\t\tconst actorFlags = getFlag(actor, \"merchant\");\r\n\t\tif (!actorFlags) return;\r\n\r\n\t\tconst { priceRatio, infiniteStocks, infiniteItems = {} } = actorFlags;\r\n\r\n\t\tif (typeof priceRatio === \"number\" && priceRatio !== 1) {\r\n\t\t\tconst ratio = clampRatio(priceRatio);\r\n\t\t\tthis.system.price.value = this.system.price.value.scale(ratio);\r\n\t\t}\r\n\r\n\t\tconst isInfinite = (() => {\r\n\t\t\tif (typeof infiniteStocks === \"boolean\" && infiniteStocks) {\r\n\t\t\t\treturn true;\r\n\t\t\t}\r\n\t\t\tconst infiniteItem = infiniteItems[this.id];\r\n\t\t\treturn typeof infiniteItem === \"boolean\" && infiniteItem;\r\n\t\t})();\r\n\r\n\t\tif (isInfinite) {\r\n\t\t\tthis.system.quantity = 9999;\r\n\t\t}\r\n\t} catch (error) {\r\n\t\twrapperError(\"merchant\", ITEM_PREPARE_DERIVED_DATA);\r\n\t}\r\n}\r\n\r\nasync function lootTranferItemToActor(...args) {\r\n\tconst [targetActor, item, quantity, containerId, newStack = false] = args;\r\n\tconst thisSuper = Actor.implementation.prototype;\r\n\r\n\tif (!(this.isOwner && targetActor.isOwner)) {\r\n\t\treturn thisSuper.transferItemToActor.apply(this, args);\r\n\t}\r\n\tif (this.isMerchant && item.isOfType(\"physical\")) {\r\n\t\tconst itemValue = game.pf2e.Coins.fromPrice(item.price, quantity);\r\n\t\tif (await targetActor.inventory.removeCoins(itemValue)) {\r\n\t\t\tif (!getFlag(this, \"merchant.noCoins\")) {\r\n\t\t\t\tawait item.actor.inventory.addCoins(itemValue);\r\n\t\t\t}\r\n\t\t\treturn thisSuper.transferItemToActor.apply(this, args);\r\n\t\t}\r\n\t\tif (this.isLoot) {\r\n\t\t\tthrow ErrorPF2e(\"Loot transfer failed\");\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\r\n\treturn thisSuper.transferItemToActor.apply(this, args);\r\n}\r\n\r\nfunction opentEquipmentTab() {\r\n\tconst browser = game.pf2e.compendiumBrowser;\r\n\tconst tab = browser.tabs.equipment;\r\n\tconst data = tab.isInitialized ? tab.filterData : undefined;\r\n\tbrowser.openTab(\"equipment\", data);\r\n}\r\n\r\nfunction pullFromBrowser(event, actor) {\r\n\tconst browser = game.pf2e.compendiumBrowser;\r\n\r\n\tconst tab = browser.tabs.equipment;\r\n\tif (!tab.isInitialized) {\r\n\t\tlocalize.warn(\"browser.noTab\");\r\n\t\topentEquipmentTab();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst nb = tab.currentIndex.length;\r\n\tif (nb > PULL_LIMIT) {\r\n\t\tlocalize.error(\"browser.limit\", { limit: PULL_LIMIT });\r\n\t\topentEquipmentTab();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst name = actor.name;\r\n\tconst msg = localize(\"browser.dialogMsg\", { nb, name });\r\n\r\n\tDialog.confirm({\r\n\t\tcontent: `<div style=\"margin-bottom: 0.5em;\">${msg}</div>`,\r\n\t\ttitle: `${name} - ${localize(\"browser.pull\")}`,\r\n\t\tyes: async (html) => {\r\n\t\t\tlocalize.info(\"browser.wait\");\r\n\t\t\tconst results = (await getTabResults(tab)).filter(Boolean);\r\n\t\t\tactor.createEmbeddedDocuments(\"Item\", results);\r\n\t\t},\r\n\t});\r\n}\r\n\r\nfunction clampRatio(value) {\r\n\treturn Math.clamped(value, RATIO_MIN, RATIO_MAX);\r\n}\r\n", "import { getFlag, updateSourceFlag } from \"module-api\";\r\n\r\nexport function bindOnPreCreateSpellDamageChatMessage(originalMessage) {\r\n\tconst messageId = originalMessage.id;\r\n\tconst save = getFlag(originalMessage, \"target.save\");\r\n\tif (!save) return;\r\n\r\n\tHooks.once(\"preCreateChatMessage\", (message) => {\r\n\t\tupdateSourceFlag(message, \"target.messageId\", messageId);\r\n\t\tupdateSourceFlag(message, \"target.save\", save);\r\n\t});\r\n}\r\n", "import { subLocalize, templatePath } from \"module-api\";\r\nimport { bindOnPreCreateSpellDamageChatMessage } from \"../../chat\";\r\n\r\nconst localize = subLocalize(\"merge.multi\");\r\n\r\nexport class MultiCast extends Application {\r\n\t#message;\r\n\t#event;\r\n\r\n\tconstructor(event, message, options) {\r\n\t\tsuper(options);\r\n\t\tthis.#event = event;\r\n\t\tthis.#message = message;\r\n\t}\r\n\r\n\tget title() {\r\n\t\treturn localize(\"title\", this.#message.item);\r\n\t}\r\n\r\n\tget template() {\r\n\t\treturn templatePath(\"merge/multi\");\r\n\t}\r\n\r\n\tgetData(options) {\r\n\t\treturn mergeObject(super.getData(options), {\r\n\t\t\ti18n: localize.template,\r\n\t\t});\r\n\t}\r\n\r\n\tactivateListeners(html) {\r\n\t\thtml.find(\"[data-action=cast]\").on(\"click\", this.#onCast.bind(this));\r\n\t\thtml.find(\"[data-action=cancel]\").on(\"click\", this.#onCancel.bind(this));\r\n\t}\r\n\r\n\tasync #onCast(event) {\r\n\t\tevent.preventDefault();\r\n\r\n\t\tconst nb = this.element.find(\"[name=multi]\").val();\r\n\t\tif (nb < 1) {\r\n\t\t\tlocalize.error(\"zero\");\r\n\t\t\tthis.close();\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst message = this.#message;\r\n\t\tif (!message) return;\r\n\r\n\t\tconst spell = message.item;\r\n\t\tconst actor = message.actor;\r\n\t\tif (!actor || !spell) return;\r\n\r\n\t\tconst updateSource = (damages, heightening) => {\r\n\t\t\tfor (const [id, damage] of Object.entries(damages)) {\r\n\t\t\t\tfor (let i = 0; i < nb - 1; i++) {\r\n\t\t\t\t\tconst newId = randomID();\r\n\r\n\t\t\t\t\tdamages[newId] = damage;\r\n\r\n\t\t\t\t\tif (heightening.type === \"interval\") {\r\n\t\t\t\t\t\tconst damage = heightening.damage[id];\r\n\t\t\t\t\t\tif (damage) heightening.damage[newId] = damage;\r\n\t\t\t\t\t} else if (heightening.type === \"fixed\") {\r\n\t\t\t\t\t\tfor (const data of Object.values(heightening.levels)) {\r\n\t\t\t\t\t\t\tconst damage = data.damage[id];\r\n\t\t\t\t\t\t\tif (!damage) continue;\r\n\t\t\t\t\t\t\tdata.damage[newId] = damage;\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tconst embeddedSource = deepClone(message.flags.pf2e.casting?.embeddedSpell);\r\n\r\n\t\tif (embeddedSource) {\r\n\t\t\tconst damages = embeddedSource.system.damage;\r\n\r\n\t\t\tembeddedSource.system.heightening ??= {};\r\n\t\t\tconst heightening = embeddedSource.system.heightening;\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = new Item.implementation(embeddedSource, {\r\n\t\t\t\tparent: actor,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.trickMagicEntry = spell.trickMagicEntry;\r\n\r\n\t\t\tconst overlayIds = message.getFlag(\"pf2e\", \"origin.variant.overlays\");\r\n\t\t\tconst castRank = message.getFlag(\"pf2e\", \"origin.castRank\") ?? spell.rank;\r\n\t\t\tconst modifiedSpell = newSpell.loadVariant({ overlayIds, castRank });\r\n\t\t\tconst castSpell = modifiedSpell ?? newSpell;\r\n\r\n\t\t\tcastSpell.rollDamage(this.#event);\r\n\t\t} else {\r\n\t\t\tconst spellSource = spell.toObject();\r\n\t\t\tconst damages = spellSource.system.damage;\r\n\t\t\tconst heightening = spellSource.system.heightening ?? {};\r\n\r\n\t\t\tupdateSource(damages, heightening);\r\n\r\n\t\t\tconst newSpell = spell.clone({\r\n\t\t\t\t\"system.damage\": damages,\r\n\t\t\t\t\"system.heightening\": heightening,\r\n\t\t\t});\r\n\r\n\t\t\tnewSpell.rollDamage(this.#event);\r\n\t\t}\r\n\r\n\t\tif (spell.damageKinds.size) {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t}\r\n\r\n\t\tthis.close();\r\n\t}\r\n\r\n\t#onCancel(event) {\r\n\t\tevent.preventDefault();\r\n\t\tthis.close();\r\n\t}\r\n}\r\n", "import {\r\n\tMODULE,\r\n\tcompareArrays,\r\n\tgetDamageRollClass,\r\n\tgetFlag,\r\n\tgetSetting,\r\n\tlatestChatMessages,\r\n\tlocalize,\r\n\trender,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { MultiCast } from \"../apps/merge/multi\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst setHook = createHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n\tupdateMessages,\r\n);\r\n\r\nexport function registerMerge() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"merge-damage\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"multi-cast\"),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"multi-cast\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) => setHook(value, \"merge-damage\"),\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: (isGm) => {\r\n\t\t\tsetHook(false, [\"multi-cast\", \"merge-damage\"], true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction updateMessages() {\r\n\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\thtml.find(\"[data-action=multi-cast]\").remove();\r\n\t\thtml.find(\"[data-action=merge-damage]\").remove();\r\n\t\trenderChatMessage(message, html);\r\n\t}\r\n}\r\n\r\nfunction renderChatMessage(message, html) {\r\n\tif (!game.user.isGM && !message.isAuthor) return;\r\n\r\n\tif (getSetting(\"merge-damage\") && isDamageRoll(message))\r\n\t\trenderDamage(message, html);\r\n\telse if (\r\n\t\tgetSetting(\"multi-cast\") &&\r\n\t\tmessage.getFlag(\"pf2e\", \"origin.type\") === \"spell\"\r\n\t)\r\n\t\trenderSpell(message, html);\r\n}\r\n\r\nfunction renderSpell(message, html) {\r\n\tconst item = message.item;\r\n\tif (!item) return;\r\n\r\n\tconst spellBtn = html.find(\r\n\t\t\".message-content .chat-card .owner-buttons .spell-button\",\r\n\t);\r\n\r\n\tspellBtn\r\n\t\t.find(\"[data-action=spell-damage]\")\r\n\t\t.after(\r\n\t\t\t`<button data-action=\"multi-cast\">${localize(\r\n\t\t\t\t\"merge.spell.button\",\r\n\t\t\t)}</button>`,\r\n\t\t);\r\n\r\n\tspellBtn.find(\"[data-action=multi-cast]\").on(\"click\", (event) => {\r\n\t\tnew MultiCast(event, message).render(true);\r\n\t});\r\n}\r\n\r\nfunction renderDamage(message, html) {\r\n\tlet buttons = '<span class=\"pf2e-toolbelt-merge\">';\r\n\r\n\tif (getFlag(message, \"merge.merged\")) {\r\n\t\tconst tooltip = localize(\"merge.damage.split-tooltip\");\r\n\t\tbuttons += `<button data-action=\"split-damage\" title=\"${tooltip}\">`;\r\n\t\tbuttons += '<i class=\"fa-duotone fa-split\"></i>';\r\n\t}\r\n\r\n\tconst tooltip = localize(\"merge.damage.tooltip\");\r\n\tbuttons += `<button data-action=\"merge-damage\" title=\"${tooltip}\">`;\r\n\tbuttons += '<i class=\"fa-duotone fa-merge\"></i></button>';\r\n\r\n\tbuttons += \"</span>\";\r\n\r\n\tconst actorUUID = getActorUUID(message);\r\n\tconst targetUUIDs = getTargetUUIDs(message);\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=merge-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\r\n\t\t\tfor (const { message: otherMessage } of latestChatMessages(5, message)) {\r\n\t\t\t\tconst otherTargetsUUIDS = getTargetUUIDs(otherMessage);\r\n\r\n\t\t\t\tif (\r\n\t\t\t\t\t!isDamageRoll(otherMessage) ||\r\n\t\t\t\t\tgetActorUUID(otherMessage) !== actorUUID ||\r\n\t\t\t\t\t!compareArrays(\r\n\t\t\t\t\t\ttargetUUIDs?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t\totherTargetsUUIDS?.map((t) => t.actor).filter(Boolean),\r\n\t\t\t\t\t)\r\n\t\t\t\t)\r\n\t\t\t\t\tcontinue;\r\n\r\n\t\t\t\tmergeDamages(event, message, otherMessage, { actorUUID, targetUUIDs });\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\twarn(\"merge.damage.none\");\r\n\t\t});\r\n\r\n\thtml\r\n\t\t.find(\".pf2e-toolbelt-merge [data-action=split-damage]\")\r\n\t\t.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsplitDamages(event, message);\r\n\t\t});\r\n}\r\n\r\nasync function splitDamages(event, message) {\r\n\tconst sources = getFlag(message, \"merge.data\").flatMap((data) => data.source);\r\n\tawait removeChatMessages(message.id);\r\n\tawait ChatMessage.implementation.createDocuments(sources);\r\n}\r\n\r\nasync function mergeDamages(event, origin, other, { actorUUID, targetUUIDs }) {\r\n\tconst dataGroups = {};\r\n\r\n\tconst data = getMessageData(other).concat(getMessageData(origin));\r\n\tfor (const { name, notes, outcome, modifiers, tags } of data) {\r\n\t\tdataGroups[name] ??= {\r\n\t\t\tname,\r\n\t\t\ttags,\r\n\t\t\tnotes: new Set(),\r\n\t\t\tresults: [],\r\n\t\t};\r\n\r\n\t\tfor (const note of notes) {\r\n\t\t\tdataGroups[name].notes.add(note);\r\n\t\t}\r\n\r\n\t\tconst exists = dataGroups[name].results.some(\r\n\t\t\t(result) =>\r\n\t\t\t\tresult.outcome === outcome &&\r\n\t\t\t\tcompareArrays(result.modifiers, modifiers),\r\n\t\t);\r\n\r\n\t\tif (!exists) dataGroups[name].results.push({ outcome, modifiers });\r\n\t}\r\n\r\n\tconst groups = Object.values(dataGroups).map((group) => {\r\n\t\tgroup.label = group.name;\r\n\r\n\t\tfor (const result of group.results) {\r\n\t\t\tif (!result.outcome) continue;\r\n\t\t\tresult.label = game.i18n.localize(\r\n\t\t\t\t`PF2E.Check.Result.Degree.Attack.${result.outcome}`,\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\treturn group;\r\n\t});\r\n\r\n\tgroups.at(-1).isLastGroup = true;\r\n\r\n\tconst flavor = await render(\"merge/merged\", {\r\n\t\tgroups,\r\n\t\thasMultipleGroups: groups.length > 1,\r\n\t});\r\n\r\n\tconst originRolls = getMessageRolls(origin);\r\n\tconst otherRolls = getMessageRolls(other);\r\n\tconst groupedRolls = [];\r\n\r\n\tfor (const roll of [].concat(otherRolls, originRolls)) {\r\n\t\tconst { options, total, terms } = roll;\r\n\t\tconst term = terms[0];\r\n\t\tconst formula = roll.formula\r\n\t\t\t.replaceAll(/(\\[[\\w,-]+\\])/g, \"\")\r\n\t\t\t.replace(/^\\(/, \"\")\r\n\t\t\t.replace(/\\)$/, \"\");\r\n\t\tconst group = groupedRolls.find(\r\n\t\t\t({ options: { flavor, critRule } }) =>\r\n\t\t\t\tflavor === options.flavor && critRule === options.critRule,\r\n\t\t);\r\n\r\n\t\tif (group) {\r\n\t\t\tgroup.terms.push(term);\r\n\t\t\tgroup.total += total;\r\n\t\t\tgroup.formulas.push(formula);\r\n\t\t} else {\r\n\t\t\tgroupedRolls.push({\r\n\t\t\t\toptions,\r\n\t\t\t\tformulas: [formula],\r\n\t\t\t\ttotal,\r\n\t\t\t\tterms: [term],\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\tconst DamageRoll = getDamageRollClass();\r\n\tfor (const group of groupedRolls) {\r\n\t\tif (group.options.flavor.includes(\"persistent\")) {\r\n\t\t\tconst { index } = group.formulas.reduce(\r\n\t\t\t\t(prev, curr, index) => {\r\n\t\t\t\t\tconst value = new DamageRoll(curr).expectedValue;\r\n\t\t\t\t\tif (value <= prev.value) return prev;\r\n\t\t\t\t\treturn { value, index };\r\n\t\t\t\t},\r\n\t\t\t\t{ value: 0, index: -1 },\r\n\t\t\t);\r\n\r\n\t\t\tgroup.formulas = [group.formulas[index]];\r\n\t\t\tgroup.terms = [group.terms[index]];\r\n\t\t}\r\n\r\n\t\tgroup.formula = `(${group.formulas.join(\" + \")})[${group.options.flavor}]`;\r\n\t\tgroup.term =\r\n\t\t\tgroup.terms.length < 2 ? group.terms[0] : createTermGroup(group.terms);\r\n\t}\r\n\r\n\tconst roll = {\r\n\t\tclass: \"DamageRoll\",\r\n\t\toptions: {},\r\n\t\tdice: [],\r\n\t\tformula: `{${groupedRolls.map(({ formula }) => formula).join(\", \")}}`,\r\n\t\ttotal: groupedRolls.reduce((acc, { total }) => acc + total, 0),\r\n\t\tevaluated: true,\r\n\t\tterms: [\r\n\t\t\t{\r\n\t\t\t\tclass: \"InstancePool\",\r\n\t\t\t\toptions: {},\r\n\t\t\t\tevaluated: true,\r\n\t\t\t\tterms: groupedRolls.map(({ formula }) => formula),\r\n\t\t\t\tmodifiers: [],\r\n\t\t\t\trolls: groupedRolls.map(({ options, formula, total, term }) => ({\r\n\t\t\t\t\tclass: \"DamageInstance\",\r\n\t\t\t\t\toptions,\r\n\t\t\t\t\tdice: [],\r\n\t\t\t\t\tformula,\r\n\t\t\t\t\ttotal,\r\n\t\t\t\t\tterms: [term],\r\n\t\t\t\t\tevaluated: true,\r\n\t\t\t\t})),\r\n\t\t\t\tresults: groupedRolls.map(({ total }) => ({\r\n\t\t\t\t\tresult: total,\r\n\t\t\t\t\tactive: true,\r\n\t\t\t\t})),\r\n\t\t\t},\r\n\t\t],\r\n\t};\r\n\r\n\tif (game.modules.get(\"dice-so-nice\")?.active) {\r\n\t\tconst setHidden = (term) => {\r\n\t\t\tif (\"results\" in term) {\r\n\t\t\t\tfor (const result of term.results) {\r\n\t\t\t\t\tresult.hidden = true;\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tconst operands = (term.term ?? term).operands ?? [];\r\n\t\t\t\tfor (const operand of operands) {\r\n\t\t\t\t\tsetHidden(operand);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tfor (const r of roll.terms[0].rolls) {\r\n\t\t\tfor (const term of r.terms) {\r\n\t\t\t\tsetHidden(term);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tawait removeChatMessages(origin.id, other.id);\r\n\r\n\tawait ChatMessage.implementation.create({\r\n\t\tflavor,\r\n\t\ttype: CONST.CHAT_MESSAGE_TYPES.ROLL,\r\n\t\tspeaker: origin.speaker,\r\n\t\tflags: {\r\n\t\t\t[MODULE.id]: {\r\n\t\t\t\tmerge: {\r\n\t\t\t\t\tactor: actorUUID,\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t\tmerged: true,\r\n\t\t\t\t\ttype: \"damage-roll\",\r\n\t\t\t\t\tdata,\r\n\t\t\t\t},\r\n\t\t\t\ttarget: {\r\n\t\t\t\t\ttargets: targetUUIDs,\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t\tpf2e: {\r\n\t\t\t\tcontext: {\r\n\t\t\t\t\toptions: Array.from(\r\n\t\t\t\t\t\tnew Set(data.flatMap((entry) => entry.itemTraits)),\r\n\t\t\t\t\t),\r\n\t\t\t\t},\r\n\t\t\t},\r\n\t\t},\r\n\t\trolls: [roll],\r\n\t});\r\n}\r\n\r\nfunction getMessageData(message) {\r\n\tconst flags = getFlag(message, \"merge.data\");\r\n\tif (flags) return flags;\r\n\r\n\tconst source = message.toObject();\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source._id;\r\n\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\tdelete source.timestamp;\r\n\r\n\tconst html = $(`<div>${message.flavor}</div>`);\r\n\tconst tags = html.find(\"h4.action + .tags\").prop(\"outerHTML\");\r\n\r\n\tconst modifiers = [];\r\n\thtml.find(\".tag.tag_transparent\").each(function () {\r\n\t\tmodifiers.push(this.innerHTML);\r\n\t});\r\n\r\n\tconst notes = source.flags.pf2e.context.notes.map(\r\n\t\t({ title, text }) =>\r\n\t\t\t`<strong>${game.i18n.localize(title)}</strong> ${game.i18n.localize(\r\n\t\t\t\ttext,\r\n\t\t\t)}`,\r\n\t);\r\n\r\n\treturn [\r\n\t\t{\r\n\t\t\tsource,\r\n\t\t\tname: source.flags.pf2e.strike?.name ?? message.item.name,\r\n\t\t\toutcome: source.flags.pf2e.context.outcome,\r\n\t\t\titemTraits: source.flags.pf2e.context.options.filter((option) =>\r\n\t\t\t\t/^(item|self):/.test(option),\r\n\t\t\t),\r\n\t\t\tmodifiers,\r\n\t\t\ttags,\r\n\t\t\tnotes,\r\n\t\t},\r\n\t];\r\n}\r\n\r\nfunction removeChatMessages(...ids) {\r\n\tconst joinedIds = ids.map((id) => `[data-message-id=${id}]`).join(\", \");\r\n\tui.chat.element.find(joinedIds).remove();\r\n\treturn ChatMessage.deleteDocuments(ids);\r\n}\r\n\r\nfunction createTermGroup(terms) {\r\n\tconst options = deepClone(terms[0].options);\r\n\r\n\tfor (const term of terms) {\r\n\t\tterm.options = {};\r\n\t}\r\n\r\n\treturn {\r\n\t\tclass: \"Grouping\",\r\n\t\toptions,\r\n\t\tevaluated: true,\r\n\t\tterm: {\r\n\t\t\tclass: \"ArithmeticExpression\",\r\n\t\t\toptions: {},\r\n\t\t\tevaluated: true,\r\n\t\t\toperator: \"+\",\r\n\t\t\toperands: [\r\n\t\t\t\tterms.shift(),\r\n\t\t\t\tterms.length > 1 ? createTermGroup(terms) : terms[0],\r\n\t\t\t],\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction getMessageRolls(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.rolls\") ??\r\n\t\tJSON.parse(message._source.rolls[0]).terms[0].rolls\r\n\t);\r\n}\r\n\r\nfunction getActorUUID(message) {\r\n\treturn getFlag(message, \"merge.actor\") ?? message.actor?.uuid;\r\n}\r\n\r\nfunction getTargetUUIDs(message) {\r\n\tconst targetTargets = getFlag(message, \"target.targets\");\r\n\tif (targetTargets) return targetTargets;\r\n\r\n\tconst mergeTargets =\r\n\t\tgetFlag(message, \"merge.targets\") ?? message.getFlag(\"pf2e\", \"target\");\r\n\tif (Array.isArray(mergeTargets)) return mergeTargets;\r\n\treturn mergeTargets ? [mergeTargets] : [];\r\n}\r\n\r\nfunction isDamageRoll(message) {\r\n\treturn (\r\n\t\tgetFlag(message, \"merge.type\") === \"damage-roll\" ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"damage-roll\"\r\n\t);\r\n}\r\n", "import { getSetting, registerWrapper } from \"module-api\";\r\nimport { registerActorPreparedEmbeddedDocuments } from \"../actor\";\r\nimport { wrapperError } from \"../misc\";\r\n\r\nconst TREASURE_PREPARE_BASE_DATA =\r\n\t\"CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData\";\r\n\r\nexport function registerNobulk() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"nobulk\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"nobulk-coins\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tif (getSetting(\"nobulk\")) {\r\n\t\t\t\tregisterActorPreparedEmbeddedDocuments(\r\n\t\t\t\t\t\"nobulk\",\r\n\t\t\t\t\tactorPrepareEmbeddedDocuments,\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t\tif (getSetting(\"nobulk-coins\")) {\r\n\t\t\t\tregisterWrapper(\r\n\t\t\t\t\tTREASURE_PREPARE_BASE_DATA,\r\n\t\t\t\t\ttreasurePrepareBaseData,\r\n\t\t\t\t\t\"WRAPPER\",\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction treasurePrepareBaseData(wrapped) {\r\n\twrapped();\r\n\r\n\ttry {\r\n\t\tif (this.isCoinage) this.system.bulk.value = 0;\r\n\t} catch {\r\n\t\twrapperError(\"nobulk\", TREASURE_PREPARE_BASE_DATA);\r\n\t}\r\n}\r\n\r\nfunction actorPrepareEmbeddedDocuments() {\r\n\tconst InventoryBulk = this.inventory.bulk.constructor;\r\n\r\n\tlet _value = null;\r\n\r\n\tObject.defineProperty(this.inventory.bulk, \"value\", {\r\n\t\tget() {\r\n\t\t\tif (_value) return _value;\r\n\t\t\t_value = InventoryBulk.computeTotalBulk(\r\n\t\t\t\tthis.actor.inventory.filter(\r\n\t\t\t\t\t(item) =>\r\n\t\t\t\t\t\t!item.isInContainer && item.system.equipped.carryType !== \"dropped\",\r\n\t\t\t\t),\r\n\t\t\t\tthis.actor.size,\r\n\t\t\t);\r\n\t\t\treturn _value;\r\n\t\t},\r\n\t});\r\n}\r\n", "import {\r\n\tdeleteInMemory,\r\n\tflagPath,\r\n\tgetFlag,\r\n\tgetFlagProperty,\r\n\tgetInMemory,\r\n\tgetSetting,\r\n\tisInstanceOf,\r\n\tregisterWrapper,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n\tsubLocalize,\r\n\tunsetFlag,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor\";\r\n\r\nconst ACTOR_PREPARE_DATA = \"CONFIG.Actor.documentClass.prototype.prepareData\";\r\nconst DOCUMENT_SHEET_RENDER_INNER = \"DocumentSheet.prototype._renderInner\";\r\n\r\nexport function registerShare() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"share\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"force\"],\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tconst share = getSetting(\"share\");\r\n\t\t\tif (share === \"disabled\") return;\r\n\r\n\t\t\tregisterWrapper(ACTOR_PREPARE_DATA, prepareData, \"WRAPPER\");\r\n\t\t\tregisterWrapper(\r\n\t\t\t\tDOCUMENT_SHEET_RENDER_INNER,\r\n\t\t\t\tdocumentSheetRenderInner,\r\n\t\t\t\t\"WRAPPER\",\r\n\t\t\t);\r\n\r\n\t\t\tHooks.on(\"preUpdateActor\", preUpdateActor);\r\n\t\t\tHooks.on(\"deleteActor\", deleteActor);\r\n\t\t\tHooks.on(\"updateActor\", updateActor);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nasync function documentSheetRenderInner(wrapped, ...args) {\r\n\tconst inner = await wrapped(...args);\r\n\tif (!isInstanceOf(this, \"CreatureConfig\")) return inner;\r\n\r\n\tconst actor = this.actor;\r\n\tif (\r\n\t\t!isPlayedActor(actor) ||\r\n\t\t!actor.isOfType(\"character\", \"npc\") ||\r\n\t\tgetSlaves(actor).size\r\n\t)\r\n\t\treturn inner;\r\n\r\n\tconst masters = game.actors\r\n\t\t.filter((a) => a.id !== actor.id && a.isOwner && isValidMaster(a))\r\n\t\t.map((actor) => ({\r\n\t\t\tkey: actor.id,\r\n\t\t\tlabel: actor.name,\r\n\t\t}));\r\n\r\n\tconst group = await render(\"share/master\", {\r\n\t\tmasters,\r\n\t\tmaster: getFlag(actor, \"share.master\"),\r\n\t\tselectPath: flagPath(\"share.master\"),\r\n\t\ti18n: subLocalize(\"share.templates.master\"),\r\n\t});\r\n\r\n\tinner.children().last().before(group);\r\n\r\n\treturn inner;\r\n}\r\n\r\nfunction deleteActor(actor) {\r\n\tremoveSlaveFromMaster(actor);\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tPromise.all(\r\n\t\tslaves.map(async (slave) => {\r\n\t\t\tunsetMaster(slave);\r\n\t\t\tawait unsetFlag(slave, \"share.master\");\r\n\t\t}),\r\n\t);\r\n}\r\n\r\nfunction preUpdateActor(actor, updates) {\r\n\tconst shareFlag = getFlagProperty(updates, \"share\");\r\n\tif (shareFlag?.master) {\r\n\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\tif (isValidMaster(master)) {\r\n\t\t\tconst hpSource = deepClone(master._source.system.attributes.hp);\r\n\t\t\tsetProperty(updates, \"system.attributes.hp\", hpSource);\r\n\t\t}\r\n\t} else {\r\n\t\tconst master = getMaster(actor);\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (master && hpUpdate) {\r\n\t\t\tmaster.update(\r\n\t\t\t\t{ system: { attributes: { hp: hpUpdate } } },\r\n\t\t\t\t{ noHook: true },\r\n\t\t\t);\r\n\t\t\t// biome-ignore lint/performance/noDelete: <explanation>\r\n\t\t\tdelete updates.system.attributes.hp;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction updateActor(actor, updates, options, userId) {\r\n\tconst isOriginalUser = game.user.id === userId;\r\n\r\n\tconst shareFlag = getFlagProperty(updates, \"share\");\r\n\tif (shareFlag?.master !== undefined) {\r\n\t\tconst slave = actor;\r\n\r\n\t\tremoveSlaveFromMaster(slave);\r\n\r\n\t\tif (shareFlag.master) {\r\n\t\t\tconst master = game.actors.get(shareFlag.master);\r\n\t\t\tif (isValidMaster(master)) {\r\n\t\t\t\tsetMaster(slave, master);\r\n\t\t\t\taddSlaveToMaster(master, slave);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tunsetMaster(slave);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!isOriginalUser) return;\r\n\r\n\tconst slaves = getSlaves(actor);\r\n\tif (slaves.size) {\r\n\t\tconst hpUpdate = getProperty(updates, \"system.attributes.hp\");\r\n\t\tif (hpUpdate) {\r\n\t\t\tconst data = { system: { attributes: { hp: hpUpdate } } };\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await slave.update(data, { noHook: true })),\r\n\t\t\t);\r\n\t\t} else {\r\n\t\t\tPromise.all(\r\n\t\t\t\tslaves.map(async (slave) => await refreshActor(slave, updates)),\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nasync function refreshActor(actor, data) {\r\n\tconst share = getSetting(\"share\");\r\n\tif (share === \"force\") {\r\n\t\tawait setFlag(actor, \"toggle\", !getFlag(actor, \"toggle\"));\r\n\t} else {\r\n\t\tactor.render(false, { action: \"update\" });\r\n\t\tactor._updateDependentTokens(data);\r\n\t}\r\n}\r\n\r\nfunction prepareData(wrapped) {\r\n\twrapped();\r\n\r\n\tconst masterId = getFlag(this, \"share.master\");\r\n\tconst master = masterId ? game.actors.get(masterId) : undefined;\r\n\r\n\tif (!isValidMaster(master)) return;\r\n\r\n\tif (!getMaster(this)) {\r\n\t\tsetMaster(this, master);\r\n\t\taddSlaveToMaster(master, this);\r\n\t}\r\n\r\n\tconst hp = this.system.attributes.hp;\r\n\tObject.defineProperty(this.system.attributes, \"hp\", {\r\n\t\tget() {\r\n\t\t\tconst masterHp = master.system.attributes.hp;\r\n\t\t\ttransfertHpData(masterHp, hp);\r\n\t\t\treturn hp;\r\n\t\t},\r\n\t\tenumerable: true,\r\n\t});\r\n}\r\n\r\nfunction transfertHpData(from, to) {\r\n\tto.breakdown = from.breakdown;\r\n\tto.max = from.max;\r\n\tto.sp = deepClone(from.sp);\r\n\tto.temp = from.temp;\r\n\tto.totalModifier = from.totalModifier;\r\n\tto.value = from.value;\r\n\tto._modifiers = from._modifiers.slice();\r\n}\r\n\r\nfunction getSlaves(actor) {\r\n\treturn getInMemory(actor, \"share.slaves\") ?? new Collection();\r\n}\r\n\r\nfunction setMaster(actor, master) {\r\n\treturn setInMemory(actor, \"share.master\", master);\r\n}\r\n\r\nfunction unsetMaster(actor) {\r\n\treturn deleteInMemory(actor, \"share.master\");\r\n}\r\n\r\nfunction getMaster(actor) {\r\n\treturn getInMemory(actor, \"share.master\");\r\n}\r\n\r\nfunction isValidMaster(actor) {\r\n\treturn actor && actor.type === \"character\" && !getMaster(actor);\r\n}\r\n\r\nfunction addSlaveToMaster(master, slave) {\r\n\tconst slaves = getSlaves(master);\r\n\treturn setInMemory(master, \"share.slaves\", slaves.set(slave.id, slave));\r\n}\r\n\r\nfunction removeSlaveFromMaster(slave) {\r\n\tconst master = getMaster(slave);\r\n\tif (!master) return;\r\n\r\n\tconst slaves = getSlaves(master);\r\n\tslaves.delete(slave.id);\r\n}\r\n", "import {\r\n\tgetItemWithSourceId,\r\n\tgetSetting,\r\n\thasItemWithSourceId,\r\n\tinfo,\r\n\tisOwner,\r\n\trefreshCharacterSheets,\r\n\trender,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport { isPlayedActor } from \"../actor\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst setSheetHook = createHook(\r\n\t\"renderCharacterSheetPF2e\",\r\n\trenderCharacterSheetPF2e,\r\n);\r\nconst setDeleteCombatHook = createHook(\"deleteCombat\", deleteCombat);\r\nconst setDeleteCombatantHook = createHook(\"deleteCombatant\", deleteCombatant);\r\nconst setCreateCombatantHook = createHook(\"createCombatant\", createCombatant);\r\n\r\nconst STANCE_SAVANT = [\r\n\t\"Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu\",\r\n\t\"Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8\",\r\n];\r\n\r\nconst REPLACERS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA\", // gorilla pound\r\n\r\n\t\t{\r\n\t\t\treplace: \"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT\", // gorilla stance\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK\",\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nconst EXTRAS = new Map([\r\n\t[\r\n\t\t\"Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt\", // arcane cascade\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl\",\r\n\t\t\taction: \"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28\", // cobra envenom\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN\",\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT\", // dread marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv\", // the stance aura\r\n\t\t},\r\n\t],\r\n\t[\r\n\t\t\"Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa\", // inspiring marshal\r\n\t\t{\r\n\t\t\teffect: \"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ\", // the stance aura\r\n\t\t},\r\n\t],\r\n]);\r\n\r\nexport function registerStances() {\r\n\treturn {\r\n\t\tname: \"stances\",\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"stances\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-stances\"],\r\n\t\tapi: {\r\n\t\t\tgetStances,\r\n\t\t\ttoggleStance,\r\n\t\t\tisValidStance,\r\n\t\t},\r\n\t\tready: (isGm) => {\r\n\t\t\tif (getSetting(\"stances\")) setup(true);\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tsetSheetHook(value);\r\n\tsetDeleteCombatHook(value);\r\n\tsetDeleteCombatantHook(value);\r\n\tsetCreateCombatantHook(value);\r\n}\r\n\r\nfunction isValidStance(stance) {\r\n\treturn (\r\n\t\tstance?.system.traits.value.includes(\"stance\") &&\r\n\t\tstance.system.selfEffect?.uuid\r\n\t);\r\n}\r\n\r\nfunction getStances(actor) {\r\n\tconst stances = [];\r\n\tconst replaced = new Set();\r\n\r\n\tfor (const {\r\n\t\treplace,\r\n\t\tsourceId,\r\n\t\teffectUUID,\r\n\t\teffect,\r\n\t\timg,\r\n\t\tname,\r\n\t\titemName,\r\n\t\taction,\r\n\t} of actorStances(actor)) {\r\n\t\tif (replace) replaced.add(replace);\r\n\r\n\t\tconst foundAction = action\r\n\t\t\t? getItemWithSourceId(actor, action, \"action\")\r\n\t\t\t: getItemWithSourceId(actor, sourceId, \"feat\");\r\n\r\n\t\tstances.push({\r\n\t\t\tname,\r\n\t\t\titemName,\r\n\t\t\tuuid: sourceId,\r\n\t\t\timg,\r\n\t\t\teffectUUID,\r\n\t\t\teffectID: effect?.id,\r\n\t\t\tactionUUID: foundAction.sourceId,\r\n\t\t\tactionID: foundAction.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn stances.filter(({ uuid }) => !replaced.has(uuid));\r\n}\r\n\r\nasync function renderCharacterSheetPF2e(sheet, html) {\r\n\tconst actor = sheet.actor;\r\n\tif (!isPlayedActor(actor)) return;\r\n\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst inCombat = actor\r\n\t\t.getActiveTokens(true, true)\r\n\t\t.some((token) => token.inCombat);\r\n\tconst tab = html.find(\r\n\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]\",\r\n\t);\r\n\tconst options = tab.find(\".actions-options\");\r\n\tconst template = await render(\"stances/sheet\", {\r\n\t\tstances,\r\n\t\tcanUseStances: inCombat && !actor.isDead,\r\n\t\ti18n: subLocalize(\"stances\"),\r\n\t});\r\n\r\n\tif (options.length) options.after(template);\r\n\telse tab.prepend(template);\r\n\r\n\thtml\r\n\t\t.find(\r\n\t\t\t\".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance\",\r\n\t\t)\r\n\t\t.on(\"click\", (event) => onToggleStance(event, actor));\r\n}\r\n\r\nfunction onToggleStance(event, actor) {\r\n\tconst target = event.currentTarget;\r\n\tconst canUseStances = target\r\n\t\t.closest(\".pf2e-stances\")\r\n\t\t?.classList.contains(\"can-use-stances\");\r\n\tif (!event.ctrlKey && !canUseStances) return;\r\n\r\n\tconst effectUUID = target.dataset.effectUuid;\r\n\ttoggleStance(actor, effectUUID);\r\n}\r\n\r\nfunction* actorStances(actor) {\r\n\tfor (const feat of actor.itemTypes.feat) {\r\n\t\tconst sourceId = feat.sourceId;\r\n\r\n\t\tconst replacer = REPLACERS.get(sourceId);\r\n\t\tconst extra = EXTRAS.get(sourceId);\r\n\t\tif (!replacer && !extra && !isValidStance(feat)) continue;\r\n\r\n\t\tconst effectUUID =\r\n\t\t\treplacer?.effect ?? extra?.effect ?? feat.system.selfEffect.uuid;\r\n\t\tconst effect = fromUuidSync(effectUUID);\r\n\t\tif (!effect) continue;\r\n\r\n\t\tyield {\r\n\t\t\tname: (replacer && fromUuidSync(replacer.replace)?.name) ?? feat.name,\r\n\t\t\titemName: feat.name,\r\n\t\t\treplace: replacer?.replace,\r\n\t\t\textra,\r\n\t\t\tsourceId,\r\n\t\t\teffectUUID,\r\n\t\t\teffect: getItemWithSourceId(actor, effectUUID, \"effect\"),\r\n\t\t\taction: extra?.action,\r\n\t\t\timg: effect.img,\r\n\t\t};\r\n\t}\r\n}\r\n\r\nfunction getStancesEffects(actor) {\r\n\tconst effects = [];\r\n\r\n\tfor (const { effect } of actorStances(actor)) {\r\n\t\tif (!effect) continue;\r\n\t\teffects.push({\r\n\t\t\tuuid: effect.sourceId,\r\n\t\t\tid: effect.id,\r\n\t\t});\r\n\t}\r\n\r\n\treturn effects;\r\n}\r\n\r\nasync function toggleStance(actor, effectUUID) {\r\n\tconst effects = getStancesEffects(actor);\r\n\tconst already = effects.findIndex((effect) => effect.uuid === effectUUID);\r\n\r\n\tlet create = false;\r\n\r\n\tif (already === -1) {\r\n\t\tcreate = true;\r\n\t} else {\r\n\t\tconst other = effects.filter((effect) => effect.uuid !== effectUUID).length;\r\n\t\tconst more =\r\n\t\t\teffects.filter((effect) => effect.uuid === effectUUID).length > 1;\r\n\t\tif (other || more) effects.splice(already, 1);\r\n\t}\r\n\r\n\tif (effects.length) {\r\n\t\tawait actor.deleteEmbeddedDocuments(\r\n\t\t\t\"Item\",\r\n\t\t\teffects.map((x) => x.id),\r\n\t\t);\r\n\t}\r\n\r\n\tif (create) addStance(actor, effectUUID);\r\n}\r\n\r\nasync function addStance(actor, uuid) {\r\n\tconst effect = await fromUuid(uuid);\r\n\r\n\tif (effect) {\r\n\t\tconst obj = effect.toObject();\r\n\t\tif (!getProperty(obj, \"flags.core.sourceId\"))\r\n\t\t\tsetProperty(obj, \"flags.core.sourceId\", effect.uuid);\r\n\r\n\t\tconst items = await actor.createEmbeddedDocuments(\"Item\", [obj]);\r\n\t\titems[0]?.toMessage();\r\n\r\n\t\treturn true;\r\n\t}\r\n\r\n\treturn false;\r\n}\r\n\r\nfunction deleteCombat(combat) {\r\n\tfor (const combatant of combat.combatants) {\r\n\t\tdeleteCombatant(combatant);\r\n\t}\r\n}\r\n\r\nfunction deleteCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isOwner(actor)) {\r\n\t\tconst effects = getStancesEffects(actor).map((effect) => effect.id);\r\n\t\tif (effects.length) actor.deleteEmbeddedDocuments(\"Item\", effects);\r\n\t}\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction createCombatant(combatant) {\r\n\tconst actor = getActorFromCombatant(combatant);\r\n\tif (!actor) return;\r\n\r\n\tif (!game.user.isGM && isOwner(actor)) checkForSavant(actor);\r\n\r\n\trefreshCharacterSheets(actor);\r\n}\r\n\r\nfunction getActorFromCombatant(combatant) {\r\n\tconst actor = combatant.actor;\r\n\tif (actor && !actor.isToken && actor.isOfType(\"character\")) return actor;\r\n}\r\n\r\nasync function checkForSavant(actor) {\r\n\tconst stances = getStances(actor);\r\n\tif (!stances.length) return;\r\n\r\n\tconst hasStancesEffects = stances.filter(({ effectID }) => effectID).length;\r\n\tif (hasStancesEffects) return;\r\n\r\n\tconst hasSavantFeat = hasItemWithSourceId(actor, STANCE_SAVANT, [\"feat\"]);\r\n\tif (!hasSavantFeat) return;\r\n\r\n\tif (stances.length === 1) {\r\n\t\tconst stance = stances[0];\r\n\t\tif (await addStance(actor, stance.effectUUID))\r\n\t\t\tinfo(\"stances.useStance\", { stance: stance.name });\r\n\t} else {\r\n\t\topenStancesMenu(actor, stances);\r\n\t}\r\n}\r\n\r\nasync function openStancesMenu(actor, stances) {\r\n\tconst localize = subLocalize(\"stances.menu\");\r\n\r\n\tnew Dialog({\r\n\t\ttitle: localize(\"title\"),\r\n\t\tcontent: await render(\"stances/menu\", {\r\n\t\t\tstances,\r\n\t\t\ti18n: localize.template,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tyes: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-people-arrows\"></i>',\r\n\t\t\t\tlabel: localize(\"accept\"),\r\n\t\t\t\tcallback: (html) =>\r\n\t\t\t\t\taddStance(actor, html.find(\"[name=stance]:checked\").val()),\r\n\t\t\t},\r\n\t\t\tno: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\t\tlabel: localize(\"cancel\"),\r\n\t\t\t},\r\n\t\t},\r\n\t}).render(true);\r\n}\r\n", "import {\r\n\tgetSetting,\r\n\tlocaleCompare,\r\n\tlocalizePath,\r\n\tordinalString,\r\n\tspellSlotGroupIdToNumber,\r\n\tsubLocalize,\r\n} from \"module-api\";\r\nimport {\r\n\tregisterCharacterSheetExtraTab,\r\n\tunregisterCharacterSheetExtraTab,\r\n} from \"../actor\";\r\n\r\nexport function registerSpellsSummary() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"summary\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tchoices: [\"disabled\", \"enabled\", \"sort\"],\r\n\t\t\t\tonChange: (value) => setup(value),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-spells-summary\"],\r\n\t\tready: (isGm) => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup(value) {\r\n\tconst enabled = (value ?? getSetting(\"summary\")) !== \"disabled\";\r\n\tif (enabled) {\r\n\t\tregisterCharacterSheetExtraTab({\r\n\t\t\ttabName: \"spellcasting\",\r\n\t\t\ttemplateFolder: \"summary/sheet\",\r\n\t\t\tgetData,\r\n\t\t\taddEvents,\r\n\t\t});\r\n\t} else {\r\n\t\tunregisterCharacterSheetExtraTab(\"spellcasting\");\r\n\t}\r\n}\r\n\r\nfunction addEvents(html, sheet, actor) {\r\n\tconst inputs = html.find(\".spell-type .uses .spell-slots-input input\");\r\n\tinputs.on(\"change\", (event) => onUsesInputChange(event, actor));\r\n\tinputs.on(\"focus\", onUsesInputFocus);\r\n\tinputs.on(\"blur\", onUsesInputBlur);\r\n\r\n\thtml\r\n\t\t.find(\".focus-pips\")\r\n\t\t.on(\"click contextmenu\", (event) => onToggleFocusPool(event, actor));\r\n\r\n\thtml\r\n\t\t.find(\".spell-slots-increment-reset\")\r\n\t\t.on(\"click\", (event) => onSlotsReset(event, sheet, actor));\r\n\r\n\thtml.find(\".item-image\").on(\"click\", (event) => onItemToChat(event, actor));\r\n}\r\n\r\nasync function onUsesInputChange(event, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { inputPath, entryId } = $(event.currentTarget).data();\r\n\tconst value = event.currentTarget.valueAsNumber;\r\n\tactor.updateEmbeddedDocuments(\"Item\", [{ _id: entryId, [inputPath]: value }]);\r\n}\r\n\r\nfunction onUsesInputFocus(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.add(\"hover\");\r\n}\r\n\r\nfunction onUsesInputBlur(event) {\r\n\tevent.preventDefault();\r\n\tevent.currentTarget.closest(\".item\")?.classList.remove(\"hover\");\r\n}\r\n\r\nfunction onToggleFocusPool(event, actor) {\r\n\tevent.preventDefault();\r\n\tconst change = event.type === \"click\" ? 1 : -1;\r\n\tconst points = (actor.system.resources.focus?.value ?? 0) + change;\r\n\tactor.update({ \"system.resources.focus.value\": points });\r\n}\r\n\r\nfunction onChargesReset(sheet, actor, entryId) {\r\n\tif (game.modules.get(\"pf2e-staves\")?.active) {\r\n\t\tconst original = getSpellcastingTab(sheet.element).find(\r\n\t\t\t\".directory-list.spellcastingEntry-list\",\r\n\t\t);\r\n\t\tconst entry = original.find(\r\n\t\t\t`.item-container.spellcasting-entry[data-item-id=${entryId}]`,\r\n\t\t);\r\n\t\tconst btn = entry.find(\r\n\t\t\t\".spell-ability-data .statistic-values a.pf2e-staves-charge\",\r\n\t\t);\r\n\t\tbtn[0]?.click();\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst dailies = game.modules.get(\"pf2e-dailies\");\r\n\tif (!dailies?.active) return;\r\n\r\n\tconst entry = actor.spellcasting.get(entryId);\r\n\tdailies.api.updateEntryCharges(entry, 9999);\r\n}\r\n\r\nfunction onSlotsReset(event, sheet, actor) {\r\n\tevent.preventDefault();\r\n\r\n\tconst { itemId, rank, isCharge } = $(event.currentTarget).data();\r\n\tif (!itemId) return;\r\n\r\n\tif (isCharge) {\r\n\t\tonChargesReset(sheet, actor, itemId);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = actor.items.get(itemId);\r\n\tif (!item) return;\r\n\r\n\tif (item.isOfType(\"consumable\")) {\r\n\t\tconst max = item.system.uses?.max;\r\n\t\tif (max) item.update({ \"system.uses.value\": max });\r\n\t} else if (item.isOfType(\"spellcastingEntry\")) {\r\n\t\tconst slotLevel = rank >= 0 && rank <= 11 ? `slot${rank}` : \"slot0\";\r\n\t\tconst slot = item.system.slots?.[slotLevel];\r\n\t\tif (slot) item.update({ [`system.slots.${slotLevel}.value`]: slot.max });\r\n\t} else if (item.isOfType(\"spell\")) {\r\n\t\tconst max = item.system.location.uses?.max;\r\n\t\tif (max) item.update({ \"system.location.uses.value\": max });\r\n\t}\r\n}\r\n\r\nasync function onItemToChat(event, actor) {\r\n\tconst { entryId, itemId, castRank } =\r\n\t\tevent.currentTarget.closest(\".item\").dataset;\r\n\r\n\tconst collection = actor.spellcasting.collections.get(entryId);\r\n\tif (!collection) return;\r\n\r\n\tconst spell = collection.get(itemId);\r\n\tspell?.toMessage(event, { data: { castRank: Number(castRank ?? NaN) } });\r\n}\r\n\r\nfunction getSpellcastingTab(html) {\r\n\treturn html.find(\r\n\t\t\"section.sheet-body .sheet-content > .tab[data-tab=spellcasting]\",\r\n\t);\r\n}\r\n\r\nasync function getData(actor) {\r\n\tconst focusPool = actor.system.resources.focus ?? { value: 0, max: 0 };\r\n\tconst pf2eStavesActive = game.modules.get(\"pf2e-staves\")?.active;\r\n\tconst pf2eDailies = game.modules.get(\"pf2e-dailies\");\r\n\tconst pf2eDailiesActive = pf2eDailies?.active;\r\n\tconst stavesActive =\r\n\t\tpf2eStavesActive ||\r\n\t\t(pf2eDailiesActive && isNewerVersion(pf2eDailies.version, \"2.14.0\"));\r\n\tconst chargesPath = pf2eStavesActive\r\n\t\t? \"flags.pf2e-staves.charges\"\r\n\t\t: pf2eDailiesActive\r\n\t\t  ? \"flags.pf2e-dailies.staff.charges\"\r\n\t\t  : \"\";\r\n\r\n\tconst spells = [];\r\n\tconst focuses = [];\r\n\r\n\tlet rituals;\r\n\tlet hasFocusCantrips = false;\r\n\r\n\tconst entries = await Promise.all(\r\n\t\tactor.spellcasting.collections.map(async (spells) => {\r\n\t\t\treturn {\r\n\t\t\t\tentry: spells.entry,\r\n\t\t\t\tdata: await spells.entry.getSheetData({ spells }),\r\n\t\t\t};\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const { entry, data } of entries) {\r\n\t\tif (data.isRitual) {\r\n\t\t\trituals = data.groups.flatMap((slot, slotId) =>\r\n\t\t\t\tslot.active\r\n\t\t\t\t\t.map(({ spell }) => ({\r\n\t\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\t\tslotId,\r\n\t\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\t\trank: spell.rank,\r\n\t\t\t\t\t\ttime: spell.system.time.value,\r\n\t\t\t\t\t}))\r\n\t\t\t\t\t.filter(Boolean),\r\n\t\t\t);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tconst entryId = data.id;\r\n\t\tconst entryDc = data.statistic.dc.value;\r\n\t\tconst entryName = data.name;\r\n\t\tconst isFocus = data.isFocusPool;\r\n\t\tconst isCharge = entry.system?.prepared?.value === \"charge\";\r\n\t\tconst isInnate = data.isInnate;\r\n\t\tconst isPrepared = data.isPrepared;\r\n\t\tconst isSpontaneous = data.isSpontaneous;\r\n\t\tconst isFlexible = data.isFlexible;\r\n\r\n\t\tconst consumable = (() => {\r\n\t\t\tif (data.category !== \"items\") return;\r\n\t\t\tconst itemId = entry.id.split(\"-\")[0];\r\n\t\t\treturn actor.items.get(itemId);\r\n\t\t})();\r\n\r\n\t\tconst charges = (() => {\r\n\t\t\tif (!isCharge) return;\r\n\r\n\t\t\tconst dailiesData =\r\n\t\t\t\tpf2eDailiesActive &&\r\n\t\t\t\tpf2eDailies.api.getSpellcastingEntryStaffData(entry);\r\n\t\t\tconst { charges, max, canPayCost } = dailiesData ??\r\n\t\t\t\tgetProperty(entry, \"flags.pf2e-staves.charges\") ?? {\r\n\t\t\t\t\tcharges: 0,\r\n\t\t\t\t\tmax: 0,\r\n\t\t\t\t};\r\n\r\n\t\t\treturn {\r\n\t\t\t\tvalue: charges,\r\n\t\t\t\tmax,\r\n\t\t\t\tnoMax: true,\r\n\t\t\t\tcanPayCost: canPayCost ?? (() => true),\r\n\t\t\t};\r\n\t\t})();\r\n\r\n\t\tfor (const group of data.groups) {\r\n\t\t\tif (!group.active.length || group.uses?.max === 0) continue;\r\n\r\n\t\t\tconst slotSpells = [];\r\n\t\t\tconst isCantrip = group.id === \"cantrips\";\r\n\t\t\tconst groupNumber = spellSlotGroupIdToNumber(group.id);\r\n\t\t\tconst isBroken = !isCantrip && isCharge && !stavesActive;\r\n\r\n\t\t\tfor (let slotId = 0; slotId < group.active.length; slotId++) {\r\n\t\t\t\tconst active = group.active[slotId];\r\n\t\t\t\tif (!active || active.uses?.max === 0) continue;\r\n\r\n\t\t\t\tconst { spell, expended, virtual, uses, castRank } = active;\r\n\r\n\t\t\t\tslotSpells.push({\r\n\t\t\t\t\tname: spell.name,\r\n\t\t\t\t\timg: spell.img,\r\n\t\t\t\t\trange: spell.system.range.value || \"-\",\r\n\t\t\t\t\tcastRank: castRank ?? spell.rank,\r\n\t\t\t\t\tslotId,\r\n\t\t\t\t\tentryId,\r\n\t\t\t\t\tentryDc,\r\n\t\t\t\t\tentryName,\r\n\t\t\t\t\titemId: spell.id,\r\n\t\t\t\t\tinputId: isInnate ? spell.id : data.id,\r\n\t\t\t\t\tinputPath: consumable\r\n\t\t\t\t\t\t? \"system.uses.value\"\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? chargesPath\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"system.location.uses.value\"\r\n\t\t\t\t\t\t\t  : `system.slots.slot${groupNumber}.value`,\r\n\t\t\t\t\tisCharge,\r\n\t\t\t\t\tisActiveCharge: isCharge && stavesActive,\r\n\t\t\t\t\tisBroken,\r\n\t\t\t\t\tisVirtual: virtual,\r\n\t\t\t\t\tisInnate,\r\n\t\t\t\t\tisCantrip,\r\n\t\t\t\t\tisFocus,\r\n\t\t\t\t\tisPrepared,\r\n\t\t\t\t\tisSpontaneous: isSpontaneous || isFlexible,\r\n\t\t\t\t\tgroupId: group.id,\r\n\t\t\t\t\tconsumable,\r\n\t\t\t\t\tuses: consumable\r\n\t\t\t\t\t\t? consumable.system.uses\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? charges\r\n\t\t\t\t\t\t  : uses ?? group.uses,\r\n\t\t\t\t\texpended:\r\n\t\t\t\t\t\tisCharge && !isCantrip\r\n\t\t\t\t\t\t\t? !charges.canPayCost(groupNumber)\r\n\t\t\t\t\t\t\t: expended ??\r\n\t\t\t\t\t\t\t  (isFocus && !isCantrip ? focusPool.value <= 0 : false),\r\n\t\t\t\t\taction: spell.system.time.value,\r\n\t\t\t\t\ttype: consumable\r\n\t\t\t\t\t\t? `PF2E.Item.Consumable.Category.${consumable.category}`\r\n\t\t\t\t\t\t: isCharge\r\n\t\t\t\t\t\t  ? localizePath(\"summary.staff\")\r\n\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeInnate\"\r\n\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t  ? \"PF2E.PreparationTypeSpontaneous\"\r\n\t\t\t\t\t\t\t\t  : isFlexible\r\n\t\t\t\t\t\t\t\t\t  ? \"PF2E.SpellFlexibleLabel\"\r\n\t\t\t\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t\t\t\t  ? \"PF2E.TraitFocus\"\r\n\t\t\t\t\t\t\t\t\t\t  : \"PF2E.SpellPreparedLabel\",\r\n\t\t\t\t\torder: isCharge\r\n\t\t\t\t\t\t? 0\r\n\t\t\t\t\t\t: isPrepared\r\n\t\t\t\t\t\t  ? 1\r\n\t\t\t\t\t\t  : isFocus\r\n\t\t\t\t\t\t\t  ? 2\r\n\t\t\t\t\t\t\t  : isInnate\r\n\t\t\t\t\t\t\t\t  ? 3\r\n\t\t\t\t\t\t\t\t  : isSpontaneous\r\n\t\t\t\t\t\t\t\t\t  ? 4\r\n\t\t\t\t\t\t\t\t\t  : 5,\r\n\t\t\t\t\tnoHover: isPrepared || isCantrip || isBroken || isFocus,\r\n\t\t\t\t});\r\n\t\t\t}\r\n\r\n\t\t\tif (slotSpells.length) {\r\n\t\t\t\tif (isFocus) {\r\n\t\t\t\t\tif (isCantrip) hasFocusCantrips = true;\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\tfocuses.push(...slotSpells);\r\n\t\t\t\t\t\tcontinue;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tspells[groupNumber] ??= [];\r\n\t\t\t\tspells[groupNumber].push(...slotSpells);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (spells.length) {\r\n\t\tconst sort =\r\n\t\t\tgetSetting(\"summary\") === \"sort\"\r\n\t\t\t\t? (a, b) =>\r\n\t\t\t\t\t\ta.order === b.order\r\n\t\t\t\t\t\t\t? localeCompare(a.name, b.name)\r\n\t\t\t\t\t\t\t: a.order - b.order\r\n\t\t\t\t: (a, b) => localeCompare(a.name, b.name);\r\n\r\n\t\tfor (const entry of spells) {\r\n\t\t\tif (!entry) continue;\r\n\t\t\tentry.sort(sort);\r\n\t\t}\r\n\t}\r\n\r\n\tif (focuses.length) {\r\n\t\tfocuses.sort((a, b) => localeCompare(a.name, b.name));\r\n\t\tspells[12] = focuses;\r\n\t\thasFocusCantrips = false;\r\n\t}\r\n\r\n\treturn {\r\n\t\tspells,\r\n\t\trituals,\r\n\t\tfocusPool,\r\n\t\thasFocusCantrips,\r\n\t\tisOwner: actor.isOwner,\r\n\t\ti18n: subLocalize(\"summary\"),\r\n\t\tentryRank: (rank) =>\r\n\t\t\tgame.i18n.format(\"PF2E.Item.Spell.Rank.Ordinal\", {\r\n\t\t\t\trank: ordinalString(rank),\r\n\t\t\t}),\r\n\t};\r\n}\r\n", "import {\r\n\tDegreeOfSuccess,\r\n\tapplyDamageFromMessage,\r\n\tdeleteInMemory,\r\n\tgetFlag,\r\n\tgetInMemory,\r\n\tgetSetting,\r\n\tgetTemplateTokens,\r\n\thasEmbeddedSpell,\r\n\tisActiveGM,\r\n\tlatestChatMessages,\r\n\tlocalize,\r\n\tlocalizePath,\r\n\tmoduleFlagUpdate,\r\n\tonClickShieldBlock,\r\n\trender,\r\n\tsetFlag,\r\n\tsetInMemory,\r\n\tsubLocalize,\r\n\ttoggleOffShieldBlock,\r\n\tupdateSourceFlag,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { bindOnPreCreateSpellDamageChatMessage } from \"../chat\";\r\nimport { createChoicesHook, createHook } from \"../hooks\";\r\nimport { roll3dDice } from \"../misc\";\r\nimport { registerSocket } from \"../socket\";\r\n\r\nconst SAVES = {\r\n\tfortitude: { icon: \"fa-solid fa-chess-rook\", label: \"PF2E.SavesFortitude\" },\r\n\treflex: { icon: \"fa-solid fa-person-running\", label: \"PF2E.SavesReflex\" },\r\n\twill: { icon: \"fa-solid fa-brain\", label: \"PF2E.SavesWill\" },\r\n};\r\n\r\nconst REROLL = {\r\n\thero: {\r\n\t\ticon: \"fa-solid fa-hospital-symbol\",\r\n\t\treroll: \"PF2E.RerollMenu.HeroPoint\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageHeroPoint\",\r\n\t},\r\n\tnew: {\r\n\t\ticon: \"fa-solid fa-dice\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepNew\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.new\",\r\n\t},\r\n\tlower: {\r\n\t\ticon: \"fa-solid fa-dice-one\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepLower\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.lower\",\r\n\t},\r\n\thigher: {\r\n\t\ticon: \"fa-solid fa-dice-six\",\r\n\t\treroll: \"PF2E.RerollMenu.KeepHigher\",\r\n\t\trerolled: \"PF2E.RerollMenu.MessageKeep.higher\",\r\n\t},\r\n};\r\n\r\nconst DEGREE_OF_SUCCESS = [\r\n\t\"criticalFailure\",\r\n\t\"failure\",\r\n\t\"success\",\r\n\t\"criticalSuccess\",\r\n];\r\n\r\nconst setPrecreateMessageHook = createHook(\r\n\t\"preCreateChatMessage\",\r\n\tpreCreateChatMessage,\r\n);\r\nconst setRenderMessageHook = createChoicesHook(\r\n\t\"renderChatMessage\",\r\n\trenderChatMessage,\r\n);\r\nconst setCreateTemplateHook = createHook(\r\n\t\"createMeasuredTemplate\",\r\n\tcreateMeasuredTemplate,\r\n);\r\n\r\nconst socket = registerSocket(\"target\", onSocket);\r\n\r\nexport function registerTargetTokenHelper() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"target\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\trequiresReload: true,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"target-client\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"small\", \"big\"],\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetRenderMessageHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"target-template\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: (value) =>\r\n\t\t\t\t\tsetCreateTemplateHook(value && getSetting(\"target\")),\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [],\r\n\t\tinit: (isGM) => {\r\n\t\t\tif (!isGM || !getSetting(\"target\")) return;\r\n\t\t\tHooks.on(\"getChatLogEntryContext\", getChatLogEntryContext);\r\n\t\t},\r\n\t\tready: (isGM) => {\r\n\t\t\tif (!getSetting(\"target\")) return;\r\n\r\n\t\t\tsetHooks(isGM);\r\n\t\t\tfor (const { message, html } of latestChatMessages(10)) {\r\n\t\t\t\trenderChatMessage(message, html);\r\n\t\t\t}\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(isGM) {\r\n\tsetPrecreateMessageHook(true);\r\n\tsetRenderMessageHook(true);\r\n\tsetCreateTemplateHook(getSetting(\"target-template\"));\r\n\r\n\tif (isGM) {\r\n\t\tsocket.activate();\r\n\t}\r\n}\r\n\r\nfunction onSocket(packet) {\r\n\tif (!isActiveGM()) return;\r\n\tswitch (packet.type) {\r\n\t\tcase \"target.update-save\":\r\n\t\t\tupdateMessageSave(packet);\r\n\t\t\tbreak;\r\n\t\tcase \"target.update-applied\":\r\n\t\t\tupdateMessageApplied(packet);\r\n\t\t\tbreak;\r\n\t}\r\n}\r\n\r\nfunction getChatLogEntryContext(_, data) {\r\n\tconst getMessageData = (html) => {\r\n\t\tconst messageId = html.data(\"messageId\");\r\n\t\tconst message = game.messages.get(messageId);\r\n\t\tif (!message) return;\r\n\r\n\t\tconst inMemory = getInMemory(message, \"target\");\r\n\t\tif (!inMemory) return;\r\n\r\n\t\treturn {\r\n\t\t\tmessage,\r\n\t\t\tinMemory,\r\n\t\t};\r\n\t};\r\n\r\n\tdata.unshift({\r\n\t\ticon: '<i class=\"fa-solid fa-dice-d20\"></i>',\r\n\t\tname: localizePath(\"target.chat.context.saves.name\"),\r\n\t\tcondition: (html) => {\r\n\t\t\tconst data = getMessageData(html);\r\n\t\t\treturn !!data?.inMemory.canRollSave?.length;\r\n\t\t},\r\n\t\tcallback: (html) => {\r\n\t\t\tconst { inMemory, message } = getMessageData(html) ?? {};\r\n\t\t\tconst canRollSave = inMemory.canRollSave;\r\n\t\t\tif (!canRollSave?.length) return;\r\n\r\n\t\t\tconst save = getSaveData(message);\r\n\t\t\tif (!save) return;\r\n\r\n\t\t\trollSave(\r\n\t\t\t\t{\r\n\t\t\t\t\ttarget: html.find(\".pf2e-toolbelt-target-damage\")[0],\r\n\t\t\t\t},\r\n\t\t\t\tmessage,\r\n\t\t\t\tsave,\r\n\t\t\t\tcanRollSave,\r\n\t\t\t);\r\n\t\t},\r\n\t});\r\n}\r\n\r\nasync function createMeasuredTemplate(template, _, userId) {\r\n\tconst user = game.user;\r\n\tif (user.id !== userId) return;\r\n\r\n\tconst localize = subLocalize(\"target.menu\");\r\n\tconst item = template.item;\r\n\tconst actor = template.actor;\r\n\tconst self = !actor ? undefined : actor.token ?? actor.getActiveTokens()[0];\r\n\r\n\tconst data = {\r\n\t\ttitle: item?.name || localize(\"title\"),\r\n\t\tcontent: await render(\"target/template-menu\", {\r\n\t\t\ti18n: localize.template,\r\n\t\t\tnoSelf: !self,\r\n\t\t}),\r\n\t\tbuttons: {\r\n\t\t\tselect: {\r\n\t\t\t\ticon: '<i class=\"fa-solid fa-bullseye-arrow\"></i>',\r\n\t\t\t\tlabel: localize(\"target\"),\r\n\t\t\t\tcallback: (html) => ({\r\n\t\t\t\t\ttargets: html.find(\"[name=targets]:checked\").val(),\r\n\t\t\t\t\tself: html.find(\"[name=self]\").prop(\"checked\"),\r\n\t\t\t\t\tneutral: html.find(\"[name=neutral]\").prop(\"checked\"),\r\n\t\t\t\t}),\r\n\t\t\t},\r\n\t\t},\r\n\t\tclose: () => null,\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(data, undefined, {\r\n\t\tid: \"pf2e-toolbelt-target-template\",\r\n\t\twidth: 260,\r\n\t});\r\n\tif (!result) return;\r\n\r\n\tconst alliance = actor ? actor.alliance : user.isGM ? \"opposition\" : \"party\";\r\n\tconst opposition =\r\n\t\talliance === \"party\"\r\n\t\t\t? \"opposition\"\r\n\t\t\t: alliance === \"opposition\"\r\n\t\t\t  ? \"party\"\r\n\t\t\t  : null;\r\n\r\n\tconst tokens = getTemplateTokens(template);\r\n\tconst targets = tokens.filter((token) => {\r\n\t\tconst validActor = token.actor?.isOfType(\"creature\", \"hazard\", \"vehicle\");\r\n\t\tif (!validActor) return false;\r\n\r\n\t\tif (token.document.hidden) return false;\r\n\r\n\t\tif (self && token === self) return result.self;\r\n\r\n\t\tconst targetAlliance = token.actor ? token.actor.alliance : token.alliance;\r\n\r\n\t\tif (targetAlliance === null) return result.neutral;\r\n\r\n\t\treturn (\r\n\t\t\tresult.targets === \"all\" ||\r\n\t\t\t(result.targets === \"allies\" && targetAlliance === alliance) ||\r\n\t\t\t(result.targets === \"enemies\" && targetAlliance === opposition)\r\n\t\t);\r\n\t});\r\n\r\n\tconst targetsIds = targets.map((token) => token.id);\r\n\tuser.updateTokenTargets(targetsIds);\r\n\tuser.broadcastActivity({ targets: targetsIds });\r\n}\r\n\r\nlet HEALINGS_REGEX;\r\nfunction isRegenMessage(message) {\r\n\tHEALINGS_REGEX ??= (() => {\r\n\t\tconst healings = [\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t\tgame.i18n.localize(\r\n\t\t\t\t\"PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage\",\r\n\t\t\t),\r\n\t\t];\r\n\t\treturn new RegExp(`^<div>(${healings.join(\"|\")})</div>`);\r\n\t})();\r\n\treturn HEALINGS_REGEX.test(message.flavor);\r\n}\r\n\r\nfunction isValidDamageMessage(message) {\r\n\treturn !message.rolls[0].options.evaluatePersistent;\r\n}\r\n\r\nfunction preCreateChatMessage(message) {\r\n\tconst isDamageRoll = message.isDamageRoll;\r\n\tconst updates = [];\r\n\r\n\tif (isDamageRoll && !isValidDamageMessage(message)) return;\r\n\r\n\tif (isDamageRoll && !getFlag(message, \"target\")) {\r\n\t\tconst token = message.token;\r\n\t\tconst actor = token?.actor;\r\n\t\tconst isRegen = isRegenMessage(message);\r\n\r\n\t\tconst targets = isRegen\r\n\t\t\t? actor\r\n\t\t\t\t? [{ token: token.uuid, actor: actor.uuid }]\r\n\t\t\t\t: []\r\n\t\t\t: Array.from(\r\n\t\t\t\t\tgame.user.targets.map((target) => ({\r\n\t\t\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t\t\t})),\r\n\t\t\t  );\r\n\r\n\t\tupdates.push([\"targets\", targets]);\r\n\t\tif (isRegen) updates.push([\"isRegen\", true]);\r\n\r\n\t\tif (message.rolls.length === 2) {\r\n\t\t\tconst rolls = message.rolls.filter((roll) => roll.options);\r\n\t\t\tconst splashRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) => roll.options.splashOnly,\r\n\t\t\t);\r\n\t\t\tconst regularRollIndex = rolls.findIndex(\r\n\t\t\t\t(roll) =>\r\n\t\t\t\t\t!roll.options.splashOnly &&\r\n\t\t\t\t\troll.options.damage?.modifiers.some(\r\n\t\t\t\t\t\t(modifier) => modifier.damageCategory === \"splash\",\r\n\t\t\t\t\t),\r\n\t\t\t);\r\n\r\n\t\t\tif (splashRollIndex !== -1 && regularRollIndex !== -1) {\r\n\t\t\t\tupdates.push([\"splashIndex\", splashRollIndex]);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (\r\n\t\tisDamageRoll ||\r\n\t\tmessage.getFlag(\"pf2e\", \"context.type\") === \"spell-cast\"\r\n\t) {\r\n\t\tconst item = message.item;\r\n\t\tconst save = item && item.type === \"spell\" && item.system.defense?.save;\r\n\t\tif (save) {\r\n\t\t\tconst dc = item.spellcasting?.statistic.dc.value;\r\n\t\t\tif (typeof dc === \"number\") updates.push([\"save\", { ...save, dc }]);\r\n\t\t}\r\n\t}\r\n\r\n\tif (!updates.length) return;\r\n\r\n\tupdateSourceFlag(\r\n\t\tmessage,\r\n\t\t\"target\",\r\n\t\tupdates.reduce((acc, [key, value]) => {\r\n\t\t\tacc[key] = value;\r\n\t\t\treturn acc;\r\n\t\t}, {}),\r\n\t);\r\n}\r\n\r\nasync function renderChatMessage(message, html) {\r\n\tconst clientEnabled = getSetting(\"target-client\") !== \"disabled\";\r\n\tdeleteInMemory(message, \"target.canRollSave\");\r\n\r\n\tif (clientEnabled && message.isDamageRoll) {\r\n\t\tif (!isValidDamageMessage(message)) return;\r\n\t\tawait renderDamageChatMessage(message, html);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst item = message.item;\r\n\tif (!item || item.type !== \"spell\") return;\r\n\r\n\tif (clientEnabled && !item.damageKinds.size) {\r\n\t\tawait renderSpellChatMessage(message, html, item);\r\n\t\trefreshMessage(message);\r\n\t\treturn;\r\n\t}\r\n\r\n\t// we remove that\r\n\tif (item.system.defense?.save && hasEmbeddedSpell(message)) {\r\n\t\thtml.find(\"[data-action=spell-damage]\").on(\"click\", () => {\r\n\t\t\tbindOnPreCreateSpellDamageChatMessage(message);\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction refreshMessage(message) {\r\n\tPromise.all(\r\n\t\t[ui.chat, ui.chat._popout].map(async (chat) => {\r\n\t\t\tconst el = chat?.element[0]?.querySelector(\"#chat-log\");\r\n\t\t\tif (!el || (!chat.isAtBottom && message.user._id !== game.user._id))\r\n\t\t\t\treturn;\r\n\r\n\t\t\tawait chat._waitForImages();\r\n\t\t\tel.scrollTop = el.scrollHeight;\r\n\t\t}),\r\n\t);\r\n\r\n\tfor (const app of Object.values(message.apps)) {\r\n\t\tif (!(app instanceof ChatPopout)) continue;\r\n\t\tif (!app.rendered) continue;\r\n\r\n\t\tapp.setPosition();\r\n\t}\r\n}\r\n\r\nasync function renderSpellChatMessage(message, html, spell) {\r\n\tconst data = await getMessageData(message);\r\n\tif (!data) return;\r\n\r\n\tconst { targets, save } = data;\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst cardBtns = msgContent.find(\".card-buttons\");\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tconst saveBtn = cardBtns.find(\"[data-action=spell-save]\");\r\n\t\tconst wrapper = $('<div class=\"pf2e-toolbelt-target-wrapper\"></div>');\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\r\n\t\tconst targetsBtn =\r\n\t\t\t$(`<button class=\"pf2e-toolbelt-target-targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\twrapper.append(targetsBtn);\r\n\t\twrapper.append(saveBtn);\r\n\t\tcardBtns.prepend(wrapper);\r\n\t}\r\n\r\n\tif (spell?.area && !spell.traits.has(\"aura\")) {\r\n\t\tconst template = canvas.scene?.templates.some(\r\n\t\t\t(template) => template.message === message && template.isOwner,\r\n\t\t);\r\n\t\tif (template)\r\n\t\t\tcardBtns.find(\".owner-buttons .hidden.small\").removeClass(\"hidden\");\r\n\t}\r\n\r\n\tif (!targets.length) return;\r\n\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-spell\"></div>');\r\n\r\n\tfor (const { template } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n}\r\n\r\nfunction addTargets(event, message) {\r\n\tevent.stopPropagation();\r\n\tconst targets = game.user.targets;\r\n\r\n\tsetFlag(\r\n\t\tmessage,\r\n\t\t\"target.targets\",\r\n\t\tArray.from(\r\n\t\t\ttargets.map((target) => ({\r\n\t\t\t\ttoken: target.document.uuid,\r\n\t\t\t\tactor: target.actor.uuid,\r\n\t\t\t})),\r\n\t\t),\r\n\t);\r\n}\r\n\r\nasync function renderDamageChatMessage(message, html) {\r\n\tconst data = await getMessageData(message);\r\n\tconst msgContent = html.find(\".message-content\");\r\n\tconst damageRows = msgContent.find(\".damage-application\");\r\n\r\n\tconst buttons = $('<div class=\"pf2e-toolbelt-target-buttons\"></div>');\r\n\r\n\tif (data?.targets.length && damageRows.length) {\r\n\t\tconst toggleDamageRow = () => {\r\n\t\t\tconst expanded = !!getInMemory(message, \"target.expanded\");\r\n\t\t\ttoggleBtn.toggleClass(\"collapse\", expanded);\r\n\t\t\tdamageRows.toggleClass(\"hidden\", !expanded);\r\n\t\t};\r\n\r\n\t\tconst toggleTooltip = localize(\"target.chat.toggle.tooltip\");\r\n\t\tconst toggleBtn = $(`<button class=\"toggle\" title=\"${toggleTooltip}\">\r\n    <i class=\"fa-solid fa-plus expand\"></i>\r\n    <i class=\"fa-solid fa-minus collapse\"></i>\r\n</button>`);\r\n\r\n\t\ttoggleDamageRow();\r\n\r\n\t\ttoggleBtn.on(\"click\", (event) => {\r\n\t\t\tevent.stopPropagation();\r\n\t\t\tsetInMemory(\r\n\t\t\t\tmessage,\r\n\t\t\t\t\"target.expanded\",\r\n\t\t\t\t!getInMemory(message, \"target.expanded\"),\r\n\t\t\t);\r\n\t\t\ttoggleDamageRow();\r\n\t\t});\r\n\r\n\t\tbuttons.append(toggleBtn);\r\n\t}\r\n\r\n\tif (data?.isRegen !== true && (game.user.isGM || message.isAuthor)) {\r\n\t\tconst targetsTooltip = localize(\"target.chat.targets.tooltip\");\r\n\t\tconst targetsBtn = $(`<button class=\"targets\" title=\"${targetsTooltip}\">\r\n    <i class=\"fa-solid fa-bullseye-arrow\"></i>\r\n</button>`);\r\n\r\n\t\ttargetsBtn.on(\"click\", (event) => addTargets(event, message));\r\n\r\n\t\tbuttons.append(targetsBtn);\r\n\t}\r\n\r\n\thtml.find(\".dice-result .dice-total\").append(buttons);\r\n\r\n\tif (!data?.targets.length) return;\r\n\r\n\tconst clonedRows = damageRows.clone();\r\n\tif (!clonedRows.length) return;\r\n\r\n\tclonedRows\r\n\t\t.removeClass(\"damage-application\")\r\n\t\t.addClass(\"target-damage-application\");\r\n\r\n\tif (getSetting(\"target-client\") !== \"big\")\r\n\t\tclonedRows.find(\"button\").addClass(\"small\");\r\n\r\n\tclonedRows.find(\"[data-action]\").each(function () {\r\n\t\tconst action = this.dataset.action;\r\n\t\tthis.dataset.action = `target-${action}`;\r\n\t});\r\n\r\n\tconst { targets, save } = data;\r\n\tconst rowsTemplate = $('<div class=\"pf2e-toolbelt-target-damage\"></div>');\r\n\r\n\tfor (const { uuid, template, save, isOwner, applied = {} } of targets) {\r\n\t\trowsTemplate.append(\"<hr>\");\r\n\t\trowsTemplate.append(template);\r\n\r\n\t\tif (!isOwner) continue;\r\n\r\n\t\tconst isBasicSave = !!(save?.result && save.basic);\r\n\t\tconst clones = clonedRows.clone();\r\n\r\n\t\tclones.each((index, el) => {\r\n\t\t\tel.dataset.rollIndex = index;\r\n\t\t\tel.dataset.targetUuid = uuid;\r\n\r\n\t\t\tel.classList.toggle(\r\n\t\t\t\t\"applied\",\r\n\t\t\t\t!!applied[index] ||\r\n\t\t\t\t\t(isBasicSave && save.result.success === \"criticalSuccess\"),\r\n\t\t\t);\r\n\t\t\tif (isBasicSave) el.classList.add(save.result.success);\r\n\t\t});\r\n\r\n\t\trowsTemplate.append(clones);\r\n\t}\r\n\r\n\tmsgContent.after(rowsTemplate);\r\n\r\n\taddHeaderListeners(message, rowsTemplate, save);\r\n\trowsTemplate\r\n\t\t.find(\"button[data-action^=target-]\")\r\n\t\t.on(\"click\", (event) => onTargetButton(event, message));\r\n}\r\n\r\nfunction getRowsElement(event) {\r\n\treturn event.target?.closest(\".pf2e-toolbelt-target-damage\");\r\n}\r\n\r\nfunction disableSaveListeners(event) {\r\n\tgetRowsElement(event)?.classList.add(\"disable-saves\");\r\n}\r\n\r\nfunction enableSaveListeners(event) {\r\n\tgetRowsElement(event)?.classList.remove(\"disable-saves\");\r\n}\r\n\r\nfunction addHeaderListeners(message, html, save) {\r\n\tconst listener = (event) => {\r\n\t\tconst target = event.target.closest(\"[data-action]\");\r\n\t\tif (!target) return;\r\n\r\n\t\tconst dataAction = target.dataset.action;\r\n\t\tconst saveEnabled = () => {\r\n\t\t\treturn !getRowsElement(event)?.classList.contains(\"disable-saves\");\r\n\t\t};\r\n\r\n\t\tswitch (dataAction) {\r\n\t\t\tcase \"ping-target\": {\r\n\t\t\t\tpingTarget(event);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"open-target-sheet\": {\r\n\t\t\t\topenTargetSheet(event);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"roll-save\": {\r\n\t\t\t\tsaveEnabled() && rollSave(event, message, save);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tcase \"reroll-save\": {\r\n\t\t\t\tsaveEnabled() && rerollSave(event, message, save);\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\thtml.on(\"click\", listener);\r\n}\r\n\r\nfunction getSaveData(message) {\r\n\tconst flag = getFlag(message, \"target.save\");\r\n\tif (!flag) return;\r\n\treturn {\r\n\t\t...flag,\r\n\t\t...SAVES[flag.statistic],\r\n\t};\r\n}\r\n\r\nasync function getMessageData(message) {\r\n\tconst isGM = game.user.isGM;\r\n\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\tconst showDC = isGM || game.settings.get(\"pf2e\", \"metagame_showDC\");\r\n\tconst showMods = isGM || game.settings.get(\"pf2e\", \"metagame_showBreakdowns\");\r\n\tconst showSuccess = isGM || game.settings.get(\"pf2e\", \"metagame_showResults\");\r\n\r\n\tconst save = getSaveData(message);\r\n\tif (!targetsFlag.length && !save) return;\r\n\r\n\tif (save) {\r\n\t\tconst saveLabel = game.i18n.format(\"PF2E.SavingThrowWithName\", {\r\n\t\t\tsaveName: game.i18n.localize(save.label),\r\n\t\t});\r\n\t\tconst saveDC = showDC\r\n\t\t\t? localize(\"target.chat.save.dcWithValue\", { dc: save.dc })\r\n\t\t\t: \"\";\r\n\t\tsave.tooltipLabel = `${saveLabel} ${saveDC}`;\r\n\t\tsave.tooltip = await render(\"target/save-tooltip\", {\r\n\t\t\tcheck: save.tooltipLabel,\r\n\t\t});\r\n\t}\r\n\r\n\tconst canRollSave = [];\r\n\r\n\tconst targets = (\r\n\t\tawait Promise.all(\r\n\t\t\ttargetsFlag.map(async ({ token }) => {\r\n\t\t\t\tconst target = await fromUuid(token);\r\n\t\t\t\tconst targetId = target.id;\r\n\t\t\t\tconst actor = target.actor;\r\n\t\t\t\tif (!actor) return;\r\n\r\n\t\t\t\tconst isVisible = !actor.hasCondition(\"undetected\");\r\n\t\t\t\tif (!isGM && !isVisible) return;\r\n\r\n\t\t\t\tconst isOwner = actor.isOwner;\r\n\t\t\t\tconst hasPlayerOwner = actor.hasPlayerOwner;\r\n\t\t\t\tconst isFriendly = isOwner || hasPlayerOwner;\r\n\t\t\t\tconst hasSave = save && !!actor?.saves[save.statistic];\r\n\t\t\t\tconst saveFlag = getFlag(message, `target.saves.${targetId}`);\r\n\r\n\t\t\t\tif (hasSave && !hasPlayerOwner && !saveFlag) {\r\n\t\t\t\t\tcanRollSave.push(token);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst targetSave = await (async () => {\r\n\t\t\t\t\tif (!hasSave || !saveFlag) return;\r\n\r\n\t\t\t\t\tconst rerolled = saveFlag.rerolled;\r\n\t\t\t\t\tconst canReroll = hasSave && isOwner && !rerolled;\r\n\t\t\t\t\tconst successLabel = game.i18n.localize(\r\n\t\t\t\t\t\t`PF2E.Check.Result.Degree.Check.${saveFlag.success}`,\r\n\t\t\t\t\t);\r\n\t\t\t\t\tconst offset = saveFlag.value - save.dc;\r\n\t\t\t\t\tconst result =\r\n\t\t\t\t\t\tisFriendly || showSuccess\r\n\t\t\t\t\t\t\t? localize(\r\n\t\t\t\t\t\t\t\t\t`target.chat.save.result.${\r\n\t\t\t\t\t\t\t\t\t\tshowDC\r\n\t\t\t\t\t\t\t\t\t\t\t? \"withOffset\"\r\n\t\t\t\t\t\t\t\t\t\t\t: isFriendly\r\n\t\t\t\t\t\t\t\t\t\t\t  ? \"withoutOffsetWithDie\"\r\n\t\t\t\t\t\t\t\t\t\t\t  : \"withoutOffset\"\r\n\t\t\t\t\t\t\t\t\t}`,\r\n\t\t\t\t\t\t\t\t\t{\r\n\t\t\t\t\t\t\t\t\t\tsuccess: successLabel,\r\n\t\t\t\t\t\t\t\t\t\toffset: offset >= 0 ? `+${offset}` : offset,\r\n\t\t\t\t\t\t\t\t\t\tdie: `<i class=\"fa-solid fa-dice-d20\"></i> ${saveFlag.die}`,\r\n\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t  )\r\n\t\t\t\t\t\t\t: undefined;\r\n\r\n\t\t\t\t\treturn {\r\n\t\t\t\t\t\t...saveFlag,\r\n\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\ttooltip: await render(\"target/save-tooltip\", {\r\n\t\t\t\t\t\t\ti18n: subLocalize(\"target.chat.save\"),\r\n\t\t\t\t\t\t\tcheck: save.tooltipLabel,\r\n\t\t\t\t\t\t\tresult,\r\n\t\t\t\t\t\t\tmodifiers: isFriendly || showMods ? saveFlag.modifiers : [],\r\n\t\t\t\t\t\t\tcanReroll,\r\n\t\t\t\t\t\t\trerolled: REROLL[rerolled],\r\n\t\t\t\t\t\t}),\r\n\t\t\t\t\t};\r\n\t\t\t\t})();\r\n\r\n\t\t\t\tconst templateSave = save && {\r\n\t\t\t\t\t...save,\r\n\t\t\t\t\tresult: targetSave,\r\n\t\t\t\t};\r\n\r\n\t\t\t\tconst anonymous = game.modules.get(\"anonymous\");\r\n\t\t\t\tconst canSeeName = isGM\r\n\t\t\t\t\t? true\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.playersSeeName(target.actor)\r\n\t\t\t\t\t  : !game.pf2e.settings.tokens.nameVisibility ||\r\n\t\t\t\t\t\t  target.playersCanSeeName;\r\n\t\t\t\tconst name = canSeeName\r\n\t\t\t\t\t? target.name\r\n\t\t\t\t\t: anonymous?.active\r\n\t\t\t\t\t  ? anonymous.api.getName(target.actor)\r\n\t\t\t\t\t  : localize(\"unnamed\");\r\n\r\n\t\t\t\treturn {\r\n\t\t\t\t\tisOwner,\r\n\t\t\t\t\tcanSeeName,\r\n\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\tuuid: token,\r\n\t\t\t\t\ttarget: target,\r\n\t\t\t\t\tsave: templateSave,\r\n\t\t\t\t\tapplied: getFlag(message, `target.applied.${targetId}`),\r\n\t\t\t\t\ttemplate: await render(\"target/row-header\", {\r\n\t\t\t\t\t\tname,\r\n\t\t\t\t\t\tisGM,\r\n\t\t\t\t\t\tisOwner,\r\n\t\t\t\t\t\thasPlayerOwner,\r\n\t\t\t\t\t\tisHidden: !isVisible,\r\n\t\t\t\t\t\tuuid: token,\r\n\t\t\t\t\t\tshowSuccess: isFriendly || showSuccess,\r\n\t\t\t\t\t\tsave: hasSave && templateSave,\r\n\t\t\t\t\t\tcanReroll: targetSave?.canReroll,\r\n\t\t\t\t\t\trerolled: REROLL[targetSave?.rerolled],\r\n\t\t\t\t\t\ti18n: subLocalize(\"target.chat.row\"),\r\n\t\t\t\t\t}),\r\n\t\t\t\t};\r\n\t\t\t}),\r\n\t\t)\r\n\t).filter(Boolean);\r\n\r\n\tsetInMemory(message, \"target.canRollSave\", canRollSave);\r\n\r\n\tif (isGM) {\r\n\t\ttargets.sort((a, b) => a.hasPlayerOwner - b.hasPlayerOwner);\r\n\t} else {\r\n\t\ttargets.sort((a, b) =>\r\n\t\t\t!a.isOwner && !b.isOwner\r\n\t\t\t\t? b.hasPlayerOwner - a.hasPlayerOwner\r\n\t\t\t\t: b.isOwner - a.isOwner,\r\n\t\t);\r\n\t}\r\n\r\n\treturn { targets, save, isRegen: getFlag(message, \"target.isRegen\") };\r\n}\r\n\r\nasync function getTargetFromEvent(event) {\r\n\tconst { targetUuid } = event.target.closest(\"[data-target-uuid]\").dataset;\r\n\treturn fromUuid(targetUuid);\r\n}\r\n\r\nasync function rerollSave(event, message, { dc }) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tconst actor = target?.actor;\r\n\tif (!actor) return;\r\n\r\n\tconst flag = getFlag(message, `target.saves.${target.id}`);\r\n\tif (!flag?.roll || flag.rerolled) return;\r\n\r\n\tconst heroPoints = actor.isOfType(\"character\") ? actor.heroPoints.value : 0;\r\n\r\n\tconst template = Object.entries(REROLL)\r\n\t\t.map(([type, { icon, reroll }]) => {\r\n\t\t\tif (type === \"hero\" && !heroPoints) return;\r\n\t\t\tconst label = game.i18n.localize(reroll);\r\n\t\t\treturn `<label><input type=\"radio\" name=\"reroll\" value=\"${type}\"><i class=\"${icon}\"></i> ${label}</label>`;\r\n\t\t})\r\n\t\t.filter(Boolean)\r\n\t\t.join(\"\");\r\n\r\n\tconst buttons = {\r\n\t\tyes: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-rotate rotate\"></i>',\r\n\t\t\tlabel: \"reroll\",\r\n\t\t\tcallback: (html) => html.find(\"[name=reroll]:checked\").val() ?? null,\r\n\t\t},\r\n\t\tno: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-xmark\"></i>',\r\n\t\t\tlabel: \"cancel\",\r\n\t\t\tcallback: () => null,\r\n\t\t},\r\n\t};\r\n\r\n\tdisableSaveListeners(event);\r\n\r\n\tconst reroll = await Dialog.wait(\r\n\t\t{\r\n\t\t\ttitle: `${target.name} - ${localize(\r\n\t\t\t\t\"target.chat.save.reroll.confirm.title\",\r\n\t\t\t)}`,\r\n\t\t\tcontent: template,\r\n\t\t\tbuttons,\r\n\t\t\tclose: () => null,\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: `pf2e-toolbelt-target-save-reroll-dialog-${target.id}`,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!reroll) {\r\n\t\tenableSaveListeners(event);\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst isHeroReroll = reroll === \"hero\";\r\n\tconst keep = isHeroReroll ? \"new\" : reroll;\r\n\r\n\tif (isHeroReroll) {\r\n\t\tconst { value, max } = actor.heroPoints;\r\n\r\n\t\tif (value < 1) {\r\n\t\t\twarn(\"target.chat.save.reroll.noPoints\");\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tawait actor.update({\r\n\t\t\t\"system.resources.heroPoints.value\": Math.clamped(value - 1, 0, max),\r\n\t\t});\r\n\t}\r\n\r\n\tconst oldRoll = Roll.fromJSON(flag.roll);\r\n\tconst unevaluatedNewRoll = oldRoll.clone();\r\n\tunevaluatedNewRoll.options.isReroll = true;\r\n\tHooks.callAll(\r\n\t\t\"pf2e.preReroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tunevaluatedNewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst newRoll = await unevaluatedNewRoll.evaluate({ async: true });\r\n\tawait roll3dDice(newRoll);\r\n\r\n\tHooks.callAll(\r\n\t\t\"pf2e.reroll\",\r\n\t\tRoll.fromJSON(flag.roll),\r\n\t\tnewRoll,\r\n\t\tisHeroReroll,\r\n\t\tkeep,\r\n\t);\r\n\r\n\tconst keptRoll =\r\n\t\t(keep === \"higher\" && oldRoll.total > newRoll.total) ||\r\n\t\t(keep === \"lower\" && oldRoll.total < newRoll.total)\r\n\t\t\t? oldRoll\r\n\t\t\t: newRoll;\r\n\r\n\tif (keptRoll === newRoll) {\r\n\t\tconst success = new DegreeOfSuccess(newRoll, dc, flag.dosAdjustments);\r\n\t\tkeptRoll.options.degreeOfSuccess = success.value;\r\n\t}\r\n\r\n\tconst isAuthor = game.user.isGM || message.isAuthor;\r\n\r\n\tconst data = {\r\n\t\tvalue: keptRoll.total,\r\n\t\tdie: keptRoll.dice[0].total,\r\n\t\tsuccess: keptRoll.degreeOfSuccess,\r\n\t\troll: JSON.stringify(keptRoll.toJSON()),\r\n\t\tdosAdjustments: deepClone(flag.dosAdjustments),\r\n\t\tmodifiers: deepClone(flag.modifiers),\r\n\t\trerolled: reroll,\r\n\t};\r\n\r\n\tif (keptRoll.options.keeleyAdd10) {\r\n\t\tdata.modifiers.push({\r\n\t\t\tlabel: localize(\"target.chat.save.reroll.keeley\"),\r\n\t\t\tmodifier: 10,\r\n\t\t});\r\n\t}\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\tmessage: isAuthor ? message : message.id,\r\n\t\ttargets: [\r\n\t\t\t{\r\n\t\t\t\ttarget: target.id,\r\n\t\t\t\tdata,\r\n\t\t\t},\r\n\t\t],\r\n\t};\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tupdateMessageSave(packet);\r\n\t} else {\r\n\t\tsocket.emit(packet);\r\n\t}\r\n}\r\n\r\nasync function rollSave(event, message, { dc, statistic }, tokens) {\r\n\tconst isAuthor = game.user.isGM || message.isAuthor;\r\n\r\n\tconst targetPromises = Array.isArray(tokens)\r\n\t\t? tokens.map((uuid) => fromUuid(uuid))\r\n\t\t: [getTargetFromEvent(event)];\r\n\r\n\tconst packet = {\r\n\t\ttype: \"target.update-save\",\r\n\t\tmessage: isAuthor ? message : message.id,\r\n\t\ttargets: [],\r\n\t};\r\n\r\n\tdisableSaveListeners(event);\r\n\r\n\tawait Promise.all(\r\n\t\ttargetPromises.map(async (targetPromise) => {\r\n\t\t\tconst target = await targetPromise;\r\n\t\t\tconst actor = target?.actor;\r\n\t\t\tif (!actor) return;\r\n\r\n\t\t\tconst save = actor.saves[statistic];\r\n\t\t\tif (!save) return;\r\n\r\n\t\t\t// we remove that\r\n\t\t\tconst item = (() => {\r\n\t\t\t\tconst item = message.item;\r\n\t\t\t\tif (item) return item;\r\n\r\n\t\t\t\tconst messageId = getFlag(message, \"target.messageId\");\r\n\t\t\t\tif (!messageId) return;\r\n\r\n\t\t\t\tconst otherMessage = game.messages.get(messageId);\r\n\t\t\t\tif (!otherMessage) return;\r\n\r\n\t\t\t\treturn otherMessage.item;\r\n\t\t\t})();\r\n\t\t\t// remove above\r\n\r\n\t\t\tconst skipDefault = !game.user.settings.showCheckDialogs;\r\n\r\n\t\t\treturn new Promise((resolve) => {\r\n\t\t\t\tsave.check.roll({\r\n\t\t\t\t\tdc: { value: dc },\r\n\t\t\t\t\titem,\r\n\t\t\t\t\t// item: message.item,\r\n\t\t\t\t\torigin: actor,\r\n\t\t\t\t\tskipDialog: event.shiftKey ? !skipDefault : skipDefault,\r\n\t\t\t\t\tcreateMessage: false,\r\n\t\t\t\t\tcallback: async (roll, __, msg) => {\r\n\t\t\t\t\t\tawait roll3dDice(roll);\r\n\r\n\t\t\t\t\t\tconst data = {\r\n\t\t\t\t\t\t\tvalue: roll.total,\r\n\t\t\t\t\t\t\tdie: roll.dice[0].total,\r\n\t\t\t\t\t\t\tsuccess: roll.degreeOfSuccess,\r\n\t\t\t\t\t\t\troll: JSON.stringify(roll.toJSON()),\r\n\t\t\t\t\t\t\tdosAdjustments: msg.getFlag(\"pf2e\", \"context.dosAdjustments\"),\r\n\t\t\t\t\t\t\tmodifiers: msg\r\n\t\t\t\t\t\t\t\t.getFlag(\"pf2e\", \"modifiers\")\r\n\t\t\t\t\t\t\t\t.filter((modifier) => modifier.enabled)\r\n\t\t\t\t\t\t\t\t.map(({ label, modifier }) => ({ label, modifier })),\r\n\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\tpacket.targets.push({\r\n\t\t\t\t\t\t\tdata,\r\n\t\t\t\t\t\t\ttarget: target.id,\r\n\t\t\t\t\t\t});\r\n\r\n\t\t\t\t\t\tresolve();\r\n\t\t\t\t\t},\r\n\t\t\t\t});\r\n\t\t\t});\r\n\t\t}),\r\n\t);\r\n\r\n\tif (isAuthor) {\r\n\t\tupdateMessageSave(packet);\r\n\t} else {\r\n\t\tsocket.emit(packet);\r\n\t}\r\n}\r\n\r\nasync function updateMessageSave({ targets, message }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\r\n\tconst updates = {};\r\n\r\n\tfor (const { data, target } of targets) {\r\n\t\tif (typeof data.success === \"number\") {\r\n\t\t\tdata.success = DEGREE_OF_SUCCESS[data.success];\r\n\t\t}\r\n\t\tupdates[target] = deepClone(data);\r\n\t}\r\n\r\n\tawait setFlag(message, \"target.saves\", updates);\r\n}\r\n\r\nasync function openTargetSheet(event) {\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\ttarget.actor?.sheet.render(true);\r\n}\r\n\r\nasync function pingTarget(event) {\r\n\tif (!canvas.ready) return;\r\n\r\n\tconst target = await getTargetFromEvent(event);\r\n\tif (!target) return;\r\n\r\n\tcanvas.ping(target.center);\r\n}\r\n\r\nasync function onTargetButton(event, message) {\r\n\tconst btn = event.currentTarget;\r\n\tconst { rollIndex, targetUuid } = btn.closest(\"[data-target-uuid]\").dataset;\r\n\tconst target = await fromUuid(targetUuid);\r\n\tif (!target) return;\r\n\r\n\tconst type = btn.dataset.action;\r\n\r\n\tif (type === \"target-shield-block\") {\r\n\t\tconst messageId = message.id;\r\n\r\n\t\tif (!btn.classList.contains(\"shield-activated\")) {\r\n\t\t\ttoggleOffShieldBlock(messageId);\r\n\t\t}\r\n\r\n\t\trequestAnimationFrame(() => {\r\n\t\t\tonClickShieldBlock(target, btn, message.element);\r\n\t\t});\r\n\r\n\t\treturn;\r\n\t}\r\n\r\n\tconst multiplier =\r\n\t\ttype === \"target-apply-healing\"\r\n\t\t\t? -1\r\n\t\t\t: type === \"target-half-damage\"\r\n\t\t\t  ? 0.5\r\n\t\t\t  : type === \"target-apply-damage\"\r\n\t\t\t\t  ? 1\r\n\t\t\t\t  : type === \"target-double-damage\"\r\n\t\t\t\t\t  ? 2\r\n\t\t\t\t\t  : 3;\r\n\r\n\tapplyDamageFromMessage({\r\n\t\tmessage,\r\n\t\tmultiplier,\r\n\t\taddend: 0,\r\n\t\tpromptModifier: event.shiftKey,\r\n\t\trollIndex: Number(rollIndex),\r\n\t\ttokens: [target],\r\n\t\tonDamageApplied,\r\n\t});\r\n}\r\n\r\nexport function onDamageApplied(message, tokens, rollIndex) {\r\n\tconst updates = {};\r\n\r\n\tfor (const token of tokens) {\r\n\t\tconst tokenId = token.id;\r\n\r\n\t\tmoduleFlagUpdate(updates, `target.applied.${tokenId}.${rollIndex}`, true);\r\n\r\n\t\tconst splashRollIndex = getFlag(message, \"target.splashIndex\");\r\n\t\tif (splashRollIndex !== undefined) {\r\n\t\t\tconst regularRollIndex = splashRollIndex === 0 ? 1 : 0;\r\n\r\n\t\t\tif (rollIndex === splashRollIndex) {\r\n\t\t\t\tmoduleFlagUpdate(\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t`target.applied.${tokenId}.${regularRollIndex}`,\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\t\t\t} else {\r\n\t\t\t\tmoduleFlagUpdate(\r\n\t\t\t\t\tupdates,\r\n\t\t\t\t\t`target.applied.${tokenId}.${splashRollIndex}`,\r\n\t\t\t\t\ttrue,\r\n\t\t\t\t);\r\n\r\n\t\t\t\tconst targetsFlag = getFlag(message, \"target.targets\") ?? [];\r\n\t\t\t\tfor (const target of targetsFlag) {\r\n\t\t\t\t\tconst targetId = target.token?.split(\".\").at(-1);\r\n\t\t\t\t\tif (targetId === tokenId) continue;\r\n\r\n\t\t\t\t\tmoduleFlagUpdate(\r\n\t\t\t\t\t\tupdates,\r\n\t\t\t\t\t\t`target.applied.${targetId}.${regularRollIndex}`,\r\n\t\t\t\t\t\ttrue,\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (game.user.isGM || message.isAuthor) {\r\n\t\tupdateMessageApplied({ message, updates });\r\n\t} else {\r\n\t\tsocket.emit({\r\n\t\t\ttype: \"target.update-applied\",\r\n\t\t\tmessage: message.id,\r\n\t\t\tupdates,\r\n\t\t});\r\n\t}\r\n}\r\n\r\nfunction updateMessageApplied({ message, updates }) {\r\n\tif (typeof message === \"string\") {\r\n\t\tmessage = game.messages.get(message);\r\n\t\tif (!message) return;\r\n\t}\r\n\tmessage.update(updates);\r\n}\r\n", "import { getSetting } from \"module-api\";\r\n\r\nlet CREATE_HOOK = null;\r\nlet UPDATE_HOOK = null;\r\n\r\nexport function registerUnided() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"unided\",\r\n\t\t\t\ttype: String,\r\n\t\t\t\tdefault: \"disabled\",\r\n\t\t\t\tchoices: [\"disabled\", \"create\", \"all\"],\r\n\t\t\t\tonChange: setHooks,\r\n\t\t\t},\r\n\t\t],\r\n\t\tconflicts: [\"pf2e-unided\"],\r\n\t\tinit: () => {\r\n\t\t\tsetHooks();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setHooks(value) {\r\n\tconst settingValue = value ?? getSetting(\"unided\");\r\n\r\n\tif (settingValue === \"disabled\") {\r\n\t\tif (CREATE_HOOK) {\r\n\t\t\tHooks.off(\"preCreateItem\", CREATE_HOOK);\r\n\t\t\tCREATE_HOOK = null;\r\n\t\t}\r\n\t\tif (UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t} else {\r\n\t\tif (!CREATE_HOOK) {\r\n\t\t\tCREATE_HOOK = Hooks.on(\"preCreateItem\", preCreateItem);\r\n\t\t}\r\n\t\tif (settingValue === \"all\" && !UPDATE_HOOK) {\r\n\t\t\tUPDATE_HOOK = Hooks.on(\"preUpdateItem\", preUpdateItem);\r\n\t\t} else if (settingValue !== \"all\" && UPDATE_HOOK) {\r\n\t\t\tHooks.off(\"preUpdateItem\", UPDATE_HOOK);\r\n\t\t\tUPDATE_HOOK = null;\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction preCreateItem(item) {\r\n\tif (!item.img || !item.isOfType(\"physical\")) return;\r\n\titem._source.system.identification.unidentified.img = item.img;\r\n}\r\n\r\nfunction preUpdateItem(item, changes) {\r\n\tif (!item.isOfType(\"physical\") || !(\"img\" in changes)) return;\r\n\tsetProperty(changes, \"system.identification.unidentified.img\", changes.img);\r\n}\r\n", "import { getSetting } from \"module-api\";\r\nimport { createHook } from \"../hooks\";\r\n\r\nconst setHook = createHook(\"updateCombat\", updateCombat);\r\n\r\nexport function registerUntarget() {\r\n\treturn {\r\n\t\tsettings: [\r\n\t\t\t{\r\n\t\t\t\tkey: \"force-untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t\t{\r\n\t\t\t\tkey: \"untarget\",\r\n\t\t\t\ttype: Boolean,\r\n\t\t\t\tdefault: false,\r\n\t\t\t\tscope: \"client\",\r\n\t\t\t\tonChange: setup,\r\n\t\t\t},\r\n\t\t],\r\n\t\tinit: () => {\r\n\t\t\tsetup();\r\n\t\t},\r\n\t};\r\n}\r\n\r\nfunction setup() {\r\n\tsetHook(getSetting(\"force-untarget\") || getSetting(\"untarget\"));\r\n}\r\n\r\nfunction updateCombat(_, data) {\r\n\tif (!(\"turn\" in data) && !(\"round\" in data)) return;\r\n\r\n\tconst user = game.user;\r\n\tuser.updateTokenTargets();\r\n\tuser.broadcastActivity({ targets: [] });\r\n}\r\n", "import { render, subLocalize } from \"module-api\";\r\n\r\nconst localize = subLocalize(\"macros.condition\");\r\n\r\nexport async function permaConditionEffect(actor) {\r\n\tconst callback = (html, type) => {\r\n\t\tconst condition = html.find(\"[name=condition]\");\r\n\t\tconst { name, slug, img } = condition.find(\":selected\").data();\r\n\r\n\t\treturn {\r\n\t\t\ttype,\r\n\t\t\tslug,\r\n\t\t\timg,\r\n\t\t\tname:\r\n\t\t\t\thtml.find(\"[name=name]\").val().trim() ||\r\n\t\t\t\tlocalize(\"effect-name\", { condition: name }),\r\n\t\t\tuuid: condition.val(),\r\n\t\t\tbadge: Number(html.find(\"[name=badge]\").val() || 1),\r\n\t\t\tunidentified: html.find(\"[name=unidentified]\").prop(\"checked\"),\r\n\t\t};\r\n\t};\r\n\r\n\tconst buttons = {\r\n\t\tgenerate: {\r\n\t\t\ticon: '<i class=\"fas fa-suitcase\"></i>',\r\n\t\t\tlabel: localize(\"generate\"),\r\n\t\t\tcallback: (html) => callback(html, \"generate\"),\r\n\t\t},\r\n\t\tadd: {\r\n\t\t\ticon: '<i class=\"fa-solid fa-user\"></i>',\r\n\t\t\tlabel: localize(\"add\"),\r\n\t\t\tcallback: (html) => callback(html, \"add\"),\r\n\t\t},\r\n\t};\r\n\r\n\tconst conditions = Array.from(game.pf2e.ConditionManager.conditions.values());\r\n\tconst withBadge = new Set(\r\n\t\tconditions\r\n\t\t\t.filter((condition) => !!condition.badge)\r\n\t\t\t.map((condition) => condition.slug),\r\n\t);\r\n\r\n\tconst content = await render(\"macros/condition\", {\r\n\t\ti18n: localize.template,\r\n\t\tconditions: Array.from(\r\n\t\t\tnew Set(conditions.sort((a, b) => a.name.localeCompare(b.name))),\r\n\t\t),\r\n\t});\r\n\r\n\tconst setInputs = (html) => {\r\n\t\tconst { name, slug } = html.find(\"[name=condition] :selected\").data();\r\n\t\thtml\r\n\t\t\t.find(\"[name=name]\")\r\n\t\t\t.prop(\"placeholder\", localize(\"effect-name\", { condition: name }));\r\n\r\n\t\tconst hasBadge = withBadge.has(slug);\r\n\t\tconst badge = html.find(\"[name=badge]\");\r\n\t\tbadge.prop(\"disabled\", !hasBadge);\r\n\t\tif (!hasBadge) badge.val(1);\r\n\t};\r\n\r\n\tconst result = await Dialog.wait(\r\n\t\t{\r\n\t\t\tbuttons,\r\n\t\t\tcontent,\r\n\t\t\ttitle: localize(\"title\"),\r\n\t\t\tclose: () => null,\r\n\t\t\trender: (html) => {\r\n\t\t\t\tsetInputs(html);\r\n\t\t\t\thtml.find(\"[name=condition]\").on(\"change\", () => setInputs(html));\r\n\t\t\t},\r\n\t\t},\r\n\t\t{\r\n\t\t\tid: \"pf2e-toolbelt-macros-condition\",\r\n\t\t\twidth: 320,\r\n\t\t},\r\n\t);\r\n\r\n\tif (!result) return;\r\n\r\n\tconst rule = {\r\n\t\tinMemoryOnly: true,\r\n\t\tkey: \"GrantItem\",\r\n\t\tuuid: result.uuid,\r\n\t};\r\n\r\n\tif (result.badge > 1 && withBadge.has(result.slug)) {\r\n\t\trule.alterations = [\r\n\t\t\t{\r\n\t\t\t\tmode: \"override\",\r\n\t\t\t\tproperty: \"badge-value\",\r\n\t\t\t\tvalue: result.badge,\r\n\t\t\t},\r\n\t\t];\r\n\t}\r\n\r\n\tconst source = {\r\n\t\tname: result.name,\r\n\t\ttype: \"effect\",\r\n\t\timg: result.img,\r\n\t\tsystem: {\r\n\t\t\trules: [rule],\r\n\t\t\tunidentified: result.unidentified,\r\n\t\t},\r\n\t};\r\n\r\n\tif (result.type === \"generate\" || !actor) await Item.create(source);\r\n\telse await actor.createEmbeddedDocuments(\"Item\", [source]);\r\n}\r\n", "import {\r\n\tMODULE,\r\n\tgetModule,\r\n\tisUserGM,\r\n\tlocalize,\r\n\tregisterModule,\r\n\tregisterSetting,\r\n\tsocketOn,\r\n\twarn,\r\n} from \"module-api\";\r\nimport { registerArp } from \"./features/arp\";\r\nimport { registerDebug } from \"./features/debug\";\r\nimport { registerEffectsPanelHelper } from \"./features/effects\";\r\nimport { registerGiveth } from \"./features/giveth\";\r\nimport { registerHeroActions } from \"./features/hero\";\r\nimport { registerInventory } from \"./features/inventory\";\r\nimport { registerKnowledges } from \"./features/knowledges\";\r\nimport { registerMerchant } from \"./features/merchant\";\r\nimport { registerMerge } from \"./features/merge\";\r\nimport { registerNobulk } from \"./features/nobulk\";\r\nimport { registerShare } from \"./features/share\";\r\nimport { registerStances } from \"./features/stances\";\r\nimport { registerSpellsSummary } from \"./features/summary\";\r\nimport { registerTargetTokenHelper } from \"./features/target\";\r\nimport { registerUnided } from \"./features/unided\";\r\nimport { registerUntarget } from \"./features/untarget\";\r\nimport { permaConditionEffect } from \"./macros/condition\";\r\nimport { onSocket } from \"./socket\";\r\n\r\nregisterModule(\"pf2e-toolbelt\");\r\n\r\nconst FEATURES = [\r\n\tregisterArp(),\r\n\tregisterNobulk(),\r\n\tregisterTargetTokenHelper(),\r\n\tregisterGiveth(),\r\n\tregisterKnowledges(),\r\n\tregisterUnided(),\r\n\tregisterMerge(),\r\n\tregisterEffectsPanelHelper(),\r\n\tregisterSpellsSummary(),\r\n\tregisterStances(),\r\n\tregisterHeroActions(),\r\n\tregisterShare(),\r\n\tregisterUntarget(),\r\n\tregisterInventory(),\r\n\tregisterDebug(),\r\n\tregisterMerchant(),\r\n];\r\n\r\nconst CONFLICTS = new Set();\r\n\r\nlet firstClientSetting = null;\r\n\r\nHooks.once(\"init\", () => {\r\n\tconst isGM = isUserGM();\r\n\r\n\tconst settings = FEATURES.flatMap(({ settings }) => settings ?? []);\r\n\tconst worldSettings = settings.filter(\r\n\t\t({ scope }) => !scope || scope === \"world\",\r\n\t);\r\n\tconst clientSettings = settings.filter(({ scope }) => scope === \"client\");\r\n\r\n\tfor (const setting of [worldSettings, clientSettings].flat()) {\r\n\t\tregisterSetting(setting);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfirstClientSetting = clientSettings[0].key;\r\n\t\tHooks.on(\"renderSettingsConfig\", renderSettingsConfig);\r\n\t}\r\n\r\n\tconst module = getModule();\r\n\tmodule.api = {\r\n\t\tmacros: {\r\n\t\t\tpermaConditionEffect,\r\n\t\t},\r\n\t};\r\n\r\n\tfor (const feature of FEATURES) {\r\n\t\tconst { init, conflicts = [], api, name, socket } = feature;\r\n\r\n\t\tif (isGM) {\r\n\t\t\tfor (const id of conflicts) {\r\n\t\t\t\tconst conflictingModule = game.modules.get(id);\r\n\t\t\t\tif (conflictingModule?.active) {\r\n\t\t\t\t\tfeature.conflicting = true;\r\n\t\t\t\t\tCONFLICTS.add(conflictingModule.title);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif (api && name) module.api[name] = api;\r\n\r\n\t\tif (!feature.conflicting && init) init(isGM);\r\n\t}\r\n\r\n\tsocketOn(onSocket);\r\n});\r\n\r\nHooks.once(\"ready\", () => {\r\n\tconst isGM = game.user.isGM;\r\n\r\n\tfor (const { conflicting, ready } of FEATURES) {\r\n\t\tif (!conflicting && ready) ready(isGM);\r\n\t}\r\n\r\n\tif (isGM) {\r\n\t\tfor (const conflict of CONFLICTS) {\r\n\t\t\twarn(\"module-conflict\", { name: conflict }, true);\r\n\t\t}\r\n\t}\r\n});\r\n\r\nfunction renderSettingsConfig(_, html) {\r\n\tif (!firstClientSetting) return;\r\n\r\n\tconst id = MODULE.id;\r\n\tconst group = html.find(\r\n\t\t`.tab[data-tab=${id}] [data-setting-id=\"${id}.${firstClientSetting}\"]`,\r\n\t);\r\n\r\n\tgroup.before(`<h3>${localize(\"settings.client\")}</h3>`);\r\n}\r\n"],
  "mappings": "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",
  "names": ["getOwner", "actor", "isValidUser", "__name", "user", "owners", "a", "b", "isOwner", "refreshCharacterSheets", "actor", "win", "winActor", "__name", "latestChatMessages", "nb", "fromMessage", "chat", "messages", "start", "m", "i", "message", "html", "__name", "chatUUID", "uuid", "label", "fake", "hasEmbeddedSpell", "getInMemory", "doc", "path", "MODULE", "__name", "setInMemory", "args", "value", "deleteInMemory", "split", "last", "cursor", "key", "arrayToObject", "arr", "fn", "key", "obj", "entry", "k", "__name", "compareArrays", "arr1", "arr2", "clonedArr2", "arr1Value", "index", "arr2Value", "indexIsValid", "getElementIndex", "el", "__name", "calculateDistanceBetweenPoints", "x1", "y1", "x2", "y2", "x", "y", "__name", "isInstanceOf", "obj", "name", "cursor", "__name", "joinStr", "separator", "path", "x", "__name", "flagPath", "path", "MODULE", "joinStr", "__name", "getFlag", "doc", "getFlagProperty", "setFlag", "args", "value", "unsetFlag", "updateSourceFlag", "doc", "args", "value", "flagPath", "__name", "moduleFlagUpdate", "updates", "render", "args", "data", "path", "templatePath", "__name", "MODULE", "joinStr", "registerUpstreamHook", "hook", "fn", "id", "index", "x", "hooked", "__name", "getSourceId", "item", "__name", "includesSourceId", "list", "sourceId", "getItemSourceIdCondition", "getItems", "actor", "itemTypes", "types", "type", "hasItemWithSourceId", "getItemWithSourceId", "registerWrapper", "path", "callback", "type", "MODULE", "__name", "unregisterWrapper", "id", "localize", "args", "MODULE", "data", "joinStr", "__name", "hasLocalization", "keys", "localizePath", "path", "MODULE", "__name", "subLocalize", "subKey", "fn", "args", "localize", "str", "arg1", "arg2", "warn", "info", "error", "key", "hasLocalization", "hash", "localeCompare", "a", "b", "notify", "str", "arg1", "arg2", "arg3", "type", "data", "permanent", "localize", "__name", "warn", "info", "error", "registerSetting", "options", "arrayToObject", "choice", "settingPath", "MODULE", "__name", "setting", "key", "getSetting", "setSetting", "value", "socketOn", "callback", "MODULE", "__name", "socketEmit", "packet", "MODULE", "__name", "getUser", "x", "__name", "isUserGM", "user", "isActiveGM", "isGMOnline", "MODULE_ID", "MODULE", "str", "registerModule", "id", "__name", "getModule", "HIGHER_BONUS", "__name", "a", "b", "LOWER_PENALTY", "applyStackingRules", "modifiers", "total", "highestBonus", "lowestPenalty", "abilityModifiers", "m", "bestAbility", "best", "modifier", "applyStacking", "isBetter", "existing", "getTabResults", "tab", "uuid", "__name", "htmlQuery", "parent", "selectors", "__name", "ordinalString", "value", "pluralRules", "suffix", "__name", "ErrorPF2e", "message", "intlNumberFormat", "signedInteger", "emptyStringZero", "zeroIsNegative", "maybeNegativeZero", "extractEphemeralEffects", "affects", "origin", "target", "item", "domains", "options", "effectsFrom", "effectsTo", "fullOptions", "resolvables", "s", "d", "e", "__name", "extractNotes", "rollNotes", "selectors", "n", "extractDamageDice", "deferredDice", "extractModifiers", "synthetics", "modifierAdjustments", "syntheticModifiers", "modifiers", "modifier", "extractModifierAdjustments", "adjustmentsRecord", "slug", "applyDamageFromMessage", "message", "multiplier", "addend", "promptModifier", "rollIndex", "tokens", "onDamageApplied", "shiftAdjustDamage", "htmlQuery", "shieldBlockRequest", "roll", "isInstanceOf", "ErrorPF2e", "damage", "messageRollOptions", "originRollOptions", "o", "messageItem", "effectRollOptions", "token", "domain", "ephemeralEffects", "extractEphemeralEffects", "contextClone", "applicationRollOptions", "outcome", "breakdown", "rolls", "critical", "resolvables", "damageDice", "extractDamageDice", "d", "dice", "formula", "previous", "current", "modifiers", "extractModifiers", "m", "applyStackingRules", "signedInteger", "notes", "extractNotes", "n", "toggleOffShieldBlock", "__name", "onClickShieldBlock", "target", "shieldButton", "messageEl", "getTokens", "getNonBrokenShields", "s", "nonBrokenShields", "hasMultipleShields", "shieldActivated", "instance", "_helper", "contentEl", "multipleShields", "listEl", "shieldList", "shield", "input", "shieldName", "hardness", "hardnessLabel", "itemLi", "messageId", "app", "selector", "button", "content", "AdjustmentDialog", "$html", "isHealing", "$dialog", "adjustment", "getDamageRollClass", "Roll", "__name", "HANDWRAPS_SLUG", "canBeInvested", "item", "__name", "hasWornSlot", "isWornAs", "isInvestedOrWornAs", "isHeld", "isTwoHanded", "isOneHanded", "inSlotValue", "value", "usage", "toggleInvestedValue", "invest", "itemCarryUpdate", "carryType", "handsHeld", "inSlot", "invested", "containerId", "update", "isHandwrapsOfMightyBlows", "spellSlotGroupIdToNumber", "groupId", "numericValue", "__name", "DEGREE_ADJUSTMENT_AMOUNTS", "DEGREE_OF_SUCCESS_STRINGS", "DegreeOfSuccess", "_DegreeOfSuccess", "__name", "roll", "dc", "dosAdjustments", "t", "d", "#calculateDegreeOfSuccess", "#getDegreeAdjustment", "#adjustDegreeOfSuccess", "degree", "adjustments", "outcome", "label", "amount", "degreeOfSuccess", "#adjustDegreeByDieValue", "getTemplateTokens", "measuredTemplate", "collisionOrigin", "collisionType", "template", "grid", "dimensions", "gridHighlight", "origin", "tokens", "gridSize", "containedTokens", "token", "tokenDoc", "tokenPositions", "h", "tokenX", "y", "w", "position", "gx", "gy", "s", "destination", "__name", "wrapperError", "feature", "path", "MODULE", "__name", "roll3dDice", "roll", "user", "synchronize", "PREPARE_WEAPON_DATA", "PREPARE_WEAPON_DERIVED_DATA", "PREPARE_ARMOR_DATA", "PREPARE_ARMOR_DERIVED_DATA", "registerArp", "setting", "getSetting", "registerWrapper", "onPrepareWeaponData", "onPrepareWeaponDerivedData", "onPrepareArmorData", "onPrepareArmorDerivedData", "renderPhysicalItemSheetPF2e", "isGM", "info", "__name", "isValidActor", "actor", "isCharacter", "WEAPON_POTENCY_PRICE", "WEAPON_STRIKING_PRICE", "isShieldWeapon", "weapon", "isValidWeapon", "traits", "group", "category", "slug", "HANDWRAPS_SLUG", "wrapped", "level", "forceUpdate", "expectedPotency", "expectedStriking", "wrapperError", "coins", "potency", "striking", "ARMOR_POTENCY_PRICE", "ARMOR_RESILIENCY_PRICE", "isValidArmor", "armor", "expectedResilient", "resiliency", "sheet", "html", "item", "lookups", "x", "createHook", "event", "listener", "callback", "HOOK", "value", "otherSettings", "skipCallback", "settingValue", "s", "getSetting", "__name", "createChoicesHook", "appHook", "createHook", "onRender", "actorHook", "itemHook", "registerDebug", "value", "setup", "__name", "enabled", "getSetting", "app", "html", "link", "event", "obj", "type", "variable", "setHook", "createHook", "renderEffectsPanel", "refreshEffectsPanel", "registerEffectsPanelHelper", "value", "__name", "panel", "html", "removeRow", "localize", "editIcon", "effectPanels", "effectPanel", "id", "effect", "getSetting", "event", "onRemoveEffect", "h1", "onConditionSheet", "getEffect", "sheetTabsRegistered", "preparedEmbeddedRegistered", "ACTOR_PREPARE_EMBEDDED_DOCUMENTS", "CHARACTER_SHEET_INNER_RENDER", "CHARACTER_SHEET_RENDER", "CHARACTER_SHEET_ACTIVE_LISTENERS", "isPlayedActor", "actor", "__name", "registerActorPreparedEmbeddedDocuments", "feature", "listener", "registerWrapper", "actorPrepareEmbeddedDocuments", "registerCharacterSheetExtraTab", "options", "characterSheetRender", "characterSheetInnerRender", "characterSheetActiveListeners", "unregisterCharacterSheetExtraTab", "tabName", "wrapperId", "unregisterWrapper", "wrapped", "args", "positions", "existingAlternate", "getCharacterSheetTab", "alternate", "data", "inner", "element", "getData", "templateFolder", "onRender", "innerTab", "tabData", "template", "render", "getInMemory", "addEvents", "event", "onCharacterSheetTabBtnToggle", "tab", "html", "sheet", "setInMemory", "MoveLootPopup", "__name", "object", "options", "callback", "prompt", "buttonLabel", "_event", "formData", "registeredSockets", "onSocket", "packet", "senderId", "registered", "__name", "registerSocket", "key", "listener", "MODULE", "socketEmit", "enabled", "enabled", "CANVAS_HOOK", "socket", "registerSocket", "onSocket", "registerGiveth", "setup", "isGM", "getSetting", "__name", "value", "registerUpstreamHook", "onDropCanvasData", "packet", "takethCondition", "takethEffect", "takethPhysical", "canvas", "data", "isGMOnline", "details", "getDetailsFromData", "target", "token", "isValidActor", "maximumX", "maximumY", "b", "giveth", "origin", "item", "ownerId", "targetId", "isIndex", "qty", "warn", "sendPhysicalRequest", "MoveLootPopup", "stack", "uuid", "itemId", "actor", "id", "isPlayedActor", "actorUUID", "source", "owner", "newQty", "newItem", "content", "chatUUID", "localize", "localize", "subLocalize", "Trade", "__name", "actor", "templatePath", "value", "options", "x", "getHeroActions", "html", "#onChangeTarget", "#onDescription", "#onSendTrade", "force", "action", "target", "user", "getOwner", "sendTradeRequest", "event", "uuid", "id", "MODULE_ID", "socket", "registerSocket", "onSocket", "setHook", "createHook", "renderCharacterSheetPF2e", "setupSocket", "JOURNAL_UUID", "TABLE_UUID", "TABLE_ICON", "registerHeroActions", "value", "refreshCharacterSheets", "createTable", "removeHeroActions", "getHeroActions", "useHeroAction", "getHeroActionDetails", "drawHeroAction", "drawHeroActions", "sendActionToChat", "discardHeroActions", "tradeHeroAction", "getDeckTable", "giveHeroActions", "createChatMessage", "__name", "packet", "onTradeRejected", "isActiveGM", "onTradeAccepted", "onTradeRequest", "onTradeError", "sheet", "html", "actor", "isPlayedActor", "addActionsToSheet", "addSheetEvents", "actions", "diff", "isOwner", "localize", "subLocalize", "template", "render", "getSetting", "list", "event", "onClickHeroActionsDraw", "onClickHeroActionExpand", "onClickHeroActionUse", "onClickHeroActionDisplay", "onClickHeroActionDiscard", "onClickHeroActionsDiscard", "uuids", "x", "action", "toDiscard", "$discarded", "uuid", "setHeroActions", "summary", "details", "text", "document", "parent", "page", "warn", "nb", "drawn", "i", "label", "secret", "content", "size", "chatActions", "data", "links", "name", "chatUUID", "Trade", "table", "r", "draw", "documentUuidFromTableResult", "getLabelfromTableResult", "points", "index", "error", "actionsUUIDS", "removed", "result", "getTableFromUuid", "getDefaultCompendiumTable", "getDefaultWorldTable", "getCustomTable", "sendTradeRequest", "trade", "acceptRequest", "sender", "receiver", "senderActor", "receiverActor", "sendTradeError", "senderActions", "receiverActions", "senderActionIndex", "receiverActionIndex", "senderAction", "receiverAction", "sentLink", "receivedLink", "users", "err", "rejectRequest", "templatePath", "buttons", "type", "unique", "createDefaultTable", "createCustomTable", "createCustomActionsTable", "setTable", "source", "getTableSource", "update", "createDefautActionsTable", "normalize", "setSetting", "removeActionsToggleAll", "removeActionsToggleActor", "actors", "state", "checked", "all", "templateLocalize", "isUnique", "actionsList", "el", "selected", "asDrawn", "withMessage", "tableUpdates", "key", "dragData", "DRAG_ID", "cleanOptions", "options", "filters", "type", "keys", "key", "option", "__name", "makeDraggable", "i", "droppable", "event", "onMouseDown", "onDragCancel", "cleanUp", "onDragEnd", "onMouseMove", "onMouseUp", "classList", "target", "closestInside", "_ghost", "targetIndex", "getElementIndex", "targetParent", "targetClassList", "newClassList", "element", "index", "child", "onDragMove", "clientX", "clientY", "draggable", "calculateDistanceBetweenPoints", "onDragStart", "dropped", "hovered", "img", "cursorElement", "offsetX", "offsetY", "value", "enabled", "parent", "selector", "filter", "cursor", "closeHook", "createHook", "closeCharacterSheetPF2e", "dragging", "registerInventory", "value", "setup", "isGm", "__name", "dragIdentifier", "COINS", "enabled", "getSetting", "registerCharacterSheetExtraTab", "getData", "addEvents", "onRender", "unregisterCharacterSheetExtraTab", "sheet", "html", "actor", "isPlayedActor", "getInMemory", "tab", "getCharacterSheetTab", "data", "getCurrentData", "setFlag", "inner", "sidebar", "tabElement", "alternate", "equipped", "equippedItemId", "slot", "itemIds", "parent", "ids", "items", "i", "item", "tabs", "tabId", "flags", "getFlag", "setInMemory", "orphans", "containers", "getTab", "itemId", "addOrphan", "handsHeld", "equippedHands", "handIndex", "indexIsValid", "isHandwrapsOfMightyBlows", "isInvestedOrWornAs", "equippedIndex", "index", "tabOrphans", "otherIndex", "grouped", "activeTabId", "container", "capacity", "containerTabs", "event", "itemElements", "itemElement", "onItemDetails", "makeDraggable", "target", "createGhost", "onDragStart", "draggable", "options", "onDragEnd", "containersDroppable", "otherEquipmentDroppable", "largeEquipmentDroppable", "itemsListDroppable", "itemsGridDroppable", "details", "getItemFromElement", "render", "dropped", "canceled", "dragged", "draggedIndex", "checkIdentifier", "error", "onDragEnter", "droppable", "ghost", "getElementIndex", "onDragLeave", "parentGrid", "closestInside", "onDrop", "updates", "cleanContainerItem", "moveItemToContainer", "checkForTwoHandedSlots", "rightHand", "canDrop", "moveItemToSlot", "element", "drop", "noTwoHand", "noUpdate", "dropSlot", "movable", "isOneHand", "isOneHanded", "isTwoHand", "isTwoHanded", "canInvest", "canBeInvested", "move", "carryType", "inSlot", "invested", "itemCarryUpdate", "isHeld", "getSlottedItem", "slotted", "dragArea", "dragSlot", "otherSlotted", "canEquip", "hasWornSlot", "containerId", "remaining", "targetIsElement", "leftHand", "leftSlotted", "rightSlotted", "clone", "el", "id", "localize", "subLocalize", "EditLores", "__name", "templatePath", "options", "actor", "getFlag", "event", "unspecified", "specific", "setFlag", "html", "#onCancel", "setHook", "createHook", "renderNPCSheetPF2e", "registerKnowledges", "value", "isGM", "getSetting", "__name", "sheet", "$html", "actor", "isPlayedActor", "replaceLores", "addEditButton", "addEvents", "knowledgeSelector", "html", "section", "selector", "editLores", "EditLores", "unspecifics", "getFlag", "specifics", "lores", "body", "tag", "skills", "dc", "adjustment", "addTags", "start", "tags", "lore", "attempts", "edit", "localize", "subLocalize", "ITEM_PREPARE_DERIVED_DATA", "LOOT_TRANSFER_ITEM_TO_ACTOR", "PULL_LIMIT", "RATIO_MAX", "RATIO_MIN", "RATIO_STEP", "registerMerchant", "isGM", "getSetting", "args", "renderLootSheetPF2e", "registerWrapper", "itemPrepareDerivedData", "lootTranferItemToActor", "__name", "sheet", "html", "actor", "noCoins", "priceRatio", "infiniteStocks", "infiniteItems", "getFlag", "sheetTemplate", "render", "clampRatio", "str", "flagPath", "sidebar", "better", "event", "pullFromBrowser", "opentEquipmentTab", "itemTypes", "hasInfiniteStock", "items", "tooltip", "item", "itemId", "isInfinite", "toggle", "el", "flagKey", "current", "setFlag", "wrapped", "actorFlags", "ratio", "infiniteItem", "wrapperError", "targetActor", "quantity", "containerId", "newStack", "thisSuper", "itemValue", "ErrorPF2e", "browser", "tab", "data", "nb", "name", "msg", "results", "getTabResults", "value", "bindOnPreCreateSpellDamageChatMessage", "originalMessage", "messageId", "save", "getFlag", "message", "updateSourceFlag", "__name", "localize", "subLocalize", "MultiCast", "__name", "#message", "#event", "event", "message", "options", "templatePath", "html", "#onCast", "#onCancel", "nb", "spell", "actor", "updateSource", "damages", "heightening", "id", "damage", "i", "newId", "data", "embeddedSource", "newSpell", "overlayIds", "castRank", "spellSource", "bindOnPreCreateSpellDamageChatMessage", "setHook", "createHook", "renderChatMessage", "updateMessages", "registerMerge", "value", "isGm", "__name", "message", "html", "latestChatMessages", "getSetting", "isDamageRoll", "renderDamage", "renderSpell", "spellBtn", "localize", "event", "MultiCast", "buttons", "getFlag", "tooltip", "actorUUID", "getActorUUID", "targetUUIDs", "getTargetUUIDs", "otherMessage", "otherTargetsUUIDS", "compareArrays", "t", "mergeDamages", "warn", "splitDamages", "sources", "data", "removeChatMessages", "origin", "other", "dataGroups", "getMessageData", "name", "notes", "outcome", "modifiers", "tags", "note", "result", "groups", "group", "flavor", "render", "originRolls", "getMessageRolls", "otherRolls", "groupedRolls", "roll", "options", "total", "terms", "term", "formula", "critRule", "DamageRoll", "getDamageRollClass", "index", "prev", "curr", "createTermGroup", "acc", "setHidden", "operands", "operand", "r", "MODULE", "entry", "flags", "source", "title", "text", "option", "ids", "joinedIds", "id", "targetTargets", "mergeTargets", "TREASURE_PREPARE_BASE_DATA", "registerNobulk", "getSetting", "registerActorPreparedEmbeddedDocuments", "actorPrepareEmbeddedDocuments", "registerWrapper", "treasurePrepareBaseData", "__name", "wrapped", "wrapperError", "InventoryBulk", "_value", "item", "ACTOR_PREPARE_DATA", "DOCUMENT_SHEET_RENDER_INNER", "registerShare", "getSetting", "registerWrapper", "prepareData", "documentSheetRenderInner", "preUpdateActor", "deleteActor", "updateActor", "__name", "wrapped", "args", "inner", "isInstanceOf", "actor", "isPlayedActor", "getSlaves", "masters", "a", "isValidMaster", "group", "render", "getFlag", "flagPath", "subLocalize", "removeSlaveFromMaster", "slaves", "slave", "unsetMaster", "unsetFlag", "updates", "shareFlag", "getFlagProperty", "master", "hpSource", "getMaster", "hpUpdate", "options", "userId", "isOriginalUser", "setMaster", "addSlaveToMaster", "data", "refreshActor", "setFlag", "masterId", "hp", "masterHp", "transfertHpData", "from", "to", "getInMemory", "setInMemory", "deleteInMemory", "setSheetHook", "createHook", "renderCharacterSheetPF2e", "setDeleteCombatHook", "deleteCombat", "setDeleteCombatantHook", "deleteCombatant", "setCreateCombatantHook", "createCombatant", "STANCE_SAVANT", "REPLACERS", "EXTRAS", "registerStances", "setup", "getStances", "toggleStance", "isValidStance", "isGm", "getSetting", "__name", "value", "stance", "actor", "stances", "replaced", "replace", "sourceId", "effectUUID", "effect", "img", "name", "itemName", "action", "actorStances", "foundAction", "getItemWithSourceId", "uuid", "sheet", "html", "isPlayedActor", "inCombat", "token", "tab", "options", "template", "render", "subLocalize", "event", "onToggleStance", "target", "canUseStances", "feat", "replacer", "extra", "getStancesEffects", "effects", "already", "create", "other", "more", "x", "addStance", "obj", "combat", "combatant", "getActorFromCombatant", "isOwner", "refreshCharacterSheets", "checkForSavant", "effectID", "hasItemWithSourceId", "info", "openStancesMenu", "localize", "registerSpellsSummary", "value", "setup", "isGm", "__name", "getSetting", "registerCharacterSheetExtraTab", "getData", "addEvents", "unregisterCharacterSheetExtraTab", "html", "sheet", "actor", "inputs", "event", "onUsesInputChange", "onUsesInputFocus", "onUsesInputBlur", "onToggleFocusPool", "onSlotsReset", "onItemToChat", "inputPath", "entryId", "change", "points", "onChargesReset", "getSpellcastingTab", "dailies", "entry", "itemId", "rank", "isCharge", "item", "max", "slotLevel", "slot", "castRank", "collection", "focusPool", "pf2eStavesActive", "pf2eDailies", "pf2eDailiesActive", "stavesActive", "chargesPath", "spells", "focuses", "rituals", "hasFocusCantrips", "entries", "data", "slotId", "spell", "entryDc", "entryName", "isFocus", "isInnate", "isPrepared", "isSpontaneous", "isFlexible", "consumable", "charges", "dailiesData", "canPayCost", "group", "slotSpells", "isCantrip", "groupNumber", "spellSlotGroupIdToNumber", "isBroken", "active", "expended", "virtual", "uses", "localizePath", "sort", "a", "b", "localeCompare", "subLocalize", "ordinalString", "SAVES", "REROLL", "DEGREE_OF_SUCCESS", "setPrecreateMessageHook", "createHook", "preCreateChatMessage", "setRenderMessageHook", "createChoicesHook", "renderChatMessage", "setCreateTemplateHook", "createMeasuredTemplate", "socket", "registerSocket", "onSocket", "registerTargetTokenHelper", "value", "getSetting", "isGM", "getChatLogEntryContext", "setHooks", "message", "html", "latestChatMessages", "__name", "packet", "isActiveGM", "updateMessageSave", "updateMessageApplied", "_", "data", "getMessageData", "messageId", "inMemory", "getInMemory", "localizePath", "canRollSave", "save", "getSaveData", "rollSave", "template", "userId", "user", "localize", "subLocalize", "item", "actor", "self", "render", "result", "alliance", "opposition", "targetsIds", "getTemplateTokens", "token", "targetAlliance", "HEALINGS_REGEX", "isRegenMessage", "healings", "isValidDamageMessage", "isDamageRoll", "updates", "getFlag", "isRegen", "targets", "target", "rolls", "roll", "splashRollIndex", "regularRollIndex", "modifier", "dc", "updateSourceFlag", "acc", "key", "clientEnabled", "deleteInMemory", "renderDamageChatMessage", "refreshMessage", "renderSpellChatMessage", "hasEmbeddedSpell", "bindOnPreCreateSpellDamageChatMessage", "chat", "el", "app", "spell", "msgContent", "cardBtns", "saveBtn", "wrapper", "targetsTooltip", "targetsBtn", "event", "addTargets", "rowsTemplate", "addHeaderListeners", "setFlag", "damageRows", "buttons", "toggleDamageRow", "expanded", "toggleBtn", "toggleTooltip", "setInMemory", "clonedRows", "action", "uuid", "isOwner", "applied", "isBasicSave", "clones", "index", "onTargetButton", "getRowsElement", "disableSaveListeners", "enableSaveListeners", "listener", "dataAction", "saveEnabled", "pingTarget", "openTargetSheet", "rerollSave", "flag", "targetsFlag", "showDC", "showMods", "showSuccess", "saveLabel", "saveDC", "targetId", "isVisible", "hasPlayerOwner", "isFriendly", "hasSave", "saveFlag", "targetSave", "rerolled", "canReroll", "successLabel", "offset", "templateSave", "anonymous", "canSeeName", "name", "a", "b", "getTargetFromEvent", "targetUuid", "heroPoints", "type", "icon", "reroll", "label", "isHeroReroll", "keep", "max", "warn", "oldRoll", "unevaluatedNewRoll", "newRoll", "roll3dDice", "keptRoll", "success", "DegreeOfSuccess", "isAuthor", "statistic", "tokens", "targetPromises", "targetPromise", "otherMessage", "skipDefault", "resolve", "__", "msg", "btn", "rollIndex", "toggleOffShieldBlock", "onClickShieldBlock", "applyDamageFromMessage", "onDamageApplied", "tokenId", "moduleFlagUpdate", "CREATE_HOOK", "UPDATE_HOOK", "registerUnided", "setHooks", "__name", "value", "settingValue", "getSetting", "preCreateItem", "preUpdateItem", "item", "changes", "setHook", "createHook", "updateCombat", "registerUntarget", "setup", "__name", "getSetting", "_", "data", "user", "localize", "subLocalize", "permaConditionEffect", "actor", "callback", "__name", "html", "type", "condition", "name", "slug", "img", "buttons", "conditions", "withBadge", "content", "render", "a", "b", "setInputs", "hasBadge", "badge", "result", "rule", "source", "registerModule", "FEATURES", "registerArp", "registerNobulk", "registerTargetTokenHelper", "registerGiveth", "registerKnowledges", "registerUnided", "registerMerge", "registerEffectsPanelHelper", "registerSpellsSummary", "registerStances", "registerHeroActions", "registerShare", "registerUntarget", "registerInventory", "registerDebug", "registerMerchant", "CONFLICTS", "firstClientSetting", "isGM", "isUserGM", "settings", "worldSettings", "scope", "clientSettings", "setting", "registerSetting", "renderSettingsConfig", "module", "getModule", "permaConditionEffect", "feature", "init", "conflicts", "api", "name", "socket", "id", "conflictingModule", "socketOn", "onSocket", "conflicting", "ready", "conflict", "warn", "_", "html", "MODULE", "localize", "__name"]
}
