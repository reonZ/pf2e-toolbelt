(()=>{var hi=Object.defineProperty;var s=(e,t)=>hi(e,"name",{value:t,configurable:!0});function gn(e){let t=s(r=>r.active&&!r.isGM,"isValidUser"),n=game.users.filter(r=>t(r)&&r.character===e);return n.length||(n=game.users.filter(r=>t(r)&&e.testUserPermission(r,"OWNER"))),n.sort((r,a)=>r.id>a.id?1:-1),n[0]||null}s(gn,"getOwner");function hn(e){return gn(e)===game.user}s(hn,"isOwner");function Ce(e){return e.token?.name??e.prototypeToken?.name??e.name}s(Ce,"getHighestName");function Se(e){for(let t of Object.values(ui.windows))t instanceof ActorSheet&&t.actor?.type===e&&t.render()}s(Se,"refreshActorSheets");function*Ke(e,t){let n=ui.chat?.element;if(!n)return;let r=game.messages.contents,a=(t?r.findLastIndex(i=>i===t):r.length)-1;for(let i=a;i>=a-e;i--){let o=r[i];if(!o)return;let c=n.find(`[data-message-id=${o.id}]`);c.length&&(yield{message:o,html:c})}}s(Ke,"latestChatMessages");function Ue(e,t){return e?t?`@UUID[${e}]{${t}}`:`@UUID[${e}]`:`<span style="background: #DDD; padding: 1px 4px; border: 1px solid var(--color-border-dark-tertiary);
border-radius: 2px; white-space: nowrap; word-break: break-all;">${t}</span>`}s(Ue,"chatUUID");function Dr(e){return!!(e.getFlag("pf2e","casting.embeddedSpell")||e.item?.trickMagicEntry)}s(Dr,"hasEmbeddedSpell");function Z(e,...t){return getProperty(e,`modules.${L.id}.${t.join(".")}`)}s(Z,"getInMemory");function ie(e,...t){let n=t.splice(-1)[0];return setProperty(e,`modules.${L.id}.${t.join(".")}`,n)}s(ie,"setInMemory");function Pr(e,...t){let n=t.splice(-1)[0],r=Z(e,...t);if(r!=null)return r;let a=typeof n=="function"?n():n;return ie(e,...t,a),a}s(Pr,"getInMemoryAndSetIfNot");function Le(e,...t){let n=["modules",L.id,...t.flatMap(i=>i.split("."))],r=n.pop(),a=e;for(let i of n)if(a=a[i],!a)return!0;return delete a[r]}s(Le,"deleteInMemory");function Mr(e){return e.getFlag("core","sourceId")}s(Mr,"getSourceId");function yi(e,t){let n=Mr(e);return n?t.includes(n):!1}s(yi,"includesSourceId");function yn(e){return Array.isArray(e)?t=>yi(t,e):t=>Mr(t)===e}s(yn,"getSourceIdCondition");function Rr(e,t,n){let r={};for(let a of e){let i=Array.isArray(a)?a[n??0]:typeof a=="object"&&n!=null?a[n]:a;r[i]=t(a)}return r}s(Rr,"arrayToObject");function bn(e,t){if(e.length!==t.length)return!1;let n=t.slice();for(let r of e){let a=n.findIndex(i=>r===i);if(a===-1)return!1;n.splice(a,1)}return!0}s(bn,"compareArrays");function ft(e){return e!==void 0&&e!==-1}s(ft,"indexIsValid");function dt(e){return Array.from(e.parentElement.children).indexOf(e)}s(dt,"getElementIndex");function Lr(e,t,n,r){let a=n-e,i=r-t;return Math.sqrt(a*a+i*i)}s(Lr,"calculateDistanceBetweenPoints");var Ku=(async()=>{}).constructor;function Ye(e,t){if(typeof e!="object")return!1;let n=Reflect.getPrototypeOf(e);for(;n;){if(n.constructor.name===t)return!0;n=Reflect.getPrototypeOf(n)}return!1}s(Ye,"isInstanceOf");function qe(e,...t){return(Array.isArray(t[0])?t[0]:t).filter(r=>typeof r=="string").join(e)}s(qe,"joinStr");function Ee(...e){return`flags.${L.id}.${qe(".",e)}`}s(Ee,"flagPath");function O(e,...t){return e.getFlag(L.id,t.join("."))}s(O,"getFlag");function Sn(e,...t){return getProperty(e,Ee(...t))}s(Sn,"getFlagProperty");function ne(e,...t){let n=t.splice(-1)[0];return e.setFlag(L.id,t.join("."),n)}s(ne,"setFlag");function Fr(e,...t){return e.unsetFlag(L.id,t.join("."))}s(Fr,"unsetFlag");function Je(e,...t){let n=t.splice(-1)[0];return e.updateSource({[Ee(...t)]:n})}s(Je,"updateSourceFlag");function Xe(e,...t){let n=t.splice(-1)[0];e[Ee(...t)]=n}s(Xe,"moduleFlagUpdate");function z(...e){let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:{},n=de(...e);return renderTemplate(n,t)}s(z,"render");function de(...e){return`modules/${L.id}/templates/${qe("/",e)}.hbs`}s(de,"templatePath");function Nr(e,t){let n=Hooks.on(e,t),r=Hooks.events[e].findIndex(a=>a.id===n);if(r!==0){let[a]=Hooks.events[e].splice(r,1);Hooks.events[e].unshift(a)}return n}s(Nr,"registerUpstreamHook");function $r(e,t=[]){let n=typeof t=="string"?[t]:t;return n.length?n.flatMap(r=>e.itemTypes[r]):e.items}s($r,"getItems");function _r(e,t,n){return $r(e,n).some(yn(t))}s(_r,"hasItemWithSourceId");function pt(e,t,n){return $r(e,n).find(yn(t))}s(pt,"getItemWithSourceId");function q(e,t,n="WRAPPER"){return libWrapper.register(L.id,e,t,n)}s(q,"registerWrapper");function Hr(e){libWrapper.unregister(L.id,e)}s(Hr,"unregisterWrapper");function H(...e){e.unshift(L.id);let t=typeof e.at(-1)=="object"?e.splice(-1)[0]:void 0;return game.i18n[t?"format":"localize"](qe(".",e),t)}s(H,"localize");function vi(...e){return game.i18n.has(`${L.id}.${e.join(".")}`,!1)}s(vi,"hasLocalization");function Qe(...e){return`${L.id}.${e.join(".")}`}s(Qe,"localizePath");function F(e){let t=s((...n)=>H(e,...n),"fn");return Object.defineProperties(t,{warn:{value:(n,r,a)=>V(`${e}.${n}`,r,a),enumerable:!1,configurable:!1},info:{value:(n,r,a)=>Ie(`${e}.${n}`,r,a),enumerable:!1,configurable:!1},error:{value:(n,r,a)=>xe(`${e}.${n}`,r,a),enumerable:!1,configurable:!1},has:{value:n=>vi(e,n),enumerable:!1,configurable:!1},path:{value:n=>Qe(e,n),enumerable:!1,configurable:!1},template:{value:(n,{hash:r})=>t(n,r),enumerable:!1,configurable:!1},i18n:{get(){return{i18n:this.template,i18Path:this.path}},enumerable:!1,configurable:!1}}),t}s(F,"subLocalize");function mt(e,t){return e.localeCompare(t,game.i18n.lang)}s(mt,"localeCompare");var wn=null,L={get id(){if(!wn)throw new Error("Module id needs to be registered.");return wn},error(e){throw new Error(`[${this.id}] ${e}`)}};function jr(e){wn=e}s(jr,"registerModule");function Ur(e){return game.modules.get(e??L.id)}s(Ur,"getModule");function En(e,t,n,r){let a=typeof t=="string"?t:"info",i=typeof t=="object"?t:typeof n=="object"?n:void 0,o=typeof t=="boolean"?t:typeof n=="boolean"?n:r??!1;ui.notifications.notify(H(e,i),a,{permanent:o})}s(En,"notify");function V(e,t,n){En(e,"warning",t,n)}s(V,"warn");function Ie(e,t,n){En(e,"info",t,n)}s(Ie,"info");function xe(e,t,n){En(e,"error",t,n)}s(xe,"error");function qr(e){e.key??=e.name,Array.isArray(e.choices)&&(e.choices=Rr(e.choices,t=>xn(e.key,"choices",t))),e.name=xn(e.key,"name"),e.hint=xn(e.key,"hint"),e.scope??="world",e.config??=!0,game.settings.register(L.id,e.key,e)}s(qr,"registerSetting");function xn(...e){return`${L.id}.settings.${e.join(".")}`}s(xn,"settingPath");function P(e){return game.settings.get(L.id,e)}s(P,"getSetting");function kn(e){return!!game.settings.settings.get(`${L.id}.${e}`)?.choices}s(kn,"isChoiceSetting");function Br(e,t){return game.settings.set(L.id,e,t)}s(Br,"setSetting");function Gr(e){game.socket.on(`module.${L.id}`,e)}s(Gr,"socketOn");function zr(e){game.socket.off(`module.${L.id}`,e)}s(zr,"socketOff");function vn(e){game.socket.emit(`module.${L.id}`,e)}s(vn,"socketEmit");function bi(){return game.user??game.data.users.find(e=>e._id===game.data.userId)}s(bi,"getUser");function Vr(){let e=bi();return e&&e.role>=CONST.USER_ROLES.ASSISTANT}s(Vr,"isUserGM");function gt(){return game.user===game.users.activeGM}s(gt,"isActiveGM");function Wr(){return game.users.some(e=>e.active&&e.isGM)}s(Wr,"isGMOnline");function ht(){return game.pf2e.compendiumBrowser}s(ht,"getBrowser");function Ae(e){return game.pf2e.compendiumBrowser.tabs[e]}s(Ae,"getBrowserTab");function Kr(e,t){let n=Si(e),r=typeof t=="object"?t:t===!1&&n.isInitialized?deepClone(n.defaultFilterData):void 0;return game.pf2e.compendiumBrowser.openTab(n.tabName,r)}s(Kr,"openBrowserTab");function Si(e){return typeof e=="string"?Ae(e):e}s(Si,"tabFromTabOrTabName");var ye;function Cn({collapsed:e=!1,mergeWith:t}={}){let n=Ae("equipment"),r=s(a=>{let i=deepClone(a);if(e){for(let[o,c]of Object.entries(i))if(!(o==="order"||o==="search"))for(let l of Object.values(c))"isExpanded"in l&&(l.isExpanded=!1)}if(typeof t=="object"){mergeObject(i,t);for(let o of Object.values(i.checkboxes))if(o.selected.length){o.isExpanded=!0;for(let c of o.selected)o.options[c].selected=!0}for(let o of["ranges","sliders"]){let c=a[o];for(let[l,f]of Object.entries(i[o])){let u=c[l];objectsEqual(f.values,u.values)||(f.isExpanded=!0)}}}return i},"returned");return n.defaultFilterData?r(n.defaultFilterData):(ye||(ye=n.prepareFilterData(),ye.checkboxes.armorTypes.options=n.generateCheckboxOptions(CONFIG.PF2E.armorCategories),mergeObject(ye.checkboxes.armorTypes.options,n.generateCheckboxOptions(CONFIG.PF2E.armorGroups)),ye.checkboxes.weaponTypes.options=n.generateCheckboxOptions(CONFIG.PF2E.weaponCategories),mergeObject(ye.checkboxes.weaponTypes.options,n.generateCheckboxOptions(CONFIG.PF2E.weaponGroups)),ye.multiselects.traits.options=n.generateMultiselectOptions({...CONFIG.PF2E.armorTraits,...CONFIG.PF2E.consumableTraits,...CONFIG.PF2E.equipmentTraits,...CONFIG.PF2E.shieldTraits,...CONFIG.PF2E.weaponTraits}),ye.checkboxes.itemTypes.options=n.generateCheckboxOptions({weapon:"TYPES.Item.weapon",shield:"TYPES.Item.shield",armor:"TYPES.Item.armor",equipment:"TYPES.Item.equipment",consumable:"TYPES.Item.consumable",treasure:"TYPES.Item.treasure",backpack:"TYPES.Item.backpack",kit:"TYPES.Item.kit"}),ye.checkboxes.rarity.options=n.generateCheckboxOptions(CONFIG.PF2E.rarityTraits,!1)),r(ye))}s(Cn,"getEquipmentTabData");function yt(e,t){return e instanceof Element||e instanceof Document?e.querySelector(t):null}s(yt,"htmlQuery");function Yr(e){let t=new Intl.PluralRules(game.i18n.lang,{type:"ordinal"}),n=game.i18n.localize(`PF2E.OrdinalSuffixes.${t.select(e)}`);return game.i18n.format("PF2E.OrdinalNumber",{value:e,suffix:n})}s(Yr,"ordinalString");function Fe(e){return Error(`PF2e System | ${e}`)}s(Fe,"ErrorPF2e");var wi={0:"F",free:"F",1:"A",2:"D",3:"T","1 or 2":"A/D","1 to 3":"A - T","2 or 3":"D/T",reaction:"R"};function In(e){if(!e&&e!==0)return"";let t=typeof e!="object"?e:e.type==="action"?e.value:e.type,n=String(t??"").toLowerCase().trim();return wi[n]?.replace("-","\u2013")??""}s(In,"getActionGlyph");function vt(e,t){return e.has(t)}s(vt,"setHasElement");async function Jr({affects:e,origin:t,target:n,item:r,domains:a,options:i}){if(!(t&&n))return[];let[o,c]=e==="target"?[t,n]:[n,t],l=[...i,o.getRollOptions(a),c.getSelfRollOptions(e)].flat(),f=r?r.isOfType("spell")?{spell:r}:{weapon:r}:{};return(await Promise.all(a.flatMap(u=>o.synthetics.ephemeralEffects[u]?.[e]??[]).map(u=>u({test:l,resolvables:f})))).flatMap(u=>u??[])}s(Jr,"extractEphemeralEffects");async function An({message:e,multiplier:t=1,addend:n=0,promptModifier:r=!1,rollIndex:a=0,tokens:i,onDamageApplied:o}){if(r)return Ei({message:e,multiplier:t,rollIndex:a,tokens:i,onDamageApplied:o});if(i??=yt(ui.chat.element[0],`li.chat-message[data-message-id="${e.id}"]`)?.dataset.actorIsTarget&&e.token?[e.token]:game.user.getActiveTokens(),i.length===0){ui.notifications.error("PF2E.ErrorMessage.NoTokenSelected",{localize:!0});return}let c=CONFIG.PF2E.chatDamageButtonShieldToggle,l=e.rolls.at(a);if(!Ye(l,"DamageRoll"))throw Fe("Unexpected error retrieving damage roll");let f=t<0?t*l.total+n:l.alter(t,n),u=[...e.flags.pf2e.context?.options??[]],p=u.filter(g=>g.startsWith("self:")).map(g=>g.replace(/^self/,"origin")),m=e.item,y=m?.isOfType("affliction","condition","effect")?m.getRollOptions("item"):[];for(let g of i){if(!g.actor)continue;u.some(k=>k.startsWith("target"))||u.push(...g.actor.getSelfRollOptions("target"));let v=t>0?"damage-received":"healing-received",S=t>0?await Jr({affects:"target",origin:e.actor,target:g.actor,item:e.item,domains:[v],options:u}):[],E=g.actor.getContextualClone(p,S),x=new Set([...u.filter(k=>!/^(?:self|target):/.test(k)),...y,...p,...E.getSelfRollOptions()]);await E.applyDamage({damage:f,token:g,item:e.item,skipIWR:t<=0,rollOptions:x,shieldBlockRequest:c,outcome:e.flags.pf2e.context?.outcome})}bt(e.id),o?.(e,i,a)}s(An,"applyDamageFromMessage");function Xr(e,t,n){let r=s(()=>[e],"getTokens"),a=s(i=>i[0]?.actor?.itemTypes.shield.filter(c=>c.isEquipped&&!c.isBroken&&!c.isDestroyed)??[],"getNonBrokenShields");t.classList.contains("tooltipstered")||$(t).tooltipster({animation:"fade",trigger:"click",arrow:!1,content:yt(n,"div.hover-content"),contentAsHTML:!0,contentCloning:!0,debug:!1,interactive:!0,side:["top"],theme:"crb-hover",functionBefore:()=>{let i=r();if(!i.length)return!1;let o=a(i),c=i.length===1&&o.length>1,l=t.classList.contains("shield-activated");return c&&!l?!0:c&&t.dataset.shieldId?(t.attributes.removeNamedItem("data-shield-id"),t.classList.remove("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!1,!0):(t.classList.toggle("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!CONFIG.PF2E.chatDamageButtonShieldToggle,!1)},functionFormat:(i,o,c)=>{let l=r(),f=a(l),u=l.length===1&&f.length>1,p=t.classList.contains("shield-activated");if(u&&!p){let m=yt(c,"ul.shield-options");if(!m)return $(c);let y=f.map(g=>{let v=document.createElement("input");v.classList.add("data"),v.type="radio",v.name="shield-id",v.value=g.id,v.addEventListener("click",()=>{t.dataset.shieldId=v.value,t.classList.add("shield-activated"),CONFIG.PF2E.chatDamageButtonShieldToggle=!0,i.close()});let S=document.createElement("span");S.classList.add("label"),S.innerHTML=g.name;let E=document.createElement("span");E.classList.add("tag");let x=game.i18n.localize("PF2E.HardnessLabel");E.innerHTML=`${x}: ${g.hardness}`;let k=document.createElement("li");return k.classList.add("item"),k.append(v,S,E),k});m.replaceChildren(...y)}return $(c)}}).tooltipster("open")}s(Xr,"onClickShieldBlock");function bt(e){for(let t of["#chat-log","#chat-popout"]){let n=`${t} > li.chat-message[data-message-id="${e}"] button[data-action$=shield-block]`;for(let r of document.body.querySelectorAll(n))r?.classList.remove("shield-activated")}CONFIG.PF2E.chatDamageButtonShieldToggle=!1}s(bt,"toggleOffShieldBlock");async function Ei({message:e,multiplier:t,rollIndex:n,tokens:r,onDamageApplied:a}){let i=await renderTemplate("systems/pf2e/templates/chat/damage/adjustment-dialog.hbs"),o=class extends Dialog{static{s(this,"AdjustmentDialog")}activateListeners(l){super.activateListeners(l),l[0].querySelector("input")?.focus()}},c=t<0;new o({title:game.i18n.localize(c?"PF2E.UI.shiftModifyHealingTitle":"PF2E.UI.shiftModifyDamageTitle"),content:i,buttons:{ok:{label:game.i18n.localize("PF2E.OK"),callback:async l=>{let f=(Number(l[0].querySelector("input")?.value)||0)*Math.sign(t);An({message:e,multiplier:t,addend:f,promptModifier:!1,rollIndex:n,tokens:r,onDamageApplied:a})}},cancel:{label:"Cancel"}},default:"ok",close:()=>{bt(e.id)}}).render(!0)}s(Ei,"shiftAdjustDamage");function xi(e){return renderTemplate("systems/pf2e/templates/chat/action/flavor.hbs",{action:{title:"PF2E.Actions.Interact.Title",subtitle:e,glyph:In(1)},traits:[{name:"manipulate",label:CONFIG.PF2E.featTraits.manipulate,description:CONFIG.PF2E.traitsDescriptions.manipulate}]})}s(xi,"createManipulateFlavor");function ki(e,t){return renderTemplate("systems/pf2e/templates/chat/action/content.hbs",{imgPath:t,message:e.replace(/\b1 Ã— /,"")})}s(ki,"createTradeContent");function St(e,{async:t=!0,label:n}={}){let r=e instanceof foundry.abstract.Document?e.link:`@UUID[${e}]`;return n&&(r=r.replace(/\{.+?\}$/,""),r=`${r}{${n}}`),TextEditor.enrichHTML(r,{async:t})}s(St,"createFancyLink");async function Ci(e,t,n,r){return ChatMessage.implementation.create({user:r??game.user.id,speaker:ChatMessage.getSpeaker({actor:n,alias:Ce(n)}),flavor:await xi(e),content:t,type:CONST.CHAT_MESSAGE_TYPES.EMOTE})}s(Ci,"createManipulationMessage");async function wt(e,t,n,r,a){let i=await ki(t,r.img);return Ci(e,i,n,a)}s(wt,"createTradeMessage");function Qr(){return CONFIG.Dice.rolls.find(e=>e.name==="DamageRoll")}s(Qr,"getDamageRollClass");var Ii=new Map([["incredibly-easy",-10],["very-easy",-5],["easy",-2],["normal",0],["hard",2],["very-hard",5],["incredibly-hard",10]]),Ai=new Map([[-1,13],[0,14],[1,15],[2,16],[3,18],[4,19],[5,20],[6,22],[7,23],[8,24],[9,26],[10,27],[11,28],[12,30],[13,31],[14,32],[15,34],[16,35],[17,36],[18,38],[19,39],[20,40],[21,42],[22,44],[23,46],[24,48],[25,50]]);function xt(e,{pwol:t,rarity:n="common"}={}){t??=game.pf2e.settings.variants.pwol.enabled;let r=Ai.get(e)??14;return Et(t?r-Math.max(e,0):r,n)}s(xt,"calculateDC");function Et(e,t="common"){return Ti(e,Oi(t))}s(Et,"adjustDCByRarity");function Ti(e,t="normal"){return e+(Ii.get(t)??0)}s(Ti,"adjustDC");function Oi(e="common"){switch(e){case"uncommon":return"hard";case"rare":return"very-hard";case"unique":return"incredibly-hard";default:return"normal"}}s(Oi,"rarityToDCAdjustment");var kt=new Set(["arcane","divine","occult","primal"]);function Zr(e){if(e==="cantrips")return 0;let t=Number(e??NaN);return t.between(0,10)?t:null}s(Zr,"spellSlotGroupIdToNumber");var es=class extends FormApplication{static{s(this,"IdentifyItemPopup")}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"identify-item",title:game.i18n.localize("PF2E.identification.Identify"),template:"systems/pf2e/templates/actors/identify-item.hbs",width:"auto",classes:["identify-popup"]}}dcs=Di(this.object,{pwol:game.pf2e.settings.variants.pwol.enabled,notMatchingTraditionModifier:game.settings.get("pf2e","identifyMagicNotMatchingTraditionModifier")});async getData(){let t=this.object;return{...await super.getData(),isMagic:t.isMagical,isAlchemical:t.isAlchemical,dcs:this.dcs}}activateListeners(t){let n=t[0],r=n.querySelector<HTMLButtonElement>"button.update-identification";r?.addEventListener("click",()=>{this.submit({updateData:{status:r.value}})}),n.querySelector("button.post-skill-checks")?.addEventListener("click",async()=>{let a=this.object,i=a.system.identification.identified.name,o=this.dcs,c=a.isMagical?"identify-magic":a.isAlchemical?"identify-alchemy":"recall-knowledge",l=await renderTemplate("systems/pf2e/templates/actors/identify-item-chat-skill-checks.hbs",{identifiedName:i,action:c,skills:R.omit(o,["dc"]),unidentified:a.system.identification.unidentified,uuid:a.uuid});await ChatMessage.implementation.create({user:game.user.id,content:l})})}async _updateObject(t,n){let r=n.status;if(r==="identified")return this.object.setIdentificationStatus(r)}};function Di(e,{pwol:t=!1,notMatchingTraditionModifier:n}){let r=xt(e.level,{pwol:t}),a=Pi(e),i=Et(r,a);return e.isMagical?Mi(e,i,n):{crafting:i}}s(Di,"getItemIdentificationDCs");function Pi(e){return e.traits.has("cursed")?"unique":e.rarity}s(Pi,"getDcRarity");function Mi(e,t,n){let r={occult:t,primal:t,divine:t,arcane:t},a=Ri(e);for(let i of kt)a.size>0&&!a.has(i)&&(r[i]=t+n);return{arcana:r.arcane,nature:r.primal,religion:r.divine,occultism:r.occult}}s(Mi,"getIdentifyMagicDCs");function Ri(e){let t=e.system.traits.value;return new Set(t.filter(n=>vt(kt,n)))}s(Ri,"getMagicTraditions");var rp=["action","check","effect-area"].map(e=>`[data-pf2-${e}]`).join(",");var It="handwraps-of-mighty-blows";function Tn(e){return e.traits.has("invested")}s(Tn,"canBeInvested");function ts(e){return e.system.equipped.inSlot!=null}s(ts,"hasWornSlot");function Ni(e){return e.system.usage.type==="worn"&&e.system.equipped.inSlot}s(Ni,"isWornAs");function On(e){return e.isInvested||Ni(e)}s(On,"isInvestedOrWornAs");function At(e){return e.system.usage.type==="held"}s(At,"isHeld");function Tt(e){return At(e)&&e.system.usage.value==="held-in-two-hands"}s(Tt,"isTwoHanded");function ns(e){return At(e)&&e.system.usage.value==="held-in-one-hand"}s(ns,"isOneHanded");function $i(e,t){let n=e.system.usage;return n.type==="worn"&&n.where?t:void 0}s($i,"inSlotValue");function _i(e,t){let n=t??!e.system.equipped.invested;return e.traits.has("invested")?n:void 0}s(_i,"toggleInvestedValue");function Ot(e,{carryType:t="worn",handsHeld:n=0,inSlot:r,invested:a,containerId:i}){let o={_id:e.id,system:{equipped:{carryType:t,handsHeld:n,inSlot:$i(e,r),invested:_i(e,a)}}};return i!==void 0&&(o.system.containerId=i),o}s(Ot,"itemCarryUpdate");function Dt(e){return e.isOfType("weapon")&&e.slug===It&&e.category==="unarmed"}s(Dt,"isHandwrapsOfMightyBlows");function Dn(e,t=1,n=1){let r=game.pf2e.Coins.fromPrice(e.price,t);return n===1?r:r.scale(n)}s(Dn,"calculateItemPrice");async function Pt(e,t,n,r,a){let i=Math.min(n,t.quantity),o=t.quantity-i;o<1?await t.delete():await t.update({"system.quantity":o});let c=t.toObject();return c.system.quantity=i,c.system.equipped.carryType="worn","invested"in c.system.equipped&&(c.system.equipped.invested=t.traits.has("invested")?!1:null),e.addToInventory(c,r,a)}s(Pt,"transferItemToActor");var Ct=class extends FormApplication{static{s(this,"MoveLootPopup")}constructor(t,n,r){super(t,n),this.onSubmitCallback=r}async getData(){let[t,n]=this.options.isPurchase?["PF2E.loot.PurchaseLootMessage","PF2E.loot.PurchaseLoot"]:["PF2E.loot.MoveLootMessage","PF2E.loot.MoveLoot"];return{...await super.getData(),quantity:{default:this.options.quantity.default,max:this.options.quantity.max},newStack:this.options.newStack,lockStack:this.options.lockStack,prompt:t,buttonLabel:n}}static get defaultOptions(){return{...FormApplication.defaultOptions,id:"MoveLootPopup",classes:[],title:game.i18n.localize("PF2E.loot.MoveLootPopupTitle"),template:"systems/pf2e/templates/popups/loot/move-loot-popup.hbs",width:"auto",quantity:{default:1,max:1},newStack:!1,lockStack:!1,isPurchase:!1}}async _updateObject(t,n){this.onSubmitCallback(n.quantity,n.newStack)}};var Mt={LOWER_BY_TWO:-2,LOWER:-1,INCREASE:1,INCREASE_BY_TWO:2,TO_CRITICAL_FAILURE:"criticalFailure",TO_FAILURE:"failure",TO_SUCCESS:"success",TO_CRITICAL_SUCCESS:"criticalSuccess"},rs=["criticalFailure","failure","success","criticalSuccess"],Rt=class e{static{s(this,"DegreeOfSuccess")}constructor(t,n,r=null){t instanceof Roll?(this.dieResult=(t.isDeterministic?t.terms.find(a=>a instanceof NumericTerm):t.dice.find(a=>a instanceof Die&&a.faces===20))?.total??1,this.rollTotal=t.total):(this.dieResult=t.dieValue,this.rollTotal=t.dieValue+t.modifier),this.dc=typeof n=="number"?{value:n}:n,this.unadjusted=this.#r(),this.adjustment=this.#e(this.unadjusted,r),this.value=this.adjustment?this.#t(this.adjustment.amount,this.unadjusted):this.unadjusted}static CRITICAL_FAILURE=0;static FAILURE=1;static SUCCESS=2;static CRITICAL_SUCCESS=3;#e(t,n){if(!n)return null;for(let r of["all",...rs]){let{label:a,amount:i}=n[r]??{};if(i&&a&&!(t===e.CRITICAL_SUCCESS&&i===Mt.INCREASE)&&!(t===e.CRITICAL_FAILURE&&i===Mt.LOWER)&&(r==="all"||rs.indexOf(r)===t))return{label:a,amount:i}}return null}#t(t,n){switch(t){case"criticalFailure":return 0;case"failure":return 1;case"success":return 2;case"criticalSuccess":return 3;default:return Math.clamped(n+t,0,3)}}#n(t){return this.dieResult===20?this.#t(Mt.INCREASE,t):this.dieResult===1?this.#t(Mt.LOWER,t):t}#r(){let t=this.dc.value;return this.rollTotal-t>=10?this.#n(e.CRITICAL_SUCCESS):t-this.rollTotal>=10?this.#n(e.CRITICAL_FAILURE):this.rollTotal>=t?this.#n(e.SUCCESS):this.#n(e.FAILURE)}};function ss(e,{collisionOrigin:t,collisionType:n="move"}={}){let r=e instanceof MeasuredTemplateDocument?e.object:e;if(!canvas.scene)return[];let{grid:a,dimensions:i}=canvas;if(!(a&&i))return[];if(!r?.highlightId)return[];let o=a.getHighlightLayer(r.highlightId);if(!o||a.type!==CONST.GRID_TYPES.SQUARE)return[];let c=t??r.center,l=canvas.tokens.quadtree.getObjects(o.getLocalBounds(void 0,!0)),f=a.size,u=[];for(let p of l){let m=p.document,y=[];for(let g=0;g<m.height;g++){let v=Math.floor(p.x/f)*f,E=Math.floor(p.y/f)*f+g*f;if(y.push(`${v}.${E}`),m.width>1)for(let x=1;x<m.width;x++)y.push(`${v+x*f}.${E}`)}for(let g of y){if(!o.positions.has(g))continue;let[v,S]=g.split(".").map(k=>Number(k)),E={x:v+i.size*.5,y:S+i.size*.5};if(E.x<0||E.y<0)continue;if(!(canvas.ready&&n&&CONFIG.Canvas.polygonBackends[n].testCollision(c,E,{type:n,mode:"any"}))){u.push(p);break}}}return u}s(ss,"getTemplateTokens");function we(e,t){console.error(`an error occured in the feature '${e}' of the module '${L.id}' with the wrapper: '${t}'`)}s(we,"wrapperError");function as(e){let t=P(e);return kn(e)?t!=="disabled":t}s(as,"settingIsEnabled");function oe(e,t){return()=>{let n=P(t);if(kn(t)?n!=="disabled":n){e(n);return}}}s(oe,"calledIfSetting");var is="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareBaseData",os="CONFIG.PF2E.Item.documentClasses.weapon.prototype.prepareDerivedData",cs="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareBaseData",ls="CONFIG.PF2E.Item.documentClasses.armor.prototype.prepareDerivedData",us={name:"arp",settings:[{key:"auto-runes",type:String,default:"disabled",choices:["disabled","force","lower"],requiresReload:!0}],conflicts:["pf2e-arp"],init:()=>{let e=P("auto-runes");e!=="disabled"&&(q(is,qi,"WRAPPER"),q(os,Bi,"WRAPPER"),q(cs,Vi,"WRAPPER"),q(ls,Wi,"WRAPPER"),e==="force"&&Hooks.on("renderPhysicalItemSheetPF2e",Ki))},ready:e=>{e&&P("auto-runes")!=="disabled"&&game.settings.get("pf2e","automaticBonusVariant")!=="noABP"&&(game.settings.set("pf2e","automaticBonusVariant","noABP"),Ie("arp.forceVariant"))}};function Ze(e,t=!1){return e&&!e.getFlag("pf2e","disableABP")&&(!t||e.isOfType("character"))}s(Ze,"isValidActor");var Hi={1:35,2:935,3:8935,4:8935},ji={1:65,2:1065,3:31065};function Ui(e){return["shield-boss","shield-spikes"].includes(e._source.system.baseItem)}s(Ui,"isShieldWeapon");function fs(e){let t=e._source.system.traits.value,{group:n,category:r,slug:a}=e._source.system;return r==="unarmed"&&a!==It?e.actor.itemTypes.weapon.some(i=>i.slug===It&&i._source.system.category==="unarmed"&&i._source.system.equipped.carryType==="worn"&&i._source.system.equipped.inSlot===!0&&i._source.system.equipped.invested===!0&&i._source.system.identification.status==="identified"):(n!=="shield"||Ui(e))&&!t.includes("alchemical")&&!t.includes("bomb")}s(fs,"isValidWeapon");function qi(e){try{let t=this.actor;if(!Ze(t,!0)||!fs(this))return e();let n=this._source.system.traits.value;if(n.includes("alchemical")&&n.includes("bomb"))return e();let r=t.level,a=P("auto-runes")==="force",i=r<2?null:r<10?1:r<16?2:3,o=r<4?null:r<12?1:r<19?2:3;(this.system.runes.potency<=i||a)&&(this.system.runes.potency=i),(this.system.runes.striking<=o||a)&&(this.system.runes.striking=o)}catch{we("auto-runes",is)}e()}s(qi,"onPrepareWeaponData");function Bi(e){e();try{if(!Ze(this.actor)||this.isSpecific||!fs(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Hi[n]);let r=this.system.runes.striking;r&&(t.gp-=ji[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{we("auto-runes",os)}}s(Bi,"onPrepareWeaponDerivedData");var Gi={1:160,2:1060,3:20560,4:20560},zi={1:340,2:3440,3:49440};function ds(e){return!0}s(ds,"isValidArmor");function Vi(e){try{let t=this.actor;if(!Ze(t,!0)||!ds(this))return e();let n=t.level,r=P("auto-runes")==="force",a=n<5?null:n<11?1:n<18?2:3,i=n<8?null:n<14?1:n<20?2:3;(this.system.runes.potency<=a||r)&&(this.system.runes.potency=a),(this.system.runes.resilient<=i||r)&&(this.system.runes.resilient=i)}catch{we("auto-runes",cs)}e()}s(Vi,"onPrepareArmorData");function Wi(e){e();try{if(!Ze(this.actor)||this.isSpecific||!ds(this))return;let t=this.price.value.toObject();if(!t.gp)return;let n=this.system.runes.potency;n&&(t.gp-=Gi[n]);let r=this.system.runes.resilient;r&&(t.gp-=zi[r]),t=new game.pf2e.Coins(t),(n||r)&&!this.system.runes.property.length&&(t=t.plus(this._source.system.price.value)),this.system.price.value=t}catch{we("auto-runes",ls)}}s(Wi,"onPrepareArmorDerivedData");function Ki(e,t){let n=e.item;if(!n||!n.isOfType("weapon","armor")||!Ze(n.actor,!0))return;let r=["potency","striking","resilient"].map(a=>`[name="system.runes.${a}"]`).join(", ");t.find(`[data-tab=details] fieldset .form-group:has(${r})`).hide()}s(Ki,"renderPhysicalItemSheetPF2e");function Pn(e){if(!e.name)throw new Error("module features need a name");if(!e.settings?.length)throw new Error("module features need at least one setting")}s(Pn,"checkFeatureOptions");function B(e){Pn(e);let t={};if(e.hooks?.length){let n=new Map;t.hooks={set:(r,a)=>{n.get(r)?.(a)},setFromSetting:(r,a)=>{let i=P(a);n.get(r)?.(i)},setAll:r=>{for(let[a,i]of n)i(r)}};for(let r of e.hooks){let a=r.key??r[0]??r.event;n.set(a,Yi(r))}e.hooks.length===1&&(t.setHook=[...n][0][1],t.setHook.fromSetting=function(r){let a=P(r);this(a)})}return e.socket&&(t.socket=Ji(e.name,e.socket)),t}s(B,"createTool");function Yi(e){let{event:t,listener:n,useChoices:r=!1,isUpstream:a=!1}=Array.isArray(e)?{event:e[0],listener:e[1]}:e,i=null,o=r?typeof r=="string"?l=>l===r:l=>l!=="disabled":l=>l,c=(a?Nr:Hooks.on).bind(Hooks);return l=>{let f=o(l);f&&!i?i=c(t,n):!f&&i&&(Hooks.off(t,i),i=null)}}s(Yi,"createHook");function Ji(e,t){let n=!1,r=`tool-${e}-`,a=s((i,o)=>{i.type?.startsWith(r)&&(i.type=i.type.slice(r.length),t(i,o))},"onSocket");return{emit(i){i.type=r+i.type,vn(i)},activate(){n||(n=!0,Gr(a))},disable(){n&&(n=!1,zr(a))},toggle(i=!n){i?this.activate():this.disable()}}}s(Ji,"createSocket");var Rn={name:"debug",settings:[{key:"debug",type:Boolean,default:!1,config:!1,scope:"client",onChange:e=>ps(e)}],hooks:[["renderApplication",Mn],["renderActorSheet",Mn],["renderItemSheet",Mn]],init:oe(ps,"debug")},{hooks:Xi}=B(Rn);function ps(e){Xi.setAll(e)}s(ps,"setup");function Mn(e,t){let n=t.find(".document-id-link")[0];n&&n.addEventListener("click",r=>{if(!r.shiftKey)return;let a=e.object;if(!a)return;r.preventDefault(),r.stopPropagation();let i=a.type,o=2,c=i;for(;window[c];)c=`${i}${o++}`;window[c]=a,console.log(c,a)},!0)}s(Mn,"onRender");var Ln=debounce(Zi,1),Fn={name:"effects",settings:[{key:"effect-remove",type:Boolean,default:!1,scope:"client",onChange:Ln},{key:"condition-sheet",type:Boolean,default:!1,scope:"client",onChange:Ln}],hooks:[["renderEffectsPanel",to]],conflicts:["pf2e-effect-description"],init:Ln},{setHook:Qi}=B(Fn);function Zi(){let e=P("effect-remove")||P("condition-sheet");Qi(e),eo()}s(Zi,"setup");function eo(){game.pf2e.effectPanel?.render()}s(eo,"refreshEffectsPanel");function to(e,t){let n=`<div>${H("effects.remove")}</div>`,r='<a data-action="edit" data-tooltip="Edit Item"><i class="fa-solid fa-fw fa-pencil"></i></a>',a=t.find(".effect-item[data-item-id]").toArray();for(let i of a){let o=i.dataset.itemId,c=e.actor?.items.get(o);if(c&&(P("effect-remove")&&!c.isLocked&&c.badge&&c.badge.type==="counter"&&(i.querySelector(".effect-info .instructions").insertAdjacentHTML("beforeend",n),i.querySelector(".icon").addEventListener("contextmenu",l=>ro(l,e),!0)),P("condition-sheet")&&c.isOfType("condition"))){let l=i.querySelector(".effect-info > h1");l.insertAdjacentHTML("beforeend",r),l.querySelector('[data-action="edit"]').addEventListener("click",f=>no(f,e))}}}s(to,"renderEffectsPanel");function no(e,t){let n=ms(e,t);n?.isOfType("condition")&&(e.preventDefault(),n.sheet.render(!0))}s(no,"onConditionSheet");function ro(e,t){if(!e.shiftKey)return;let n=ms(e,t);!n||n.isLocked||!n.badge||n.badge.type!=="counter"||(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),n.delete())}s(ro,"onRemoveEffect");function ms(e,t){let a=e.currentTarget.closest(".effect-item[data-item-id]").dataset.itemId;return t.actor?.items.get(a)}s(ms,"getEffect");var ue={wrapperIds:[],tabs:new Collection},so="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._renderInner",ao="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype._render",io="CONFIG.Actor.sheetClasses.character['pf2e.CharacterSheetPF2e'].cls.prototype.activateListeners";function fe(e){return e&&!e.pack&&e.id&&game.actors.has(e.id)}s(fe,"isPlayedActor");function Lt(e){ue.wrapperIds.length||(ue.wrapperIds=[q(ao,oo),q(so,co),q(io,lo)]),ue.tabs.set(e.tabName,e)}s(Lt,"registerCharacterSheetExtraTab");function Ft(e){if(ue.tabs.delete(e),ue.wrapperIds.length&&!ue.tabs.size){for(let t of ue.wrapperIds)Hr(t);ue.wrapperIds=[]}}s(Ft,"unregisterCharacterSheetExtraTab");async function oo(e,...t){let n={};for(let{tabName:r}of ue.tabs){let i=Te(this.element,r).find(".toolbelt-alternate")[0];i&&(n[r]=i.scrollTop)}await e(...t);for(let{tabName:r}of ue.tabs){if(!n[r])continue;let o=Te(this.element,r).find(".toolbelt-alternate")[0];o.scrollTop=n[r]}}s(oo,"characterSheetRender");async function co(e,t){let n=await e(t),r=this.actor;if(!ue.tabs.size||!fe(r))return n;let a=this.element;for(let{tabName:i,getData:o,templateFolder:c,onRender:l,beforeSelector:f}of ue.tabs){let u=Te(n,i),p=await o(r,this,Te(a,i)),m=await z(c,p);l&&await l(r,this,n),Z(this,`${i}.toggled`)&&u.addClass("toggled"),f?u.find(f).before(m):u.children(":last").before(m)}return n}s(co,"characterSheetInnerRender");function lo(e,t){e(t);let n=this.actor;if(!(!ue.tabs.size||!fe(n)))for(let{tabName:r,addEvents:a}of ue.tabs){t.find(`nav.sheet-navigation .item[data-tab=${r}]`).on("click",o=>uo(o,t,this,r));let i=Te(t,r);a(i.find(".toolbelt-alternate"),this,n,t)}}s(lo,"characterSheetActiveListeners");function Te(e,t){return e.find(`section.sheet-body .sheet-content > .tab[data-tab=${t}]`)}s(Te,"getCharacterSheetTab");function uo(e,t,n,r){e.preventDefault();let a=Te(t,r);a.hasClass("active")&&(a.toggleClass("toggled"),a.scrollTop(0),ie(n,`${r}.toggled`,a.hasClass("toggled")))}s(uo,"onCharacterSheetTabBtnToggle");var Nn={name:"giveth",settings:[{key:"giveth",type:String,default:"disabled",choices:["disabled","enabled","no-message"],onChange:e=>gs(e)}],hooks:[{event:"dropCanvasData",listener:mo,isUpstream:!0,useChoices:!0}],socket:po,conflicts:["pf2e-giveth"],ready:oe(gs,"giveth")},{socket:Nt,setHook:fo}=B(Nn);function gs(e){game.user.isGM?Nt.toggle(e):fo(e)}s(gs,"setup");function po(e,t){e.type==="giveth-condition"?yo(e):e.type==="giveth-effect"?vo(e):bo(e,t)}s(po,"onSocket");function mo(e,t){if(!Wr())return!0;let n=ho(t);if(!n)return!0;let r=e.tokens.placeables.slice().filter(a=>{if(!a.document.actorLink)return!1;let i=a.actor;if(!ys(i,t.actorId)||i.isOwner)return!1;let o=a.x+(a.hitArea?.right??0),c=a.y+(a.hitArea?.bottom??0);return t.x>=a.x&&t.y>=a.y&&t.x<=o&&t.y<=c}).sort((a,i)=>i.document.sort-a.document.sort).at(0)?.actor;return r?(go(n.actor,r,n.item,n.value),!1):!0}s(mo,"dropCanvasData");function go(e,t,n,r){let a=e.id,i=t.id,o=!(n instanceof Item);if(!o&&n.isOfType("physical")){let c=n.quantity;if(c<1)return V("giveth.notification.zero");if(c===1)return hs(a,i,n.id,1,!1);let l=t.inventory.findStackableItem(n._source);new Ct(e,{quantity:{max:c,default:c},lockStack:!l,isPurchase:!1},(f,u)=>{hs(a,i,n.id,f,u)}).render(!0)}else{let c=o?`Compendium.${n.pack}.${n._id}`:n.uuid;n.type==="condition"?Nt.emit({type:"giveth-condition",targetId:i,value:r??1,uuid:c}):Nt.emit({type:"giveth-effect",targetId:i,uuid:c})}}s(go,"giveth");function hs(e,t,n,r,a){Nt.emit({type:"giveth-physical",ownerId:e,targetId:t,itemId:n,qty:r,stack:a})}s(hs,"sendPhysicalRequest");function ys(e,t){return!fe(e)||t&&e.id===t?!1:e.hasPlayerOwner&&!e.isToken&&e.isOfType("character","npc","vehicle")}s(ys,"isValidActor");function ho(e){if(e.tokenId||e.type!=="Item"||!e.uuid)return;let t=fromUuidSync(e.uuid);if(!t)return;let n=t.actor;if(!n){let a=e.context?.origin.actor;n=a?fromUuidSync(a):null}if(!ys(n)||!n.isOwner)return;let r=!(t instanceof Item);if(r&&t.pack&&["effect","condition"].includes(t.type))return{actor:n,item:t,value:e.value};if(!r&&t.isOfType("physical","effect"))return{actor:n,item:t,value:e.value}}s(ho,"getDetailsFromData");async function yo({targetId:e,uuid:t,value:n}){let r=game.actors.get(e);if(!r)return;let a=await fromUuid(t);a&&r.increaseCondition(a.slug,{min:n})}s(yo,"takethCondition");async function vo({targetId:e,uuid:t}){let n=game.actors.get(e);if(!n)return;let r=await fromUuid(t);if(!r)return;let a=r.clone({"system.tokenIcon.show":!0,"system.unidentified":!1}).toObject();n.createEmbeddedDocuments("Item",[a])}s(vo,"takethEffect");async function bo({itemId:e,ownerId:t,qty:n,stack:r,targetId:a},i){let o=game.actors.get(t),c=game.actors.get(a);if(!o||!c)return;let l=o.items.get(e);if(!l)return;let f=Math.min(n,l.quantity),u=await Pt(c,l,f,void 0,r);if(P("giveth")==="no-message")return;let p=H("giveth.giveth",{giver:Ce(o),quantity:f,item:await St(u),recipient:Ce(c)});await wt(H("giveth.subtitle"),p,o,u,i)}s(bo,"takethPhysical");var Be=F("hero.templates.trade"),$t=class extends Application{static{s(this,"Trade")}constructor(t){super({id:`pf2e-hero-actions-trade-${t.id}`}),this._actor=t}static get defaultOptions(){return mergeObject(Application.defaultOptions,{title:Be("title"),template:de("hero/trade"),width:600,height:"auto"})}get actor(){return this._actor}get target(){return this._target}set target(t){if(!t){Be.error("no-target");return}t!==this._target&&(delete this.target?.apps?.[this.appId],this._target=t,this.render())}getData(t){return mergeObject(super.getData(),{actor:this.actor,target:this.target,targets:game.actors.filter(n=>n.type==="character"&&n.id!==this.actor.id&&n.hasPlayerOwner),actions:me(this.actor),targetActions:this.target?me(this.target):[],i18n:Be.template})}activateListeners(t){super.activateListeners(t),t.find('select[name="target"]').on("change",this.#n.bind(this)),t.find('[data-action="description"]').on("click",this.#t.bind(this)),t.find('[data-action="trade"]').on("click",this.#e.bind(this)),t.find('[data-action="cancel"]').on("click",()=>this.close())}render(t,n){return this.actor.apps[this.appId]=this,this.target&&(this.target.apps[this.appId]=this),super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId],delete this.target?.apps?.[this.appId]}#e(){if(!this.target){Be.warn("no-target");return}let t=this.element.find('[name="action"]:checked').val(),n=this.element.find('[name="targetAction"]:checked').val();if(typeof t!="string"||typeof n!="string"){Be.warn("no-select");return}let r=gn(this.target)??game.users.activeGM;if(!r){Be.warn("no-user");return}vs({sender:{id:game.user.id,cid:this.actor.id,uuid:t},receiver:{id:r.id,cid:this.target.id,uuid:n}}),this.close()}async#t(t){let n=$(t.currentTarget).siblings("input").val();(await fromUuid(n))?.sheet.render(!0)}#n(t){let n=t.currentTarget.value;this.target=game.actors.get(n)}};var _t="pf2e-hero-actions",So="Compendium.pf2e.journals.JournalEntry.BSp4LUSaOmUyjBko",Ht="Compendium.pf2e.rollable-tables.RollTable.zgZoI7h0XjjJrrNK",wo="systems/pf2e/icons/features/feats/heroic-recovery.webp",Hn={name:"heroActions",settings:[{key:"hero",type:Boolean,default:!1,onChange:e=>bs(e)},{key:"hero-table",type:String,default:""},{key:"hero-trade",type:Boolean,default:!1,onChange:()=>Se("character")},{key:"hero-private",type:Boolean,default:!1}],socket:xo,hooks:[["renderCharacterSheetPF2e",ko]],conflicts:[_t],api:{createTable:$o,removeHeroActions:qo,getHeroActions:me,useHeroAction:ks,getHeroActionDetails:jt,drawHeroAction:xs,drawHeroActions:ws,sendActionToChat:Os,discardHeroActions:Cs,tradeHeroAction:Es,getDeckTable:jn,giveHeroActions:zo,createChatMessage:Ut},init:oe(bs,"hero")},{socket:et,setHook:Eo}=B(Hn);function bs(e){et.toggle(e),Eo(e)}s(bs,"setup");function xo(e){switch(e.type){case"hero.trade-reject":if(e.sender.id!==game.user.id)return;Rs(e);break;case"hero.trade-accept":if(!gt())return;Ps(e);break;case"hero.trade-request":if(e.receiver.id!==game.user.id)return;Fo(e);break;case"hero.trade-error":if(!e.users.includes(game.user.id))return;Ms(e.error);break}}s(xo,"onSocket");async function ko(e,t){let n=e.actor;fe(n)&&(await Co(t,n),Io(t,n))}s(ko,"renderCharacterSheetPF2e");async function Co(e,t){let n=me(t),r=t.heroPoints.value-n.length,a=t.isOwner,i=F("hero.templates.heroActions"),o=await z("hero/sheet",{owner:a,list:n,canUse:r>=0&&a,canDraw:r>0&&a,canTrade:P("hero-trade"),mustDiscard:r<0,diff:Math.abs(r),i18n:i.template});e.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] > .strikes-list:not(.skill-action-list)").first().after(o)}s(Co,"addActionsToSheet");function Io(e,t){let n=e.find(".tab.actions .heroActions-list");n.find("[data-action=draw]").on("click",r=>Po(t,r)),n.find("[data-action=expand]").on("click",Ss),n.find("[data-action=use]").on("click",r=>Do(t,r)),n.find("[data-action=display]").on("click",r=>Oo(t,r)),n.find("[data-action=discard]").on("click",To),n.find("[data-action=discard-selected]").on("click",()=>Ao(t,e)),e.find("[data-action=hero-actions-trade]").on("click",()=>Es(t))}s(Io,"addSheetEvents");async function Ao(e,t){let r=t.find(".tab.actions .heroActions-list .action.discarded").toArray().map(a=>a.dataset.uuid);Cs(e,r)}s(Ao,"onClickHeroActionsDiscard");function To(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.closest(".heroActions-list");t.toggleClass("discarded");let r=Number(n.attr("data-discard")??"0"),a=n.find(".action.discarded");n.toggleClass("discardable",a.length===r)}s(To,"onClickHeroActionDiscard");async function Oo(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");Os(e,n)}s(Oo,"onClickHeroActionDisplay");async function Do(e,t){t.preventDefault();let n=$(t.currentTarget).closest(".action").attr("data-uuid");ks(e,n)}s(Do,"onClickHeroActionUse");async function Po(e,t){t.preventDefault(),ws(e)}s(Po,"onClickHeroActionsDraw");function me(e){return getProperty(e,`flags.${_t}.heroActions`)??[]}s(me,"getHeroActions");async function Ne(e,t){return e.update({[`flags.${_t}.heroActions`]:t})}s(Ne,"setHeroActions");async function Ss(e){e.preventDefault();let t=$(e.currentTarget).closest(".action"),n=t.find(".item-summary");if(!n.hasClass("loaded")){let r=t.attr("data-uuid"),a=await jt(r);if(!a)return;let i=await TextEditor.enrichHTML(a.description,{async:!0});n.find(".item-description").html(i),n.addClass("loaded")}t.toggleClass("expanded")}s(Ss,"onClickHeroActionExpand");async function jt(e){let t=await fromUuid(e);if(!t)return;let n=t instanceof JournalEntry?t:t.parent,r=t instanceof JournalEntry?t.pages.contents[0]:t,a=r?.text.content;if(a)return n.uuid===So&&(a=a.replace(/^<p>/,"<p><strong>Trigger</strong> ")),{name:r.name,description:a}}s(jt,"getHeroActionDetails");async function ws(e){if(!e?.isOfType("character")){V("hero.onlyCharacter");return}let t=me(e),n=e.heroPoints.value-t.length,r=[];for(let a=0;a<n;a++){let i=await xs();if(i!==void 0){if(i===null)return;t.push(i),r.push(i)}}r.length&&(Ne(e,t),Ut({actor:e,actions:r,label:a=>H("hero.actions-draw.header",{nb:a}),secret:!0}))}s(ws,"drawHeroActions");function Ut({actor:e,actions:t,label:n,secret:r=!1}){let{content:a,size:i}=Mo(t);n=typeof n=="function"?n(i):n;let o={flavor:`<h4 class="action">${n}</h4>`,content:a,speaker:ChatMessage.getSpeaker({actor:e})};r&&P("hero-private")&&(o.type=CONST.CHAT_MESSAGE_TYPES.ROLL,o.rollMode=CONST.DICE_ROLL_MODES.PRIVATE),ChatMessage.create(o)}s(Ut,"createChatMessage");function Mo(e){let t=e.map(({uuid:n,name:r})=>Ue(n,r));return{content:t.map(n=>`<div style="line-height: 1.6;">${n}</div>`).join(""),size:t.length}}s(Mo,"chatActions");function Es(e){if(!e?.isOfType("character")){V("hero.onlyCharacter");return}let t=me(e);if(!t||!t.length){V("hero.no-action");return}let n=t.length-e.heroPoints.value;if(n>0){V("hero.no-points",{nb:n.toString()});return}new $t(e).render(!0)}s(Es,"tradeHeroAction");async function xs(){let e=await jn(),t=F("hero.table");if(!e)return t.error("drawError",!0),null;if(!e.formula)if(game.user.isGM){if(e.compendium)return t.error("noFormulaCompendium",!0),null;await e.normalize()}else return t.error("noFormula",!0),null;e.replacement===!1&&(e.results.some(i=>!i.drawn)||await e.resetResults());let n=(await e.draw({displayChat:!1})).results[0];if(!n)return;let r=Ls(n);if(r)return{uuid:r,name:await Is(n,r)}}s(xs,"drawHeroAction");async function ks(e,t){if(!e?.isOfType("character")){V("hero.onlyCharacter");return}let n=e.heroPoints.value;if(n<1)return V("hero.use.noPoints");let r=me(e),a=r.findIndex(o=>o.uuid===t);if(a===-1)return;let i=await jt(t);i||xe("hero.use.noDetails"),r.splice(a,1),i?(e.update({"system.resources.heroPoints.value":n-1,[`flags.${_t}.heroActions`]:r}),ChatMessage.create({flavor:`<h4 class="action">${H("hero.actions-use.header")}</h4>`,content:`<h2>${i.name}</h2>${i.description}`,speaker:ChatMessage.getSpeaker({actor:e})})):Ne(e,r)}s(ks,"useHeroAction");async function Cs(e,t){if(!e?.isOfType("character")){V("hero.onlyCharacter");return}let n=typeof t=="string"?[t]:t,r=me(e),a=[];for(let i of n){let o=r.findIndex(c=>c.uuid===i);o!==-1&&(a.push(r[o]),r.splice(o,1))}Ne(e,r),Ut({actor:e,actions:a,label:i=>H("hero.actions-discard.header",{nb:i})})}s(Cs,"discardHeroActions");async function Is(e,t){return e.type!==CONST.TABLE_RESULT_TYPES.TEXT?e.text:/@UUID\[[\w\.]+\]{([\w -]+)}/.exec(e.text)?.[1]??(t&&(await fromUuid(t))?.name)}s(Is,"getLabelfromTableResult");async function As(e){if(!e)return;let t=await fromUuid(e);return t&&t instanceof RollTable?t:void 0}s(As,"getTableFromUuid");async function Ro(){return As(Ht)}s(Ro,"getDefaultCompendiumTable");function Ts(){return game.tables.find(e=>e.getFlag("core","sourceId")===Ht)}s(Ts,"getDefaultWorldTable");async function Lo(){return As(P("hero-table"))}s(Lo,"getCustomTable");async function jn(){return await Lo()??Ts()??await Ro()}s(jn,"getDeckTable");async function Os(e,t){let n=await jt(t);if(!n)return xe("hero.details.missing");ChatMessage.create({content:`<h2>${n.name}</h2>${n.description}`,speaker:ChatMessage.getSpeaker({actor:e})})}s(Os,"sendActionToChat");function vs(e){if(e.receiver.id===game.user.id){Ds(e);return}et.emit({...e,type:"hero.trade-request"})}s(vs,"sendTradeRequest");function Ds(e){if(game.user.isGM){Ps(e);return}et.emit({...e,type:"hero.trade-accept"})}s(Ds,"acceptRequest");async function Ps(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!r||!a){$n(e);return}let i=me(r),o=me(a),c=i.findIndex(v=>v.uuid===t.uuid),l=o.findIndex(v=>v.uuid===n.uuid);if(c===-1||l===-1){$n(e);return}let f=i.splice(c,1)[0],u=o.splice(l,1)[0];i.push(u),o.push(f),Ne(r,i),Ne(a,o);let p=Ue(f.uuid),m=Ue(u.uuid),y=F("hero.trade-success"),g=`<div style="line-height: 1.6">${y("offer",{offer:p})}</div>`;g+=`<div style="line-height: 1.6">${y("receive",{receive:m})}</div>`,ChatMessage.create({flavor:`<h4 class="action">${y("header",{name:a.name})}</h4>`,content:g,speaker:ChatMessage.getSpeaker({actor:r})})}s(Ps,"onTradeAccepted");function $n({sender:e,receiver:t},n="trade-error"){let r=new Set([e.id,t.id]);r.has(game.user.id)&&(r.delete(game.user.id),Ms(n)),r.size&&et.emit({type:"hero.trade-error",users:Array.from(r),error:n})}s($n,"sendTradeError");function Ms(e){xe("hero.trade-error")}s(Ms,"onTradeError");async function Fo(e){let{sender:t,receiver:n}=e,r=game.actors.get(t.cid),a=game.actors.get(n.cid);if(!r||!a){$n(e);return}let i=F("hero.trade-request"),o=`<p>${i("header",{sender:r.name,receiver:a.name})}</p>`;o+=`<p>${i("give",{give:Ue(t.uuid)})}</p>`,o+=`<p>${i("want",{want:Ue(n.uuid)})}</p>`,o+=`<p style="margin-bottom: 1em;">${i("accept")}</p>`,await Dialog.confirm({title:i("title"),content:await TextEditor.enrichHTML(o,{async:!0})})?Ds(e):No(e)}s(Fo,"onTradeRequest");function No(e){if(e.sender.id===game.user.id){Rs(e);return}et.emit({...e,type:"hero.trade-reject"})}s(No,"rejectRequest");async function Rs({receiver:e}){let t=game.actors.get(e.cid);V("hero.trade-rejected",{name:t.name},!0)}s(Rs,"onTradeRejected");async function $o(){if(!game.user.isGM){V("hero.notGM");return}let e=F("hero.templates.createTable.choice"),t=de("hero/dialogs/create-table"),n={yes:{label:e("create"),icon:'<i class="fas fa-border-all"></i>',callback:i=>{let o=i.find('.window-content input[name="type"]:checked').val(),c=i.find('.window-content input[name="draw"]:checked').val()==="unique";return{type:o,unique:c}}},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{i18n:e.template}),title:e("title"),buttons:n,default:"yes",close:()=>null},a=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-create-table"});a&&(a.type==="default"?jo(a.unique):_o(a.unique))}s($o,"createTable");async function _o(e){let t=await Ho(e);await _n(t),t.sheet?.render(!0)}s(_o,"createCustomTable");function Ho(e=!0){let t=Un(e);return RollTable.create(t,{temporary:!1})}s(Ho,"createCustomActionsTable");async function jo(e){let t=F("templates.createTable.default.confirm"),n=await Ts();if(n&&await Dialog.confirm({title:t("title"),content:t("content")})){let a=Un(e);return await n.update(a),_n(n,!0)}n=await Uo(e),await _n(n)}s(jo,"createDefaultTable");async function Uo(e=!0){let t=await fromUuid(Ht),n=Un(e,t);return RollTable.create(n,{temporary:!1})}s(Uo,"createDefautActionsTable");async function _n(e,t=!1){t&&await e.normalize(),await Br("hero-table",e.uuid)}s(_n,"setTable");function Un(e,t){let n={name:H("hero.table.name"),replacement:!(e??!0),img:wo,description:H("hero.table.description"),flags:{core:{sourceId:Ht}}};return t?mergeObject(deepClone(t._source),n):n}s(Un,"getTableSource");async function qo(){if(!game.user.isGM){V("hero.notGM");return}let e=F("hero.templates.removeActions"),t=de("hero/dialogs/remove-actions"),n={yes:{label:e("remove"),icon:'<i class="fas fa-trash"></i>',callback:i=>i.find('input[name="actor"]:checked').toArray().map(o=>game.actors.get(o.value)).filter(o=>o)},no:{label:e("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},r={content:await renderTemplate(t,{actors:game.actors.filter(i=>i.type==="character"),i18n:e.template}),title:e("title"),buttons:n,default:"yes",render:i=>{i.on("change",'input[name="all"]',()=>Bo(i)),i.on("change",'input[name="actor"]',()=>Go(i))},close:()=>null},a=await Dialog.wait(r,void 0,{id:"pf2e-hero-actions-remove-actions"});if(a){if(!a.length){e.warn("noSelection");return}for(let i of a)Ne(i,[]);e.info("removed")}}s(qo,"removeHeroActions");function Bo(e){let t=e.find('input[name="all"]')[0].checked;e.find('input[name="actor"]').prop("checked",t)}s(Bo,"removeActionsToggleAll");function Go(e){let t=e.find('input[name="actor"]'),n=t.filter(":checked"),r=e.find('input[name="all"]');t.length===n.length?(r.prop("checked",!0).prop("indeterminate",!1),t.prop("checked",!0)):n.length?r.prop("checked",!1).prop("indeterminate",!0):(r.prop("checked",!1).prop("indeterminate",!1),t.prop("checked",!1))}s(Go,"removeActionsToggleActor");function Ls(e){if(e.type===CONST.TABLE_RESULT_TYPES.TEXT)return/@UUID\[([\w\.]+)\]/.exec(e.text)?.[1];if(e.type===CONST.TABLE_RESULT_TYPES.DOCUMENT)return`${e.documentCollection}.${e.documentId}`;if(e.type===CONST.TABLE_RESULT_TYPES.COMPENDIUM)return`Compendium.${e.documentCollection}.${e.documentId}`}s(Ls,"documentUuidFromTableResult");async function zo(e){if(!game.user.isGM){V("hero.notGM");return}let t=F("hero.templates.giveAction");if(!e?.isOfType("character"))return t.warn("noCharacter"),null;let n=await jn();if(!n)return xe("hero.table.drawError",!0),null;let r=n.replacement===!1,a=(await Promise.all(n.results.map(async v=>{let S=Ls(v);if(S)return{key:v.id,uuid:S,name:await Is(v,S),drawn:v.drawn}}))).filter(Boolean),i=de("hero/dialogs/give-action"),o=await renderTemplate(i,{actions:a,isUnique:r,i18n:t}),c={yes:{label:t("give"),icon:'<i class="fa-solid fa-gift"></i>',callback:v=>({selected:v.find("[name=action]:checked").closest(".action").toArray().map(S=>S.dataset),asDrawn:v.find("[name=drawn]").prop("checked")??!1,withMessage:v.find("[name=message]").prop("checked")})},no:{label:t("cancel"),icon:'<i class="fas fa-times"></i>',callback:()=>null}},l={title:t("title"),content:o,buttons:c,render:v=>{v.find("[data-action=expand]").on("click",Ss)},close:()=>null},f=await Dialog.wait(l,void 0,{id:"pf2e-hero-actions-give-action"});if(!f)return;let{selected:u,asDrawn:p,withMessage:m}=f,y=me(e),g=[];for(let{uuid:v,name:S,key:E}of u){if(y.push({uuid:v,name:S}),!p)continue;let x=n.results.get(E);x&&!x.drawn&&g.push(E)}g.length&&await n.updateEmbeddedDocuments("TableResult",g.map(v=>({_id:v,drawn:!0}))),Ne(e,y),m&&Ut({actor:e,actions:u,label:v=>H("hero.actions-give.header",{nb:v}),secret:!0})}s(zo,"giveHeroActions");var T=null,Vo=0;function Fs(e,t){for(let[n,r]of Object.entries(t))for(let a of r){let i=e[a];!i||typeof i===n||(e[i]=void 0)}}s(Fs,"cleanOptions");function Ns(e){if(e.element instanceof HTMLElement){Fs(e,{string:["draggedClass","group","selector","filter","identifier"],number:["triggerDistance"],boolean:["cancelOnRightClick"],function:["onCancel","onDragEnd","onDragStart"]}),e.triggerDistance??=6,e.cancelOnRightClick??=!0,e.cursorImage??={},e.cursorImage.id=typeof e.cursorImage.id=="string"?e.cursorImage.id:"",e.cursorImage.img=typeof e.cursorImage.img=="function"?e.cursorImage.img:void 0,e.droppables??=[];for(let t=e.droppables.length-1;t>=0;t--){let n=e.droppables[t];if(!(n.element instanceof HTMLElement)){e.droppables.splice(t,1);continue}Fs(n,{string:["selector","overClass","filter"],boolean:["purgeOnLeave"],function:["onDragEnter","onDragLeave","onDragOver","onDrop"]})}e.element.addEventListener("mousedown",t=>Ko(t,e))}}s(Ns,"makeDraggable");async function Wo(e){T&&(T.canceled=!0,T.dragging&&T.draggable.ghost&&T.draggable.ghost.reset(),T.dragging&&T.options.onCancel&&await T.options.onCancel(e,T.draggable),_s(),await $s(e))}s(Wo,"onDragCancel");async function $s(e){T&&(T.dragging&&T.options.onDragEnd&&await T.options.onDragEnd(e,T.draggable,{canceled:T.canceled,dropped:T.dropped}),window.removeEventListener("mousemove",Hs),window.removeEventListener("mouseup",js),T=null)}s($s,"onDragEnd");function _s(){if(T){T.draggable.classList.purge(),T.draggable.ghost?.classList.purge(),T.cursorElement?.remove();for(let{classList:e}of Object.values(T.hovered))e.purge()}}s(_s,"cleanUp");function Ko(e,t){if(e.button===2&&T?.dragging&&T.options.cancelOnRightClick){Wo(e);return}if(e.button)return;let n=tt(e.target,t.element,t);if(!n)return;let r,a=dt(n),i=n.parentElement,o=qn(n);T={canceled:!1,dragging:!1,dropped:!1,options:t,group:t.group,draggable:{identifier:t.identifier,element:n,triggeringElement:e.target,x:e.clientX,y:e.clientY,parent:i,index:a,classList:o,get ghost(){if(r)return t.ghostClass&&r.classList.add(t.ghostClass),r;let{element:c=n.cloneNode(!0),index:l=1/0}=t.createGhost?.(n,a)??{},f=qn(c);return t.draggedClass&&c!==n&&c.classList.remove(t.draggedClass),t.ghostClass&&f.add(t.ghostClass),r={element:c,classList:f,index:l,reset:()=>{if(c.remove(),c===n){let u=i.children[a];i.insertBefore(n,u),r.index=a,t.ghostClass&&f.remove(t.ghostClass)}else r.index=1/0}},r},resetPosition:()=>{n.remove(),i.children[a].before(n)}},droppables:t.droppables.map(c=>({...c,id:Vo++})),hovered:{}},window.addEventListener("mousemove",Hs),window.addEventListener("mouseup",js)}s(Ko,"onMouseDown");async function Hs(e){if(!T)return;if(T.dragging){Jo(e);return}let{clientX:t,clientY:n}=e,{draggable:r}=T;Lr(r.x,r.y,t,n)>T.options.triggerDistance&&await Yo(e)}s(Hs,"onMouseMove");async function js(e){if(!(e.button||!T)){if(T.dragging){let t=!1;_s(),await Promise.all(Object.values(T.hovered).map(async n=>{if(!n.droppable.onDrop)return;await n.droppable.onDrop(e,T.draggable,{classList:n.classList,element:n.element,triggeringElement:n.triggeringElement})&&(t=!0)})),T.dropped=t}await $s(e)}}s(js,"onMouseUp");async function Yo(e){if(!T.dragging){if(T.dragging=!0,T.options.cursorImage.img){let t=T.options.cursorImage.img(T.draggable.element);t instanceof HTMLElement?T.cursorElement=t:(T.cursorElement=new Image,T.cursorElement.src=typeof t=="string"?t:"")}else T.cursorElement=T.draggable.element.cloneNode(!0);T.cursorElement.id=T.options.cursorImage.id,T.options.draggedClass&&T.draggable.classList.add(T.options.draggedClass),document.body.appendChild(T.cursorElement),await T.options.onDragStart?.(e,T.draggable)}}s(Yo,"onDragStart");async function Jo(e){if(!T)return;let{clientX:t,clientY:n}=e,r=T.cursorElement,a=r.offsetWidth/2,i=r.offsetHeight/2;r.style.left=`${t-a}px`,r.style.top=`${n-i}px`,await Promise.all(T.droppables.map(async o=>{let c=tt(e.target,o.element,{selector:o.selector,filter:o.filter}),l=T.hovered[o.id];if(l&&(!c||l.element!==c)&&await o.onDragLeave?.(e,T.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target})!==!1&&(delete T.hovered[o.id],o.purgeOnLeave?l.classList.purge():o.overClass&&l.classList.remove(o.overClass)),!!c)if(l)o.onDragOver&&await o.onDragOver(e,T.draggable,{classList:l.classList,element:l.element,triggeringElement:e.target});else{let f=qn(c);await o.onDragEnter?.(e,T.draggable,{classList:f,element:c,triggeringElement:e.target})!==!1&&(o.overClass&&f.add(o.overClass),T.hovered[o.id]={id:o.id,classList:f,droppable:o,element:c,triggeringElement:e.target})}}))}s(Jo,"onDragMove");function qn(e){return new class extends Set{add(t){e.classList.add(t),super.add(t)}remove(t){e.classList.remove(t),super.delete(t)}toggle(t,n){n??!e.classList.contains(t)?this.add(t):this.remove(t)}contains(t){return this.has(t)}purge(){e.classList.remove(...this)}}}s(qn,"newClassList");function tt(e,t,{selector:n,filter:r}={}){if(!t.contains(e))return;if(!n&&!r)return t;let a,i=e;for(;;){if(r&&i.matches(r))return;if(!a&&n&&i.matches(n)&&(a=i),i===t)break;i=i.parentElement}return n?a:t}s(tt,"closestInside");var Gn=!1,zn={name:"inventory",settings:[{key:"inventory",type:Boolean,default:!1,scope:"client",onChange:e=>Us(e)}],hooks:[["closeCharacterSheetPF2e",Zo]],ready:oe(Us,"inventory")},{setHook:Xo}=B(zn),Bn,Qo=["platinum-pieces","gold-pieces","silver-pieces","copper-pieces"];function Us(e){e?Lt({tabName:"inventory",templateFolder:"inventory/sheet",getData:tc,addEvents:nc,onRender:ec}):Ft("inventory"),Xo(e),Se("character")}s(Us,"setup");function Zo(e,t){let n=e.actor;if(!fe(n)||!Z(e,"inventory.requireSave"))return;let r=Te(t,"inventory")[0],a=qs(r);a&&ne(n,"inventory",a)}s(Zo,"closeCharacterSheetPF2e");function ec(e,t,n){let r=n.find("> aside");r.css("position","relative"),r.append("<div id='pf2e-toobelt-inventory-item-details' class='hidden'></div>")}s(ec,"onRender");function qs(e){if(!e)return;let t=e.querySelector(".toolbelt-alternate");if(!t)return;let n=t.querySelector("[data-area='equipped']"),r=s(o=>n.querySelector(`[data-equipped-slot='${o}']`).querySelector("[data-item-id]")?.dataset.itemId??null,"equippedItemId"),a=s(o=>{let c={},l=o.querySelectorAll(":scope > [data-item-id]");for(let f=0;f<l.length;f++){let u=l[f];c[u.dataset.itemId]=f}return c},"itemIds"),i={};for(let o of t.querySelectorAll("[data-area='items-grid']")){let c=o.dataset.tabId;i[c]=a(o)}return{equipped:{hands:[r("left-hand"),r("right-hand")],armor:[r("armor")],others:a(n)},tabs:i}}s(qs,"getCurrentData");async function tc(e,t,n){let r=O(e,"inventory"),a=qs(n[0])??r??{equipped:{hands:[null,null],armor:[null],others:{}},tabs:{}};r||ie(t,"inventory.requireSave",!0);let i=new Collection,o={},c=new Set,l={hands:[null,null],armor:[null],others:[]};function f(p){let m=p?.id,y=i.get(m);return y||(y={id:m,item:p,parent:p?.container,containers:[],matrix:[],parents:[]},i.set(m,y),y)}s(f,"getTab");for(let p of e.inventory){if(p.isOfType("treasure")&&p.system.stackGroup==="coins"&&Qo.includes(p.slug))continue;let m=p.id,y=p.container,g=f(y),v=s(k=>{o[g.id]??=[],o[g.id].push(k)},"addOrphan");if(p.isOfType("backpack")){g.containers.push(p),c.add(p),f(p);continue}let S=p.handsHeld,E=l.hands.filter(Boolean).length;if(S===2&&E===0){a.equipped.hands[0]===m?l.hands=[p,p]:v(p);continue}if(S===1&&E<=1){let k=a.equipped.hands.indexOf(m);ft(k)?l.hands[k]=p:v(p);continue}if(!l.armor[0]&&p.isOfType("armor")&&p.isEquipped){a.equipped.armor[0]===m?l.armor[0]=p:v(p);continue}if((p.isOfType("equipment")||Dt(p))&&On(p)){let k=a.equipped.others[m];ft(k)?l.others[k]=p:v(p);continue}let x=a.tabs[g.id]?.[m];if(ft(x)){g.matrix[x]=p;continue}v(p)}for(let p of i){let m=o[p.id];if(m){for(let y of m){let g=y.handsHeld,v=l.hands.filter(Boolean).length;if(v===0&&g===2){l.hands=[y,y];continue}if(v<=1&&g===1){let S=l.hands[0]?1:0;l.hands[S]=y;continue}if(!l.armor[0]&&y.isOfType("armor")&&y.isEquipped){l.armor[0]=y;continue}if((y.isOfType("equipment")||Dt(y))&&On(y)){l.others.push(y);continue}p.matrix.push(y)}p.matrix=p.matrix.filter(Boolean)}}for(let p of i){let m=p.parent;for(;m;)p.parents.push(m),m=m.container;p.parents.reverse();let y=[p.containers,p.parents,p.item].flat();p.trailings=c.filter(g=>!y.includes(g))}i.size||f(void 0),l.others=l.others.filter(Boolean);let u=Z(t,"inventory.activeTab");return{tabs:Array.from(i.values()),equipped:l,actor:e,selectedTab:i.get(u)?.id,containerBulk:p=>{let m=p.capacity;return`${m.value.toString()} / ${m.max.toString()}`}}}s(tc,"getData");function nc(e,t,n,r){let a=e.find("[data-tab-id]");for(let c of e.find("[data-container-id]"))c.addEventListener("click",l=>{let f=c.dataset.containerId;a.removeClass("active"),a.filter(`[data-tab-id=${f}]`).addClass("active"),ie(t,"inventory.activeTab",f)});let i=r.find("#pf2e-toobelt-inventory-item-details")[0],o=e.find("[data-item-id], [data-container-id]");for(let c of o)c.addEventListener("mouseenter",l=>rc(l,n,c,i)),c.addEventListener("mouseleave",l=>{i.classList.add("hidden")});n.isOwner&&(Bn=randomID(),Ns({element:e[0],selector:"[data-item-id]",filter:"input",draggedClass:"dragged",ghostClass:"ghost",identifier:Bn,cursorImage:{id:"pf2e-toolbelt-inventory-cursor-image",img:c=>c.dataset.itemImg},createGhost:ic,onDragStart:()=>sc(i),onDragEnd:(c,l,f)=>ac(t,f),droppables:[fc(e,t),uc(e,t),lc(e,t),cc(e,t),oc(e,t)]}))}s(nc,"addEvents");async function rc(e,t,n,r){if(Gn)return;let a=n.dataset.details;if(!a){let i=_e(t,n);if(!i)return;a=await z("inventory/details",{item:i}),n.dataset.details=a}r.innerHTML=a,r.classList.remove("hidden")}s(rc,"onItemDetails");function sc(e){Gn=!0,e.classList.add("hidden")}s(sc,"onDragStart");function ac(e,{dropped:t,canceled:n}){Gn=!1,!(n||!t)&&ie(e,"inventory.requireSave",!0)}s(ac,"onDragEnd");function ic(e,t){return e.parentElement.dataset.area==="items-grid"?{element:e,index:t}:void 0}s(ic,"createGhost");function qt(e){return e.identifier===Bn?!0:(xe("inventory.identifier.error"),!1)}s(qt,"checkIdentifier");function oc(e,t){function n(a,i,o){if(o.element===i.element||o.element===i.ghost)return;let c=i.ghost,l=dt(o.element),f=c.index>=l?o.element:o.element.nextElementSibling;o.element.parentElement.insertBefore(c.element,f),c.index=l}s(n,"onDragEnter");function r(a,i,o){let c=o.element.parentElement;!c||tt(o.triggeringElement,c,{selector:"[data-item-id]"})||!c.parentElement.contains(o.triggeringElement)||(c.appendChild(i.ghost.element),i.ghost.index=1/0)}return s(r,"onDragLeave"),{element:e[0],selector:"[data-area='items-grid'] [data-item-id]",onDragEnter:n,onDragLeave:r}}s(oc,"itemsGridDroppable");function cc(e,t){let n=t.actor;function r(o,c,l){tt(l.triggeringElement,l.element,{selector:"[data-item-id]"})||l.element.querySelector("[data-area='items-grid']").appendChild(c.ghost.element)}s(r,"onDragEnter");function a(o,c,l){c.ghost.reset()}s(a,"onDragLeave");async function i(o,c,l){if(!qt(c))return!1;let f=_e(n,c);if(!f)return!1;let u=[];return c.element===c.ghost.element?(c.ghost.classList.purge(),Bs(c.element)):($e({html:e,updates:u,item:f,...c,target:c.ghost.element}),Vn(e,n),c.ghost.reset()),await n.updateEmbeddedDocuments("Item",u),!0}return s(i,"onDrop"),{element:e[0],selector:"[data-area='items-list']",onDragEnter:r,onDragLeave:a,onDrop:i}}s(cc,"itemsListDroppable");function lc(e,t){let n=t.actor,r=e.find("[data-equipped-slot=right-hand]")[0];function a(f,u){let p=u.element.dataset.equippedSlot;if(p===f.parent.dataset.equippedSlot||u.element.querySelector("[data-two-hands]"))return{canDrop:void 0};let m=_e(n,f);if(!m)return{canDrop:!1};let y=p==="armor"?m.isOfType("armor"):!0;return{item:m,slot:p,canDrop:y}}s(a,"getData");function i({updates:f,item:u,element:p,drop:m,noTwoHand:y=!1,noUpdate:g=!1}){let v=m instanceof HTMLElement?m:m.element,S=v.dataset.equippedSlot,E=p instanceof HTMLElement?p:p.element,x=ns(u),k=Tt(u),M=Tn(u);v.appendChild(E);let N=s((j,se,be,Y)=>{g||f.push(Ot(u,{carryType:j,handsHeld:se,inSlot:be,invested:Y,containerId:null})),E.classList.toggle("invested",M&&Y)},"move");if(S==="armor"){N("worn",0,!0,!0);return}if(S==="right-hand"){N("held",1,!1,x);return}N("held",k&&!y?2:1,!1,At(u)&&(!k||!y))}s(i,"moveItemToSlot");function o(f){let p=(f instanceof HTMLElement?f:f.element).querySelector("[data-item-id]"),m=_e(n,p);return{element:p,item:m}}s(o,"getSlottedItem");function c(f,u,p){let{canDrop:m}=a(u,p);m!==void 0&&(p.classList.toggle("valid",m),p.classList.toggle("invalid",!m))}s(c,"onDragEnter");async function l(f,u,p){if(!qt(u))return!1;let{item:m,canDrop:y,slot:g}=a(u,p);if(!y)return!1;let v=[],S=o(p),E=u.parent.dataset.area,x=u.parent.dataset.equippedSlot,k=Tt(m),M=!1;if(E==="equipped")S.item&&$e({html:e,updates:v,...S});else if(E==="items-grid"){if(g==="left-hand"&&k){let N=o(r);N.item&&$e({html:e,updates:v,...N})}S.item&&$e({html:e,updates:v,...S,target:u.element})}else g==="armor"?S.item&&i({updates:v,...S,drop:u.parent}):x==="armor"?S.item&&(S.item.isOfType("armor")?i({updates:v,...S,drop:u.parent}):$e({html:e,updates:v,...S})):g==="right-hand"?(M=!0,S.item&&i({updates:v,...S,drop:u.parent,noUpdate:!0,noTwoHand:!0})):S.item&&(k?$e({html:e,updates:v,...S}):(i({updates:v,...S,drop:u.parent,noUpdate:!0}),M=!0));return i({updates:v,item:m,element:u,drop:p,noUpdate:M}),(g==="left-hand"||x==="left-hand")&&Vn(e,n),await n.updateEmbeddedDocuments("Item",v),!0}return s(l,"onDrop"),{element:e.find("[data-area=equipped] .main-items")[0],selector:"[data-equipped-slot]",purgeOnLeave:!0,onDragEnter:c,onDrop:l}}s(lc,"largeEquipmentDroppable");function uc(e,t){let n=t.actor;function r(o,c){if(o.parent===c.element)return{canDrop:void 0};let l=_e(n,o);if(!l.isIdentified||!(l.isOfType("equipment")||Dt(l)))return{canDrop:!1};let f=Tn(l),u=ts(l);return!f&&!u?{canDrop:!1}:{canDrop:!0,item:l,canInvest:f}}s(r,"getData");function a(o,c,l){let{canDrop:f,canInvest:u}=r(c,l);f!==void 0&&(l.classList.add("show"),l.classList.toggle("add-forbidden",!f),l.classList.toggle("add-invest",f&&u),l.classList.toggle("add-equip",f&&!u))}s(a,"onDragEnter");async function i(o,c,l){if(!qt(c))return!1;let{canDrop:f,canInvest:u,item:p}=r(c,l);return f?(l.element.appendChild(c.element),c.element.classList.toggle("invested",u),await n.updateEmbeddedDocuments("Item",[Ot(p,{containerId:null,inSlot:!0,invested:!0})]),!0):!1}return s(i,"onDrop"),{element:e.find("[data-area=equipped]")[0],filter:".main-items",purgeOnLeave:!0,onDragEnter:a,onDrop:i}}s(uc,"otherEquipmentDroppable");function fc(e,t){let n=t.actor;function r(o,c){let l=_e(n,o);if(!l)return{canDrop:!1};let f=c.element.dataset.containerId;if(f==="undefined")return{item:l,canDrop:!0};let u=n.items.get(f);if(!u)return{canDrop:!1};let p=u.capacity,m=p.max.minus(p.value);return{item:l,container:u,canDrop:m.value>=l.bulk.value}}s(r,"getData");function a(o,c,l){let{canDrop:f}=r(c,l);l.classList.toggle("valid",f),l.classList.toggle("invalid",!f)}s(a,"onDragEnter");async function i(o,c,l){if(!qt(c))return!1;let{canDrop:f,item:u,container:p}=r(c,l);if(!f)return!1;let m=$e({html:e,updates:[],item:u,element:c,target:p});return c.parent.dataset.equippedSlot==="left-hand"&&Vn(e,n),await n.updateEmbeddedDocuments("Item",m),!0}return s(i,"onDrop"),{element:e[0],selector:"[data-container-id]",filter:".back",purgeOnLeave:!0,onDragEnter:a,onDrop:i}}s(fc,"containersDroppable");function Bs(e){e.classList.remove("invested"),e.querySelector(".vignette.hands")?.remove()}s(Bs,"cleanContainerItem");function $e({html:e,updates:t,item:n,element:r,target:a}){let i=a instanceof HTMLElement,o=r instanceof HTMLElement?r:r.element,c=i?a.closest("[data-tab-id]").dataset.tabId:a instanceof Item?a.id:a;return Bs(o),i?a.before(o):e.find(`.container-tab[data-tab-id=${c}] [data-area=items-grid]`).append(o),c=[void 0,"undefined"].includes(c)?null:c,t.push(Ot(n,{containerId:c,inSlot:!1,invested:!1,carryType:c?"stowed":"worn",handsHeld:0})),t}s($e,"moveItemToContainer");function Vn(e,t){let n=e.find("[data-area='equipped'] .main-items")[0],r=n.querySelector("[data-equipped-slot='left-hand']"),a=n.querySelector("[data-equipped-slot='right-hand']"),i=r.querySelector("[data-item-id]"),o=a.querySelector(".item:not(.fake)"),c=_e(t,i),l=!!c&&Tt(c);if(!l&&o?.dataset.twoHands)o.remove();else if(l&&!o){let f=i.cloneNode(!0);f.dataset.twoHands="true",a.appendChild(f)}}s(Vn,"checkForTwoHandedSlots");function _e(e,t){if(!t)return;let n=t instanceof HTMLElement?t:t.element,{itemId:r,containerId:a}=n.dataset,i=r??a;if(i)return e.items.get(i)}s(_e,"getItemFromElement");var Gs=F("knowledges.editLore"),Bt=class extends FormApplication{static{s(this,"EditLores")}get actor(){return this.object}get id(){return`npc-edit-lores-${this.actor.id}`}get title(){return Gs("title",this.actor)}get template(){return de("knowledges/lores")}getData(t){let n=this.actor;return mergeObject(super.getData(t),{unspecified:O(n,"knowledges.unspecified")??"",specific:O(n,"knowledges.specific")??"",i18n:Gs.template})}async _updateObject(t,{unspecified:n,specific:r}){let a=this.object;ne(a,"knowledges.unspecified",n.trim()),ne(a,"knowledges.specific",r.trim())}activateListeners(t){t.find("button.cancel").on("click",this.#e.bind(this))}#e(t){t.preventDefault(),this.close()}};var Wn={name:"knowledges",settings:[{key:"knowledges",type:Boolean,default:!1,onChange:e=>zs(e)}],hooks:[["renderNPCSheetPF2e",pc]],conflicts:["pf2e-npc-knowledges"],ready:oe(zs,"knowledges")},{setHook:dc}=B(Wn);function zs(e){dc(e),Se("npc")}s(zs,"setup");function pc(e,t){let n=e.actor;fe(n)&&(gc(n,t),yc(t),hc(n,t))}s(pc,"renderNPCSheetPF2e");function Kn(e,t,n){return e.find(`[data-tab="main"] .recall-knowledge ${t==="header"?".section-header":".section-body"} ${n}`)}s(Kn,"knowledgeSelector");function mc(e){new Bt(e).render(!0)}s(mc,"editLores");function gc(e,t){let n=O(e,"knowledges.unspecified"),r=O(e,"knowledges.specific");if(!n&&!r)return;let a=e.identificationDCs.lore,i=Kn(t,"body","");i.find(".identification-skills").last().remove();function o(l,f,u){return`<div class="tag-legacy identification-skills tooltipstered">${game.i18n.format("PF2E.Actor.NPC.Identification.Skills.Label",{skills:l,dc:f,adjustment:u})}</div>`}s(o,"tag");function c(l,{dc:f,start:u}){let p=l.split(",").filter(m=>m.trim()).map(m=>o(m,f,u)).join("");i.append(p)}s(c,"addTags"),c(n||"Unspecific",a[0]),c(r||"Specific",a[1])}s(gc,"replaceLores");function hc(e,t){Kn(t,"header","button.edit").on("click",()=>mc(e))}s(hc,"addEvents");function yc(e){let t=Kn(e,"header","button"),n='<button type="button" class="breakdown edit">Edit</button>';t.before(n)}s(yc,"addEditButton");var De;(function(e){e.Range="range",e.Steps="steps",e.Positions="positions",e.Count="count",e.Values="values"})(De||(De={}));var le;(function(e){e[e.None=-1]="None",e[e.NoValue=0]="NoValue",e[e.LargeValue=1]="LargeValue",e[e.SmallValue=2]="SmallValue"})(le||(le={}));function vc(e){return zt(e)&&typeof e.from=="function"}s(vc,"isValidFormatter");function zt(e){return typeof e=="object"&&typeof e.to=="function"}s(zt,"isValidPartialFormatter");function Vs(e){e.parentElement.removeChild(e)}s(Vs,"removeElement");function Yn(e){return e!=null}s(Yn,"isSet");function Ws(e){e.preventDefault()}s(Ws,"preventDefault");function bc(e){return e.filter(function(t){return this[t]?!1:this[t]=!0},{})}s(bc,"unique");function Sc(e,t){return Math.round(e/t)*t}s(Sc,"closest");function wc(e,t){var n=e.getBoundingClientRect(),r=e.ownerDocument,a=r.documentElement,i=Xs(r);return/webkit.*Chrome.*Mobile/i.test(navigator.userAgent)&&(i.x=0),t?n.top+i.y-a.clientTop:n.left+i.x-a.clientLeft}s(wc,"offset");function ve(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}s(ve,"isNumeric");function Ks(e,t,n){n>0&&(ce(e,t),setTimeout(function(){Gt(e,t)},n))}s(Ks,"addClassFor");function Ys(e){return Math.max(Math.min(e,100),0)}s(Ys,"limit");function Vt(e){return Array.isArray(e)?e:[e]}s(Vt,"asArray");function Ec(e){e=String(e);var t=e.split(".");return t.length>1?t[1].length:0}s(Ec,"countDecimals");function ce(e,t){e.classList&&!/\s/.test(t)?e.classList.add(t):e.className+=" "+t}s(ce,"addClass");function Gt(e,t){e.classList&&!/\s/.test(t)?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t.split(" ").join("|")+"(\\b|$)","gi")," ")}s(Gt,"removeClass");function xc(e,t){return e.classList?e.classList.contains(t):new RegExp("\\b"+t+"\\b").test(e.className)}s(xc,"hasClass");function Xs(e){var t=window.pageXOffset!==void 0,n=(e.compatMode||"")==="CSS1Compat",r=t?window.pageXOffset:n?e.documentElement.scrollLeft:e.body.scrollLeft,a=t?window.pageYOffset:n?e.documentElement.scrollTop:e.body.scrollTop;return{x:r,y:a}}s(Xs,"getPageOffset");function kc(){return window.navigator.pointerEnabled?{start:"pointerdown",move:"pointermove",end:"pointerup"}:window.navigator.msPointerEnabled?{start:"MSPointerDown",move:"MSPointerMove",end:"MSPointerUp"}:{start:"mousedown touchstart",move:"mousemove touchmove",end:"mouseup touchend"}}s(kc,"getActions");function Cc(){var e=!1;try{var t=Object.defineProperty({},"passive",{get:function(){e=!0}});window.addEventListener("test",null,t)}catch{}return e}s(Cc,"getSupportsPassive");function Ic(){return window.CSS&&CSS.supports&&CSS.supports("touch-action","none")}s(Ic,"getSupportsTouchActionNone");function Xn(e,t){return 100/(t-e)}s(Xn,"subRangeRatio");function Jn(e,t,n){return t*100/(e[n+1]-e[n])}s(Jn,"fromPercentage");function Ac(e,t){return Jn(e,e[0]<0?t+Math.abs(e[0]):t-e[0],0)}s(Ac,"toPercentage");function Tc(e,t){return t*(e[1]-e[0])/100+e[0]}s(Tc,"isPercentage");function nt(e,t){for(var n=1;e>=t[n];)n+=1;return n}s(nt,"getJ");function Oc(e,t,n){if(n>=e.slice(-1)[0])return 100;var r=nt(n,e),a=e[r-1],i=e[r],o=t[r-1],c=t[r];return o+Ac([a,i],n)/Xn(o,c)}s(Oc,"toStepping");function Dc(e,t,n){if(n>=100)return e.slice(-1)[0];var r=nt(n,t),a=e[r-1],i=e[r],o=t[r-1],c=t[r];return Tc([a,i],(n-o)*Xn(o,c))}s(Dc,"fromStepping");function Pc(e,t,n,r){if(r===100)return r;var a=nt(r,e),i=e[a-1],o=e[a];return n?r-i>(o-i)/2?o:i:t[a-1]?e[a-1]+Sc(r-e[a-1],t[a-1]):r}s(Pc,"getStep");var Qs=function(){function e(t,n,r){this.xPct=[],this.xVal=[],this.xSteps=[],this.xNumSteps=[],this.xHighestCompleteStep=[],this.xSteps=[r||!1],this.xNumSteps=[!1],this.snap=n;var a,i=[];for(Object.keys(t).forEach(function(o){i.push([Vt(t[o]),o])}),i.sort(function(o,c){return o[0][0]-c[0][0]}),a=0;a<i.length;a++)this.handleEntryPoint(i[a][1],i[a][0]);for(this.xNumSteps=this.xSteps.slice(0),a=0;a<this.xNumSteps.length;a++)this.handleStepPoint(a,this.xNumSteps[a])}return s(e,"Spectrum"),e.prototype.getDistance=function(t){for(var n=[],r=0;r<this.xNumSteps.length-1;r++)n[r]=Jn(this.xVal,t,r);return n},e.prototype.getAbsoluteDistance=function(t,n,r){var a=0;if(t<this.xPct[this.xPct.length-1])for(;t>this.xPct[a+1];)a++;else t===this.xPct[this.xPct.length-1]&&(a=this.xPct.length-2);!r&&t===this.xPct[a+1]&&a++,n===null&&(n=[]);var i,o=1,c=n[a],l=0,f=0,u=0,p=0;for(r?i=(t-this.xPct[a])/(this.xPct[a+1]-this.xPct[a]):i=(this.xPct[a+1]-t)/(this.xPct[a+1]-this.xPct[a]);c>0;)l=this.xPct[a+1+p]-this.xPct[a+p],n[a+p]*o+100-i*100>100?(f=l*i,o=(c-100*i)/n[a+p],i=1):(f=n[a+p]*l/100*o,o=0),r?(u=u-f,this.xPct.length+p>=1&&p--):(u=u+f,this.xPct.length-p>=1&&p++),c=n[a+p]*o;return t+u},e.prototype.toStepping=function(t){return t=Oc(this.xVal,this.xPct,t),t},e.prototype.fromStepping=function(t){return Dc(this.xVal,this.xPct,t)},e.prototype.getStep=function(t){return t=Pc(this.xPct,this.xSteps,this.snap,t),t},e.prototype.getDefaultStep=function(t,n,r){var a=nt(t,this.xPct);return(t===100||n&&t===this.xPct[a-1])&&(a=Math.max(a-1,1)),(this.xVal[a]-this.xVal[a-1])/r},e.prototype.getNearbySteps=function(t){var n=nt(t,this.xPct);return{stepBefore:{startValue:this.xVal[n-2],step:this.xNumSteps[n-2],highestStep:this.xHighestCompleteStep[n-2]},thisStep:{startValue:this.xVal[n-1],step:this.xNumSteps[n-1],highestStep:this.xHighestCompleteStep[n-1]},stepAfter:{startValue:this.xVal[n],step:this.xNumSteps[n],highestStep:this.xHighestCompleteStep[n]}}},e.prototype.countStepDecimals=function(){var t=this.xNumSteps.map(Ec);return Math.max.apply(null,t)},e.prototype.hasNoSize=function(){return this.xVal[0]===this.xVal[this.xVal.length-1]},e.prototype.convert=function(t){return this.getStep(this.toStepping(t))},e.prototype.handleEntryPoint=function(t,n){var r;if(t==="min"?r=0:t==="max"?r=100:r=parseFloat(t),!ve(r)||!ve(n[0]))throw new Error("noUiSlider: 'range' value isn't numeric.");this.xPct.push(r),this.xVal.push(n[0]);var a=Number(n[1]);r?this.xSteps.push(isNaN(a)?!1:a):isNaN(a)||(this.xSteps[0]=a),this.xHighestCompleteStep.push(0)},e.prototype.handleStepPoint=function(t,n){if(n){if(this.xVal[t]===this.xVal[t+1]){this.xSteps[t]=this.xHighestCompleteStep[t]=this.xVal[t];return}this.xSteps[t]=Jn([this.xVal[t],this.xVal[t+1]],n,0)/Xn(this.xPct[t],this.xPct[t+1]);var r=(this.xVal[t+1]-this.xVal[t])/this.xNumSteps[t],a=Math.ceil(Number(r.toFixed(3))-1),i=this.xVal[t]+this.xNumSteps[t]*a;this.xHighestCompleteStep[t]=i}},e}(),Js={to:function(e){return e===void 0?"":e.toFixed(2)},from:Number},Zs={target:"target",base:"base",origin:"origin",handle:"handle",handleLower:"handle-lower",handleUpper:"handle-upper",touchArea:"touch-area",horizontal:"horizontal",vertical:"vertical",background:"background",connect:"connect",connects:"connects",ltr:"ltr",rtl:"rtl",textDirectionLtr:"txt-dir-ltr",textDirectionRtl:"txt-dir-rtl",draggable:"draggable",drag:"state-drag",tap:"state-tap",active:"active",tooltip:"tooltip",pips:"pips",pipsHorizontal:"pips-horizontal",pipsVertical:"pips-vertical",marker:"marker",markerHorizontal:"marker-horizontal",markerVertical:"marker-vertical",markerNormal:"marker-normal",markerLarge:"marker-large",markerSub:"marker-sub",value:"value",valueHorizontal:"value-horizontal",valueVertical:"value-vertical",valueNormal:"value-normal",valueLarge:"value-large",valueSub:"value-sub"},Oe={tooltips:".__tooltips",aria:".__aria"};function Mc(e,t){if(!ve(t))throw new Error("noUiSlider: 'step' is not numeric.");e.singleStep=t}s(Mc,"testStep");function Rc(e,t){if(!ve(t))throw new Error("noUiSlider: 'keyboardPageMultiplier' is not numeric.");e.keyboardPageMultiplier=t}s(Rc,"testKeyboardPageMultiplier");function Lc(e,t){if(!ve(t))throw new Error("noUiSlider: 'keyboardMultiplier' is not numeric.");e.keyboardMultiplier=t}s(Lc,"testKeyboardMultiplier");function Fc(e,t){if(!ve(t))throw new Error("noUiSlider: 'keyboardDefaultStep' is not numeric.");e.keyboardDefaultStep=t}s(Fc,"testKeyboardDefaultStep");function Nc(e,t){if(typeof t!="object"||Array.isArray(t))throw new Error("noUiSlider: 'range' is not an object.");if(t.min===void 0||t.max===void 0)throw new Error("noUiSlider: Missing 'min' or 'max' in 'range'.");e.spectrum=new Qs(t,e.snap||!1,e.singleStep)}s(Nc,"testRange");function $c(e,t){if(t=Vt(t),!Array.isArray(t)||!t.length)throw new Error("noUiSlider: 'start' option is incorrect.");e.handles=t.length,e.start=t}s($c,"testStart");function _c(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'snap' option must be a boolean.");e.snap=t}s(_c,"testSnap");function Hc(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'animate' option must be a boolean.");e.animate=t}s(Hc,"testAnimate");function jc(e,t){if(typeof t!="number")throw new Error("noUiSlider: 'animationDuration' option must be a number.");e.animationDuration=t}s(jc,"testAnimationDuration");function Uc(e,t){var n=[!1],r;if(t==="lower"?t=[!0,!1]:t==="upper"&&(t=[!1,!0]),t===!0||t===!1){for(r=1;r<e.handles;r++)n.push(t);n.push(!1)}else{if(!Array.isArray(t)||!t.length||t.length!==e.handles+1)throw new Error("noUiSlider: 'connect' option doesn't match handle count.");n=t}e.connect=n}s(Uc,"testConnect");function qc(e,t){switch(t){case"horizontal":e.ort=0;break;case"vertical":e.ort=1;break;default:throw new Error("noUiSlider: 'orientation' option is invalid.")}}s(qc,"testOrientation");function ea(e,t){if(!ve(t))throw new Error("noUiSlider: 'margin' option must be numeric.");t!==0&&(e.margin=e.spectrum.getDistance(t))}s(ea,"testMargin");function Bc(e,t){if(!ve(t))throw new Error("noUiSlider: 'limit' option must be numeric.");if(e.limit=e.spectrum.getDistance(t),!e.limit||e.handles<2)throw new Error("noUiSlider: 'limit' option is only supported on linear sliders with 2 or more handles.")}s(Bc,"testLimit");function Gc(e,t){var n;if(!ve(t)&&!Array.isArray(t))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(Array.isArray(t)&&!(t.length===2||ve(t[0])||ve(t[1])))throw new Error("noUiSlider: 'padding' option must be numeric or array of exactly 2 numbers.");if(t!==0){for(Array.isArray(t)||(t=[t,t]),e.padding=[e.spectrum.getDistance(t[0]),e.spectrum.getDistance(t[1])],n=0;n<e.spectrum.xNumSteps.length-1;n++)if(e.padding[0][n]<0||e.padding[1][n]<0)throw new Error("noUiSlider: 'padding' option must be a positive number(s).");var r=t[0]+t[1],a=e.spectrum.xVal[0],i=e.spectrum.xVal[e.spectrum.xVal.length-1];if(r/(i-a)>1)throw new Error("noUiSlider: 'padding' option must not exceed 100% of the range.")}}s(Gc,"testPadding");function zc(e,t){switch(t){case"ltr":e.dir=0;break;case"rtl":e.dir=1;break;default:throw new Error("noUiSlider: 'direction' option was not recognized.")}}s(zc,"testDirection");function Vc(e,t){if(typeof t!="string")throw new Error("noUiSlider: 'behaviour' must be a string containing options.");var n=t.indexOf("tap")>=0,r=t.indexOf("drag")>=0,a=t.indexOf("fixed")>=0,i=t.indexOf("snap")>=0,o=t.indexOf("hover")>=0,c=t.indexOf("unconstrained")>=0,l=t.indexOf("drag-all")>=0,f=t.indexOf("smooth-steps")>=0;if(a){if(e.handles!==2)throw new Error("noUiSlider: 'fixed' behaviour must be used with 2 handles");ea(e,e.start[1]-e.start[0])}if(c&&(e.margin||e.limit))throw new Error("noUiSlider: 'unconstrained' behaviour cannot be used with margin or limit");e.events={tap:n||i,drag:r,dragAll:l,smoothSteps:f,fixed:a,snap:i,hover:o,unconstrained:c}}s(Vc,"testBehaviour");function Wc(e,t){if(t!==!1)if(t===!0||zt(t)){e.tooltips=[];for(var n=0;n<e.handles;n++)e.tooltips.push(t)}else{if(t=Vt(t),t.length!==e.handles)throw new Error("noUiSlider: must pass a formatter for all handles.");t.forEach(function(r){if(typeof r!="boolean"&&!zt(r))throw new Error("noUiSlider: 'tooltips' must be passed a formatter or 'false'.")}),e.tooltips=t}}s(Wc,"testTooltips");function Kc(e,t){if(t.length!==e.handles)throw new Error("noUiSlider: must pass a attributes for all handles.");e.handleAttributes=t}s(Kc,"testHandleAttributes");function Yc(e,t){if(!zt(t))throw new Error("noUiSlider: 'ariaFormat' requires 'to' method.");e.ariaFormat=t}s(Yc,"testAriaFormat");function Jc(e,t){if(!vc(t))throw new Error("noUiSlider: 'format' requires 'to' and 'from' methods.");e.format=t}s(Jc,"testFormat");function Xc(e,t){if(typeof t!="boolean")throw new Error("noUiSlider: 'keyboardSupport' option must be a boolean.");e.keyboardSupport=t}s(Xc,"testKeyboardSupport");function Qc(e,t){e.documentElement=t}s(Qc,"testDocumentElement");function Zc(e,t){if(typeof t!="string"&&t!==!1)throw new Error("noUiSlider: 'cssPrefix' must be a string or `false`.");e.cssPrefix=t}s(Zc,"testCssPrefix");function el(e,t){if(typeof t!="object")throw new Error("noUiSlider: 'cssClasses' must be an object.");typeof e.cssPrefix=="string"?(e.cssClasses={},Object.keys(t).forEach(function(n){e.cssClasses[n]=e.cssPrefix+t[n]})):e.cssClasses=t}s(el,"testCssClasses");function ta(e){var t={margin:null,limit:null,padding:null,animate:!0,animationDuration:300,ariaFormat:Js,format:Js},n={step:{r:!1,t:Mc},keyboardPageMultiplier:{r:!1,t:Rc},keyboardMultiplier:{r:!1,t:Lc},keyboardDefaultStep:{r:!1,t:Fc},start:{r:!0,t:$c},connect:{r:!0,t:Uc},direction:{r:!0,t:zc},snap:{r:!1,t:_c},animate:{r:!1,t:Hc},animationDuration:{r:!1,t:jc},range:{r:!0,t:Nc},orientation:{r:!1,t:qc},margin:{r:!1,t:ea},limit:{r:!1,t:Bc},padding:{r:!1,t:Gc},behaviour:{r:!0,t:Vc},ariaFormat:{r:!1,t:Yc},format:{r:!1,t:Jc},tooltips:{r:!1,t:Wc},keyboardSupport:{r:!0,t:Xc},documentElement:{r:!1,t:Qc},cssPrefix:{r:!0,t:Zc},cssClasses:{r:!0,t:el},handleAttributes:{r:!1,t:Kc}},r={connect:!1,direction:"ltr",behaviour:"tap",orientation:"horizontal",keyboardSupport:!0,cssPrefix:"noUi-",cssClasses:Zs,keyboardPageMultiplier:5,keyboardMultiplier:1,keyboardDefaultStep:10};e.format&&!e.ariaFormat&&(e.ariaFormat=e.format),Object.keys(n).forEach(function(l){if(!Yn(e[l])&&r[l]===void 0){if(n[l].r)throw new Error("noUiSlider: '"+l+"' is required.");return}n[l].t(t,Yn(e[l])?e[l]:r[l])}),t.pips=e.pips;var a=document.createElement("div"),i=a.style.msTransform!==void 0,o=a.style.transform!==void 0;t.transformRule=o?"transform":i?"msTransform":"webkitTransform";var c=[["left","top"],["right","bottom"]];return t.style=c[t.dir][t.ort],t}s(ta,"testOptions");function tl(e,t,n){var r=kc(),a=Ic(),i=a&&Cc(),o=e,c,l,f,u,p,m=t.spectrum,y=[],g=[],v=[],S=0,E={},x=e.ownerDocument,k=t.documentElement||x.documentElement,M=x.body,N=x.dir==="rtl"||t.ort===1?0:100;function j(d,h){var b=x.createElement("div");return h&&ce(b,h),d.appendChild(b),b}s(j,"addNodeTo");function se(d,h){var b=j(d,t.cssClasses.origin),w=j(b,t.cssClasses.handle);if(j(w,t.cssClasses.touchArea),w.setAttribute("data-handle",String(h)),t.keyboardSupport&&(w.setAttribute("tabindex","0"),w.addEventListener("keydown",function(C){return ai(C,h)})),t.handleAttributes!==void 0){var I=t.handleAttributes[h];Object.keys(I).forEach(function(C){w.setAttribute(C,I[C])})}return w.setAttribute("role","slider"),w.setAttribute("aria-orientation",t.ort?"vertical":"horizontal"),h===0?ce(w,t.cssClasses.handleLower):h===t.handles-1&&ce(w,t.cssClasses.handleUpper),b.handle=w,b}s(se,"addOrigin");function be(d,h){return h?j(d,t.cssClasses.connect):!1}s(be,"addConnect");function Y(d,h){var b=j(h,t.cssClasses.connects);l=[],f=[],f.push(be(b,d[0]));for(var w=0;w<t.handles;w++)l.push(se(h,w)),v[w]=w,f.push(be(b,d[w+1]))}s(Y,"addElements");function pe(d){ce(d,t.cssClasses.target),t.dir===0?ce(d,t.cssClasses.ltr):ce(d,t.cssClasses.rtl),t.ort===0?ce(d,t.cssClasses.horizontal):ce(d,t.cssClasses.vertical);var h=getComputedStyle(d).direction;return h==="rtl"?ce(d,t.cssClasses.textDirectionRtl):ce(d,t.cssClasses.textDirectionLtr),j(d,t.cssClasses.base)}s(pe,"addSlider");function X(d,h){return!t.tooltips||!t.tooltips[h]?!1:j(d.firstChild,t.cssClasses.tooltip)}s(X,"addTooltip");function ge(){return o.hasAttribute("disabled")}s(ge,"isSliderDisabled");function ke(d){var h=l[d];return h.hasAttribute("disabled")}s(ke,"isHandleDisabled");function je(d){d!=null?(l[d].setAttribute("disabled",""),l[d].handle.removeAttribute("tabindex")):(o.setAttribute("disabled",""),l.forEach(function(h){h.handle.removeAttribute("tabindex")}))}s(je,"disable");function Ve(d){d!=null?(l[d].removeAttribute("disabled"),l[d].handle.setAttribute("tabindex","0")):(o.removeAttribute("disabled"),l.forEach(function(h){h.removeAttribute("disabled"),h.handle.setAttribute("tabindex","0")}))}s(Ve,"enable");function he(){p&&(We("update"+Oe.tooltips),p.forEach(function(d){d&&Vs(d)}),p=null)}s(he,"removeTooltips");function it(){he(),p=l.map(X),cn("update"+Oe.tooltips,function(d,h,b){if(!(!p||!t.tooltips)&&p[h]!==!1){var w=d[h];t.tooltips[h]!==!0&&(w=t.tooltips[h].to(b[h])),p[h].innerHTML=w}})}s(it,"tooltips");function tn(){We("update"+Oe.aria),cn("update"+Oe.aria,function(d,h,b,w,I){v.forEach(function(C){var D=l[C],A=ct(g,C,0,!0,!0,!0),G=ct(g,C,100,!0,!0,!0),U=I[C],W=String(t.ariaFormat.to(b[C]));A=m.fromStepping(A).toFixed(1),G=m.fromStepping(G).toFixed(1),U=m.fromStepping(U).toFixed(1),D.children[0].setAttribute("aria-valuemin",A),D.children[0].setAttribute("aria-valuemax",G),D.children[0].setAttribute("aria-valuenow",U),D.children[0].setAttribute("aria-valuetext",W)})})}s(tn,"aria");function nn(d){if(d.mode===De.Range||d.mode===De.Steps)return m.xVal;if(d.mode===De.Count){if(d.values<2)throw new Error("noUiSlider: 'values' (>= 2) required for mode 'count'.");for(var h=d.values-1,b=100/h,w=[];h--;)w[h]=h*b;return w.push(100),ot(w,d.stepped)}return d.mode===De.Positions?ot(d.values,d.stepped):d.mode===De.Values?d.stepped?d.values.map(function(I){return m.fromStepping(m.getStep(m.toStepping(I)))}):d.values:[]}s(nn,"getGroup");function ot(d,h){return d.map(function(b){return m.fromStepping(h?m.getStep(b):b)})}s(ot,"mapToRange");function Xa(d){function h(U,W){return Number((U+W).toFixed(7))}s(h,"safeIncrement");var b=nn(d),w={},I=m.xVal[0],C=m.xVal[m.xVal.length-1],D=!1,A=!1,G=0;return b=bc(b.slice().sort(function(U,W){return U-W})),b[0]!==I&&(b.unshift(I),D=!0),b[b.length-1]!==C&&(b.push(C),A=!0),b.forEach(function(U,W){var K,_,Q,ae=U,ee=b[W+1],te,fn,dn,pn,Ar,mn,Tr,Or=d.mode===De.Steps;for(Or&&(K=m.xNumSteps[W]),K||(K=ee-ae),ee===void 0&&(ee=ae),K=Math.max(K,1e-7),_=ae;_<=ee;_=h(_,K)){for(te=m.toStepping(_),fn=te-G,Ar=fn/(d.density||1),mn=Math.round(Ar),Tr=fn/mn,Q=1;Q<=mn;Q+=1)dn=G+Q*Tr,w[dn.toFixed(5)]=[m.fromStepping(dn),0];pn=b.indexOf(_)>-1?le.LargeValue:Or?le.SmallValue:le.NoValue,!W&&D&&_!==ee&&(pn=0),_===ee&&A||(w[te.toFixed(5)]=[_,pn]),G=te}}),w}s(Xa,"generateSpread");function Qa(d,h,b){var w,I,C=x.createElement("div"),D=(w={},w[le.None]="",w[le.NoValue]=t.cssClasses.valueNormal,w[le.LargeValue]=t.cssClasses.valueLarge,w[le.SmallValue]=t.cssClasses.valueSub,w),A=(I={},I[le.None]="",I[le.NoValue]=t.cssClasses.markerNormal,I[le.LargeValue]=t.cssClasses.markerLarge,I[le.SmallValue]=t.cssClasses.markerSub,I),G=[t.cssClasses.valueHorizontal,t.cssClasses.valueVertical],U=[t.cssClasses.markerHorizontal,t.cssClasses.markerVertical];ce(C,t.cssClasses.pips),ce(C,t.ort===0?t.cssClasses.pipsHorizontal:t.cssClasses.pipsVertical);function W(_,Q){var ae=Q===t.cssClasses.value,ee=ae?G:U,te=ae?D:A;return Q+" "+ee[t.ort]+" "+te[_]}s(W,"getClasses");function K(_,Q,ae){if(ae=h?h(Q,ae):ae,ae!==le.None){var ee=j(C,!1);ee.className=W(ae,t.cssClasses.marker),ee.style[t.style]=_+"%",ae>le.NoValue&&(ee=j(C,!1),ee.className=W(ae,t.cssClasses.value),ee.setAttribute("data-value",String(Q)),ee.style[t.style]=_+"%",ee.innerHTML=String(b.to(Q)))}}return s(K,"addSpread"),Object.keys(d).forEach(function(_){K(_,d[_][0],d[_][1])}),C}s(Qa,"addMarking");function rn(){u&&(Vs(u),u=null)}s(rn,"removePips");function sn(d){rn();var h=Xa(d),b=d.filter,w=d.format||{to:function(I){return String(Math.round(I))}};return u=o.appendChild(Qa(h,b,w)),u}s(sn,"pips");function br(){var d=c.getBoundingClientRect(),h="offset"+["Width","Height"][t.ort];return t.ort===0?d.width||c[h]:d.height||c[h]}s(br,"baseSize");function Me(d,h,b,w){var I=s(function(D){var A=Za(D,w.pageOffset,w.target||h);if(!A||ge()&&!w.doNotReject||xc(o,t.cssClasses.tap)&&!w.doNotReject||d===r.start&&A.buttons!==void 0&&A.buttons>1||w.hover&&A.buttons)return!1;i||A.preventDefault(),A.calcPoint=A.points[t.ort],b(A,w)},"method"),C=[];return d.split(" ").forEach(function(D){h.addEventListener(D,I,i?{passive:!0}:!1),C.push([D,I])}),C}s(Me,"attachEvent");function Za(d,h,b){var w=d.type.indexOf("touch")===0,I=d.type.indexOf("mouse")===0,C=d.type.indexOf("pointer")===0,D=0,A=0;if(d.type.indexOf("MSPointer")===0&&(C=!0),d.type==="mousedown"&&!d.buttons&&!d.touches)return!1;if(w){var G=s(function(K){var _=K.target;return _===b||b.contains(_)||d.composed&&d.composedPath().shift()===b},"isTouchOnTarget");if(d.type==="touchstart"){var U=Array.prototype.filter.call(d.touches,G);if(U.length>1)return!1;D=U[0].pageX,A=U[0].pageY}else{var W=Array.prototype.find.call(d.changedTouches,G);if(!W)return!1;D=W.pageX,A=W.pageY}}return h=h||Xs(x),(I||C)&&(D=d.clientX+h.x,A=d.clientY+h.y),d.pageOffset=h,d.points=[D,A],d.cursor=I||C,d}s(Za,"fixEvent");function Sr(d){var h=d-wc(c,t.ort),b=h*100/br();return b=Ys(b),t.dir?100-b:b}s(Sr,"calcPointToPercentage");function ei(d){var h=100,b=!1;return l.forEach(function(w,I){if(!ke(I)){var C=g[I],D=Math.abs(C-d),A=D===100&&h===100,G=D<h,U=D<=h&&d>C;(G||U||A)&&(b=I,h=D)}}),b}s(ei,"getClosestHandle");function ti(d,h){d.type==="mouseout"&&d.target.nodeName==="HTML"&&d.relatedTarget===null&&an(d,h)}s(ti,"documentLeave");function ni(d,h){if(navigator.appVersion.indexOf("MSIE 9")===-1&&d.buttons===0&&h.buttonsProperty!==0)return an(d,h);var b=(t.dir?-1:1)*(d.calcPoint-h.startCalcPoint),w=b*100/h.baseSize;wr(b>0,w,h.locations,h.handleNumbers,h.connect)}s(ni,"eventMove");function an(d,h){h.handle&&(Gt(h.handle,t.cssClasses.active),S-=1),h.listeners.forEach(function(b){k.removeEventListener(b[0],b[1])}),S===0&&(Gt(o,t.cssClasses.drag),un(),d.cursor&&(M.style.cursor="",M.removeEventListener("selectstart",Ws))),t.events.smoothSteps&&(h.handleNumbers.forEach(function(b){Re(b,g[b],!0,!0,!1,!1)}),h.handleNumbers.forEach(function(b){J("update",b)})),h.handleNumbers.forEach(function(b){J("change",b),J("set",b),J("end",b)})}s(an,"eventEnd");function on(d,h){if(!h.handleNumbers.some(ke)){var b;if(h.handleNumbers.length===1){var w=l[h.handleNumbers[0]];b=w.children[0],S+=1,ce(b,t.cssClasses.active)}d.stopPropagation();var I=[],C=Me(r.move,k,ni,{target:d.target,handle:b,connect:h.connect,listeners:I,startCalcPoint:d.calcPoint,baseSize:br(),pageOffset:d.pageOffset,handleNumbers:h.handleNumbers,buttonsProperty:d.buttons,locations:g.slice()}),D=Me(r.end,k,an,{target:d.target,handle:b,listeners:I,doNotReject:!0,handleNumbers:h.handleNumbers}),A=Me("mouseout",k,ti,{target:d.target,handle:b,listeners:I,doNotReject:!0,handleNumbers:h.handleNumbers});I.push.apply(I,C.concat(D,A)),d.cursor&&(M.style.cursor=getComputedStyle(d.target).cursor,l.length>1&&ce(o,t.cssClasses.drag),M.addEventListener("selectstart",Ws,!1)),h.handleNumbers.forEach(function(G){J("start",G)})}}s(on,"eventStart");function ri(d){d.stopPropagation();var h=Sr(d.calcPoint),b=ei(h);b!==!1&&(t.events.snap||Ks(o,t.cssClasses.tap,t.animationDuration),Re(b,h,!0,!0),un(),J("slide",b,!0),J("update",b,!0),t.events.snap?on(d,{handleNumbers:[b]}):(J("change",b,!0),J("set",b,!0)))}s(ri,"eventTap");function si(d){var h=Sr(d.calcPoint),b=m.getStep(h),w=m.fromStepping(b);Object.keys(E).forEach(function(I){I.split(".")[0]==="hover"&&E[I].forEach(function(C){C.call(ut,w)})})}s(si,"eventHover");function ai(d,h){if(ge()||ke(h))return!1;var b=["Left","Right"],w=["Down","Up"],I=["PageDown","PageUp"],C=["Home","End"];t.dir&&!t.ort?b.reverse():t.ort&&!t.dir&&(w.reverse(),I.reverse());var D=d.key.replace("Arrow",""),A=D===I[0],G=D===I[1],U=D===w[0]||D===b[0]||A,W=D===w[1]||D===b[1]||G,K=D===C[0],_=D===C[1];if(!U&&!W&&!K&&!_)return!0;d.preventDefault();var Q;if(W||U){var ae=U?0:1,ee=Ir(h),te=ee[ae];if(te===null)return!1;te===!1&&(te=m.getDefaultStep(g[h],U,t.keyboardDefaultStep)),G||A?te*=t.keyboardPageMultiplier:te*=t.keyboardMultiplier,te=Math.max(te,1e-7),te=(U?-1:1)*te,Q=y[h]+te}else _?Q=t.spectrum.xVal[t.spectrum.xVal.length-1]:Q=t.spectrum.xVal[0];return Re(h,m.toStepping(Q),!0,!0),J("slide",h),J("update",h),J("change",h),J("set",h),!1}s(ai,"eventKeydown");function ii(d){d.fixed||l.forEach(function(h,b){Me(r.start,h.children[0],on,{handleNumbers:[b]})}),d.tap&&Me(r.start,c,ri,{}),d.hover&&Me(r.move,c,si,{hover:!0}),d.drag&&f.forEach(function(h,b){if(!(h===!1||b===0||b===f.length-1)){var w=l[b-1],I=l[b],C=[h],D=[w,I],A=[b-1,b];ce(h,t.cssClasses.draggable),d.fixed&&(C.push(w.children[0]),C.push(I.children[0])),d.dragAll&&(D=l,A=v),C.forEach(function(G){Me(r.start,G,on,{handles:D,handleNumbers:A,connect:h})})}})}s(ii,"bindSliderEvents");function cn(d,h){E[d]=E[d]||[],E[d].push(h),d.split(".")[0]==="update"&&l.forEach(function(b,w){J("update",w)})}s(cn,"bindEvent");function oi(d){return d===Oe.aria||d===Oe.tooltips}s(oi,"isInternalNamespace");function We(d){var h=d&&d.split(".")[0],b=h?d.substring(h.length):d;Object.keys(E).forEach(function(w){var I=w.split(".")[0],C=w.substring(I.length);(!h||h===I)&&(!b||b===C)&&(!oi(C)||b===C)&&delete E[w]})}s(We,"removeEvent");function J(d,h,b){Object.keys(E).forEach(function(w){var I=w.split(".")[0];d===I&&E[w].forEach(function(C){C.call(ut,y.map(t.format.to),h,y.slice(),b||!1,g.slice(),ut)})})}s(J,"fireEvent");function ct(d,h,b,w,I,C,D){var A;return l.length>1&&!t.events.unconstrained&&(w&&h>0&&(A=m.getAbsoluteDistance(d[h-1],t.margin,!1),b=Math.max(b,A)),I&&h<l.length-1&&(A=m.getAbsoluteDistance(d[h+1],t.margin,!0),b=Math.min(b,A))),l.length>1&&t.limit&&(w&&h>0&&(A=m.getAbsoluteDistance(d[h-1],t.limit,!1),b=Math.min(b,A)),I&&h<l.length-1&&(A=m.getAbsoluteDistance(d[h+1],t.limit,!0),b=Math.max(b,A))),t.padding&&(h===0&&(A=m.getAbsoluteDistance(0,t.padding[0],!1),b=Math.max(b,A)),h===l.length-1&&(A=m.getAbsoluteDistance(100,t.padding[1],!0),b=Math.min(b,A))),D||(b=m.getStep(b)),b=Ys(b),b===d[h]&&!C?!1:b}s(ct,"checkHandlePosition");function ln(d,h){var b=t.ort;return(b?h:d)+", "+(b?d:h)}s(ln,"inRuleOrder");function wr(d,h,b,w,I){var C=b.slice(),D=w[0],A=t.events.smoothSteps,G=[!d,d],U=[d,!d];w=w.slice(),d&&w.reverse(),w.length>1?w.forEach(function(K,_){var Q=ct(C,K,C[K]+h,G[_],U[_],!1,A);Q===!1?h=0:(h=Q-C[K],C[K]=Q)}):G=U=[!0];var W=!1;w.forEach(function(K,_){W=Re(K,b[K]+h,G[_],U[_],!1,A)||W}),W&&(w.forEach(function(K){J("update",K),J("slide",K)}),I!=null&&J("drag",D))}s(wr,"moveHandles");function Er(d,h){return t.dir?100-d-h:d}s(Er,"transformDirection");function ci(d,h){g[d]=h,y[d]=m.fromStepping(h);var b=Er(h,0)-N,w="translate("+ln(b+"%","0")+")";l[d].style[t.transformRule]=w,xr(d),xr(d+1)}s(ci,"updateHandlePosition");function un(){v.forEach(function(d){var h=g[d]>50?-1:1,b=3+(l.length+h*d);l[d].style.zIndex=String(b)})}s(un,"setZindex");function Re(d,h,b,w,I,C){return I||(h=ct(g,d,h,b,w,!1,C)),h===!1?!1:(ci(d,h),!0)}s(Re,"setHandle");function xr(d){if(f[d]){var h=0,b=100;d!==0&&(h=g[d-1]),d!==f.length-1&&(b=g[d]);var w=b-h,I="translate("+ln(Er(h,w)+"%","0")+")",C="scale("+ln(w/100,"1")+")";f[d].style[t.transformRule]=I+" "+C}}s(xr,"updateConnect");function kr(d,h){return d===null||d===!1||d===void 0||(typeof d=="number"&&(d=String(d)),d=t.format.from(d),d!==!1&&(d=m.toStepping(d)),d===!1||isNaN(d))?g[h]:d}s(kr,"resolveToValue");function lt(d,h,b){var w=Vt(d),I=g[0]===void 0;h=h===void 0?!0:h,t.animate&&!I&&Ks(o,t.cssClasses.tap,t.animationDuration),v.forEach(function(A){Re(A,kr(w[A],A),!0,!1,b)});var C=v.length===1?0:1;if(I&&m.hasNoSize()&&(b=!0,g[0]=0,v.length>1)){var D=100/(v.length-1);v.forEach(function(A){g[A]=A*D})}for(;C<v.length;++C)v.forEach(function(A){Re(A,g[A],!0,!0,b)});un(),v.forEach(function(A){J("update",A),w[A]!==null&&h&&J("set",A)})}s(lt,"valueSet");function li(d){lt(t.start,d)}s(li,"valueReset");function fi(d,h,b,w){if(d=Number(d),!(d>=0&&d<v.length))throw new Error("noUiSlider: invalid handle number, got: "+d);Re(d,kr(h,d),!0,!0,w),J("update",d),b&&J("set",d)}s(fi,"valueSetHandle");function Cr(d){if(d===void 0&&(d=!1),d)return y.length===1?y[0]:y.slice(0);var h=y.map(t.format.to);return h.length===1?h[0]:h}s(Cr,"valueGet");function di(){for(We(Oe.aria),We(Oe.tooltips),Object.keys(t.cssClasses).forEach(function(d){Gt(o,t.cssClasses[d])});o.firstChild;)o.removeChild(o.firstChild);delete o.noUiSlider}s(di,"destroy");function Ir(d){var h=g[d],b=m.getNearbySteps(h),w=y[d],I=b.thisStep.step,C=null;if(t.snap)return[w-b.stepBefore.startValue||null,b.stepAfter.startValue-w||null];I!==!1&&w+I>b.stepAfter.startValue&&(I=b.stepAfter.startValue-w),w>b.thisStep.startValue?C=b.thisStep.step:b.stepBefore.step===!1?C=!1:C=w-b.stepBefore.highestStep,h===100?I=null:h===0&&(C=null);var D=m.countStepDecimals();return I!==null&&I!==!1&&(I=Number(I.toFixed(D))),C!==null&&C!==!1&&(C=Number(C.toFixed(D))),[C,I]}s(Ir,"getNextStepsForHandle");function pi(){return v.map(Ir)}s(pi,"getNextSteps");function mi(d,h){var b=Cr(),w=["margin","limit","padding","range","animate","snap","step","format","pips","tooltips"];w.forEach(function(C){d[C]!==void 0&&(n[C]=d[C])});var I=ta(n);w.forEach(function(C){d[C]!==void 0&&(t[C]=I[C])}),m=I.spectrum,t.margin=I.margin,t.limit=I.limit,t.padding=I.padding,t.pips?sn(t.pips):rn(),t.tooltips?it():he(),g=[],lt(Yn(d.start)?d.start:b,h)}s(mi,"updateOptions");function gi(){c=pe(o),Y(t.connect,c),ii(t.events),lt(t.start),t.pips&&sn(t.pips),t.tooltips&&it(),tn()}s(gi,"setupSlider"),gi();var ut={destroy:di,steps:pi,on:cn,off:We,get:Cr,set:lt,setHandle:fi,reset:li,disable:je,enable:Ve,__moveHandles:function(d,h,b){wr(d,h,g,b)},options:n,updateOptions:mi,target:o,removePips:rn,removeTooltips:he,getPositions:function(){return g.slice()},getTooltips:function(){return p},getOrigins:function(){return l},pips:sn};return ut}s(tl,"scope");function nl(e,t){if(!e||!e.nodeName)throw new Error("noUiSlider: create requires a single element, got: "+e);if(e.noUiSlider)throw new Error("noUiSlider: Slider was already initialized.");var n=ta(t),r=tl(e,n,t);return e.noUiSlider=r,r}s(nl,"initialize");var na={__spectrum:Qs,cssClasses:Zs,create:nl};var Pe=F("merchant.buy"),rt=class extends Application{static{s(this,"BuyItems")}constructor(t,n={}){super(n),this.actor=t,this.defaultData=Cn({collapsed:!0}),this.defaultData.name="",this.editing=null,this.tabs={equipment:{filterData:deepClone(this.defaultData),isOfType:(...r)=>r.includes("equipment")}},this.activeTab="equipment",this.navigationTab={active:"equipment"},this.expanded={}}get id(){return`pf2e-toolbelt-buy-${this.actor.id}`}get title(){return Pe("title",this.actor)}get template(){return de("merchant/buy")}get tab(){return this.tabs.equipment}get filters(){return O(this.actor,"merchant.filters")??[]}async setFilters(t,n=!1){n&&this.resetFilters(),await ne(this.actor,"merchant.filters",t),this.render()}render(t,n){return this.actor.apps[this.appId]=this,super.render(t,n)}async close(t){await super.close(t),delete this.actor.apps?.[this.appId]}async getData(t){let n=this.filters,r=O(this.actor,"merchant.buyRatio"),a=O(this.actor,"merchant.buyPurse"),i=s(c=>{let l=Wt(c);return l<0?"":Math.floor(l)},"formatPurse"),o=s(c=>{let l=[],f=s((m,y)=>{let g=this.defaultData[m][y];return{defaultData:g,title:game.i18n.localize(g.label)}},"getDefaultData"),u=Object.entries(c.checkboxes??{});for(let[m,{selected:y}]of u){let{title:g,defaultData:v}=f("checkboxes",m),S=y.map(E=>v.options[E].label).join(", ");l.push({title:g,row:S})}let p=Object.entries(c.multiselects??{});for(let[m,{selected:y,conjunction:g}]of p){let{title:v}=f("multiselects",m),S=y.map(({label:E,not:x})=>x?`<s>${E}</s>`:E).join(", ");l.push({title:`${v} (${g})`,row:S})}for(let m of["ranges","sliders"]){let y=Object.entries(c[m]??{});for(let[g,{values:v}]of y){let{title:S}=f(m,g),E=v.inputMin??v.min,x=v.inputMax??v.max,k=`${E} - ${x}`;l.push({title:S,row:k})}}return l.map(({title:m,row:y})=>`<div><strong>${m}: </strong>${y}</div>`).join("")},"getSummary");return{...this.tabs.equipment,...Pe.i18n,filters:n.map(c=>({...c,summary:o(c),expanded:this.expanded[c.id],name:this.getFilterName(c),purse:i(c.purse),priceRatio:He("buy",c.priceRatio)})),defaultFilter:{id:"",name:Pe("default.label"),purse:i(a),priceRatio:He("buy",r),buyAll:Qn(this.actor)},priceRatio:Ge}}async activateListeners(t){let n=this.tab.filterData,r=t.find(".control-area");r.find("[id]").removeAttr("id"),r.find("[data-filter-name='source']").remove();let a=r.find(".sortcontainer");a.children().remove();let i=await z("merchant/extra",{value:n.name,editing:this.editing,...Pe.i18n});a.append(i),a.find("[name=filter-name]").on("change",u=>{n.name=u.currentTarget.value.trim()}),a.find("button").on("click",u=>{u.preventDefault();let{action:p}=u.currentTarget.dataset;switch(p){case"reset-filter":this.resetFilters();break;case"save-filter":this.saveFilter();break}});let o=r.find(".filtercontainer:not([data-filter-type=multiselects])");for(let u of o){let{filterType:p,filterName:m}=u.dataset,y=n[p][m],g=u.querySelector(".title");g.querySelector("button")?.remove();let v=g.nextElementSibling;if(g.addEventListener("click",()=>{v.style.display=y.isExpanded?"none":"",y.isExpanded=!y.isExpanded}),v.style.display=y.isExpanded?"":"none",u.setAttribute("data-buy-filter-type",p),u.setAttribute("data-buy-filter-name",m),u.removeAttribute("data-filter-type"),u.removeAttribute("data-filter-name"),p==="sliders"){let S=v.querySelector("[class^=slider-]"),E=na.create(S,{range:{min:y.values.lowerLimit,max:y.values.upperLimit},start:[y.values.min,y.values.max],tooltips:{to(M){return Math.floor(M).toString()}},connect:[!1,!0,!1],behaviour:"snap",step:y.values.step}),x=S.previousElementSibling,k=S.nextElementSibling;E.on("change",M=>{let[N,j]=M.map(se=>Number(se));y.values.min=N,y.values.max=j,x.textContent=N,k.textContent=j})}else if(p==="ranges"){let S=v.querySelector("input[name^=lowerBound]"),E=v.querySelector("input[name^=upperBound]");for(let x of[S,E])x.addEventListener("change",()=>{let k=S.value??"",M=E.value??"",N=this.parseRangeFilterInput(m,k,M);y.values=N,y.changed=!0,S.value=N.inputMin,E.value=N.inputMax})}else if(p==="checkboxes"){let S=u.querySelectorAll("input[type=checkbox]");for(let E of S)E.addEventListener("click",()=>{let x=E.name,k=y.options[x];k.selected=!k.selected,k.selected?y.selected.push(x):y.selected=y.selected.filter(M=>M!==x)})}}t.find("input[type=text], input[type=search], input[type=number]").on("keyup",u=>{u.key==="Enter"&&u.currentTarget.blur()}),ht().activateListeners.call(this,t);let c=t.find(".filters .filter"),l=s(u=>{let p=u.currentTarget.closest("[data-filter-id]");return{filterElement:p,filterId:p.dataset.filterId}},"getFilterId");c.find("[data-action]").on("click",u=>{u.preventDefault();let{filterId:p,filterElement:m}=l(u),{direction:y,action:g}=u.currentTarget.dataset;switch(g){case"delete-filter":this.deleteFilter(p);break;case"move-filter":this.moveFilterPosition(p,y);break;case"edit-filter":this.editFilter(p);break;case"toggle-summary":this.toggleFilterSummary(m,p);break}});let f=s((u,p,m)=>{if(!u){ne(this.actor,`merchant.${p}`,m);return}let y=this.filters.slice(),g=y.find(v=>v.id===u);g&&(g[p]=m,this.setFilters(y))},"setFilterValue");c.find("[name=price-ratio]").on("change",u=>{let{filterId:p}=l(u),m=u.currentTarget.valueAsNumber,y=He("buy",m);f(p,p?"priceRatio":"buyRatio",y)}),c.find("[name=purse]").on("change",u=>{let{filterId:p}=l(u),m=u.currentTarget.value,y=Wt(m);f(p,p?"purse":"buyPurse",y)}),c.find("[name=buy-all]").on("change",u=>{let p=u.currentTarget.checked;ne(this.actor,"merchant.buyAll",p)})}toggleFilterSummary(t,n){let r=this.expanded[n];this.expanded[n]=!r,t.classList.toggle("expanded",!r)}editFilter(t){let n=this.filters.find(a=>a.id===t);if(!n)return;let r=Cn({collapsed:!0,mergeWith:deepClone(n)});this.tab.filterData=r,this.editing=t,this.render()}deleteFilter(t,n=!1){let r=this.filters.slice(),a=r.findIndex(o=>o.id===t);if(a===-1)return;let i=s(()=>{r.splice(a,1),this.setFilters(r,this.editing===t)},"deleteIt");if(n){i();return}Dialog.confirm({title:Pe("delete.title"),content:Pe("delete.content",{name:r[a].name}),yes:()=>{r.findIndex(c=>c.id===t)!==-1&&i()}})}moveFilterPosition(t,n){let r=this.filters.slice();if(r.length<2)return;let a=r.findIndex(c=>c.id===t);if(a===-1||n==="up"&&a===0||n==="down"&&a===r.length-1)return;let i=n==="down"?a+1:a-1,o=r.splice(a,1)[0];r.splice(i,0,o),this.setFilters(r)}parseRangeFilterInput(t,n,r){let a=Ae("equipment"),i=this.defaultData.ranges[t].values,o=n.trim()||i.inputMin,c=r.trim()||i.inputMax,l=a.parseRangeFilterInput(t,o,c);return l.max<l.min&&(l.max=l.min,l.inputMax=l.inputMin),l}resetFilters(){this.editing=null,this.tab.filterData=deepClone(this.defaultData),this.render(!1,{force:!0})}static compareItemWithFilter(t,n){let r=Ae("equipment"),{checkboxes:a={},multiselects:i={},ranges:o={},sliders:c={}}=n;return!(c.level&&(t.level<c.level.values.min||t.level>c.level.values.max)||o.price&&(t.priceInCopper<o.price.values.min||t.priceInCopper>o.price.values.max)||a.itemTypes?.selected.length>0&&!a.itemTypes.selected.includes(t.type)||a.armorTypes?.selected.length>0&&!r.arrayIncludes(a.armorTypes.selected,[t.category,t.group])||a.weaponTypes?.selected.length>0&&!r.arrayIncludes(a.weaponTypes.selected,[t.category,t.group])||i.traits&&!r.filterTraits([...t.traits],i.traits.selected,i.traits.conjunction)||a.source?.selected.length>0&&!a.source.selected.includes(t.source)||a.rarity?.selected.length>0&&!a.rarity.selected.includes(t.rarity))}getFilterName(t){return t.name||`filter-${t.id}`}extractFilterData(){let t=this.defaultData,n=this.tab.filterData,r={};for(let a of["checkboxes","multiselects"])for(let[i,o]of Object.entries(n[a])){if(!o.selected.length)continue;let c=`${a}.${i}`;setProperty(r,`${c}.selected`,o.selected),a==="multiselects"&&setProperty(r,`${c}.conjunction`,o.conjunction)}for(let a of["ranges","sliders"]){let i=t[a];for(let[o,c]of Object.entries(n[a])){let l=i[o];objectsEqual(c.values,l.values)||setProperty(r,`${a}.${o}.values`,c.values)}}if(!isEmpty(r))return r.name=n.name.trim(),r.id=n.id??randomID(),r.priceRatio=n.priceRatio,r.purse=n.purse,r}saveFilter(){let t=this.extractFilterData();if(!t){Pe.warn("empty");return}let n=this.filters.slice();if(this.editing){let r=n.findIndex(a=>a.id===this.editing);if(r===-1)return;n[r]=t}else n.push(t);Pe.info(this.editing?"saved":"created",{name:this.getFilterName(t)}),this.setFilters(n,!0)}};var re=F("merchant"),ra="CONFIG.Item.documentClass.prototype.prepareDerivedData",rl="CONFIG.PF2E.Actor.documentClasses.loot.prototype.transferItemToActor",sl="CONFIG.Actor.documentClass.prototype.transferItemToActor",al="game.pf2e.compendiumBrowser.constructor.prototype.close",il="game.pf2e.compendiumBrowser.constructor.prototype._renderInner",ol="game.pf2e.compendiumBrowser.constructor.prototype.activateListeners",cl="game.pf2e.compendiumBrowser.tabs.equipment.constructor.prototype.renderResults",er=100,Ge={min:.1,max:5,step:.1,buy:.5,sell:1},tr={name:"merchant",settings:[{key:"merchant",type:Boolean,default:!1,requiresReload:!0}],socket:ll,init:e=>{P("merchant")&&(e&&(sa.activate(),Hooks.on("renderLootSheetPF2e",ml)),q(ra,gl,"WRAPPER"),q(rl,hl,"OVERRIDE"),q(sl,yl,"MIXED"))},ready:e=>{!e||!P("merchant")||(q(al,ul),q(il,fl),q(cl,pl),q(ol,dl))}},{socket:sa}=B(tr);function ll(e,t){switch(e.type){case"buy-deal":oa(e,t);break}}s(ll,"onSocket");async function ul(e,t){Le(this,"merchant"),await e(t)}s(ul,"browserClose");async function fl(e,t){let n=await e(t),r=Z(this,"merchant.actor");if(!r)return n;Le(this,"merchant.selection"),ie(this,"merchant.owned",r.inventory.map(u=>u.sourceId)),n.addClass("toolbelt-merchant");let a=n.find(".content .tab[data-tab=equipment]"),i=a.find(".control-area");i.prepend(`<h2>${r.name}</h2>`),i.find("input[name=textFilter]").remove();let o=a.find(".list-buttons");o.find("button").remove();let c=re("browser.selected");o.append(`<div>${c}: <span>0</span>/<span>0</span></div>`);let l=re("browser.add");o.append(`<button type='button'>${l}</button>`);let f=re("browser.all");return o.append(`<label>${f} <input type='checkbox'></button></label>`),n}s(fl,"browserInnerRender");function Zn(e,t=!1){let n=document.getElementById("compendium-browser");if(!n)return;let r=n.querySelector(".content-box.toolbelt-merchant .content .tab[data-tab=equipment]"),a=r.querySelector(".list-buttons"),i=Ae("equipment"),o=e.length,c=i.currentIndex.length,l=a.querySelectorAll(":scope > div span");l.length&&(l[0].textContent=o,l[1].textContent=c);let f=o>=er;if(!t){let m=a.querySelector(":scope > label input");m&&(o===0?(m.indeterminate=!1,m.checked=!1):f||o>=c?(m.indeterminate=!1,m.checked=!0):(m.indeterminate=!0,m.checked=!0))}a.querySelector("button").disabled=o===0;let u=re("browser.limit"),p=r.querySelectorAll(".result-list .item input");for(let m of p){let g=!m.checked&&f;m.disabled=g,m.dataset.tooltip=g?u:""}}s(Zn,"updateBrowser");function aa(e,t,n=Z(e.browser,"merchant.owned")){t.length=0;for(let{uuid:r}of e.currentIndex)if(!n.includes(r)&&(t.push(r),t.length>=er))break;return t}s(aa,"fillSelection");function dl(e,t){e(t);let n=this,r=Z(n,"merchant.actor");if(!r)return;let a=t[0].querySelector(".content .tab[data-tab=equipment]"),i=a.querySelector(".list-buttons"),o=i.querySelector("label input[type=checkbox]");if(o){let l=Ae("equipment");o.addEventListener("change",()=>{let f=o.checked,u=Z(l.browser,"merchant.selection");f?aa(l,u):u.length=0;let p=a.querySelectorAll(".item input");for(let m of p){let y=m.dataset.uuid;m.checked=u.includes(y)}Zn(u,!1)})}let c=i.querySelector("button");c&&c.addEventListener("click",()=>{let l=Z(n,"merchant.selection"),f=re("browser.dialogMsg",{nb:l.length});Dialog.confirm({content:`<div style="margin-bottom: 0.5em;">${f}</div>`,title:`${re("browser.pull")} - ${r.name}`,yes:async u=>{re.info("browser.wait"),n.close();let p=await Promise.all(l.map(m=>fromUuid(m)));await r.createEmbeddedDocuments("Item",p.map(m=>m.toObject())),re.info("browser.finished")}})})}s(dl,"browserActiveListeners");async function pl(e,t){let n=await e(t),r=Z(this.browser,"merchant.owned");if(!r)return n;let a=this.browser,i=Pr(a,"merchant.selection",()=>{let f=aa(this,[],r);return Zn(f),f}),o=i.length>=er?`data-tooltip="${re("browser.limit")}" disabled`:"",l=`<i class="fa-solid fa-box" data-tooltip="${re("browser.owned")}"></i>`;for(let f of n){for(let y of f.querySelectorAll(":scope > a"))y.remove();let u=f.dataset.entryUuid;if(r.includes(u)){f.insertAdjacentHTML("beforeend",l);continue}let p=i.includes(u)?"checked":"";f.insertAdjacentHTML("beforeend",`<input type='checkbox' data-uuid="${u}" 
			${p} ${p?"":o}>`);let m=f.querySelector("input");m.addEventListener("change",()=>{if(m.checked)i.push(u);else{let y=i.indexOf(u);i.splice(y,1)}Zn(i)})}return n}s(pl,"browserRenderResults");async function ml(e,t){let n=e.actor;if(!n?.isMerchant)return;let{noCoins:r=!1,buyItems:a=!1,priceRatio:i=1,infiniteStocks:o=!1,infiniteItems:c={}}=O(n,"merchant")??{},l=await z("merchant/sheet",{noCoins:r,buyItems:a,infiniteStocks:o,priceRatio:{...Ge,value:He("sell",i)},actorUUID:n.uuid,...re.i18n,flagPath:y=>Ee("merchant",y)}),f=t.find(".sheet-sidebar");f.find(".editor").before(l);let u=f.find(".better-merchant");u.find("[data-action=open-equipment-tab]").on("click",y=>vl(n)),u.find("[data-action=open-buy-settings]").on("click",y=>bl(y,n));let p=t.find(".content .sheet-body [data-item-types]").filter("[data-item-types!=treasure]"),m=o;if(o)p.find(".quantity a").remove();else{let y=p.find("[data-item-id]"),g=re.path("infinite-item.tooltip");for(let v of y){let S=v.dataset.itemId,E=!!c[S],x=$(`<a data-action="toggle-infinite-item" data-tooltip="${g}">
	<i class="${E?"fa-solid":"fa-duotone"} fa-infinity"></i>
</a>`)[0];if(v.querySelector(".item-controls").prepend(x),E)for(let k of v.querySelectorAll(".quantity a"))k.remove();x.addEventListener("click",k=>{let M=`merchant.infiniteItems.${S}`,N=O(n,M)??!1;ne(n,M,!N)}),E&&(m=!0)}}m&&(t.find(".content .sheet-body .coinage .wealth h3:last span").html("-"),t.find(".content .sheet-body .total-bulk span").html(game.i18n.format("PF2E.Actor.Inventory.TotalBulk",{bulk:"-"})))}s(ml,"renderLootSheetPF2e");function gl(e){e();try{if(!this.isOfType("physical")||this.isOfType("treasure"))return;let t=this.actor;if(!t?.isMerchant)return;let n=O(t,"merchant");if(!n)return;let{priceRatio:r,infiniteStocks:a,infiniteItems:i={}}=n;if(r!==1){let c=He("sell",r);this.system.price.value=this.system.price.value.scale(c)}(()=>{if(typeof a=="boolean"&&a)return!0;let c=i[this.id];return typeof c=="boolean"&&c})()&&(this.system.quantity=9999)}catch{we("merchant",ra)}}s(gl,"itemPrepareDerivedData");async function hl(...e){let[t,n,r]=e,a=Actor.implementation.prototype;if(!(this.isOwner&&t.isOwner))return a.transferItemToActor.apply(this,e);if(this.isMerchant&&n.isOfType("physical")){let i=game.pf2e.Coins.fromPrice(n.price,r);if(await t.inventory.removeCoins(i))return O(this,"merchant.noCoins")||await n.actor.inventory.addCoins(i),a.transferItemToActor.apply(this,e);if(this.isLoot)throw Fe("Loot transfer failed");return null}return a.transferItemToActor.apply(this,e)}s(hl,"lootTranferItemToActor");function ia(e){return O(e,"merchant.filters")?.slice()??[]}s(ia,"getFilters");function Qn(e){return O(e,"merchant.buyAll")??!0}s(Qn,"getBuyAll");function Kt(e,t){let n=e instanceof Actor,r=Wt(n?O(e,"merchant.buyPurse"):e.purse),a=He("buy",n?O(e,"merchant.buyRatio"):e.priceRatio),i=t.scale(a),o=r<0,c=i.goldValue;return{price:i,ratio:a,purse:r,goldValue:c,isInfinite:o,canAfford:o||r>=c}}s(Kt,"createPurse");async function yl(e,...t){let[n,r,a=1,i,o]=t;if(!n.isOfType("loot")||!n.isMerchant||!O(n,"merchant.buyItems"))return e(...t);let c=this.hasPlayerOwner;switch(this.type){case"character":case"party":break;case"loot":if(!c||this.isMerchant)return e(...t);break;case"npc":if(!c)return e(...t);break;default:return e(...t)}let l=n.name,f=Math.min(a,r.quantity),u=Dn(r,f);if(!Kt(n,u).canAfford){re.info("buy.poor.total",{actor:l});return}let m=!1,y=null,g=ia(n);for(let v of g)if(rt.compareItemWithFilter(r,v)){if(!Kt(v,u).canAfford){m=!0;continue}y=v.id;break}if(!y&&!Qn(n)){re.info(m?"buy.poor.filter":"buy.refuse",{actor:l});return}oa({buyer:n,seller:this,item:r,quantity:a,containerId:i,newStack:o,filter:y})}s(yl,"actorTranferItemToActor");async function oa(e,t){let n=s(async(x,k)=>x instanceof k?x:await fromUuid(x),"getDocument"),r=s(x=>{throw re.error("An error occured while making a deal (F12 for more details in the console)."),new Error(x)},"errorMsg"),a=await n(e.buyer,Actor),i=await n(e.seller,Actor),o=await n(e.item,Item);if(!a||!i||!o){let x=["buyer","seller","item"].map(k=>`${k}: ${e[k].uuid??e[k]}`).join(", ");r(`Missing actors or item to finish processing the buy deal, ${x}.`)}if(!a.isOwner||!i.isOwner){sa.emit({...e,type:"buy-deal",buyer:a.uuid,seller:i.uuid,item:o.uuid});return}let c=Math.min(e.quantity,o.quantity),l=Dn(o,c),f=ia(a),u=f.find(x=>x.id===e.filter),p=Kt(a,l),m=u?Kt(u,l):void 0,y=s((x,k)=>{r(`${a.uuid} can't buy ${c} x ${o.uuid}, the ${x} gold purse doesn't have enough founds, need: ${goldPrice}, has: ${k}.`)},"purseError");p.canAfford||y("total",p),m&&!m.canAfford&&y("filter",u.purse);let g=m??p,v={};p.isInfinite||(v[Ee("merchant.buyPurse")]=p.purse-g.goldValue),m&&!m.isInfinite&&(u.purse=m.purse-g.goldValue,v[Ee("merchant.filters")]=f),isEmpty(v)||await a.update(v),await i.inventory.addCoins(g.price);let S=await Pt(a,o,c),E=re("sold.message",{buyer:Ce(a),quantity:c,item:await St(S),seller:Ce(i),price:parseFloat(g.goldValue.toFixed(2))});await wt(re("sold.subtitle"),E,a,S,t)}s(oa,"makeBuyDeal");function vl(e){let t=ht();ie(t,"merchant",{actor:e}),Kr("equipment",!1)}s(vl,"openEquipmentTab");function bl(e,t){new rt(t).render(!0)}s(bl,"openBuySettings");function He(e,t){return Number.isNumeric(t)?Math.clamped(t,Ge.min,Ge.max):Ge[e]}s(He,"clampPriceRatio");function Wt(e){return Number.isNumeric(e)?Math.max(e,-1):-1}s(Wt,"clampPurse");function Yt(e){let t=e.id,n=O(e,"target.save");n&&Hooks.once("preCreateChatMessage",r=>{Je(r,"target.messageId",t),Je(r,"target.save",n)})}s(Yt,"bindOnPreCreateSpellDamageChatMessage");var nr=F("merge.multi"),Jt=class extends Application{static{s(this,"MultiCast")}#e;#t;constructor(t,n,r){super(r),this.#t=t,this.#e=n}get title(){return nr("title",this.#e.item)}get template(){return de("merge/multi")}getData(t){return mergeObject(super.getData(t),{i18n:nr.template})}activateListeners(t){t.find("[data-action=cast]").on("click",this.#n.bind(this)),t.find("[data-action=cancel]").on("click",this.#r.bind(this))}async#n(t){t.preventDefault();let n=this.element.find("[name=multi]").val();if(n<1){nr.error("zero"),this.close();return}let r=this.#e;if(!r)return;let a=r.item,i=r.actor;if(!i||!a)return;let o=s((l,f)=>{for(let[u,p]of Object.entries(l))for(let m=0;m<n-1;m++){let y=randomID();if(l[y]=p,f.type==="interval"){let g=f.damage[u];g&&(f.damage[y]=g)}else if(f.type==="fixed")for(let g of Object.values(f.levels)){let v=g.damage[u];v&&(g.damage[y]=v)}}},"updateSource"),c=deepClone(r.flags.pf2e.casting?.embeddedSpell);if(c){let l=c.system.damage;c.system.heightening??={};let f=c.system.heightening;o(l,f);let u=new Item.implementation(c,{parent:i});u.trickMagicEntry=a.trickMagicEntry;let p=r.getFlag("pf2e","origin.variant.overlays"),m=r.getFlag("pf2e","origin.castRank")??a.rank;(u.loadVariant({overlayIds:p,castRank:m})??u).rollDamage(this.#t)}else{let l=a.toObject(),f=l.system.damage,u=l.system.heightening??{};o(f,u),a.clone({"system.damage":f,"system.heightening":u}).rollDamage(this.#t)}a.damageKinds.size&&Yt(r),this.close()}#r(t){t.preventDefault(),this.close()}};var rr=debounce(wl,1),sr={name:"merge",settings:[{key:"merge-damage",type:Boolean,default:!1,scope:"client",onChange:rr},{key:"multi-cast",type:Boolean,default:!1,scope:"client",onChange:rr}],hooks:[["renderChatMessage",da]],init:rr},{setHook:Sl}=B(sr);function wl(){let e=P("merge-damage")||P("multi-cast");Sl(e),El()}s(wl,"setup");function El(){for(let{message:e,html:t}of Ke(10))t.find("[data-action=multi-cast]").remove(),t.find("[data-action=merge-damage]").remove(),da(e,t)}s(El,"updateMessages");function da(e,t){!game.user.isGM&&!e.isAuthor||(P("merge-damage")&&ga(e)?kl(e,t):P("multi-cast")&&e.getFlag("pf2e","origin.type")==="spell"&&xl(e,t))}s(da,"renderChatMessage");function xl(e,t){if(!e.item)return;let r=t.find(".message-content .chat-card .owner-buttons .spell-button");r.find("[data-action=spell-damage]").after(`<button data-action="multi-cast">${H("merge.spell.button")}</button>`),r.find("[data-action=multi-cast]").on("click",a=>{new Jt(a,e).render(!0)})}s(xl,"renderSpell");function kl(e,t){let n='<span class="pf2e-toolbelt-merge">';if(O(e,"merge.merged")){let o=H("merge.damage.split-tooltip");n+=`<button data-action="split-damage" title="${o}">`,n+='<i class="fa-duotone fa-split"></i>'}let r=H("merge.damage.tooltip");n+=`<button data-action="merge-damage" title="${r}">`,n+='<i class="fa-duotone fa-merge"></i></button>',n+="</span>";let a=ua(e),i=fa(e);t.find(".dice-result .dice-total").append(n),t.find(".pf2e-toolbelt-merge [data-action=merge-damage]").on("click",o=>{o.stopPropagation();for(let{message:c}of Ke(5,e)){let l=fa(c);if(!(!ga(c)||ua(c)!==a||!bn(i?.map(f=>f.actor).filter(Boolean),l?.map(f=>f.actor).filter(Boolean)))){Il(o,e,c,{actorUUID:a,targetUUIDs:i});return}}V("merge.damage.none")}),t.find(".pf2e-toolbelt-merge [data-action=split-damage]").on("click",o=>{o.stopPropagation(),Cl(o,e)})}s(kl,"renderDamage");async function Cl(e,t){let n=O(t,"merge.data").flatMap(r=>r.source);await pa(t.id),await ChatMessage.implementation.createDocuments(n)}s(Cl,"splitDamages");async function Il(e,t,n,{actorUUID:r,targetUUIDs:a}){let i={},o=ca(n).concat(ca(t));for(let{name:g,notes:v,outcome:S,modifiers:E,tags:x}of o){i[g]??={name:g,tags:x,notes:new Set,results:[]};for(let M of v)i[g].notes.add(M);i[g].results.some(M=>M.outcome===S&&bn(M.modifiers,E))||i[g].results.push({outcome:S,modifiers:E})}let c=Object.values(i).map(g=>{g.label=g.name;for(let v of g.results)v.outcome&&(v.label=game.i18n.localize(`PF2E.Check.Result.Degree.Attack.${v.outcome}`));return g});c.at(-1).isLastGroup=!0;let l=await z("merge/merged",{groups:c,hasMultipleGroups:c.length>1}),f=la(t),u=la(n),p=[];for(let g of[].concat(u,f)){let{options:v,total:S,terms:E}=g,x=E[0],k=g.formula.replaceAll(/(\[[\w,-]+\])/g,"").replace(/^\(/,"").replace(/\)$/,""),M=p.find(({options:{flavor:N,critRule:j}})=>N===v.flavor&&j===v.critRule);M?(M.terms.push(x),M.total+=S,M.formulas.push(k)):p.push({options:v,formulas:[k],total:S,terms:[x]})}let m=Qr();for(let g of p){if(g.options.flavor.includes("persistent")){let{index:v}=g.formulas.reduce((S,E,x)=>{let k=new m(E).expectedValue;return k<=S.value?S:{value:k,index:x}},{value:0,index:-1});g.formulas=[g.formulas[v]],g.terms=[g.terms[v]]}g.formula=`(${g.formulas.join(" + ")})[${g.options.flavor}]`,g.term=g.terms.length<2?g.terms[0]:ma(g.terms)}let y={class:"DamageRoll",options:{},dice:[],formula:`{${p.map(({formula:g})=>g).join(", ")}}`,total:p.reduce((g,{total:v})=>g+v,0),evaluated:!0,terms:[{class:"InstancePool",options:{},evaluated:!0,terms:p.map(({formula:g})=>g),modifiers:[],rolls:p.map(({options:g,formula:v,total:S,term:E})=>({class:"DamageInstance",options:g,dice:[],formula:v,total:S,terms:[E],evaluated:!0})),results:p.map(({total:g})=>({result:g,active:!0}))}]};if(game.modules.get("dice-so-nice")?.active){let g=s(v=>{if("results"in v)for(let S of v.results)S.hidden=!0;else{let S=(v.term??v).operands??[];for(let E of S)g(E)}},"setHidden");for(let v of y.terms[0].rolls)for(let S of v.terms)g(S)}await pa(t.id,n.id),await ChatMessage.implementation.create({flavor:l,type:CONST.CHAT_MESSAGE_TYPES.ROLL,speaker:t.speaker,flags:{[L.id]:{merge:{actor:r,targets:a,merged:!0,type:"damage-roll",data:o},target:{targets:a}},pf2e:{context:{options:Array.from(new Set(o.flatMap(g=>g.itemTraits)))}}},rolls:[y]})}s(Il,"mergeDamages");function ca(e){let t=O(e,"merge.data");if(t)return t;let n=e.toObject();delete n._id,delete n.timestamp;let r=$(`<div>${e.flavor}</div>`),a=r.find("h4.action + .tags").prop("outerHTML"),i=[];r.find(".tag.tag_transparent").each(function(){i.push(this.innerHTML)});let o=n.flags.pf2e.context.notes.map(({title:c,text:l})=>`<strong>${game.i18n.localize(c)}</strong> ${game.i18n.localize(l)}`);return[{source:n,name:n.flags.pf2e.strike?.name??e.item.name,outcome:n.flags.pf2e.context.outcome,itemTraits:n.flags.pf2e.context.options.filter(c=>/^(item|self):/.test(c)),modifiers:i,tags:a,notes:o}]}s(ca,"getMessageData");function pa(...e){let t=e.map(n=>`[data-message-id=${n}]`).join(", ");return ui.chat.element.find(t).remove(),ChatMessage.deleteDocuments(e)}s(pa,"removeChatMessages");function ma(e){let t=deepClone(e[0].options);for(let n of e)n.options={};return{class:"Grouping",options:t,evaluated:!0,term:{class:"ArithmeticExpression",options:{},evaluated:!0,operator:"+",operands:[e.shift(),e.length>1?ma(e):e[0]]}}}s(ma,"createTermGroup");function la(e){return O(e,"merge.rolls")??JSON.parse(e._source.rolls[0]).terms[0].rolls}s(la,"getMessageRolls");function ua(e){return O(e,"merge.actor")??e.actor?.uuid}s(ua,"getActorUUID");function fa(e){let t=O(e,"target.targets");if(t)return t;let n=O(e,"merge.targets")??e.getFlag("pf2e","target");return Array.isArray(n)?n:n?[n]:[]}s(fa,"getTargetUUIDs");function ga(e){return O(e,"merge.type")==="damage-roll"||e.getFlag("pf2e","context.type")==="damage-roll"}s(ga,"isDamageRoll");var ha="CONFIG.Actor.documentClass.prototype.prepareEmbeddedDocuments",ya="CONFIG.PF2E.Item.documentClasses.treasure.prototype.prepareBaseData",va={name:"nobulk",settings:[{key:"nobulk",type:Boolean,default:!1,requiresReload:!0},{key:"nobulk-coins",type:Boolean,default:!1,requiresReload:!0}],init:()=>{P("nobulk")&&q(ha,Tl,"WRAPPER"),P("nobulk-coins")&&q(ya,Al,"WRAPPER")}};function Al(e){e();try{this.isCoinage&&(this.system.bulk.value=0)}catch{we("nobulk",ya)}}s(Al,"treasurePrepareBaseData");function Tl(e){e();try{let t=this.inventory.bulk.constructor,n=null;Object.defineProperty(this.inventory.bulk,"value",{get(){return n||(n=t.computeTotalBulk(this.actor.inventory.filter(r=>!r.isInContainer&&r.system.equipped.carryType!=="dropped"),this.actor.size),n)}})}catch{we("nobulk",ha)}}s(Tl,"actorPrepareEmbeddedDocuments");var Ol="CONFIG.Actor.documentClass.prototype.prepareData",Dl="DocumentSheet.prototype._renderInner",ba={name:"share",settings:[{key:"share",type:String,default:"disabled",choices:["disabled","enabled","force"],requiresReload:!0}],init:()=>{P("share")!=="disabled"&&(q(Ol,Nl,"WRAPPER"),q(Dl,Pl,"WRAPPER"),Hooks.on("preUpdateActor",Rl),Hooks.on("deleteActor",Ml),Hooks.on("updateActor",Ll))}};async function Pl(e,...t){let n=await e(...t);if(!Ye(this,"CreatureConfig"))return n;let r=this.actor;if(!fe(r)||!r.isOfType("character","npc")||st(r).size)return n;let a=game.actors.filter(o=>o.id!==r.id&&o.isOwner&&Qt(o)).map(o=>({key:o.id,label:o.name})),i=await z("share/master",{masters:a,master:O(r,"share.master"),selectPath:Ee("share.master"),i18n:F("share.templates.master")});return n.children().last().before(i),n}s(Pl,"documentSheetRenderInner");function Ml(e){xa(e);let t=st(e);Promise.all(t.map(async n=>{wa(n),await Fr(n,"share.master")}))}s(Ml,"deleteActor");function Rl(e,t){let n=Sn(t,"share");if(n?.master){let r=game.actors.get(n.master);if(Qt(r)){let a=deepClone(r._source.system.attributes.hp);setProperty(t,"system.attributes.hp",a)}}else{let r=Xt(e),a=getProperty(t,"system.attributes.hp");r&&a&&(r.update({system:{attributes:{hp:a}}},{noHook:!0}),delete t.system.attributes.hp)}}s(Rl,"preUpdateActor");function Ll(e,t,n,r){let a=game.user.id===r,i=Sn(t,"share");if(i?.master!==void 0){let c=e;if(xa(c),i.master){let l=game.actors.get(i.master);Qt(l)&&(Sa(c,l),Ea(l,c))}else wa(c)}if(!a)return;let o=st(e);if(o.size){let c=getProperty(t,"system.attributes.hp");if(c){let l={system:{attributes:{hp:c}}};Promise.all(o.map(async f=>await f.update(l,{noHook:!0})))}else Promise.all(o.map(async l=>await Fl(l,t)))}}s(Ll,"updateActor");async function Fl(e,t){P("share")==="force"?await ne(e,"toggle",!O(e,"toggle")):(e.render(!1,{action:"update"}),e._updateDependentTokens(t))}s(Fl,"refreshActor");function Nl(e){e();let t=O(this,"share.master"),n=t?game.actors.get(t):void 0;if(!Qt(n))return;Xt(this)||(Sa(this,n),Ea(n,this));let r=this.system.attributes.hp;Object.defineProperty(this.system.attributes,"hp",{get(){let a=n.system.attributes.hp;return $l(a,r),r},enumerable:!0})}s(Nl,"prepareData");function $l(e,t){t.breakdown=e.breakdown,t.max=e.max,t.sp=deepClone(e.sp),t.temp=e.temp,t.totalModifier=e.totalModifier,t.value=e.value,t._modifiers=e._modifiers.slice()}s($l,"transfertHpData");function st(e){return Z(e,"share.slaves")??new Collection}s(st,"getSlaves");function Sa(e,t){return ie(e,"share.master",t)}s(Sa,"setMaster");function wa(e){return Le(e,"share.master")}s(wa,"unsetMaster");function Xt(e){return Z(e,"share.master")}s(Xt,"getMaster");function Qt(e){return e&&e.type==="character"&&!Xt(e)}s(Qt,"isValidMaster");function Ea(e,t){let n=st(e);return ie(e,"share.slaves",n.set(t.id,t))}s(Ea,"addSlaveToMaster");function xa(e){let t=Xt(e);if(!t)return;st(t).delete(e.id)}s(xa,"removeSlaveFromMaster");var _l=["Compendium.pf2e.feats-srd.Item.yeSyGnYDkl2GUNmu","Compendium.pf2e.feats-srd.Item.LI9VtCaL5ZRk0Wo8"],Hl=new Map([["Compendium.pf2e.feats-srd.Item.nRjyyDulHnP5OewA",{replace:"Compendium.pf2e.feats-srd.Item.DqD7htz8Sd1dh3BT",effect:"Compendium.pf2e.feat-effects.Item.UZKIKLuwpQu47feK"}]]),jl=new Map([["Compendium.pf2e.classfeatures.Item.09iL38CZZEa0q0Mt",{effect:"Compendium.pf2e.feat-effects.Item.fsjO5oTKttsbpaKl",action:"Compendium.pf2e.actionspf2e.Item.HbejhIywqIufrmVM"}],["Compendium.pf2e.feats-srd.Item.xQuNswWB3eg1UM28",{effect:"Compendium.pf2e.feat-effects.Item.2Qpt0CHuOMeL48rN"}],["Compendium.pf2e.feats-srd.Item.R7c4PyTNkZb0yvoT",{effect:"Compendium.pf2e.feat-effects.Item.qX62wJzDYtNxDbFv"}],["Compendium.pf2e.feats-srd.Item.bvOsJNeI0ewvQsFa",{effect:"Compendium.pf2e.feat-effects.Item.er5tvDNvpbcnlbHQ"}]]),ar={name:"stances",settings:[{key:"stances",type:Boolean,default:!1,scope:"client",onChange:e=>ka(e)}],hooks:[["deleteCombat",Gl],["deleteCombatant",Oa],["createCombatant",zl],["renderCharacterSheetPF2e",ql]],conflicts:["pf2e-stances"],api:{getStances:ir,toggleStance:Ta,isValidStance:Ca},ready:oe(ka,"stances")},{hooks:Ul}=B(ar);function ka(e){Ul.setAll(e),Se("character")}s(ka,"setup");function Ca(e){return e?.system.traits.value.includes("stance")&&e.system.selfEffect?.uuid}s(Ca,"isValidStance");function ir(e){let t=[],n=new Set;for(let{replace:r,sourceId:a,effectUUID:i,effect:o,img:c,name:l,itemName:f,action:u}of Ia(e)){r&&n.add(r);let p=u?pt(e,u,"action"):pt(e,a,"feat");t.push({name:l,itemName:f,uuid:a,img:c,effectUUID:i,effectID:o?.id,actionUUID:p.sourceId,actionID:p.id})}return t.filter(({uuid:r})=>!n.has(r))}s(ir,"getStances");async function ql(e,t){let n=e.actor;if(!fe(n))return;let r=ir(n);if(!r.length)return;let a=n.getActiveTokens(!0,!0).some(l=>l.inCombat),i=t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter]"),o=i.find(".actions-options"),c=await z("stances/sheet",{stances:r,canUseStances:a&&!n.isDead,i18n:F("stances")});o.length?o.after(c):i.prepend(c),t.find(".sheet-body .sheet-content [data-tab=actions] .tab-content .actions-panels [data-tab=encounter] .pf2e-stances .pf2e-stances__stance").on("click",l=>Bl(l,n))}s(ql,"renderCharacterSheetPF2e");function Bl(e,t){let n=e.currentTarget,r=n.closest(".pf2e-stances")?.classList.contains("can-use-stances");if(!e.ctrlKey&&!r)return;let a=n.dataset.effectUuid;Ta(t,a)}s(Bl,"onToggleStance");function*Ia(e){for(let t of e.itemTypes.feat){let n=t.sourceId,r=Hl.get(n),a=jl.get(n);if(!r&&!a&&!Ca(t))continue;let i=r?.effect??a?.effect??t.system.selfEffect.uuid,o=fromUuidSync(i);o&&(yield{name:(r&&fromUuidSync(r.replace)?.name)??t.name,itemName:t.name,replace:r?.replace,extra:a,sourceId:n,effectUUID:i,effect:pt(e,i,"effect"),action:a?.action,img:o.img})}}s(Ia,"actorStances");function Aa(e){let t=[];for(let{effect:n}of Ia(e))n&&t.push({uuid:n.sourceId,id:n.id});return t}s(Aa,"getStancesEffects");async function Ta(e,t){let n=Aa(e),r=n.findIndex(i=>i.uuid===t),a=!1;if(r===-1)a=!0;else{let i=n.filter(c=>c.uuid!==t).length,o=n.filter(c=>c.uuid===t).length>1;(i||o)&&n.splice(r,1)}n.length&&await e.deleteEmbeddedDocuments("Item",n.map(i=>i.id)),a&&or(e,t)}s(Ta,"toggleStance");async function or(e,t){let n=await fromUuid(t);if(n){let r=n.toObject();return getProperty(r,"flags.core.sourceId")||setProperty(r,"flags.core.sourceId",n.uuid),(await e.createEmbeddedDocuments("Item",[r]))[0]?.toMessage(),!0}return!1}s(or,"addStance");function Gl(e){for(let t of e.combatants)Oa(t)}s(Gl,"deleteCombat");function Oa(e){let t=Da(e);if(t){if(!game.user.isGM&&hn(t)){let n=Aa(t).map(r=>r.id);n.length&&t.deleteEmbeddedDocuments("Item",n)}t.sheet.render()}}s(Oa,"deleteCombatant");function zl(e){let t=Da(e);t&&(!game.user.isGM&&hn(t)&&Vl(t),t.sheet.render())}s(zl,"createCombatant");function Da(e){let t=e.actor;if(t&&!t.isToken&&t.isOfType("character"))return t}s(Da,"getActorFromCombatant");async function Vl(e){let t=ir(e);if(!(!t.length||t.filter(({effectID:a})=>a).length||!_r(e,_l,["feat"])))if(t.length===1){let a=t[0];await or(e,a.effectUUID)&&Ie("stances.useStance",{stance:a.name})}else Wl(e,t)}s(Vl,"checkForSavant");async function Wl(e,t){let n=F("stances.menu");new Dialog({title:n("title"),content:await z("stances/menu",{stances:t,i18n:n.template}),buttons:{yes:{icon:'<i class="fa-solid fa-people-arrows"></i>',label:n("accept"),callback:r=>or(e,r.find("[name=stance]:checked").val())},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:n("cancel")}}}).render(!0)}s(Wl,"openStancesMenu");var Ma={name:"summary",settings:[{key:"summary",type:String,default:"disabled",scope:"client",choices:["disabled","enabled","sort"],onChange:e=>Pa(e)}],conflicts:["pf2e-spells-summary"],ready:oe(Pa,"summary")};function Pa(e){e!=="disabled"?Lt({tabName:"spellcasting",templateFolder:"summary/sheet",beforeSelector:".spell-collections [data-tab=known-spells]",getData:ru,addEvents:Kl}):Ft("spellcasting"),Se("character")}s(Pa,"setup");function Kl(e,t,n){let r=e.find(".spell-type .uses .spell-slots-input input");r.on("change",a=>Yl(a,n)),r.on("focus",Jl),r.on("blur",Xl),e.find(".focus-pips").on("click contextmenu",a=>Ql(a,n)),e.find(".spell-slots-increment-reset").on("click",a=>eu(a,t,n)),e.find(".item-image").on("click",a=>tu(a,n))}s(Kl,"addEvents");async function Yl(e,t){e.preventDefault();let{inputPath:n,entryId:r}=$(e.currentTarget).data(),a=e.currentTarget.valueAsNumber;t.updateEmbeddedDocuments("Item",[{_id:r,[n]:a}])}s(Yl,"onUsesInputChange");function Jl(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.add("hover")}s(Jl,"onUsesInputFocus");function Xl(e){e.preventDefault(),e.currentTarget.closest(".item")?.classList.remove("hover")}s(Xl,"onUsesInputBlur");function Ql(e,t){e.preventDefault();let n=e.type==="click"?1:-1,r=(t.system.resources.focus?.value??0)+n;t.update({"system.resources.focus.value":r})}s(Ql,"onToggleFocusPool");function Zl(e,t,n){if(game.modules.get("pf2e-staves")?.active){nu(e.element).find(".directory-list.spellcastingEntry-list").find(`.item-container.spellcasting-entry[data-item-id=${n}]`).find(".spell-ability-data .statistic-values a.pf2e-staves-charge")[0]?.click();return}let r=game.modules.get("pf2e-dailies");if(!r?.active)return;let a=t.spellcasting.get(n);r.api.updateEntryCharges(a,9999)}s(Zl,"onChargesReset");function eu(e,t,n){e.preventDefault();let{itemId:r,rank:a,isCharge:i}=$(e.currentTarget).data();if(!r)return;if(i){Zl(t,n,r);return}let o=n.items.get(r);if(o){if(o.isOfType("consumable")){let c=o.system.uses?.max;c&&o.update({"system.uses.value":c})}else if(o.isOfType("spellcastingEntry")){let c=a>=0&&a<=11?`slot${a}`:"slot0",l=o.system.slots?.[c];l&&o.update({[`system.slots.${c}.value`]:l.max})}else if(o.isOfType("spell")){let c=o.system.location.uses?.max;c&&o.update({"system.location.uses.value":c})}}}s(eu,"onSlotsReset");async function tu(e,t){let{entryId:n,itemId:r,castRank:a}=e.currentTarget.closest(".item").dataset,i=t.spellcasting.collections.get(n);if(!i)return;i.get(r)?.toMessage(e,{data:{castRank:Number(a??NaN)}})}s(tu,"onItemToChat");function nu(e){return e.find("section.sheet-body .sheet-content > .tab[data-tab=spellcasting]")}s(nu,"getSpellcastingTab");async function ru(e){let t=e.system.resources.focus??{value:0,max:0},n=game.modules.get("pf2e-staves")?.active,r=game.modules.get("pf2e-dailies"),a=r?.active,i=n||a&&isNewerVersion(r.version,"2.14.0"),o=n?"flags.pf2e-staves.charges":a?"flags.pf2e-dailies.staff.charges":"",c=[],l=[],f,u=!1,p=await Promise.all(e.spellcasting.collections.map(async m=>({entry:m.entry,data:await m.entry.getSheetData({spells:m})})));for(let{entry:m,data:y}of p){if(y.isRitual){f=y.groups.flatMap((Y,pe)=>Y.active.map(({spell:X})=>({name:X.name,img:X.img,slotId:pe,itemId:X.id,rank:X.rank,time:X.system.time.value})).filter(Boolean));continue}let g=y.id,v=y.statistic.dc.value,S=y.name,E=y.isFocusPool,x=m.system?.prepared?.value==="charge",k=y.isInnate,M=y.isPrepared,N=y.isSpontaneous,j=y.isFlexible,se=(()=>{if(y.category!=="items")return;let Y=m.id.split("-")[0];return e.items.get(Y)})(),be=(()=>{if(!x)return;let Y=a&&r.api.getSpellcastingEntryStaffData(m),{charges:pe,max:X,canPayCost:ge}=Y??getProperty(m,"flags.pf2e-staves.charges")??{charges:0,max:0};return{value:pe,max:X,noMax:!0,canPayCost:ge??(()=>!0)}})();for(let Y of y.groups){if(!Y.active.length||Y.uses?.max===0)continue;let pe=[],X=Y.id==="cantrips",ge=Zr(Y.id),ke=!X&&x&&!i;for(let je=0;je<Y.active.length;je++){let Ve=Y.active[je];if(!Ve||Ve.uses?.max===0)continue;let{spell:he,expended:it,virtual:tn,uses:nn,castRank:ot}=Ve;pe.push({name:he.name,img:he.img,range:he.system.range.value||"-  ",castRank:ot??he.rank,slotId:je,entryId:g,entryDc:v,entryName:S,itemId:he.id,inputId:k?he.id:y.id,inputPath:se?"system.uses.value":x?o:k?"system.location.uses.value":`system.slots.slot${ge}.value`,isCharge:x,isActiveCharge:x&&i,isBroken:ke,isVirtual:tn,isInnate:k,isCantrip:X,isFocus:E,isPrepared:M,isSpontaneous:N||j,groupId:Y.id,consumable:se,uses:se?se.system.uses:x?be:nn??Y.uses,expended:x&&!X?!be.canPayCost(ge):it??(E&&!X?t.value<=0:!1),action:he.system.time.value,type:se?`PF2E.Item.Consumable.Category.${se.category}`:x?Qe("summary.staff"):k?"PF2E.PreparationTypeInnate":N?"PF2E.PreparationTypeSpontaneous":j?"PF2E.SpellFlexibleLabel":E?"PF2E.TraitFocus":"PF2E.SpellPreparedLabel",order:x?0:M?1:E?2:k?3:N?4:5,noHover:M||X||ke||E})}if(pe.length){if(E)if(X)u=!0;else{l.push(...pe);continue}c[ge]??=[],c[ge].push(...pe)}}}if(c.length){let m=P("summary")==="sort"?(y,g)=>y.order===g.order?mt(y.name,g.name):y.order-g.order:(y,g)=>mt(y.name,g.name);for(let y of c)y&&y.sort(m)}return l.length&&(l.sort((m,y)=>mt(m.name,y.name)),c[12]=l,u=!1),{spells:c,rituals:f,focusPool:t,hasFocusCantrips:u,isOwner:e.isOwner,i18n:F("summary"),entryRank:m=>game.i18n.format("PF2E.Item.Spell.Rank.Ordinal",{rank:Yr(m)})}}s(ru,"getData");var su={fortitude:{icon:"fa-solid fa-chess-rook",label:"PF2E.SavesFortitude"},reflex:{icon:"fa-solid fa-person-running",label:"PF2E.SavesReflex"},will:{icon:"fa-solid fa-brain",label:"PF2E.SavesWill"}},lr={hero:{icon:"fa-solid fa-hospital-symbol",reroll:"PF2E.RerollMenu.HeroPoint",rerolled:"PF2E.RerollMenu.MessageHeroPoint"},new:{icon:"fa-solid fa-dice",reroll:"PF2E.RerollMenu.KeepNew",rerolled:"PF2E.RerollMenu.MessageKeep.new"},lower:{icon:"fa-solid fa-dice-one",reroll:"PF2E.RerollMenu.KeepLower",rerolled:"PF2E.RerollMenu.MessageKeep.lower"},higher:{icon:"fa-solid fa-dice-six",reroll:"PF2E.RerollMenu.KeepHigher",rerolled:"PF2E.RerollMenu.MessageKeep.higher"}},au=["criticalFailure","failure","success","criticalSuccess"],iu="TextEditor.enrichHTML",ou="ChatLog.prototype.activateListeners",ur={name:"target",settings:[{key:"target",type:Boolean,default:!1,requiresReload:!0},{key:"target-client",type:String,default:"disabled",choices:["disabled","small","big"],scope:"client"}],hideSettings:[{global:"target",settings:["target-client"]}],socket:cu,init:e=>{P("target")&&(at.activate(),e&&Hooks.on("getChatLogEntryContext",mu),q(iu,lu),q(ou,uu),document.body.addEventListener("dragstart",pu,!0),Hooks.on("preCreateChatMessage",hu))},ready:e=>{if(P("target")){Hooks.on("renderChatMessage",Fa);for(let{message:t,html:n}of Ke(10))Fa(t,n)}}},{socket:at}=B(ur);function cu(e,t){let n=gt();switch(e.type){case"update-save":{n&&pr(e);break}case"update-applied":{n&&Va(e);break}case"dice-so-nice":{game.user.id!==t&&fr(e.roll,e.target,!0);break}}}s(cu,"onSocket");async function fr(e,t,n=!1){if(!game.modules.get("dice-so-nice")?.active)return;let r=t instanceof TokenDocument?t:await fromUuid(t),a=game.user,i=e instanceof Roll?e:Roll.fromData(e),o=!n&&game.settings.get("pf2e","metagame_showBreakdowns");return!n&&!o?at.emit({type:"dice-so-nice",roll:i.toJSON(),target:r?.uuid}):n&&!a.isGM&&!r?.playersCanSeeName&&(i.ghost=!0),game.dice3d.showForRoll(i,a,o)}s(fr,"roll3dDice");var Ra=/(class="inline-check[\w0-9 -]*")/g;function lu(e,...t){let n=e(...t);return typeof n=="string"?(n=n.replace(Ra,"$1 draggable='true'"),n):Promise.resolve().then(async()=>(n=await n,n.replace(Ra,"$1 draggable='true'")))}s(lu,"textEditorEnrichHTML");function uu(e,t){e(t),t[0].addEventListener("drop",du)}s(uu,"chatActivateListeners");function du(e){let t=e.target.closest("li.chat-message");if(!t)return;let{isBasic:n,pf2Dc:r,pf2Check:a,type:i,pf2RollOptions:o,pf2Traits:c}=TextEditor.getDragEventData(e);if(i!==`${L.id}-check-roll`)return;let l=t.dataset.messageId,f=game.messages.get(l);if(!(!f||!f.isDamageRoll)){if(!game.user.isGM&&!f.isAuthor){V("target.chat.drop.unauth");return}if(O(f,"target.save")){V("target.chat.drop.already");return}ne(f,"target",{rollOptions:[...c?.split(",").map(u=>u.trim())??[],...o?.split(",").map(u=>u.trim())??[]],save:{basic:n,dc:Number(r),statistic:a}}),Ie("target.chat.drop.added")}}s(du,"onChatMessageDrop");var cr;function pu(e){let{target:t,dataTransfer:n}=e;if(!n||!(t instanceof HTMLAnchorElement)||!t.classList.contains("inline-check"))return;let r={...t.dataset,type:`${L.id}-check-roll`};if(!r.pf2Dc||!["reflex","will","fortitude"].includes(r.pf2Check)){e.preventDefault();return}if(e.stopPropagation(),r.isBasic==null){let a=t.querySelector("span.label")?.lastChild.textContent.trim();if(a){if(!cr){let i=Object.values(CONFIG.PF2E.saves).map(c=>game.i18n.localize(c)),o=game.i18n.format("PF2E.InlineCheck.BasicWithSave",{save:`(${i.join("|")})`});cr=new RegExp(o)}r.isBasic=cr.test(a)}else r.isBasic=!1}n.setData("text/plain",JSON.stringify(r))}s(pu,"onDragStart");function mu(e,t){let n=s(r=>{let a=r.data("messageId"),i=game.messages.get(a);if(!i)return;let o=Z(i,"target");if(o)return{message:i,inMemory:o}},"getMessageData");t.unshift({icon:'<i class="fa-solid fa-dice-d20"></i>',name:Qe("target.chat.context.saves.name"),condition:r=>!!n(r)?.inMemory.canRollSave?.length,callback:r=>{let{inMemory:a,message:i}=n(r)??{},o=a.canRollSave;if(!o?.length)return;let c=Ba(i);c&&za({target:r.find(".pf2e-toolbelt-target-damage")[0]},i,c,o)}})}s(mu,"getChatLogEntryContext");var La;function gu(e){return La??=(()=>{let t=[game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.fast-healing.ReceivedMessage"),game.i18n.localize("PF2E.Encounter.Broadcast.FastHealing.regeneration.ReceivedMessage")];return new RegExp(`^<div>(${t.join("|")})</div>`)})(),La.test(e.flavor)}s(gu,"isRegenMessage");function $a(e){return!e.rolls[0].options.evaluatePersistent}s($a,"isValidDamageMessage");function hu(e){let t=e.isDamageRoll,n=[];if(!(t&&!$a(e))){if(t&&!O(e,"target")){let r=e.token,a=r?.actor,i=gu(e),o=i?a?[{token:r.uuid,actor:a.uuid}]:[]:_a();if(n.push(["targets",o]),i&&n.push(["isRegen",!0]),e.rolls.length===2){let c=e.rolls.filter(u=>u.options),l=c.findIndex(u=>u.options.splashOnly),f=c.findIndex(u=>!u.options.splashOnly&&u.options.damage?.modifiers.some(p=>p.damageCategory==="splash"));l!==-1&&f!==-1&&n.push(["splashIndex",l])}}if(t||e.getFlag("pf2e","context.type")==="spell-cast"){let r=e.item,a=r&&r.type==="spell"&&r.system.defense?.save;if(a){let i=r.spellcasting?.statistic.dc.value;typeof i=="number"&&n.push(["save",{...a,dc:i}])}}n.length&&Je(e,"target",n.reduce((r,[a,i])=>(r[a]=i,r),{}))}}s(hu,"preCreateChatMessage");async function Fa(e,t){let n=P("target-client")!=="disabled";if(Le(e,"target.canRollSave"),n&&e.isDamageRoll){if(!$a(e))return;await vu(e,t),Na(e);return}let r=e.item;if(!(!r||r.type!=="spell")){if(n&&!r.damageKinds.size){await yu(e,t,r),Na(e);return}r.system.defense?.save&&Dr(e)&&t.find("[data-action=spell-damage]").on("click",()=>{Yt(e)})}}s(Fa,"renderChatMessage");function Na(e){Promise.all([ui.chat,ui.chat._popout].map(async t=>{let n=t?.element[0]?.querySelector("#chat-log");!n||!t.isAtBottom&&e.user._id!==game.user._id||(await t._waitForImages(),n.scrollTop=n.scrollHeight)}));for(let t of Object.values(e.apps))t instanceof ChatPopout&&t.rendered&&t.setPosition()}s(Na,"refreshMessage");async function yu(e,t,n){let r=await Ga(e);if(!r)return;let{targets:a,save:i}=r,o=t.find(".message-content"),c=o.find(".card-buttons");if(game.user.isGM||e.isAuthor){let f=c.find("[data-action=spell-save]"),u=$('<div class="pf2e-toolbelt-target-wrapper"></div>'),p=H("target.chat.targets.tooltip"),m=$(`<button class="pf2e-toolbelt-target-targets" title="${p}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);m.on("click",y=>Ha(y,e)),u.append(m),u.append(f),c.prepend(u)}if(n?.area&&!n.traits.has("aura")&&canvas.scene?.templates.some(u=>u.message===e&&u.isOwner)&&c.find(".owner-buttons .hidden.small").removeClass("hidden"),!a.length)return;let l=$('<div class="pf2e-toolbelt-target-spell"></div>');for(let{template:f}of a)l.append("<hr>"),l.append(f);o.after(l),qa(e,l,i)}s(yu,"renderSpellChatMessage");function _a(){return Array.from(game.user.targets.filter(e=>e.actor).map(e=>({token:e.document.uuid,actor:e.actor.uuid})))}s(_a,"getTargets");function Ha(e,t){e.stopPropagation(),ne(t,"target.targets",_a())}s(Ha,"addTargets");async function vu(e,t){let n=await Ga(e),r=t.find(".message-content"),a=r.find(".damage-application"),i=$('<div class="pf2e-toolbelt-target-buttons"></div>');if(n?.targets.length&&a.length){let u=s(()=>{let y=!!Z(e,"target.expanded");m.toggleClass("collapse",y),a.toggleClass("hidden",!y)},"toggleDamageRow"),p=H("target.chat.toggle.tooltip"),m=$(`<button class="toggle" title="${p}">
    <i class="fa-solid fa-plus expand"></i>
    <i class="fa-solid fa-minus collapse"></i>
</button>`);u(),m.on("click",y=>{y.stopPropagation(),ie(e,"target.expanded",!Z(e,"target.expanded")),u()}),i.append(m)}if(n?.isRegen!==!0&&(game.user.isGM||e.isAuthor)){let u=H("target.chat.targets.tooltip"),p=$(`<button class="targets" title="${u}">
    <i class="fa-solid fa-bullseye-arrow"></i>
</button>`);p.on("click",m=>Ha(m,e)),i.append(p)}if(t.find(".dice-result .dice-total").append(i),!n?.targets.length)return;let o=a.clone();if(!o.length)return;o.removeClass("damage-application").addClass("target-damage-application"),P("target-client")!=="big"&&o.find("button").addClass("small"),o.find("[data-action]").each(function(){let u=this.dataset.action;this.dataset.action=`target-${u}`});let{targets:c,save:l}=n,f=$('<div class="pf2e-toolbelt-target-damage"></div>');for(let{uuid:u,template:p,save:m,isOwner:y,applied:g={}}of c){if(f.append("<hr>"),f.append(p),!y)continue;let v=!!(m?.result&&m.basic),S=o.clone();S.each((E,x)=>{x.dataset.rollIndex=E,x.dataset.targetUuid=u,x.classList.toggle("applied",!!g[E]||v&&m.result.success==="criticalSuccess"),v&&x.classList.add(m.result.success)}),f.append(S)}r.after(f),qa(e,f,l),f.find("button[data-action^=target-]").on("click",u=>Eu(u,e,t))}s(vu,"renderDamageChatMessage");function dr(e){return e.target?.closest(".pf2e-toolbelt-target-damage")}s(dr,"getRowsElement");function ja(e){dr(e)?.classList.add("disable-saves")}s(ja,"disableSaveListeners");function Ua(e){dr(e)?.classList.remove("disable-saves")}s(Ua,"enableSaveListeners");function qa(e,t,n){let r=s(a=>{let i=a.target.closest("[data-action]");if(!i)return;let o=i.dataset.action,c=s(()=>!dr(a)?.classList.contains("disable-saves"),"saveEnabled");switch(o){case"ping-target":{wu(a);break}case"open-target-sheet":{Su(a);break}case"roll-save":{c()&&za(a,e,n);break}case"reroll-save":{c()&&bu(a,e,n);break}}},"listener");t.on("click",r)}s(qa,"addHeaderListeners");function Ba(e){let t=O(e,"target.save");if(t)return{...t,...su[t.statistic]}}s(Ba,"getSaveData");async function Ga(e){let t=game.user.isGM,n=O(e,"target.targets")??[],r=t||game.settings.get("pf2e","metagame_showDC"),a=t||game.settings.get("pf2e","metagame_showBreakdowns"),i=t||game.settings.get("pf2e","metagame_showResults"),o=Ba(e);if(!n.length&&!o)return;if(o){let f=game.i18n.format("PF2E.SavingThrowWithName",{saveName:game.i18n.localize(o.label)}),u=r?H("target.chat.save.dcWithValue",{dc:o.dc}):"";o.tooltipLabel=`${f} ${u}`,o.tooltip=await z("target/save-tooltip",{check:o.tooltipLabel})}let c=[],l=(await Promise.all(n.map(async({token:f})=>{let u=await fromUuid(f);if(!u)return;let p=u.id,m=u.actor;if(!m)return;let y=!m.hasCondition("undetected");if(!t&&!y)return;let g=m.isOwner,v=m.hasPlayerOwner,S=g||v,E=o&&!!m?.saves[o.statistic],x=O(e,`target.saves.${p}`);E&&!v&&!x&&c.push(f);let k=await(async()=>{if(!E||!x)return;let be=x.rerolled,Y=E&&g&&!be,pe=game.i18n.localize(`PF2E.Check.Result.Degree.Check.${x.success}`),X=x.value-o.dc,ge=S||i?H(`target.chat.save.result.${r?"withOffset":S?"withoutOffsetWithDie":"withoutOffset"}`,{success:pe,offset:X>=0?`+${X}`:X,die:`<i class="fa-solid fa-dice-d20"></i> ${x.die}`}):void 0,ke=(S||a)&&x.success!==x.unadjustedOutcome?x.dosAdjustments[x.unadjustedOutcome]?.label:void 0;return{...x,canReroll:Y,tooltip:await z("target/save-tooltip",{i18n:F("target.chat.save").template,check:o.tooltipLabel,result:ge,modifiers:S||a?x.modifiers:[],adjustment:ke,canReroll:Y,rerolled:lr[be]})}})(),M=o&&{...o,result:k},N=game.modules.get("anonymous"),j=t?!0:N?.active?N.api.playersSeeName(u.actor):!game.pf2e.settings.tokens.nameVisibility||u.playersCanSeeName,se=j?u.name:N?.active?N.api.getName(u.actor):H("unnamed");return{isOwner:g,canSeeName:j,hasPlayerOwner:v,uuid:f,target:u,save:M,applied:O(e,`target.applied.${p}`),template:await z("target/row-header",{name:se,isGM:t,isOwner:g,hasPlayerOwner:v,isHidden:!y,uuid:f,showSuccess:S||i,save:E&&M,canReroll:k?.canReroll,rerolled:lr[k?.rerolled],i18n:F("target.chat.row")})}}))).filter(Boolean);return ie(e,"target.canRollSave",c),t?l.sort((f,u)=>f.hasPlayerOwner-u.hasPlayerOwner):l.sort((f,u)=>!f.isOwner&&!u.isOwner?u.hasPlayerOwner-f.hasPlayerOwner:u.isOwner-f.isOwner),{targets:l,save:o,isRegen:O(e,"target.isRegen")}}s(Ga,"getMessageData");async function Zt(e){let{targetUuid:t}=e.target.closest("[data-target-uuid]").dataset;return fromUuid(t)}s(Zt,"getTargetFromEvent");async function bu(e,t,{dc:n}){let r=await Zt(e),a=r?.actor;if(!a)return;let i=O(t,`target.saves.${r.id}`);if(!i?.roll||i.rerolled)return;let o=a.isOfType("character")?a.heroPoints.value:0,c=Object.entries(lr).map(([k,{icon:M,reroll:N}])=>{if(k==="hero"&&!o)return;let j=game.i18n.localize(N);return`<label><input type="radio" name="reroll" value="${k}"><i class="${M}"></i> ${j}</label>`}).filter(Boolean).join(""),l={yes:{icon:'<i class="fa-solid fa-rotate rotate"></i>',label:"reroll",callback:k=>k.find("[name=reroll]:checked").val()??null},no:{icon:'<i class="fa-solid fa-xmark"></i>',label:"cancel",callback:()=>null}};ja(e);let f=await Dialog.wait({title:`${r.name} - ${H("target.chat.save.reroll.confirm.title")}`,content:c,buttons:l,close:()=>null},{id:`pf2e-toolbelt-target-save-reroll-dialog-${r.id}`});if(!f){Ua(e);return}let u=f==="hero",p=u?"new":f;if(u){let{value:k,max:M}=a.heroPoints;if(k<1){V("target.chat.save.reroll.noPoints");return}await a.update({"system.resources.heroPoints.value":Math.clamped(k-1,0,M)})}let m=Roll.fromJSON(i.roll),y=m.clone();y.options.isReroll=!0,Hooks.callAll("pf2e.preReroll",Roll.fromJSON(i.roll),y,u,p);let g=await y.evaluate({async:!0});await fr(g,r),Hooks.callAll("pf2e.reroll",Roll.fromJSON(i.roll),g,u,p);let v=p==="higher"&&m.total>g.total||p==="lower"&&m.total<g.total?m:g;if(v===g){let k=new Rt(g,n,i.dosAdjustments);v.options.degreeOfSuccess=k.value}let S=game.user.isGM||t.isAuthor,E={value:v.total,die:v.dice[0].total,success:v.degreeOfSuccess,roll:JSON.stringify(v.toJSON()),dosAdjustments:deepClone(i.dosAdjustments),modifiers:deepClone(i.modifiers),rerolled:f};v.options.keeleyAdd10&&E.modifiers.push({label:H("target.chat.save.reroll.keeley"),modifier:10});let x={type:"update-save",message:S?t:t.id,targets:[{target:r.id,data:E}]};game.user.isGM||t.isAuthor?pr(x):at.emit(x)}s(bu,"rerollSave");async function za(e,t,{dc:n,statistic:r},a){let i=game.user.isGM||t.isAuthor,o=Array.isArray(a)?a.map(l=>fromUuid(l)):[Zt(e)],c={type:"update-save",message:i?t:t.id,targets:[]};ja(e),await Promise.all(o.map(async l=>{let f=await l,u=f?.actor;if(!u)return;let p=u.saves[r];if(!p)return;let m=(()=>{let S=t.item;if(S)return S;let E=O(t,"target.messageId");if(E)return game.messages.get(E)?.item})(),y=O(t,"target.rollOptions"),g=!game.user.settings.showCheckDialogs,v=o.length>1||(e.shiftKey?!g:g);if(o.length===1&&!v){let S;Hooks.once("renderCheckModifiersDialog",x=>{S=x});let E=Hooks.on("closeCheckModifiersDialog",x=>{S===x&&(Hooks.off("closeCheckModifiersDialog",E),x.isResolved||Ua(e))})}return new Promise(S=>{p.check.roll({dc:{value:n},item:m,origin:u,skipDialog:v,extraRollOptions:y,createMessage:!1,callback:async(E,x,k)=>{await fr(E,f);let M=k.getFlag("pf2e","context"),N={value:E.total,die:E.dice[0].total,success:E.degreeOfSuccess,roll:JSON.stringify(E.toJSON()),dosAdjustments:M.dosAdjustments,unadjustedOutcome:M.unadjustedOutcome,modifiers:k.getFlag("pf2e","modifiers").filter(j=>j.enabled).map(({label:j,modifier:se})=>({label:j,modifier:se}))};c.targets.push({data:N,target:f.id}),S()}})})})),i?pr(c):at.emit(c)}s(za,"rollSave");async function pr({targets:e,message:t}){if(typeof t=="string"&&(t=game.messages.get(t),!t))return;let n={};for(let{data:r,target:a}of e)typeof r.success=="number"&&(r.success=au[r.success]),n[a]=deepClone(r);await ne(t,"target.saves",n)}s(pr,"updateMessageSave");async function Su(e){let t=await Zt(e);t&&t.actor?.sheet.render(!0)}s(Su,"openTargetSheet");async function wu(e){if(!canvas.ready)return;let t=await Zt(e);t&&canvas.ping(t.center)}s(wu,"pingTarget");async function Eu(e,t,n){let r=e.currentTarget,{rollIndex:a,targetUuid:i}=r.closest("[data-target-uuid]").dataset,o=await fromUuid(i);if(!o)return;let c=r.dataset.action;if(c==="target-shield-block"){let f=t.id;r.classList.contains("shield-activated")||bt(f),requestAnimationFrame(()=>{Xr(o,r,n[0])});return}An({message:t,multiplier:c==="target-apply-healing"?-1:c==="target-half-damage"?.5:c==="target-apply-damage"?1:c==="target-double-damage"?2:3,addend:0,promptModifier:e.shiftKey,rollIndex:Number(a),tokens:[o],onDamageApplied:xu})}s(Eu,"onTargetButton");function xu(e,t,n){let r={};for(let a of t){let i=a.id;Xe(r,`target.applied.${i}.${n}`,!0);let o=O(e,"target.splashIndex");if(o!==void 0){let c=o===0?1:0;if(n===o)Xe(r,`target.applied.${i}.${c}`,!0);else{Xe(r,`target.applied.${i}.${o}`,!0);let l=O(e,"target.targets")??[];for(let f of l){let u=f.token?.split(".").at(-1);u!==i&&Xe(r,`target.applied.${u}.${c}`,!0)}}}}game.user.isGM||e.isAuthor?Va({message:e,updates:r}):at.emit({type:"update-applied",message:e.id,updates:r})}s(xu,"onDamageApplied");function Va({message:e,updates:t}){typeof e=="string"&&(e=game.messages.get(e),!e)||e.update(t)}s(Va,"updateMessageApplied");var mr={name:"template",settings:[{key:"target-template",type:Boolean,default:!1,scope:"client",onChange:e=>Wa(e)}],hooks:[["createMeasuredTemplate",ku]],init:()=>{Wa.fromSetting("target-template")}},{setHook:Wa}=B(mr);async function ku(e,t,n){let r=game.user;if(r.id!==n)return;let a=F("target.menu"),i=e.item,o=e.actor,c=o?o.token??o.getActiveTokens()[0]:void 0,l={title:i?.name||a("title"),content:await z("template/menu",{i18n:a.template,noSelf:!c}),buttons:{select:{icon:'<i class="fa-solid fa-bullseye-arrow"></i>',label:a("target"),callback:v=>({targets:v.find("[name=targets]:checked").val(),self:v.find("[name=self]").prop("checked"),neutral:v.find("[name=neutral]").prop("checked")})}},close:()=>null},f=await Dialog.wait(l,void 0,{id:"pf2e-toolbelt-target-template",width:260});if(!f)return;let u=o?o.alliance:r.isGM?"opposition":"party",p=u==="party"?"opposition":u==="opposition"?"party":null,g=ss(e).filter(v=>{if(!v.actor?.isOfType("creature","hazard","vehicle")||v.document.hidden)return!1;if(c&&v===c)return f.self;let E=v.actor?v.actor.alliance:v.alliance;return E===null?f.neutral:f.targets==="all"||f.targets==="allies"&&E===u||f.targets==="enemies"&&E===p}).map(v=>v.id);r.updateTokenTargets(g),r.broadcastActivity({targets:g})}s(ku,"createMeasuredTemplate");var gr={name:"unided",settings:[{key:"unided",type:String,default:"disabled",choices:["disabled","create","all"],onChange:e=>Ka(e)}],hooks:[{event:"preCreateItem",listener:Iu,useChoices:!0},{event:"preUpdateItem",listener:Au,useChoices:"all"}],conflicts:["pf2e-unided"],init:oe(Ka,"unided")},{hooks:Cu}=B(gr);function Ka(e){Cu.setAll(e)}s(Ka,"setup");function Iu(e){!e.img||!e.isOfType("physical")||(e._source.system.identification.unidentified.img=e.img)}s(Iu,"preCreateItem");function Au(e,t){!e.isOfType("physical")||!("img"in t)||setProperty(t,"system.identification.unidentified.img",t.img)}s(Au,"preUpdateItem");var hr=debounce(Ou,1),yr={name:"untarget",settings:[{key:"force-untarget",type:Boolean,default:!1,onChange:hr},{key:"untarget",type:Boolean,default:!1,scope:"client",onChange:hr}],hooks:[["updateCombat",Du]],init:hr},{setHook:Tu}=B(yr);function Ou(){let e=P("force-untarget")||P("untarget");Tu(e)}s(Ou,"setup");function Du(e,t){if(!("turn"in t)&&!("round"in t))return;let n=game.user;n.updateTokenTargets(),n.broadcastActivity({targets:[]})}s(Du,"updateCombat");var ze=F("macros.condition");async function Ya(e){let t=s((u,p)=>{let m=u.find("[name=condition]"),{name:y,slug:g,img:v}=m.find(":selected").data();return{type:p,slug:g,img:v,name:u.find("[name=name]").val().trim()||ze("effect-name",{condition:y}),uuid:m.val(),badge:Number(u.find("[name=badge]").val()||1),unidentified:u.find("[name=unidentified]").prop("checked")}},"callback"),n={generate:{icon:'<i class="fas fa-suitcase"></i>',label:ze("generate"),callback:u=>t(u,"generate")},add:{icon:'<i class="fa-solid fa-user"></i>',label:ze("add"),callback:u=>t(u,"add")}},r=Array.from(game.pf2e.ConditionManager.conditions.values()),a=new Set(r.filter(u=>!!u.badge).map(u=>u.slug)),i=await z("macros/condition",{i18n:ze.template,conditions:Array.from(new Set(r.sort((u,p)=>u.name.localeCompare(p.name))))}),o=s(u=>{let{name:p,slug:m}=u.find("[name=condition] :selected").data();u.find("[name=name]").prop("placeholder",ze("effect-name",{condition:p}));let y=a.has(m),g=u.find("[name=badge]");g.prop("disabled",!y),y||g.val(1)},"setInputs"),c=await Dialog.wait({buttons:n,content:i,title:ze("title"),close:()=>null,render:u=>{o(u),u.find("[name=condition]").on("change",()=>o(u))}},{id:"pf2e-toolbelt-macros-condition",width:320});if(!c)return;let l={inMemoryOnly:!0,key:"GrantItem",uuid:c.uuid};c.badge>1&&a.has(c.slug)&&(l.alterations=[{mode:"override",property:"badge-value",value:c.badge}]);let f={name:c.name,type:"effect",img:c.img,system:{rules:[l],unidentified:c.unidentified}};c.type==="generate"||!e?await Item.create(f):await e.createEmbeddedDocuments("Item",[f])}s(Ya,"permaConditionEffect");jr("pf2e-toolbelt");var en=[us,Rn,Fn,Nn,Hn,zn,Wn,tr,sr,va,ba,ar,Ma,ur,mr,gr,yr],Ja=new Set,vr=null;Hooks.once("init",()=>{let e=Vr(),t=[];for(let i of en)Pn(i),t.push(...i.settings);let n=t.filter(({scope:i})=>!i||i==="world"),r=t.filter(({scope:i})=>i==="client");for(let i of[n,r].flat())qr(i);if(e&&r.length){let i=r.find(o=>o.config!==!1);i&&(vr=i.key,Hooks.on("renderSettingsConfig",Pu))}let a=Ur();a.api={macros:{permaConditionEffect:Ya}};for(let i of en){let{init:o,conflicts:c=[],api:l,name:f}=i;if(e)for(let u of c){let p=game.modules.get(u);p?.active&&(i.conflicting=!0,Ja.add(p.title))}l&&(a.api[f]=l),!i.conflicting&&o&&o(e)}});Hooks.once("ready",()=>{let e=game.user.isGM;for(let{conflicting:t,ready:n}of en)!t&&n&&n(e);if(e)for(let t of Ja)V("module-conflict",{name:t},!0)});function Pu(e,t){let n=L.id,r=t.find(`.tab[data-tab=${n}]`),a=s(i=>r.find(`[data-setting-id="${n}.${i}"]`),"getSettingSection");vr&&a(vr).before(`<h3>${H("settings.client")}</h3>`);for(let{hideSettings:i=[]}of en)for(let{global:o,settings:c}of i)if(!as(o))for(let f of c)a(f).remove()}s(Pu,"renderSettingsConfig");})();
//# sourceMappingURL=main.js.map
